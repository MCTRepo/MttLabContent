<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ400-DesigningandImplementingMicrosoftDevOpsSolutions
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3Dc4119e2670c1341e2dee3899942ea4f91a667f7e.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ400-DesigningandImplementingMicrosoftDevOpsSolutions
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ400-DesigningandImplementingMicrosoftDevOpsSolutions" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#before-you-start">Before you start</a></li><li class="nav-item"><a class="nav-link" href="#exercise-0-configure-the-lab-prerequisites">Exercise 0: Configure the lab prerequisites</a></li><li class="nav-item"><a class="nav-link" href="#exercise-1-configure-cicd-pipelines-as-code-with-yaml-in-azure-devops">Exercise 1: Configure CI/CD Pipelines as Code with YAML in Azure DevOps</a></li><li class="nav-item"><a class="nav-link" href="#exercise-2-remove-the-azure-lab-resources">Exercise 2: Remove the Azure lab resources</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="lab-11a-configuring-pipelines-as-code-with-yaml">Lab 11a: Configuring Pipelines as Code with YAML</h1>
<h1 id="student-lab-manual">Student lab manual</h1>

<h2 id="lab-overview">Lab overview</h2>

<p>Many teams prefer to define their build and release pipelines using YAML. This allows them to access the same pipeline features as those using the visual designer, but with a markup file that can be managed like any other source file. YAML build definitions can be added to a project by simply adding the corresponding files to the root of the repository. Azure DevOps also provides default templates for popular project types, as well as a YAML designer to simplify the process of defining build and release tasks.</p>

<h2 id="objectives">Objectives</h2>

<p>After you complete this lab, you will be able to:</p>

<ul>
  <li>configure CI/CD pipelines as code with YAML in Azure DevOps</li>
</ul>

<h2 id="lab-duration">Lab duration</h2>

<ul>
  <li>Estimated time: <strong>60 minutes</strong></li>
</ul>

<h2 id="instructions">Instructions</h2>

<h3 id="before-you-start">Before you start</h3>

<h4 id="sign-in-to-the-lab-virtual-machine">Sign in to the lab virtual machine</h4>

<p>Ensure that you’re signed in to your Windows 10 virtual machine by using the following credentials:</p>

<ul>
  <li>Username: <strong>Student</strong></li>
  <li>Password: <strong>Pa55w.rd</strong></li>
</ul>

<h4 id="review-applications-required-for-this-lab">Review applications required for this lab</h4>

<p>Identify the applications that you’ll use in this lab:</p>

<ul>
  <li>Microsoft Edge</li>
</ul>

<h4 id="set-up-an-azure-devops-organization">Set up an Azure DevOps organization.</h4>

<p>If you don’t already have an Azure DevOps organization that you can use for this lab, create one by following the instructions available at <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/create-organization?view=azure-devops">Create an organization or project collection</a>.</p>

<h4 id="prepare-an-azure-subscription">Prepare an Azure subscription</h4>

<ul>
  <li>Identify an existing Azure subscription or create a new one.</li>
  <li>Verify that you have a Microsoft account or an Azure AD account with the Owner role in the Azure subscription and the Global Administrator role in the Azure AD tenant associated with the Azure subscription. For details, refer to <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-list-portal">List Azure role assignments using the Azure portal</a> and <a href="https://docs.microsoft.com/en-us/azure/active-directory/roles/manage-roles-portal#view-my-roles">View and assign administrator roles in Azure Active Directory</a>.</li>
</ul>

<h3 id="exercise-0-configure-the-lab-prerequisites">Exercise 0: Configure the lab prerequisites</h3>

<p>In this exercise, you will set up the prerequisites for the lab, which consist of the preconfigured Parts Unlimited team project based on an Azure DevOps Demo Generator template and Azure resources, including an Azure web app and an Azure SQL database.</p>

<h4 id="task-1-configure-the-team-project">Task 1: Configure the team project</h4>

<p>In this task, you will use Azure DevOps Demo Generator to generate a new project based on the <strong>PartsUnlimited-YAML</strong> template.</p>

<ol>
  <li>
    <p>On your lab computer, start a web browser and navigate to <a href="https://azuredevopsdemogenerator.azurewebsites.net">Azure DevOps Demo Generator</a>. This utility site will automate the process of creating a new Azure DevOps project within your account that is prepopulated with content (work items, repos, etc.) required for the lab.</p>

    <blockquote>
      <p><strong>Note</strong>: For more information on the site, see <a href="https://docs.microsoft.com/en-us/azure/devops/demo-gen">What is the Azure DevOps Services Demo Generator?</a>.</p>
    </blockquote>
  </li>
  <li>Click <strong>Sign in</strong> and sign in using the Microsoft account associated with your Azure DevOps subscription.</li>
  <li>If required, on the <strong>Azure DevOps Demo Generator</strong> page, click <strong>Accept</strong> to accept the permission requests for accessing your Azure DevOps subscription.</li>
  <li>On the <strong>Create New Project</strong> page, in the <strong>New Project Name</strong> textbox, type <strong>Configuring Pipelines as Code with YAML</strong>, in the <strong>Select organization</strong> dropdown list, select your Azure DevOps organization, and then click <strong>Choose template</strong>.</li>
  <li>In the list of templates, in the toolbar, click <strong>General</strong>, select the <strong>PartsUnlimited-YAML</strong> template and click <strong>Select Template</strong>.</li>
  <li>
    <p>Back on the <strong>Create New Project</strong> page, click <strong>Create Project</strong></p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the process to complete. This should take about 2 minutes. In case the process fails, navigate to your DevOps organization, delete the project, and try again.</p>
    </blockquote>
  </li>
  <li>On the <strong>Create New Project</strong> page, click <strong>Navigate to project</strong>.</li>
</ol>

<h4 id="task-2-create-azure-resources">Task 2: Create Azure resources</h4>

<p>In this task, you will create an Azure web app and an Azure SQL database by using the Azure portal.</p>

<ol>
  <li>From the lab computer, start a web browser, navigate to the <a href="https://portal.azure.com"><strong>Azure Portal</strong></a>, and sign in with the user account that has the Owner role in the Azure subscription you will be using in this lab and has the role of the Global Administrator in the Azure AD tenant associated with this subscription.</li>
  <li>In the Azure portal, in the toolbar, click the <strong>Cloud Shell</strong> icon located directly to the right of the search text box.</li>
  <li>
    <p>If prompted to select either <strong>Bash</strong> or <strong>PowerShell</strong>, select <strong>Bash</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is the first time you are starting <strong>Cloud Shell</strong> and you are presented with the <strong>You have no storage mounted</strong> message, select the subscription you are using in this lab, and select <strong>Create storage</strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>From the <strong>Bash</strong> prompt, in the <strong>Cloud Shell</strong> pane, run the following command to create a resource group (replace the <code>&lt;region&gt;</code> placeholder with the name of the Azure region closest to you such as ‘eastus’).</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-bash hljs">LOCATION=<span class="hljs-string"><span class="hljs-string">'&lt;region&gt;'</span></span>
</code></pre>
    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-bash hljs">RESOURCEGROUPNAME=<span class="hljs-string"><span class="hljs-string">'az400m11l01-RG'</span></span>
az group create --name <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --location <span class="hljs-variable"><span class="hljs-variable">$LOCATION</span></span>
</code></pre>
  </li>
  <li>
    <p>To create a Windows App service plan by running the following command:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-bash hljs">SERVICEPLANNAME=<span class="hljs-string"><span class="hljs-string">'az400l11a-sp1'</span></span>
az appservice plan create --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --name <span class="hljs-variable"><span class="hljs-variable">$SERVICEPLANNAME</span></span> --sku B3
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: If the <code>az appservice plan create</code> command fails with an error message starting with <code>ModuleNotFoundError: No module named 'vsts_cd_manager'</code>, then run the following commands and then re-run the failed command.</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-bash hljs">az extension remove -n appservice-kube
az extension add --yes --<span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"https://aka.ms/appsvc/appservice_kube-latest-py2.py3-none-any.whl"</span></span>
</code></pre>
  </li>
  <li>
    <p>Create a web app with a unique name.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-bash hljs">WEBAPPNAME=partsunlimited<span class="hljs-variable"><span class="hljs-variable">$RANDOM</span></span><span class="hljs-variable"><span class="hljs-variable">$RANDOM</span></span>
az webapp create --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --plan <span class="hljs-variable"><span class="hljs-variable">$SERVICEPLANNAME</span></span> --name <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: Record the name of the web app. You will need it later in this lab.</p>
    </blockquote>
  </li>
  <li>
    <p>Next, create an Azure SQL Server.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-bash hljs">USERNAME=<span class="hljs-string"><span class="hljs-string">"Student"</span></span>
SQLSERVERPASSWORD=<span class="hljs-string"><span class="hljs-string">"Pa55w.rd1234"</span></span>
SERVERNAME=<span class="hljs-string"><span class="hljs-string">"partsunlimitedserver</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RANDOM</span></span></span><span class="hljs-string">"</span></span>

az sql server create --name <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
--location <span class="hljs-variable"><span class="hljs-variable">$LOCATION</span></span> --admin-user <span class="hljs-variable"><span class="hljs-variable">$USERNAME</span></span> --admin-password <span class="hljs-variable"><span class="hljs-variable">$SQLSERVERPASSWORD</span></span>
</code></pre>
  </li>
  <li>
    <p>The web app needs to be able to access the SQL server, so we need to allow access to Azure resources in the SQL Server firewall rules.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-bash hljs">STARTIP=<span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>
ENDIP=<span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>
az sql server firewall-rule create --server <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
--name AllowAzureResources --start-ip-address <span class="hljs-variable"><span class="hljs-variable">$STARTIP</span></span> --end-ip-address <span class="hljs-variable"><span class="hljs-variable">$ENDIP</span></span>
</code></pre>
  </li>
  <li>
    <p>Now create a database within that server.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-bash hljs">az sql db create --server <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --name PartsUnlimited \
--service-objective S0
</code></pre>
  </li>
  <li>
    <p>The web app you created needs the database connection string in its configuration, so run the following commands to prepare and add it to the app settings of the web app.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-bash hljs">CONNSTRING=$(az sql db show-connection-string --name PartsUnlimited --server <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> \
--client ado.net --output tsv)

CONNSTRING=<span class="hljs-variable"><span class="hljs-variable">${CONNSTRING//&lt;username&gt;/$USERNAME}</span></span>
CONNSTRING=<span class="hljs-variable"><span class="hljs-variable">${CONNSTRING//&lt;password&gt;/$SQLSERVERPASSWORD}</span></span>

az webapp config connection-string <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --name <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
-t SQLAzure --settings <span class="hljs-string"><span class="hljs-string">"DefaultConnectionString=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CONNSTRING</span></span></span><span class="hljs-string">"</span></span> 
</code></pre>
  </li>
</ol>

<h3 id="exercise-1-configure-cicd-pipelines-as-code-with-yaml-in-azure-devops">Exercise 1: Configure CI/CD Pipelines as Code with YAML in Azure DevOps</h3>

<p>In this exercise, you will configure CI/CD Pipelines as code with YAML in Azure DevOps.</p>

<h4 id="task-1-delete-the-existing-pipeline">Task 1: Delete the existing pipeline</h4>

<p>In this task, you will delete the existing pipeline.</p>

<ol>
  <li>
    <p>On the lab computer, switch to the browser window displaying the <strong>Configuring Pipelines as Code with YAML</strong> project in the Azure DevOps portal and, in the vertical navigational pane, select the <strong>Pipelines</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: Before configuring YAML pipelines, you will disable the existing build pipeline.</p>
    </blockquote>
  </li>
  <li>On the <strong>Pipelines</strong> pane, select the <strong>PartsUnlimited</strong> entry.</li>
  <li>In the upper right corner of the <strong>PartsUnlimited</strong> blade, click the vertical ellipsis symbol and, in the drop-down menu, select <strong>Delete</strong>.</li>
  <li>Write <strong>PartsUnlimited</strong> and click <strong>Delete</strong>.</li>
  <li>In the vertical navigational pane, select the <strong>Repos &gt; Files</strong>. Make sure you are in the <strong>master</strong> branch (dropdown on top of <strong>Files</strong> window), on the <strong>azure-pipelines.yml</strong> file, click the vertical ellipsis symbol and, in the drop-down menu, select <strong>Delete</strong>. Commit the change on the master branch by clicking on <strong>Commit</strong> (leaving default options).</li>
</ol>

<h4 id="task-2-add-a-yaml-build-definition">Task 2: Add a YAML build definition</h4>

<p>In this task, you will add a YAML build definition to the existing project.</p>

<ol>
  <li>Navigate back to the <strong>Pipelines</strong> pane in of the <strong>Pipelines</strong> hub.</li>
  <li>
    <p>In the <strong>Create your first Pipeline</strong> window, click <strong>Create pipeline</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: We will use the wizard to automatically create the YAML definition based on our project.</p>
    </blockquote>
  </li>
  <li>On the <strong>Where is your code?</strong> pane, click <strong>Azure Repos Git (YAML)</strong> option.</li>
  <li>On the <strong>Select a repository</strong> pane, click <strong>PartsUnlimited</strong>.</li>
  <li>
    <p>On the <strong>Configure your pipeline</strong> pane, click **ASP<nolink>.NET** to use this template as the starting point for your pipeline. This will open the **Review your pipeline YAML** pane.</nolink></p>

    <blockquote>
      <p><strong>Note</strong>: The pipeline definition will be saved as a file named <strong>azure-pipelines.yml</strong> in the root of the repository. The file will contain the steps required to build and test a typical ASP<nolink>.NET solution. You can also customize the build as needed. In this scenario, you will update the **pool** to enforce the use of a VM running Visual Studio 2017.</nolink></p>
    </blockquote>
  </li>
  <li>
    <p>Make sure  <code>trigger</code> is <strong>master</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: Review in Repos if your repository has <strong>master</strong> or <strong>main</strong> branch, organizations could choose default branch name for new repos: <a href="https://docs.microsoft.com/en-us/azure/devops/repos/git/change-default-branch?view=azure-devops#choosing-a-name">Change the default branch</a>.</p>
    </blockquote>
  </li>
  <li>On the <strong>Review your pipeline YAML</strong> pane, in line <strong>10</strong>, replace <code>vmImage: 'windows-latest'</code> with <code>vmImage: 'windows-2019'</code>.</li>
  <li>Remove the <strong>VSTest@2</strong> task:
```yaml
    <ul>
      <li>task: VSTest@2
inputs:
  platform: ‘$(buildPlatform)’
  configuration: ‘$(buildConfiguration)’
```</li>
    </ul>
  </li>
  <li>On the <strong>Review your pipeline YAML</strong> pane, click <strong>Save and run</strong>.</li>
  <li>On the <strong>Save and run</strong> pane, accept the default settings and click <strong>Save and run</strong>.</li>
  <li>
    <p>On the pipeline run pane, in the <strong>Jobs</strong> section, click <strong>Job</strong> and monitor its progress and verify that it completes successfully.</p>

    <blockquote>
      <p><strong>Note</strong>: Each task from the YAML file is available for review, including any warnings and errors.</p>
    </blockquote>
  </li>
  <li>Return to the pipeline run pane, switch from the <strong>Summary</strong> tab to the <strong>Tests</strong> tab, and review test statistics.</li>
</ol>

<h4 id="task-3-add-continuous-delivery-to-the-yaml-definition">Task 3: Add continuous delivery to the YAML definition</h4>

<p>In this task, you will add continuous delivery to the YAML-based definition of the pipeline you created in the previous task.</p>

<blockquote>
  <p><strong>Note</strong>: Now that the build and test processes are successful, we can now add delivery to the YAML definition.</p>
</blockquote>

<ol>
  <li>On the pipeline run pane, click the ellipsis symbol in the upper right corner and, in the dropdown menu, click <strong>Edit pipeline</strong>.</li>
  <li>
    <p>On the pane displaying the content of the <strong>azure-pipelines.yaml</strong> file, in line <strong>8</strong>, following the <code>trigger</code> section, add the following content to define the <strong>Build</strong> stage in the YAML pipeline.</p>

    <blockquote>
      <p><strong>Note</strong>: You can define whatever stages you need to better organize and track pipeline progress.</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-yaml">stages:
- stage: Build
  jobs:
  - job: Build
</code></pre>
  </li>
  <li>
    <p>Select the remaining content of the YAML file and press the <strong>Tab</strong> key twice to indent it four spaces (it should be placed with same identation as <code>job: Build</code>).</p>

    <blockquote>
      <p><strong>Note</strong>: This way, everything starting with the <code>pool</code> section becomes part of the <code>job: Build</code>.</p>
    </blockquote>
  </li>
  <li>
    <p>At the bottom of the file, add the configuration below to define the second stage.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-yaml">- stage: Deploy
  jobs:
  - job: Deploy
    pool:
      vmImage: 'vs2017-win2016'
    steps:
</code></pre>
  </li>
  <li>
    <p>Set the cursor on a new line at the end of the YAML definition.</p>

    <blockquote>
      <p><strong>Note</strong>: This will be the location where new tasks are added.</p>
    </blockquote>
  </li>
  <li>In the list of tasks on the right side of the code pane, search for and select the <strong>Azure App Service Deploy</strong> task.</li>
  <li>
    <p>In the <strong>Azure App Service deploy</strong> pane, specify the following settings and click <strong>Add</strong>:</p>

    <ul>
      <li>in the <strong>Azure subscription</strong> drop-down list, select the Azure subscription into which you deployed the Azure resources earlier in the lab, click <strong>Authorize</strong>, and, when prompted, authenticate by using the same user account you used during the Azure resource deployment.</li>
      <li>in the <strong>App Service name</strong> dropdown list, select the name of the web app you deployed earlier in the lab.</li>
      <li>in the <strong>Package or folder</strong> text box, type <code>$(System.ArtifactsDirectory)/drop/*.zip</code>.</li>
    </ul>

    <blockquote>
      <p><strong>Note</strong>: This will automatically add the deployment task to the YAML pipeline definition.</p>
    </blockquote>
  </li>
  <li>
    <p>With the added task still selected in the editor, press the <strong>Tab</strong> key twice to indent it four spaces, so that it listed as a child of the <strong>steps</strong> task.</p>

    <blockquote>
      <p><strong>Note</strong>: The <strong>packageForLinux</strong> parameter is misleading in the context of this lab, but it is valid for Windows or Linux.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: By default, these two stages run independently. As a result, the build output from the first stage might not be available to the second stage without additional changes. To implement these changes, we will use one task to publish the build output at the end of the build stage and another to download it in the beginning of the deploy stage.</p>
    </blockquote>
  </li>
  <li>Place the cursor on a blank line at the end of the build stage to add another task. (right below  <code>task: VSTest@2</code> )</li>
  <li>On the <strong>Tasks</strong> pane, search for and select the <strong>Publish build artifacts</strong> task.</li>
  <li>
    <p>On the <strong>Publish build artifacts</strong> pane, accept the default settings and click <strong>Add</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: This will publish the build artifacts to a location that will be downloadable under the alias <strong>drop</strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>With the added task still selected in the editor, press the <strong>Tab</strong> key twice to indent it four spaces (or press the <strong>Tab</strong> until task is indented as the ones above).</p>

    <blockquote>
      <p><strong>Note</strong>: You may also want to add an empty line before and after to make it easier to read.</p>
    </blockquote>
  </li>
  <li>Place the cursor on the first line under the <strong>steps</strong> node of the <strong>deploy</strong> stage.</li>
  <li>On the <strong>Tasks</strong> pane, search for and select the <strong>Download build artifacts</strong> task.</li>
  <li>Click <strong>Add</strong>.</li>
  <li>
    <p>With the added task still selected in the editor, press the <strong>Tab</strong> key twice to indent it four spaces.</p>

    <blockquote>
      <p><strong>Note</strong>: Here as well you may also want to add an empty line before and after to make it easier to read.</p>
    </blockquote>
  </li>
  <li>
    <p>Add a property to the download task specifying the <code>artifactName</code> of <code>drop</code> (make sure to match the spacing):</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="hljs bash">artifactName: <span class="hljs-string"><span class="hljs-string">'drop'</span></span>
</code></pre>
  </li>
  <li>
    <p>Click <strong>Save</strong>, on the <strong>Save</strong> pane, click <strong>Save</strong> again to commit the change directly into the master branch.</p>

    <blockquote>
      <p><strong>Note</strong>: This will automatically trigger a new build.</p>
    </blockquote>
  </li>
  <li>
    <p>The pipeline will look similar to this example  (<strong>Reference your own subscription and webapp on last task</strong>):</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="hljs perl">trigger:
- master

stages:
- stage: Build
  jobs:
  - job: Build
    pool:
        vmImage: <span class="hljs-string"><span class="hljs-string">'windows-2019'</span></span>

    variables:
        solution: <span class="hljs-string"><span class="hljs-string">'**/*.sln'</span></span>
        buildPlatform: <span class="hljs-string"><span class="hljs-string">'Any CPU'</span></span>
        buildConfiguration: <span class="hljs-string"><span class="hljs-string">'Release'</span></span>

    steps:
    - task: NuGetToolInstaller@1

    - task: NuGetCommand@2
      inputs:
        restoreSolution: <span class="hljs-string"><span class="hljs-string">'$(solution)'</span></span>

    - task: VSBuild@1
      inputs:
        solution: <span class="hljs-string"><span class="hljs-string">'$(solution)'</span></span>
        msbuildArgs: <span class="hljs-string"><span class="hljs-string">'/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'</span></span>
        platform: <span class="hljs-string"><span class="hljs-string">'$(buildPlatform)'</span></span>
        configuration: <span class="hljs-string"><span class="hljs-string">'$(buildConfiguration)'</span></span>

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: <span class="hljs-string"><span class="hljs-string">'$(Build.ArtifactStagingDirectory)'</span></span>
        ArtifactName: <span class="hljs-string"><span class="hljs-string">'drop'</span></span>
        publishLocation: <span class="hljs-string"><span class="hljs-string">'Container'</span></span>

- stage: Deploy
  jobs:
  - job: Deploy
    pool:
        vmImage: <span class="hljs-string"><span class="hljs-string">'windows-2019'</span></span>
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: <span class="hljs-string"><span class="hljs-string">'current'</span></span>
        downloadType: <span class="hljs-string"><span class="hljs-string">'single'</span></span>
        downloadPath: <span class="hljs-string"><span class="hljs-string">'$(System.ArtifactsDirectory)'</span></span>
        artifactName: <span class="hljs-string"><span class="hljs-string">'drop'</span></span>
    - task: AzureRmWebAppDeployment@4
      inputs:
        ConnectionType: <span class="hljs-string"><span class="hljs-string">'AzureRM'</span></span>
        azureSubscription: <span class="hljs-string"><span class="hljs-string">'YOUR-AZURE-SUBSCRIPTION'</span></span>
        appType: <span class="hljs-string"><span class="hljs-string">'webApp'</span></span>
        WebAppName: <span class="hljs-string"><span class="hljs-string">'YOUR-WEBAPP-NAME'</span></span>
        packageForLinux: <span class="hljs-string"><span class="hljs-string">'$(System.ArtifactsDirectory)/drop/*.zip'</span></span>
</code></pre>
  </li>
  <li>In the web browser window displaying the Azure DevOps portal, in the vertical navigational pane, select the <strong>Pipelines</strong>.</li>
  <li>On the <strong>Pipelines</strong> pane, click the entry representing the newly configured pipeline.</li>
  <li>Click on the most recent run (automatically started).</li>
  <li>On the <strong>Summary</strong> pane, monitor the progress of the pipeline run.</li>
  <li>If you notice a message stating that <em>This pipeline needs permissions to access a resource before this run can continue to Deploy</em>, click <strong>View</strong>, in the <strong>Waiting for review</strong> dialog box, click <strong>Permit</strong>, and, in the <strong>Permit access?</strong> pane, click <strong>Permit</strong> again.</li>
  <li>
    <p>At the bottom of the <strong>Summary</strong> pane, click the <strong>Deploy</strong> stage to view details of the deployment.</p>

    <blockquote>
      <p><strong>Note</strong>: Once the task completes, your app will be deployed to an Azure web app.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-4-review-the-deployed-site">Task 4: Review the deployed site</h4>

<ol>
  <li>Switch back to web browser window displaying the Azure portal and navigate to the blade displaying the properties of the Azure web app.</li>
  <li>On the Azure web app blade, click <strong>Overview</strong> and, on the overview blade, click <strong>Browse</strong> to open your site in a new web browser tab.</li>
  <li>Verify that the deployed site loads as expected in the new browser tab.</li>
</ol>

<h3 id="exercise-2-remove-the-azure-lab-resources">Exercise 2: Remove the Azure lab resources</h3>

<p>In this exercise, you will remove the Azure resources provisione in this lab to eliminate unexpected charges.</p>

<blockquote>
  <p><strong>Note</strong>: Remember to remove any newly created Azure resources that you no longer use. Removing unused resources ensures you will not see unexpected charges.</p>
</blockquote>

<h4 id="task-1-remove-the-azure-lab-resources">Task 1: Remove the Azure lab resources</h4>

<p>In this task, you will use Azure Cloud Shell to remove the Azure resources provisioned in this lab to eliminate unnecessary charges.</p>

<ol>
  <li>In the Azure portal, open the <strong>Bash</strong> shell session within the <strong>Cloud Shell</strong> pane.</li>
  <li>
    <p>List all resource groups created throughout the labs of this module by running the following command:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="language-sh hljs bash">az group list --query <span class="hljs-string"><span class="hljs-string">"[?starts_with(name,'az400m11l01-RG')].name"</span></span> --output tsv
</code></pre>
  </li>
  <li>
    <p>Delete all resource groups you created throughout the labs of this module by running the following command:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="language-sh hljs bash">az group list --query <span class="hljs-string"><span class="hljs-string">"[?starts_with(name,'az400m11l01-RG')].[name]"</span></span> --output tsv | xargs -L1 bash -c <span class="hljs-string"><span class="hljs-string">'az group delete --name $0 --no-wait --yes'</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The command executes asynchronously (as determined by the –nowait parameter), so while you will be able to run another Azure CLI command immediately afterwards within the same Bash session, it will take a few minutes before the resource groups are actually removed.</p>
    </blockquote>
  </li>
</ol>

<h2 id="review">Review</h2>

<p>In this lab, you configured CI/CD pipelines as code with YAML in Azure DevOps.</p>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ400-DesigningandImplementingMicrosoftDevOpsSolutions" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ400-DesigningandImplementingMicrosoftDevOpsSolutions
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3Dc4119e2670c1341e2dee3899942ea4f91a667f7e.js"></script>



</body></html>