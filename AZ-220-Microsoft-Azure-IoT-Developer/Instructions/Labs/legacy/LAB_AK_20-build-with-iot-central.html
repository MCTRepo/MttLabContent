<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-220-Microsoft-Azure-IoT-Developer
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../../assets/css/style_v%3Dfdcd20e7353e74116ec5bb7c4b9ad222d1bd751d.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../../">
                AZ-220-Microsoft-Azure-IoT-Developer
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-220-Microsoft-Azure-IoT-Developer" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#exercise-1-create-and-configure-azure-iot-central">Exercise 1: Create and Configure Azure IoT Central</a></li><li class="nav-item"><a class="nav-link" href="#exercise-3-monitor-a-simulated-device">Exercise 3: Monitor a Simulated Device</a></li><li class="nav-item"><a class="nav-link" href="#exercise-4-create-a-free-azure-maps-account">Exercise 4: Create a free Azure Maps account</a></li><li class="nav-item"><a class="nav-link" href="#exercise-5-create-a-programming-project-for-a-real-device">Exercise 5: Create a Programming Project for a Real Device</a></li><li class="nav-item"><a class="nav-link" href="#exercise-6-test-your-iot-central-device">Exercise 6: Test Your IoT Central Device</a></li><li class="nav-item"><a class="nav-link" href="#exercise-7-create-multiple-devices">Exercise 7: Create multiple devices</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="create-your-first-azure-iot-central-app">Create your first Azure IoT Central App</h1>

<p>Azure IoT Services and technologies work great and are easy to manage when you have the team of people, but a full IoT solution architecture can be a lot for a small, less specialized team to implement and support. Azure IoT Central is a SaaS application that encompasses a full range of underlying IoT technologies, including Azure IoT Hub, Azure Device Provisioning System (DPS), Azure Maps, Azure Time Series Insights, Azure IoT Edge, and others. Although IoT Central does not provide the level of granularity that you get when you implement these technologies directly, it does enable a smaller team to easily manage and monitor a fleet of remote devices.</p>

<p>Among other things, this lab will help you to decide when IoT Central is the right tool to support a particular scenario. So, get ready to explore what IoT Central can do.</p>

<h2 id="lab-scenario">Lab Scenario</h2>

<p>Contoso operates a fleet of refrigerated trucks that are used to deliver cheese within a city and the surrounding area. You have a large number of customers in the region and use a centralized location in the city to operate the fleet. Each day, the trucks are loaded with products and the driver is given a delivery route by the dispatcher. The system works great and there are seldom issues. However, if the cooling system on a truck fails, the drivers and dispatcher needs discuss how best to proceed. The dispatcher will either have the products returned to the warehouse for inspection, or delivered to a customer location that is close by the vehicle’s current location. The amount of product remaining undelivered on the truck as well as the temperature in the refrigeration area are both factors in the decision.</p>

<p>In order to make an informed decision, the driver and dispatcher need up-to-date information about the truck and the products that it is carrying. They need to know the location of each truck on a map, the status of the truck’s cooling system, and the status of the truck’s cargo.</p>

<p>IoT Central provides everything that you will need to handle this scenario.</p>

<p>The following resources will be created:</p>

<p><a href="media/LAB_AK_20-architecture.png/" target="_blank"><img src="media/LAB_AK_20-architecture.png/" alt="Lab 20 Architecture"></a></p>

<h2 id="in-this-lab">In This Lab</h2>

<p>In this lab, you will complete the following activities:</p>

<ul>
  <li>Create an Azure IoT Central custom app, using the IoT Central portal</li>
  <li>Create a device template for a custom device, using the IoT Central portal</li>
  <li>Create a programming project to simulate a refrigerated truck, with routes selected by Azure Maps, using Visual Studio Code, or Visual Studio</li>
  <li>Monitor and command the simulated device, from an IoT Central dashboard</li>
</ul>

<h2 id="lab-instructions">Lab Instructions</h2>

<h3 id="exercise-1-create-and-configure-azure-iot-central">Exercise 1: Create and Configure Azure IoT Central</h3>

<h4 id="task-1-create-the-initial-iot-central-app">Task 1: Create the initial IoT Central app</h4>

<ol>
  <li>
    <p>Navigate to <a href="https://apps.azureiotcentral.com/?azure-portal=true">Azure IoT Central</a>.</p>

    <p>It’s a good idea to bookmark this URL, as it’s the home for all your IoT Central apps.</p>
  </li>
  <li>
    <p>Take a minute to scroll down and read the contents of this home page.</p>
  </li>
  <li>
    <p>On the left side navigation menu, click <strong>Build</strong>.</p>

    <p>Notice that there are several options that provide a more advanced starting point for certain scenarios.</p>
  </li>
  <li>
    <p>Under <strong>Featured</strong>, click <strong>Custom apps</strong>.</p>
  </li>
  <li>
    <p>On the <strong>New application</strong> page, under <strong>Application name</strong>, enter <strong>Refrigerated-Trucks-{your-id}</strong>.</p>

    <p>Notice that the Application name that you enter is being used as the root for your application URL (converted to lower-case).</p>

    <p>Although your Application name can be any friendly name, the <strong>URL</strong> <em>must</em> be unique. The two don’t have to match exactly, but it can be less confusing when they do.</p>

    <p>Appending <code>{your-id}</code> to the Application name helps to ensure that the URL will be unique.</p>
  </li>
  <li>
    <p>Under <strong>Application template</strong>, leave the default <strong>Custom application</strong> value.</p>
  </li>
  <li>
    <p>Take a minute to review the fields under <strong>Billing info</strong>.</p>

    <p>The <strong>Directory</strong> field is used to specify an Azure Active Directory tenant. If your organization uses an AAD tenant, you would specify that here. For this course we will leave the default.</p>

    <p>If you select a pricing option that includes a cost, you would need to specify an Azure subscription.</p>
  </li>
  <li>
    <p>Under <strong>Pricing plan</strong>, click <strong>Free</strong>.</p>

    <p>Notice that the free option provides a 7 day trial and includes 5 free devices. The <strong>Billing info</strong> section has also been updated for <strong>Contact info</strong> instead.</p>
  </li>
  <li>
    <p>Under <strong>Contact info</strong>, provide your contact information within each of the required fields.</p>

    <blockquote>
      <p><strong>Note</strong>: There is no commitment or termination fees associated with the plan. The <strong>Build</strong> page includes a link to <a href="https://aka.ms/iotcentral-pricing">Get pricing details</a> if you are interested in reading more about IoT Central pricing.</p>
    </blockquote>
  </li>
  <li>
    <p>At the bottom of the page, click <strong>Create</strong>.</p>

    <p>Wait a few seconds while the app resource is built, then you should see a <strong>Dashboard</strong> with a few default links.</p>
  </li>
  <li>
    <p>Close the Azure IoT Central browser tab.</p>

    <p>The next time you open the Azure IoT Central home page, you will select <strong>My apps</strong> from the left side navigation menu, and your  <strong>Refrigerated-Trucks-{your-id}</strong> app will be listed.</p>
  </li>
  <li>
    <p>Use your browser to open <a href="https://apps.azureiotcentral.com/?azure-portal=true">Azure IoT Central</a>.</p>
  </li>
  <li>
    <p>On the left side navigation menu, click <strong>My apps</strong>, and then click <strong>Refrigerated-Trucks-{your-id}</strong>.</p>

    <p>Your next step is to specify a <em>device template</em>.</p>
  </li>
</ol>

<h4 id="task-2-create-a-device-template">Task 2: Create a device template</h4>

<p>The data that will be communicated between a remote device and IoT Central is specified in a <em>device template</em>. The device template encapsulates all the details of the data, so that both the device and IoT Central have all they need to make sense of the communication.</p>

<ol>
  <li>
    <p>On the <strong>Dashboard</strong> page of your Azure IoT Central app, on the left side navigation menu under <strong>App settings</strong>, click <strong>Device templates</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Device templates</strong>, click <strong>+ New</strong>.</p>

    <p>You should see a range of custom and preconfigured device template options.</p>

    <blockquote>
      <p><strong>TIP</strong>: Take note of the preconfigured options. You may want to use one of these preconfigured device templates for a future project if you have the associated hardware.</p>
    </blockquote>
  </li>
  <li>
    <p>Under <strong>Create a custom device template</strong>, click <strong>IoT device</strong>.</p>
  </li>
  <li>
    <p>At the bottom of the page, click <strong>Next: Customize</strong></p>
  </li>
  <li>
    <p>In the <strong>Enter a device template name</strong> textbox, enter <strong>RefrigeratedTruck</strong> and then press <strong>Enter</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: do not select <strong>Gateway device</strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>At the bottom of the page, click <strong>Next: Review</strong>.</p>

    <p>Verify the <strong>Basic Info</strong> shown.</p>
  </li>
  <li>
    <p>At the bottom of the <strong>Review</strong> page, click <strong>Create</strong>.</p>

    <p>Once the template has been created, the <strong>RefrigeratedTruck</strong> page will be displayed.</p>
  </li>
  <li>
    <p>On the <strong>RefrigeratedTruck</strong> page, under <strong>Create a capability model</strong>, click <strong>Custom</strong>.</p>

    <p>You are now ready to add the specifics of the device template.</p>
  </li>
</ol>

<h4 id="task-3-add-sensor-telemetry">Task 3: Add sensor telemetry</h4>

<p>Telemetry is the data values transmitted by sensors. The most important sensor in our refrigerated truck, monitors the temperature of the contents.</p>

<ol>
  <li>
    <p>On the <strong>RefrigeratedTruck</strong> device template page, click <strong>+ Add interface</strong>, and then click <strong>Custom</strong></p>

    <p>An interface defines a set of <em>capabilities</em>. To define the capabilities of your refrigerated truck you will be adding quite a few interfaces.</p>

    <p>The Custom interface allows you to start building from a blank interface.</p>
  </li>
  <li>
    <p>Under <strong>Capabilities</strong>, click <strong>+ Add capability</strong></p>
  </li>
  <li>
    <p>Take a moment to examine the types of fields that are available.</p>
  </li>
  <li>
    <p>To define a capability for the truck’s temperature sensor, enter the following field values:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Contents temperature</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>ContentsTemperature</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Telemetry</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>Temperature</td>
        </tr>
        <tr>
          <td>Schema</td>
          <td>Double</td>
        </tr>
        <tr>
          <td>Unit</td>
          <td><sup>o</sup>C</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Take a minute to double-check the information that you entered.</p>

    <blockquote>
      <p><strong>IMPORTANT</strong>:
The code that you will be adding later in this lab uses the names listed above, therefor names entered for the interface must be entered <em>exactly</em> as shown.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-4-add-state-and-event-telemetry">Task 4: Add state and event telemetry</h4>

<p>States are important, they let the operator know what is going on. A state in IoT Central is a name associated with a range of values. Later in this lab, you will choose a color to associate with each state value, making them easy to identify.</p>

<ol>
  <li>
    <p>Under <strong>Capabilities</strong>, click <strong>+ Add capability</strong>.</p>
  </li>
  <li>
    <p>To define a capability for the truck’s cargo state, enter the following field values:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Contents state</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>ContentsState</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Telemetry</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>State</td>
        </tr>
        <tr>
          <td>Value schema</td>
          <td>String</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Under <strong>Value schema</strong>, notice the message informing you that <strong>Complex type has to be defined</strong>.</p>

    <p>To simplify the lab scenario, you will define the truck’s cargo state as one of the following: <em>empty</em>, <em>full</em>, or <em>melting</em>.</p>
  </li>
  <li>
    <p>Under the <strong>Complex type has to be defined</strong> message, click <strong>+</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Display name</strong>, enter <strong>empty</strong></p>

    <p>The <strong>Name</strong> field should automatically be populated with <strong>empty</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Value</strong>, enter <strong>empty</strong></p>

    <p>All three fields should contain <strong>empty</strong>.</p>
  </li>
  <li>
    <p>Directly below the fields that you just entered, click <strong>+</strong>.</p>
  </li>
  <li>
    <p>Use the process above to add two more state values: <strong>full</strong> and <strong>melting</strong>.</p>

    <p>Again, the same text should appear in the <strong>Display name</strong>, <strong>Name</strong>, and <strong>Value</strong> fields for each of the additional state value options.</p>
  </li>
  <li>
    <p>Carefully check each capability before moving on.</p>

    <p>Now, to add some uncertainty to our simulation, let’s add a failure state for the truck’s cooling system. If the cooling system fails, as you’ll see later in this lab, the chances of the contents “melting” increase considerably! You will add <em>on</em>, <em>off</em> and <em>failed</em> entries for the truck’s cooling system.</p>
  </li>
  <li>
    <p>On the <strong>RefrigeratedTruck</strong> device template page, under <strong>Capabilities</strong>, click <strong>+ Add capability</strong>.</p>
  </li>
  <li>
    <p>To define a capability for the truck’s cooling system state, enter the following field values:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Cooling system state</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>CoolingSystemState</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Telemetry</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>State</td>
        </tr>
        <tr>
          <td>Value schema</td>
          <td>String</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Under the <strong>Complex type has to be defined</strong> message, click <strong>+</strong>, and then use the same process that you used above to add the following state value options:</p>

    <ul>
      <li>on</li>
      <li>off</li>
      <li>failed</li>
    </ul>

    <p>Make sure that the three state value options (on, off, failed) are repeated in all three <strong>Display name</strong>, <strong>Name</strong>, and <strong>Value</strong> fields.</p>

    <p>The truck itself will need an even more complex state defined. If all goes well, a truck’s normal routing might be: <em>ready</em>, <em>enroute</em>, <em>delivering</em>, <em>returning</em>, <em>loading</em>, and the back to <em>ready</em> again. However, you will include a <em>dumping</em> state to cater for when melted contents need to be taken back to the warehouse for inspection (and potentially disposed of).</p>
  </li>
  <li>
    <p>Using the same process that you used to define the previous state capabilities, create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Truck state</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>TruckState</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Telemetry</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>State</td>
        </tr>
        <tr>
          <td>Value schema</td>
          <td>String</td>
        </tr>
      </tbody>
    </table>

    <p>For the state value options, use the following:</p>

    <ul>
      <li>ready</li>
      <li>enroute</li>
      <li>delivering</li>
      <li>returning</li>
      <li>loading</li>
      <li>dumping</li>
    </ul>

    <p>The next capability type that you need to specify is an Event. Events are issues triggered by the device, and communicated to the IoT Central app. Events can be one of three types: <em>Error</em>, <em>Warning</em>, or <em>Informational</em>.</p>
  </li>
  <li>
    <p>To create an event capability, click <strong>+ Add capability</strong>, and then create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Event</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>Event</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Telemetry</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>Event</td>
        </tr>
        <tr>
          <td>Schema</td>
          <td>String</td>
        </tr>
      </tbody>
    </table>

    <p>One possible event a device might trigger is a conflicting command. An example might be a truck is returning empty from a customer, but receives a command to deliver its contents to another customer. If a conflict occurs, it’s a good idea for the device to trigger an event to warn the operator of the IoT Central app.</p>

    <p>Another event might be just to acknowledge, and record, the customer ID that a truck is to deliver to.</p>
  </li>
</ol>

<h4 id="task-5-add-location-telemetry">Task 5: Add location telemetry</h4>

<p>A location is probably the most important, and yet one of the easiest measurements to add to a device template. Under the hood, it consists of a latitude, longitude, and an optional altitude, for the device.</p>

<ol>
  <li>
    <p>To create a location capability, click <strong>+ Add capability</strong>, and then create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Location</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>Location</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Telemetry</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>Location</td>
        </tr>
        <tr>
          <td>Schema</td>
          <td>Geopoint</td>
        </tr>
      </tbody>
    </table>
  </li>
</ol>

<h4 id="task-6-add-properties">Task 6: Add properties</h4>

<p>A property of a device is typically a constant value, that is communicated to the IoT Central app when communication is first initiated. In the refrigerated truck scenario, a good example of a property is the license plate of the truck, or some similar unique truck ID.</p>

<p>Properties can also be used for device configuration data. You will be defining an <em>optimal temperature</em> for the truck contents as a property. This optimal temperature might change with different types of content, different weather conditions, or whatever might be appropriate. A setting has an initial default value, which may not need to be changed, but the ability to change it easily and quickly is there, if needed. This kind of property is called a <em>writable property</em>.</p>

<p>A property is a single value. If more complex sets of data need to be transmitted to a device, a Command (see below) is the more appropriate way of handling it.</p>

<ol>
  <li>
    <p>To create a property capability for the truck ID, click <strong>+ Add capability</strong>, and then create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Truck ID</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>TruckID</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Property</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>None</td>
        </tr>
        <tr>
          <td>Schema</td>
          <td>String</td>
        </tr>
        <tr>
          <td>Writable</td>
          <td>Off</td>
        </tr>
        <tr>
          <td>Unit</td>
          <td>None</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>To create a property capability for the optimal temperature, click <strong>+ Add capability</strong>, and then create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Optimal Temperature</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>OptimalTemperature</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Property</td>
        </tr>
        <tr>
          <td>Semantic type</td>
          <td>None</td>
        </tr>
        <tr>
          <td>Schema</td>
          <td>Double</td>
        </tr>
        <tr>
          <td>Writable</td>
          <td>On</td>
        </tr>
        <tr>
          <td>Unit</td>
          <td><sup>o</sup>C</td>
        </tr>
      </tbody>
    </table>
  </li>
</ol>

<h4 id="task-7-add-commands">Task 7: Add commands</h4>

<p>Commands are sent by the operator of the IoT Central app to the remote devices. Commands are similar to writable properties, but a command can contain any number of input fields, whereas a writable property is limited to a single value.</p>

<p>For refrigerated trucks, there are two commands you should add: a command to deliver the contents to a customer, and a command to recall the truck to base.</p>

<ol>
  <li>
    <p>To create a command capability to deliver the contents to a customer, click <strong>+ Add capability</strong>, and then create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Go to customer</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>GoToCustomer</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Command</td>
        </tr>
        <tr>
          <td>Command</td>
          <td>Synchronous</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Under <strong>Command</strong>, click <strong>Request</strong>.</p>

    <p>When you turn on the <strong>Request</strong> option, you’ll be able to enter more details of the command.</p>
  </li>
  <li>
    <p>To complete the <strong>Request</strong> portion of the command capability, enter field values as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Request</td>
          <td>On</td>
        </tr>
        <tr>
          <td>Display name</td>
          <td>Customer ID</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>CustomerID</td>
        </tr>
        <tr>
          <td>Schema</td>
          <td>Integer</td>
        </tr>
        <tr>
          <td>Unit</td>
          <td>None</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>To create a command capability for recalling the truck, click <strong>+ Add capability</strong>, and then create a new capability as follows:</p>

    <table>
      <thead>
        <tr>
          <th>Field</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Display Name</td>
          <td>Recall</td>
        </tr>
        <tr>
          <td>Name</td>
          <td>Recall</td>
        </tr>
        <tr>
          <td>Capability Type</td>
          <td>Command</td>
        </tr>
        <tr>
          <td>Command</td>
          <td>Synchronous</td>
        </tr>
      </tbody>
    </table>

    <p>For this command there are no additional parameters, so leave <strong>Request</strong> off.</p>
  </li>
  <li>
    <p>Near the top of the page, click <strong>Save</strong>.</p>

    <p>Before going any further carefully double check your interface. After an interface has been published, there are very limited editing options. It’s important to get it right before publishing.</p>

    <p>If you click on the name of the device template, in the menu that ends with the <strong>Views</strong> option, you’ll get a summary of the capabilities.</p>
  </li>
</ol>

<h4 id="task-8-publish-the-template">Task 8: Publish the template</h4>

<ol>
  <li>
    <p>If you’ve made any changes since the last time you saved, click <strong>Save</strong>.</p>
  </li>
  <li>
    <p>in the top right corner of your <strong>RefrigeratedTruck</strong> device template, click <strong>Publish</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If a popup dialog appears asking for confirmation, click <strong>Publish</strong>.</p>
    </blockquote>

    <p>You should see that the annotation changes from <strong>Draft</strong> to <strong>Published</strong>.</p>
  </li>
</ol>

<p>Preparing a device template does take some care and some time.</p>

<p>In the next Exercise, you will use the capabilities of your device template to prepare a controllers dashboard. Preparing views can be done before, or after, a device template is published.</p>

<h3 id="exercise-3-monitor-a-simulated-device">Exercise 3: Monitor a Simulated Device</h3>

<p>To begin this exercise, you will create a dashboard showing all the capabilities of the device template. After that you will use your device template to create a device, and make a record of the connection settings needed for the remote device app.</p>

<h4 id="task-1-create-a-rich-dashboard">Task 1: Create a rich dashboard</h4>

<ol>
  <li>
    <p>On the left menu of the <strong>RefrigeratedTruck</strong> device template, click <strong>Views</strong>, and then click <strong>Visualizing the device</strong>.</p>
  </li>
  <li>
    <p>Take a moment to review the list of available <strong>Telemetry</strong>, <strong>Properties</strong>, and <strong>Commands</strong>.</p>

    <p>These are the capabilities that you created, each with a selection check box.</p>
  </li>
  <li>
    <p>Under <strong>Telemetry</strong>, click <strong>Location</strong>, an then click <strong>Add tile</strong>.</p>

    <p>Dashboards are constructed using tiles, and the tiles that you choose can be arranged and resized. The Location tile will show the location of the truck on a map of the world, and by creating it first, there is plenty of room for you to resize the map.</p>
  </li>
  <li>
    <p>Hover your mouse pointer over the lower-right corner of the tile, and then drag the corner so that the tile height and width are about twice the default size.</p>
  </li>
  <li>
    <p>Under <strong>View name</strong>, enter <strong>Truck view</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Telemetry</strong>, click <strong>Contents state</strong>, and then click <strong>Add tile</strong>.</p>
  </li>
  <li>
    <p>Repeat the previous step for each of the remaining Telemetry capabilities, working from the top down.</p>

    <p>Recall that you’ve already added the Location tile.</p>
  </li>
  <li>
    <p>Use the same top-down process to add the Properties capabilities.</p>

    <p>You will have a chance to arrange the tiles on your dashboard later later in the lab. For now, you just want a dashboard that will confirm all the telemetry being sent from your remote device.</p>

    <p>There’s no need to add the commands to the dashboard, though that option does exist.</p>
  </li>
  <li>
    <p>Take a minute to review your dashboard.</p>

    <p>Scroll around to view your dashboard. Examine the contents of the tiles and consider how you might use that information.</p>
  </li>
  <li>
    <p>Quickly arrange the position of the tiles.</p>

    <p>Don’t spend too much time on this now, but notice that you can drag tiles around, and that the portal will try to rearrange them neatly.</p>
  </li>
  <li>
    <p>Click <strong>Save</strong>, and then click <strong>Publish</strong>.</p>

    <p>Notice that the publish dialog now shows <strong>Yes</strong> next to <strong>Views</strong>.</p>
  </li>
  <li>
    <p>On the publish dialog, click <strong>Publish</strong>.</p>
  </li>
</ol>

<p>You can create as many views as you need, giving each a friendly name.</p>

<p>In the next Task, you will be creating a device from the device template.</p>

<h4 id="task-2-create-a-real-device">Task 2: Create a real device</h4>

<p>IoT Central can be connected to physical devices with real sensors, or to simulated devices that generate data based on an algorithm. In both of these cases, IoT Central understands that a remote app is generating the telemetry data, and either way it treats the connected device as a “real” device.</p>

<ol>
  <li>
    <p>On the left side navigation menu, click <strong>Devices</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Devices</strong> menu, under <strong>All devices</strong>, click <strong>RefrigeratedTruck</strong></p>

    <p>Notice that the screen refreshed and that the device template you selected is now shown in bold text. If you had a large number of device templates, this would help you to ensure that you’re using the correct device template.</p>
  </li>
  <li>
    <p>On the top menu, click <strong>+ New</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Create new device</strong> dialog, under <strong>Device name</strong>, verify that <strong>RefrigeratedTruck</strong> is listed as a prefix.</p>

    <p>This is another opportunity to ensure that you’ve selected the right device template.</p>
  </li>
  <li>
    <p>Under <strong>Device ID</strong>, enter <strong>RefrigeratedTruck1</strong></p>
  </li>
  <li>
    <p>Under <strong>Device name</strong>, enter <strong>RefrigeratedTruck - 1</strong></p>
  </li>
  <li>
    <p>Under <strong>Simulated</strong>, ensure that <strong>Off</strong> is selected.</p>

    <p>Recall that IoT Central treats the connection to physical and simulated devices in the same way. Both are remote apps, and both are real. You will be building a real truck here. Well, a simulated <em>real</em> truck!</p>

    <p>Setting this Simulated value to <strong>On</strong> would instruct IoT Central to pump out random values for your telemetry. These random values can be useful in validating a device template, but in this lab you will be simulating the telemetry with you own simulated device (truck).</p>
  </li>
  <li>
    <p>On the <strong>Create new device</strong> dialog, click <strong>Create</strong>.</p>

    <p>Wait a few seconds, then your device list should be populated with a single entry.</p>

    <p>Notice that the <strong>Device status</strong> is set to <strong>Registered</strong>. The IoT Central app will only accept a connection to a device when the <strong>Device status</strong> is <strong>Provisioned</strong>. Later in this lab there’s a coding task that shows you how to provision a device.</p>
  </li>
  <li>
    <p>Under <strong>Device name</strong>, click <strong>RefrigeratedTruck - 1</strong>.</p>

    <p>Your live dashboard should be displayed (with lots of <strong>Waiting for data</strong> messages).</p>
  </li>
  <li>
    <p>Just below the <strong>RefrigeratedTruck - 1</strong> title of your device dashboard, click <strong>Commands</strong></p>

    <p>Notice that the two commands you entered are already listed and ready to be run.</p>
  </li>
</ol>

<p>Your next step will be to create the keys that will allow a remote device to communicate with your IoT Central app.</p>

<h4 id="task-3-record-the-connection-keys">Task 3: Record the connection keys</h4>

<ol>
  <li>
    <p>On the top-right menu, click <strong>Connect</strong>.</p>

    <p>Do <em>not</em> click <strong>Attach to gateway</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Device connection</strong> dialog, carefully copy the values of <strong>ID scope</strong>, <strong>Device ID</strong>, and <strong>Primary key</strong>, and save them to a text file named <strong>Truck-connections.txt</strong>.</p>

    <p>Use Notepad (or another text editor) to save the values to a text file, providing a meaningful name such as Truck-connections.txt.</p>
  </li>
  <li>
    <p>Under <strong>Connect method</strong>, ensure that <strong>Shared access signature (SAS)</strong> is selected.</p>
  </li>
  <li>
    <p>At he bottom of the dialog, click <strong>Close</strong>.</p>
  </li>
</ol>

<p>Leave the IoT portal open in your browser, waiting as it is.</p>

<h3 id="exercise-4-create-a-free-azure-maps-account">Exercise 4: Create a free Azure Maps account</h3>

<p>If you do not already have an Azure Maps account, you will need to create one.</p>

<ol>
  <li>
    <p>Open a new browser tab, and then navigate to <a href="https://azure.microsoft.com/services/azure-maps/?azure-portal=true">Azure Maps</a>.</p>
  </li>
  <li>
    <p>To create a free account, in the upper right corner, click <strong>Start free</strong>, and then follow the instructions provided.</p>

    <blockquote>
      <p><strong>Note</strong>: You can use the Subscription and Resource Group that you have been using for this course to create your Azure Maps account, and use AZ-220-MAPS for the name of the Account, and Standard S1 for the pricing tier.</p>
    </blockquote>
  </li>
  <li>
    <p>Once your Azure Maps account is created, copy the Azure Maps account subscription key (Primary Key) to the Truck-connections.txt text file.</p>

    <p>If you used the Azure Subscription that you are using for this course to create your Azure Maps account, you can find the Primary Key for the account in the Azure portal as follows: Open the Azure Maps (AZ-220-MAPS) blade, then open the Authentication pane. You will see the the Primary Key listed.</p>

    <blockquote>
      <p><strong>Note</strong>: If you want to verify that your Primary Key (for Azure Maps) is correct/working. Save the following HTML to an .html file. Replace the <code>'&lt;your Azure Maps subscription key&gt;'</code> placeholder with the value of your Primary Key, and then load the file into a web browser. You should see a map of the world displayed.</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-html hljs xml"> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span>
 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>

 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Map<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span></span></span><span class="hljs-tag">&gt;</span></span>

     <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Add references to the Azure Maps Map control JavaScript and CSS files. --&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>

     <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Add a reference to the Azure Maps Services lab JavaScript file. --&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas-service.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>

     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript">
         </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">GetMap</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{
             </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//Instantiate a map object</span></span></span><span class="javascript">
             </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> map = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> atlas.Map(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"myMap"</span></span></span><span class="javascript">, {
                 </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps</span></span></span><span class="javascript">
                 authOptions: {
                     </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">authType</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'subscriptionKey'</span></span></span><span class="javascript">,
                     </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">subscriptionKey</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'&lt;your Azure Maps subscription key&gt;'</span></span></span><span class="javascript">
                 }
             });
         }
     </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css">
         </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">html</span></span></span><span class="css">,
         </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css"> {
             </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">;
             </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">;
             </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;
             </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">;
         }

         </span><span class="hljs-selector-id"><span class="css"><span class="hljs-selector-id">#myMap</span></span></span><span class="css"> {
             </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">;
             </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">: </span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">;
         }
     </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span>
 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span>

 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"GetMap()"</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myMap"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span>
 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>

 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>
</code></pre>
  </li>
</ol>

<p>You’ve now completed the preparatory steps of connecting your first IoT Central app to real devices. Good work!</p>

<p>The next step is to create the device app.</p>

<h3 id="exercise-5-create-a-programming-project-for-a-real-device">Exercise 5: Create a Programming Project for a Real Device</h3>

<p>In this task, you are going to create a programming project to simulate a sensor device in a refrigerated truck. This simulation enables you to test the code long before requiring a physical device.</p>

<p>IoT Central treats this simulation as “real” because the communication code between the device app and the IoT Central app is the same as it would be for a physical device/truck. In other words, if you do run a refrigerated truck company, you would start with simulated code similar to the code in this task. After you verify that the code works to your satisfaction, the simulation-specific code would be replaced with code that receives sensor data. This limited update makes writing the following code a valuable experience.</p>

<h4 id="task-1-create-the-device-app">Task 1: Create the device app</h4>

<p>Using Visual Studio Code, build the device sensor app.</p>

<ol>
  <li>
    <p>Open a new instance of Visual Studio Code.</p>
  </li>
  <li>
    <p>On the <strong>File</strong> menu, click <strong>Open Folder</strong>.</p>
  </li>
  <li>
    <p>At the top of the <strong>Open Folder</strong> dialog, click <strong>New folder</strong>, type <strong>RefrigeratedTruck</strong> and then press <strong>Enter</strong>.</p>

    <p>You can create the RefrigeratedTruck folder under the Lab 20 folder for this course, or another location of your choice.</p>
  </li>
  <li>
    <p>Click <strong>RefrigeratedTruck</strong>, and then click <strong>Select Folder</strong>.</p>

    <p>The Visual Studio Code EXPLORER pane should now be open.</p>
  </li>
  <li>
    <p>On the <strong>View</strong> menu, to open the integrated terminal, click <strong>Terminal</strong>.</p>

    <p>You should see RefrigeratedTruck folder listed in terminal command prompt. This is important because the following commands will run in the current folder.</p>
  </li>
  <li>
    <p>At the Terminal command prompt, to create a new console app, enter the following command:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-cmd/sh"> dotnet new console
</code></pre>

    <p>This command creates a Program.cs file in your folder, along with a project file.</p>
  </li>
  <li>
    <p>At the Terminal command prompt, to ensure that your app has access to required .NET packages, enter the following command:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-cmd/sh"> dotnet restore
</code></pre>
  </li>
  <li>
    <p>At the Terminal command prompt, to install the required libraries, enter the following commands:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-CLI"> dotnet add package AzureMapsRestToolkit
 dotnet add package Microsoft.Azure.Devices.Client
 dotnet add package Microsoft.Azure.Devices.Provisioning.Client
 dotnet add package Microsoft.Azure.Devices.Provisioning.Transport.Mqtt
 dotnet add package System.Text.Json
</code></pre>
  </li>
  <li>
    <p>In the <strong>EXPLORER</strong> pane, click <strong>Program.cs</strong></p>
  </li>
  <li>
    <p>In the code editor pane, delete the contents of the Program.cs file.</p>
  </li>
</ol>

<p>You are now ready to add the code below.</p>

<h4 id="task-2-write-the-device-app">Task 2: Write the device app</h4>

<p>In this task, you will build the simulated device app for your Refrigerated Truck one section at a time. A brief explanation for each section is provided.</p>

<p>To make this process as simple as possible, each additional section of code should be appended to the end of the file, in the order listed here.</p>

<blockquote>
  <p><strong>Note</strong>:
 If you would like to skip this task, and load all of the code into your app, then download and copy all of the contents of Program.cs into the Program.cs file of your project. If you copy this code (and replace the connection and subscription strings) then go straight to the next task, and start testing! In Lab 3 of this course, “Setup the Development Environment”, you cloned the GitHub repository containing lab resources by downloading a ZIP file and extracting the contents locally. The extracted folder structure includes the following folder path:</p>
</blockquote>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="hljs javascript">* Allfiles
  * Labs
      * <span class="hljs-number"><span class="hljs-number">20</span></span>-Build <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> IoT Central
        * Final
</code></pre>

<ol>
  <li>
    <p>In the Code Editor pane, to add the required <code>using</code> statements, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text.Json;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Client;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Shared;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Provisioning.Client;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Provisioning.Client.Transport;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> AzureMapsToolkit;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> AzureMapsToolkit.Common;
</code></pre>

    <p>These <code>using</code> statements provide easy access to resources that the code uses, such Azure IoT Central and Azure Maps.</p>
  </li>
  <li>
    <p>In the Code Editor pane, to add the namespace, class, and global variables, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">refrigerated_truck</span></span>
 {
     <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span>
     {
         <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> StateEnum
         {
             ready,
             enroute,
             delivering,
             returning,
             loading,
             dumping
         };
         <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ContentsEnum
         {
             full,
             melting,
             empty
         }
         <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> FanEnum
         {
             <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>,
             off,
             failed
         }

         <span class="hljs-comment"><span class="hljs-comment">// Azure maps service globals.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AzureMapsServices azureMapsServices;

         <span class="hljs-comment"><span class="hljs-comment">// Telemetry globals.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> intervalInMilliseconds = <span class="hljs-number"><span class="hljs-number">5000</span></span>;        <span class="hljs-comment"><span class="hljs-comment">// Time interval required by wait function.</span></span>

         <span class="hljs-comment"><span class="hljs-comment">// Refrigerated truck globals.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> truckNum = <span class="hljs-number"><span class="hljs-number">1</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> truckIdentification = <span class="hljs-string"><span class="hljs-string">"Truck number "</span></span> + truckNum;

         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> deliverTime = <span class="hljs-number"><span class="hljs-number">600</span></span>;                 <span class="hljs-comment"><span class="hljs-comment">// Time to complete delivery, in seconds.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> loadingTime = <span class="hljs-number"><span class="hljs-number">800</span></span>;                 <span class="hljs-comment"><span class="hljs-comment">// Time to load contents.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dumpingTime = <span class="hljs-number"><span class="hljs-number">400</span></span>;                 <span class="hljs-comment"><span class="hljs-comment">// Time to dump melted contents.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> tooWarmThreshold = <span class="hljs-number"><span class="hljs-number">2</span></span>;              <span class="hljs-comment"><span class="hljs-comment">// Degrees C that is too warm for contents.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> tooWarmtooLong = <span class="hljs-number"><span class="hljs-number">60</span></span>;               <span class="hljs-comment"><span class="hljs-comment">// Time in seconds for contents to start melting if temps are above threshold.</span></span>


         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;            <span class="hljs-comment"><span class="hljs-comment">// Time on current task in seconds.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> interval = <span class="hljs-number"><span class="hljs-number">60</span></span>;                    <span class="hljs-comment"><span class="hljs-comment">// Simulated time interval in seconds.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> tooWarmPeriod = <span class="hljs-number"><span class="hljs-number">0</span></span>;                <span class="hljs-comment"><span class="hljs-comment">// Time that contents are too warm in seconds.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> tempContents = <span class="hljs-number"><span class="hljs-number">-2</span></span>;                <span class="hljs-comment"><span class="hljs-comment">// Current temp of contents in degrees C.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> baseLat = <span class="hljs-number"><span class="hljs-number">47.644702</span></span>;              <span class="hljs-comment"><span class="hljs-comment">// Base position latitude.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> baseLon = <span class="hljs-number"><span class="hljs-number">-122.130137</span></span>;            <span class="hljs-comment"><span class="hljs-comment">// Base position longitude.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> currentLat;                       <span class="hljs-comment"><span class="hljs-comment">// Current position latitude.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> currentLon;                       <span class="hljs-comment"><span class="hljs-comment">// Current position longitude.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> destinationLat;                   <span class="hljs-comment"><span class="hljs-comment">// Destination position latitude.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> destinationLon;                   <span class="hljs-comment"><span class="hljs-comment">// Destination position longitude.</span></span>

         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> FanEnum fan = FanEnum.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;                <span class="hljs-comment"><span class="hljs-comment">// Cooling fan state.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ContentsEnum contents = ContentsEnum.full;    <span class="hljs-comment"><span class="hljs-comment">// Truck contents state.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> StateEnum state = StateEnum.ready;       <span class="hljs-comment"><span class="hljs-comment">// Truck is full and ready to go!</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> optimalTemperature = <span class="hljs-number"><span class="hljs-number">-5</span></span>;         <span class="hljs-comment"><span class="hljs-comment">// Setting - can be changed by the operator from IoT Central.</span></span>

         <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> noEvent = <span class="hljs-string"><span class="hljs-string">"none"</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> eventText = noEvent;              <span class="hljs-comment"><span class="hljs-comment">// Event text sent to IoT Central.</span></span>

         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[,] customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[,]
         {
             <span class="hljs-comment"><span class="hljs-comment">// Lat/lon position of customers.</span></span>
             <span class="hljs-comment"><span class="hljs-comment">// Gasworks Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.645892</span></span>, <span class="hljs-number"><span class="hljs-number">-122.336954</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Golden Gardens Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.688741</span></span>, <span class="hljs-number"><span class="hljs-number">-122.402965</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Seward Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.551093</span></span>, <span class="hljs-number"><span class="hljs-number">-122.249266</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Lake Sammamish Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.555698</span></span>, <span class="hljs-number"><span class="hljs-number">-122.065996</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Marymoor Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.663747</span></span>, <span class="hljs-number"><span class="hljs-number">-122.120879</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Meadowdale Beach Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.857295</span></span>, <span class="hljs-number"><span class="hljs-number">-122.316355</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Lincoln Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.530250</span></span>, <span class="hljs-number"><span class="hljs-number">-122.393055</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Gene Coulon Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.503266</span></span>, <span class="hljs-number"><span class="hljs-number">-122.200194</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Luther Bank Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.591094</span></span>, <span class="hljs-number"><span class="hljs-number">-122.226833</span></span>},

             <span class="hljs-comment"><span class="hljs-comment">// Pioneer Park</span></span>
             {<span class="hljs-number"><span class="hljs-number">47.544120</span></span>, <span class="hljs-number"><span class="hljs-number">-122.221673</span></span> }
         };

         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[,] path;                          <span class="hljs-comment"><span class="hljs-comment">// Lat/lon steps for the route.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[] timeOnPath;                     <span class="hljs-comment"><span class="hljs-comment">// Time in seconds for each section of the route.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> truckOnSection;                      <span class="hljs-comment"><span class="hljs-comment">// The current path section the truck is on.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> truckSectionsCompletedTime;       <span class="hljs-comment"><span class="hljs-comment">// The time the truck has spent on previous completed sections.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Random rand;

         <span class="hljs-comment"><span class="hljs-comment">// IoT Central global variables.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DeviceClient s_deviceClient;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> CancellationTokenSource cts;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GlobalDeviceEndpoint = <span class="hljs-string"><span class="hljs-string">"global.azure-devices-provisioning.net"</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TwinCollection reportedProperties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TwinCollection();

         <span class="hljs-comment"><span class="hljs-comment">// User IDs.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ScopeID = <span class="hljs-string"><span class="hljs-string">"&lt;your Scope ID&gt;"</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DeviceID = <span class="hljs-string"><span class="hljs-string">"&lt;your Device ID&gt;"</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PrimaryKey = <span class="hljs-string"><span class="hljs-string">"&lt;your device Primary Key&gt;"</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AzureMapsKey = <span class="hljs-string"><span class="hljs-string">"&lt;your Azure Maps Subscription Key&gt;"</span></span>;
</code></pre>

    <p>Although there is more code to add, now is a good time to replace the placeholder values that you just entered. They should all be available in the text file that you have been adding to during the lab.</p>
  </li>
  <li>
    <p>Open the text file containing the RefrigeratorTruck1 and Azure Maps Account information that you saved previously.</p>
  </li>
  <li>
    <p>In the Code Editor pane, replace the placeholder values with the corresponding values from your text file.</p>

    <p>With these values updated in your code, you can get back to building the app.</p>
  </li>
  <li>
    <p>In the Code Editor pane, to add the methods that will be used to get a route via Azure Maps, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-cs hljs">         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Degrees2Radians</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> deg</span></span></span><span class="hljs-function">)
         </span></span>{
             <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deg * Math.PI / <span class="hljs-number"><span class="hljs-number">180</span></span>;
         }

         <span class="hljs-comment"><span class="hljs-comment">// Returns the distance in meters between two locations on Earth.</span></span>
         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DistanceInMeters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lat1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lon1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lat2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lon2</span></span></span><span class="hljs-function">)
         </span></span>{
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dlon = Degrees2Radians(lon2 - lon1);
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dlat = Degrees2Radians(lat2 - lat1);

             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = (Math.Sin(dlat / <span class="hljs-number"><span class="hljs-number">2</span></span>) * Math.Sin(dlat / <span class="hljs-number"><span class="hljs-number">2</span></span>)) + Math.Cos(Degrees2Radians(lat1)) * Math.Cos(Degrees2Radians(lat2)) * (Math.Sin(dlon / <span class="hljs-number"><span class="hljs-number">2</span></span>) * Math.Sin(dlon / <span class="hljs-number"><span class="hljs-number">2</span></span>));
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> angle = <span class="hljs-number"><span class="hljs-number">2</span></span> * Math.Atan2(Math.Sqrt(a), Math.Sqrt(<span class="hljs-number"><span class="hljs-number">1</span></span> - a));
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meters = angle * <span class="hljs-number"><span class="hljs-number">6371000</span></span>;
             <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> meters;
         }

         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Arrived</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
         </span></span>{
             <span class="hljs-comment"><span class="hljs-comment">// If the truck is within 10 meters of the destination, call it good.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DistanceInMeters(currentLat, currentLon, destinationLat, destinationLon) &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>)
                 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
             <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
         }

         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdatePosition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
         </span></span>{
             <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((truckSectionsCompletedTime + timeOnPath[truckOnSection] &lt; timeOnCurrentTask) &amp;&amp; (truckOnSection &lt; timeOnPath.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>))
             {
                 <span class="hljs-comment"><span class="hljs-comment">// Truck has moved onto the next section.</span></span>
                 truckSectionsCompletedTime += timeOnPath[truckOnSection];
                 ++truckOnSection;
             }

             <span class="hljs-comment"><span class="hljs-comment">// Ensure remainder is 0 to 1, as interval may take count over what is needed.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> remainderFraction = Math.Min(<span class="hljs-number"><span class="hljs-number">1</span></span>, (timeOnCurrentTask - truckSectionsCompletedTime) / timeOnPath[truckOnSection]);

             <span class="hljs-comment"><span class="hljs-comment">// The path should be one entry longer than the timeOnPath array.</span></span>
             <span class="hljs-comment"><span class="hljs-comment">// Find how far along the section the truck has moved.</span></span>
             currentLat = path[truckOnSection, <span class="hljs-number"><span class="hljs-number">0</span></span>] + remainderFraction * (path[truckOnSection + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>] - path[truckOnSection, <span class="hljs-number"><span class="hljs-number">0</span></span>]);
             currentLon = path[truckOnSection, <span class="hljs-number"><span class="hljs-number">1</span></span>] + remainderFraction * (path[truckOnSection + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>] - path[truckOnSection, <span class="hljs-number"><span class="hljs-number">1</span></span>]);
         }

         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRoute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StateEnum newState</span></span></span><span class="hljs-function">)
         </span></span>{
             <span class="hljs-comment"><span class="hljs-comment">// Set the state to ready, until the new route arrives.</span></span>
             state = StateEnum.ready;

             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteRequestDirections
             {
                 Query = FormattableString.Invariant(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{currentLat}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{currentLon}</span></span></span><span class="hljs-string">:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{destinationLat}</span></span></span><span class="hljs-string">,</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{destinationLon}</span></span></span><span class="hljs-string">"</span></span>)
             };
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> directions = azureMapsServices.GetRouteDirections(req).Result;

             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (directions.Error != <span class="hljs-literal"><span class="hljs-literal">null</span></span> || directions.Result == <span class="hljs-literal"><span class="hljs-literal">null</span></span>)
             {
                 <span class="hljs-comment"><span class="hljs-comment">// Handle any error.</span></span>
                 redMessage(<span class="hljs-string"><span class="hljs-string">"Failed to find map route"</span></span>);
             }
             <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
             {
                 <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nPoints = directions.Result.Routes[<span class="hljs-number"><span class="hljs-number">0</span></span>].Legs[<span class="hljs-number"><span class="hljs-number">0</span></span>].Points.Length;
                 greenMessage(<span class="hljs-string"><span class="hljs-string">$"Route found. Number of points = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{nPoints}</span></span></span><span class="hljs-string">"</span></span>);

                 <span class="hljs-comment"><span class="hljs-comment">// Clear the path. Add two points for the start point and destination.</span></span>
                 path = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[nPoints + <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>];
                 <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>;

                 <span class="hljs-comment"><span class="hljs-comment">// Start with the current location.</span></span>
                 path[c, <span class="hljs-number"><span class="hljs-number">0</span></span>] = currentLat;
                 path[c, <span class="hljs-number"><span class="hljs-number">1</span></span>] = currentLon;
                 ++c;

                 <span class="hljs-comment"><span class="hljs-comment">// Retrieve the route and push the points onto the array.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; nPoints; n++)
                 {
                     <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = directions.Result.Routes[<span class="hljs-number"><span class="hljs-number">0</span></span>].Legs[<span class="hljs-number"><span class="hljs-number">0</span></span>].Points[n].Latitude;
                     <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = directions.Result.Routes[<span class="hljs-number"><span class="hljs-number">0</span></span>].Legs[<span class="hljs-number"><span class="hljs-number">0</span></span>].Points[n].Longitude;
                     path[c, <span class="hljs-number"><span class="hljs-number">0</span></span>] = x;
                     path[c, <span class="hljs-number"><span class="hljs-number">1</span></span>] = y;
                     ++c;
                 }

                 <span class="hljs-comment"><span class="hljs-comment">// Finish with the destination.</span></span>
                 path[c, <span class="hljs-number"><span class="hljs-number">0</span></span>] = destinationLat;
                 path[c, <span class="hljs-number"><span class="hljs-number">1</span></span>] = destinationLon;

                 <span class="hljs-comment"><span class="hljs-comment">// Store the path length and time taken, to calculate the average speed.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meters = directions.Result.Routes[<span class="hljs-number"><span class="hljs-number">0</span></span>].Summary.LengthInMeters;
                 <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> seconds = directions.Result.Routes[<span class="hljs-number"><span class="hljs-number">0</span></span>].Summary.TravelTimeInSeconds;
                 <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pathSpeed = meters / seconds;

                 <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> distanceApartInMeters;
                 <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> timeForOneSection;

                 <span class="hljs-comment"><span class="hljs-comment">// Clear the time on path array. The path array is 1 less than the points array.</span></span>
                 timeOnPath = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[nPoints + <span class="hljs-number"><span class="hljs-number">1</span></span>];

                 <span class="hljs-comment"><span class="hljs-comment">// Calculate how much time is required for each section of the path.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-number"><span class="hljs-number">0</span></span>; t &lt; nPoints + <span class="hljs-number"><span class="hljs-number">1</span></span>; t++)
                 {
                     <span class="hljs-comment"><span class="hljs-comment">// Calculate distance between the two path points, in meters.</span></span>
                     distanceApartInMeters = DistanceInMeters(path[t, <span class="hljs-number"><span class="hljs-number">0</span></span>], path[t, <span class="hljs-number"><span class="hljs-number">1</span></span>], path[t + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>], path[t + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>]);

                     <span class="hljs-comment"><span class="hljs-comment">// Calculate the time for each section of the path.</span></span>
                     timeForOneSection = distanceApartInMeters / pathSpeed;
                     timeOnPath[t] = timeForOneSection;
                 }
                 truckOnSection = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                 truckSectionsCompletedTime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                 timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;

                 <span class="hljs-comment"><span class="hljs-comment">// Update the state now the route has arrived. One of: enroute or returning.</span></span>
                 state = newState;
             }
         }
</code></pre>

    <blockquote>
      <p><strong>Note</strong>:
The key call within the code above is <code>var directions = azureMapsServices.GetRouteDirections(req).Result;</code>. The <code>directions</code> structure is complex. Consider setting a breakpoint in this method, and examining the contents of <code>directions</code>.</p>
    </blockquote>
  </li>
  <li>
    <p>In the Code Editor pane, to add the direct method to deliver to a customer, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-cs hljs">     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;MethodResponse&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CmdGoToCustomer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodRequest methodRequest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userContext</span></span></span><span class="hljs-function">)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>
         {
             <span class="hljs-comment"><span class="hljs-comment">// Pick up variables from the request payload, with the name specified in IoT Central.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payloadString = Encoding.UTF8.GetString(methodRequest.Data);
             <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> customerNumber = Int32.Parse(payloadString);

             <span class="hljs-comment"><span class="hljs-comment">// Check for a valid key and customer ID.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (customerNumber &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; customerNumber &lt; customer.Length)
             {
                 <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (state)
                 {
                     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.dumping:
                     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.loading:
                     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.delivering:
                         eventText = <span class="hljs-string"><span class="hljs-string">"Unable to act - "</span></span> + state;
                         <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

                     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.ready:
                     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.enroute:
                     <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.returning:
                         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (contents == ContentsEnum.empty)
                         {
                             eventText = <span class="hljs-string"><span class="hljs-string">"Unable to act - empty"</span></span>;
                         }
                         <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                         {
                             <span class="hljs-comment"><span class="hljs-comment">// Set event only when all is good.</span></span>
                             eventText = <span class="hljs-string"><span class="hljs-string">"New customer: "</span></span> + customerNumber.ToString();

                             destinationLat = customer[customerNumber, <span class="hljs-number"><span class="hljs-number">0</span></span>];
                             destinationLon = customer[customerNumber, <span class="hljs-number"><span class="hljs-number">1</span></span>];

                             <span class="hljs-comment"><span class="hljs-comment">// Find route from current position to destination, storing route.</span></span>
                             GetRoute(StateEnum.enroute);
                         }
                         <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
                 }

                 <span class="hljs-comment"><span class="hljs-comment">// Acknowledge the direct method call with a 200 success message.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = <span class="hljs-string"><span class="hljs-string">"{\"result\":\"Executed direct method: "</span></span> + methodRequest.Name + <span class="hljs-string"><span class="hljs-string">"\"}"</span></span>;
                 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodResponse(Encoding.UTF8.GetBytes(result), <span class="hljs-number"><span class="hljs-number">200</span></span>));
             }
             <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
             {
                 eventText = <span class="hljs-string"><span class="hljs-string">$"Invalid customer: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{customerNumber}</span></span></span><span class="hljs-string">"</span></span>;

                 <span class="hljs-comment"><span class="hljs-comment">// Acknowledge the direct method call with a 400 error message.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = <span class="hljs-string"><span class="hljs-string">"{\"result\":\"Invalid customer\"}"</span></span>;
                 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodResponse(Encoding.UTF8.GetBytes(result), <span class="hljs-number"><span class="hljs-number">400</span></span>));
             }
         }
         <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>
         {
             <span class="hljs-comment"><span class="hljs-comment">// Acknowledge the direct method call with a 400 error message.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = <span class="hljs-string"><span class="hljs-string">"{\"result\":\"Invalid call\"}"</span></span>;
             <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodResponse(Encoding.UTF8.GetBytes(result), <span class="hljs-number"><span class="hljs-number">400</span></span>));
         }
     }
</code></pre>

    <blockquote>
      <p><strong>Note</strong>:
The device responds with a conflict, if the device isn’t in the correct state. The command itself is acknowledged at the end of the method. The recall command that follows in the next step handles things similarly.</p>
    </blockquote>
  </li>
  <li>
    <p>In the Code Editor pane, to add the recall direct method, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-cs hljs">     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReturnToBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
     </span></span>{
         destinationLat = baseLat;
         destinationLon = baseLon;

         <span class="hljs-comment"><span class="hljs-comment">// Find route from current position to base, storing route.</span></span>
         GetRoute(StateEnum.returning);
     }
     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Task&lt;MethodResponse&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CmdRecall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodRequest methodRequest, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userContext</span></span></span><span class="hljs-function">)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (state)
         {
             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.ready:
             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.loading:
             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.dumping:
                 eventText = <span class="hljs-string"><span class="hljs-string">"Already at base"</span></span>;
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.returning:
                 eventText = <span class="hljs-string"><span class="hljs-string">"Already returning"</span></span>;
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.delivering:
                 eventText = <span class="hljs-string"><span class="hljs-string">"Unable to recall - "</span></span> + state;
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.enroute:
                 ReturnToBase();
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
         }

         <span class="hljs-comment"><span class="hljs-comment">// Acknowledge the command.</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventText == noEvent)
         {
             <span class="hljs-comment"><span class="hljs-comment">// Acknowledge the direct method call with a 200 success message.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = <span class="hljs-string"><span class="hljs-string">"{\"result\":\"Executed direct method: "</span></span> + methodRequest.Name + <span class="hljs-string"><span class="hljs-string">"\"}"</span></span>;
             <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodResponse(Encoding.UTF8.GetBytes(result), <span class="hljs-number"><span class="hljs-number">200</span></span>));
         }
         <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
         {
             <span class="hljs-comment"><span class="hljs-comment">// Acknowledge the direct method call with a 400 error message.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = <span class="hljs-string"><span class="hljs-string">"{\"result\":\"Invalid call\"}"</span></span>;
             <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MethodResponse(Encoding.UTF8.GetBytes(result), <span class="hljs-number"><span class="hljs-number">400</span></span>));
         }
     }
</code></pre>
  </li>
  <li>
    <p>In the Code Editor pane, to add the method that updates the truck simulation at each time interval, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-cs hljs">     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DieRoll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> max</span></span></span><span class="hljs-function">)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand.NextDouble() * max;
     }

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateTruck</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (contents == ContentsEnum.empty)
         {
             <span class="hljs-comment"><span class="hljs-comment">// Turn the cooling system off, if possible, when the contents are empty.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan == FanEnum.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>)
             {
                 fan = FanEnum.off;
             }
             tempContents += <span class="hljs-number"><span class="hljs-number">-2.9</span></span> + DieRoll(<span class="hljs-number"><span class="hljs-number">6</span></span>);
         }
         <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
         {
             <span class="hljs-comment"><span class="hljs-comment">// Contents are full or melting.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan != FanEnum.failed)
             {
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempContents &lt; optimalTemperature - <span class="hljs-number"><span class="hljs-number">5</span></span>)
                 {
                     <span class="hljs-comment"><span class="hljs-comment">// Turn the cooling system off, as contents are getting too cold.</span></span>
                     fan = FanEnum.off;
                 }
                 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                 {
                     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempContents &gt; optimalTemperature)
                     {
                         <span class="hljs-comment"><span class="hljs-comment">// Temp getting higher, turn cooling system back on.</span></span>
                         fan = FanEnum.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;
                     }
                 }

                 <span class="hljs-comment"><span class="hljs-comment">// Randomly fail the cooling system.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DieRoll(<span class="hljs-number"><span class="hljs-number">100</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>)
                 {
                     fan = FanEnum.failed;
                 }
             }

             <span class="hljs-comment"><span class="hljs-comment">// Set the contents temperature. Maintaining a cooler temperature if the cooling system is on.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fan == FanEnum.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>)
             {
                 tempContents += <span class="hljs-number"><span class="hljs-number">-3</span></span> + DieRoll(<span class="hljs-number"><span class="hljs-number">5</span></span>);
             }
             <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
             {
                 tempContents += <span class="hljs-number"><span class="hljs-number">-2.9</span></span> + DieRoll(<span class="hljs-number"><span class="hljs-number">6</span></span>);
             }

             <span class="hljs-comment"><span class="hljs-comment">// If the temperature is above a threshold, count the seconds this is occurring, and melt the contents if it goes on too long.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempContents &gt;= tooWarmThreshold)
             {
                 <span class="hljs-comment"><span class="hljs-comment">// Contents are warming.</span></span>
                 tooWarmPeriod += interval;

                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tooWarmPeriod &gt;= tooWarmtooLong)
                 {
                     <span class="hljs-comment"><span class="hljs-comment">// Contents are melting.</span></span>
                     contents = ContentsEnum.melting;
                 }
             }
             <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
             {
                 <span class="hljs-comment"><span class="hljs-comment">// Contents are cooling.</span></span>
                 tooWarmPeriod = Math.Max(<span class="hljs-number"><span class="hljs-number">0</span></span>, tooWarmPeriod - interval);
             }
         }

         timeOnCurrentTask += interval;

         <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (state)
         {
             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.loading:
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeOnCurrentTask &gt;= loadingTime)
                 {
                     <span class="hljs-comment"><span class="hljs-comment">// Finished loading.</span></span>
                     state = StateEnum.ready;
                     contents = ContentsEnum.full;
                     timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;

                     <span class="hljs-comment"><span class="hljs-comment">// Turn on the cooling fan.</span></span>
                     <span class="hljs-comment"><span class="hljs-comment">// If the fan is in a failed state, assume it has been fixed, as it is at the base.</span></span>
                     fan = FanEnum.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;
                     tempContents = <span class="hljs-number"><span class="hljs-number">-2</span></span>;
                 }
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.ready:
                 timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.delivering:
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeOnCurrentTask &gt;= deliverTime)
                 {
                     <span class="hljs-comment"><span class="hljs-comment">// Finished delivering.</span></span>
                     contents = ContentsEnum.empty;
                     ReturnToBase();
                 }
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.returning:

                 <span class="hljs-comment"><span class="hljs-comment">// Update the truck position.</span></span>
                 UpdatePosition();

                 <span class="hljs-comment"><span class="hljs-comment">// Check to see if the truck has arrived back at base.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Arrived())
                 {
                     <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (contents)
                     {
                         <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ContentsEnum.empty:
                             state = StateEnum.loading;
                             <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

                         <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ContentsEnum.full:
                             state = StateEnum.ready;
                             <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

                         <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ContentsEnum.melting:
                             state = StateEnum.dumping;
                             <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
                     }
                     timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                 }
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.enroute:

                 <span class="hljs-comment"><span class="hljs-comment">// Move the truck.</span></span>
                 UpdatePosition();

                 <span class="hljs-comment"><span class="hljs-comment">// Check to see if the truck has arrived at the customer.</span></span>
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Arrived())
                 {
                     state = StateEnum.delivering;
                     timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                 }
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;

             <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> StateEnum.dumping:
                 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (timeOnCurrentTask &gt;= dumpingTime)
                 {
                     <span class="hljs-comment"><span class="hljs-comment">// Finished dumping.</span></span>
                     state = StateEnum.loading;
                     contents = ContentsEnum.empty;
                     timeOnCurrentTask = <span class="hljs-number"><span class="hljs-number">0</span></span>;
                 }
                 <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
         }
     }
</code></pre>

    <blockquote>
      <p><strong>Note</strong>:
This function is called every time interval. The actual time interval is set at 5 seconds, though the <em>simulated time</em> (the number of simulated seconds you specify that has passed each time this function is called) is set by the global <code>static double interval = 60</code>. Setting this value at 60 means the simulation runs at a rate of 60 divided by 5, or 12 times real time. To lower the simulated time, reduce <code>interval</code> to, say, 30 (for a simulation that runs at six times real-time). Setting <code>interval</code> at 5 would run the simulation in real-time. Though realistic, this speed would be a bit slow, given the real driving times to the customer destinations.</p>
    </blockquote>
  </li>
  <li>
    <p>In the Code Editor pane, to add the methods that will send truck telemetry (and send events too, if any have occurred), enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="language-cs hljs">     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">colorMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text, ConsoleColor clr</span></span></span><span class="hljs-function">)
     </span></span>{
         Console.ForegroundColor = clr;
         Console.WriteLine(text);
         Console.ResetColor();
     }
     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">greenMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)
     </span></span>{
         colorMessage(text, ConsoleColor.Green);
     }

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> text</span></span></span><span class="hljs-function">)
     </span></span>{
         colorMessage(text, ConsoleColor.Red);
     }

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendTruckTelemetryAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Random rand, CancellationToken token</span></span></span><span class="hljs-function">)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>)
         {
             UpdateTruck();

             <span class="hljs-comment"><span class="hljs-comment">// Create the telemetry JSON message.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> telemetryDataPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>
             {
                 ContentsTemperature = Math.Round(tempContents, <span class="hljs-number"><span class="hljs-number">2</span></span>),
                 TruckState = state.ToString(),
                 CoolingSystemState = fan.ToString(),
                 ContentsState = contents.ToString(),
                 Location = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { lon = currentLon, lat = currentLat },
                 Event = eventText,
             };
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> telemetryMessageString = JsonSerializer.Serialize(telemetryDataPoint);
             <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> telemetryMessage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Message(Encoding.ASCII.GetBytes(telemetryMessageString));

             <span class="hljs-comment"><span class="hljs-comment">// Clear the events, as the message has been sent.</span></span>
             eventText = noEvent;

             Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"\nTelemetry data: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{telemetryMessageString}</span></span></span><span class="hljs-string">"</span></span>);

             <span class="hljs-comment"><span class="hljs-comment">// Bail if requested.</span></span>
             token.ThrowIfCancellationRequested();

             <span class="hljs-comment"><span class="hljs-comment">// Send the telemetry message.</span></span>
             <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> s_deviceClient.SendEventAsync(telemetryMessage);
             greenMessage(<span class="hljs-string"><span class="hljs-string">$"Telemetry sent </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{DateTime.Now.ToShortTimeString()}</span></span></span><span class="hljs-string">"</span></span>);

             <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Delay(intervalInMilliseconds);
         }
     }
</code></pre>

    <blockquote>
      <p><strong>Note</strong>:
The <code>SendTruckTelemetryAsync</code> is an important function, handling the sending of telemetry, states, and events to IoT Central. Note the use of JSON strings to send the data.</p>
    </blockquote>
  </li>
  <li>
    <p>In the Code Editor pane, to add the code that will handle settings and properties, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="language-cs hljs">     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendDevicePropertiesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
     </span></span>{
         reportedProperties[<span class="hljs-string"><span class="hljs-string">"TruckID"</span></span>] = truckIdentification;
         <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> s_deviceClient.UpdateReportedPropertiesAsync(reportedProperties);
         greenMessage(<span class="hljs-string"><span class="hljs-string">$"Sent device properties: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{JsonSerializer.Serialize(reportedProperties)}</span></span></span><span class="hljs-string">"</span></span>);
     }
     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleSettingChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TwinCollection desiredProperties, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userContext</span></span></span><span class="hljs-function">)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> setting = <span class="hljs-string"><span class="hljs-string">"OptimalTemperature"</span></span>;
         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (desiredProperties.Contains(setting))
         {
             BuildAcknowledgement(desiredProperties, setting);
             optimalTemperature = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) desiredProperties[setting];
             greenMessage(<span class="hljs-string"><span class="hljs-string">$"Optimal temperature updated: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{optimalTemperature}</span></span></span><span class="hljs-string">"</span></span>);
         }
         <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> s_deviceClient.UpdateReportedPropertiesAsync(reportedProperties);
     }

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildAcknowledgement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TwinCollection desiredProperties, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> setting</span></span></span><span class="hljs-function">)
     </span></span>{
         reportedProperties[setting] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>
         {
             <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = desiredProperties[setting],
             status = <span class="hljs-string"><span class="hljs-string">"completed"</span></span>,
             desiredVersion = desiredProperties[<span class="hljs-string"><span class="hljs-string">"$version"</span></span>],
             message = <span class="hljs-string"><span class="hljs-string">"Processed"</span></span>
         };
     }
</code></pre>

    <p>You only have one setting and one property added to your app. If more are required, they are easily added.</p>

    <blockquote>
      <p><strong>Note</strong>:
This section of code is generic to most C# apps that communicate with IoT Central. To add additional properties or settings, add to <code>reportedProperties</code>, or create a new setting string, and check on <code>desiredProperties</code>, respectively. No other code changes are usually needed.</p>
    </blockquote>
  </li>
  <li>
    <p>In the Code Editor pane, to add the <code>Main</code> function, enter the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="language-cs hljs">         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)
         </span></span>{

             rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random();
             colorMessage(<span class="hljs-string"><span class="hljs-string">$"Starting </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{truckIdentification}</span></span></span><span class="hljs-string">"</span></span>, ConsoleColor.Yellow);
             currentLat = baseLat;
             currentLon = baseLon;

             <span class="hljs-comment"><span class="hljs-comment">// Connect to Azure Maps.</span></span>
             azureMapsServices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AzureMapsServices(AzureMapsKey);

             <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>
             {
                 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> security = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecurityProviderSymmetricKey(DeviceID, PrimaryKey, <span class="hljs-literal"><span class="hljs-literal">null</span></span>))
                 {
                     DeviceRegistrationResult result = RegisterDeviceAsync(security).GetAwaiter().GetResult();
                     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Status != ProvisioningRegistrationStatusType.Assigned)
                     {
                         Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Failed to register device"</span></span>);
                         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;
                     }
                     IAuthenticationMethod auth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeviceAuthenticationWithRegistrySymmetricKey(result.DeviceId, (security <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SecurityProviderSymmetricKey).GetPrimaryKey());
                     s_deviceClient = DeviceClient.Create(result.AssignedHub, auth, TransportType.Mqtt);
                 }
                 greenMessage(<span class="hljs-string"><span class="hljs-string">"Device successfully connected to Azure IoT Central"</span></span>);

                 SendDevicePropertiesAsync().GetAwaiter().GetResult();

                 Console.Write(<span class="hljs-string"><span class="hljs-string">"Register settings changed handler..."</span></span>);
                 s_deviceClient.SetDesiredPropertyUpdateCallbackAsync(HandleSettingChanged, <span class="hljs-literal"><span class="hljs-literal">null</span></span>).GetAwaiter().GetResult();
                 Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Done"</span></span>);

                 cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource();

                 <span class="hljs-comment"><span class="hljs-comment">// Create a handler for the direct method calls.</span></span>
                 s_deviceClient.SetMethodHandlerAsync(<span class="hljs-string"><span class="hljs-string">"GoToCustomer"</span></span>, CmdGoToCustomer, <span class="hljs-literal"><span class="hljs-literal">null</span></span>).Wait();
                 s_deviceClient.SetMethodHandlerAsync(<span class="hljs-string"><span class="hljs-string">"Recall"</span></span>, CmdRecall, <span class="hljs-literal"><span class="hljs-literal">null</span></span>).Wait();

                 SendTruckTelemetryAsync(rand, cts.Token);

                 Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Press any key to exit..."</span></span>);
                 Console.ReadKey();
                 cts.Cancel();
             }
             <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex)
             {
                 Console.WriteLine();
                 Console.WriteLine(ex.Message);
             }
         }


         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;DeviceRegistrationResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterDeviceAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SecurityProviderSymmetricKey security</span></span></span><span class="hljs-function">)
         </span></span>{
             Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Register device..."</span></span>);

             <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transport = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProvisioningTransportHandlerMqtt(TransportFallbackType.TcpOnly))
             {
                 ProvisioningDeviceClient provClient =
                           ProvisioningDeviceClient.Create(GlobalDeviceEndpoint, ScopeID, security, transport);

                 Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"RegistrationID = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{security.GetRegistrationID()}</span></span></span><span class="hljs-string">"</span></span>);

                 Console.Write(<span class="hljs-string"><span class="hljs-string">"ProvisioningClient RegisterAsync..."</span></span>);
                 DeviceRegistrationResult result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> provClient.RegisterAsync();

                 Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{result.Status}</span></span></span><span class="hljs-string">"</span></span>);

                 <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;
             }
         }
     }
 }
</code></pre>

    <blockquote>
      <p><strong>Note</strong>:
Direct methods are set in the client using statements such as <code>s_deviceClient.SetMethodHandlerAsync("cmdGoTo", CmdGoToCustomer, null).Wait();</code>.</p>
    </blockquote>
  </li>
  <li>
    <p>On the <strong>File</strong> menu, click <strong>Save</strong>.</p>

    <p>With your simulated device app complete, you can now start thinking about testing your code.</p>
  </li>
</ol>

<h3 id="exercise-6-test-your-iot-central-device">Exercise 6: Test Your IoT Central Device</h3>

<p>In this exercise, you finally get to check whether all the moving parts you’ve created will work together as intended.</p>

<p>To fully test the refrigerated truck device, it helps to break down the testing into a number of discreet checks:</p>

<ul>
  <li>
    <p>The device app connects to Azure IoT Central.</p>
  </li>
  <li>
    <p>The telemetry functions send data on the specified interval.</p>
  </li>
  <li>
    <p>The data is picked up correctly by IoT Central.</p>
  </li>
  <li>
    <p>The command to send the truck to a specified customer works as expected.</p>
  </li>
  <li>
    <p>The command to recall the truck works as expected.</p>
  </li>
  <li>
    <p>Check customer and conflict events are transmitted correctly.</p>
  </li>
  <li>
    <p>Check the truck properties, and change the optimal temperature.</p>
  </li>
</ul>

<p>In addition to this list, there are edge-cases you could also investigate. One such case is what happens when the truck’s contents start to melt? This state is left up to chance in our simulation, with the use of random numbers in our code in the previous task.</p>

<h4 id="task-1-prepare-iot-central-and-your-simulated-device">Task 1: Prepare IoT Central and Your Simulated Device</h4>

<ol>
  <li>
    <p>Ensure that your Azure IoT Central app is open in a browser.</p>

    <p>Before you begin testing the connection between IoT Central and your device, ensure that your Azure IoT Central app is open in a browser. You left the app open to the Commands tab of your RefrigeratedTruck - 1 dashboard. If needed, you can reopen <a href="https://apps.azureiotcentral.com/?azure-portal=true">Azure IoT Central</a> in a browser.</p>
  </li>
  <li>
    <p>In Visual Studio Code, the Terminal command prompt, enter the following command:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="language-cmd/sh"> dotnet run
</code></pre>
  </li>
  <li>
    <p>Examine the output being sent to the Terminal pane.</p>

    <p>You should see output displayed to the Terminal console, with the text: <strong>Starting Truck number 1</strong>.</p>
  </li>
  <li>
    <p>Verify that the text: <strong>Starting Truck number 1</strong> is displayed.</p>

    <blockquote>
      <p><strong>Note</strong>: If everything is working as expected, you will be able to check off several of the defined test cases very quickly.</p>
    </blockquote>

    <p>You will continue to monitor the Terminal pane for the upcoming tasks.</p>
  </li>
</ol>

<h4 id="task-2-confirm-the-device-app-connects-to-azure-iot-central">Task 2: Confirm the device app connects to Azure IoT Central</h4>

<ol>
  <li>
    <p>Verify that <strong>Device successfully connected to Azure IoT Central</strong> appears the Terminal pane.</p>

    <p>If one of the next lines on the console is <strong>Device successfully connected to Azure IoT Central</strong> you’ve made the connection. If you do not get this message, it usually means either the IoT Central app isn’t running, or the connection key strings aren’t correct.</p>
  </li>
  <li>
    <p>Verify that the “connected” message is followed by text verifying the settings and properties were sent successfully.</p>

    <p>If all is going well, continue to the second test (Task 3).</p>
  </li>
</ol>

<h4 id="task-3-confirm-the-telemetry-functions-send-data-on-the-specified-interval">Task 3: Confirm the telemetry functions send data on the specified interval</h4>

<ol>
  <li>
    <p>Verify that telemetry data is being sent.</p>

    <p>A console message should appear every five seconds, with the contents temperature.</p>
  </li>
  <li>
    <p>Watch the telemetry for a short while, and mentally prepare for the main test of this lab!</p>
  </li>
</ol>

<h4 id="task-4-confirm-the-data-is-picked-up-correctly-by-iot-central">Task 4: Confirm the data is picked up correctly by IoT Central</h4>

<ol>
  <li>
    <p>Switch to the browser window containing your Azure IoT Central app.</p>
  </li>
  <li>
    <p>On your <strong>RefrigeratedTruck - 1</strong> dashboard, click <strong>Truck view</strong>.</p>

    <p>If your RefrigeratedTruck device is not selected in IoT Central, perform the following:</p>

    <ul>
      <li>on the left side navigation menu, click <strong>Devices</strong>.</li>
      <li>in the list of devices, double-click <strong>RefrigeratedTruck - 1</strong>.</li>
      <li>on your dashboard, ensure that <strong>Truck view</strong> is selected.</li>
    </ul>
  </li>
  <li>
    <p>Verify that data is being on your <strong>RefrigeratedTruck - 1</strong> dashboard.</p>

    <p>For example, the Truck ID tile should show “Truck number 1”, and the Truck state tile should display “ready” and a time value.</p>
  </li>
  <li>
    <p>On your dashboard, locate the <strong>Contents temperature</strong> tile.</p>

    <blockquote>
      <p><strong>Note</strong>: After a period of generally acceptable temperatures (near zero degrees C), numbers will begin to cycle upward.</p>
    </blockquote>
  </li>
  <li>
    <p>Verify that the temperatures being sent by the device app match the data being shown in the telemetry view of the IoT Central app.</p>

    <p>Compare the most recent values in the Terminal pane of Visual Studio Code with the most recent values displayed on the “Contents temperature” graph.</p>
  </li>
  <li>
    <p>To verify that the truck and its contents are in the expected state, check the state tiles: <strong>Truck state</strong>, <strong>Cooling system state</strong>, and <strong>Contents state</strong>.</p>
  </li>
  <li>
    <p>Check the <strong>Location</strong> map view for the device.</p>

    <p>A blue circle near Seattle, USA shows our truck ready to go. You may have to zoom out a bit.</p>

    <p>The truck should be located at its base, in the correct state, and waiting for a command.</p>

    <p>In the next task, you will complete your app testing.</p>
  </li>
</ol>

<h4 id="task-5-confirm-the-command-to-send-the-truck-to-a-specified-customer-works-as-expected">Task 5. Confirm the command to send the truck to a specified customer works as expected</h4>

<ol>
  <li>
    <p>On your <strong>RefrigeratedTruck - 1</strong> dashboard, just below the dashboard title, click <strong>Commands</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Customer ID</strong>, enter <strong>1</strong></p>

    <p>Any value of “0” through “9” is a valid customer IDs</p>
  </li>
  <li>
    <p>To issue the command, click <strong>Run</strong>.</p>
  </li>
  <li>
    <p>Switch back to <strong>Truck view</strong>.</p>

    <p>In the console for the device app, you should both see a <strong>New customer</strong> event, and a <strong>Route found</strong> message.</p>

    <blockquote>
      <p><strong>Note</strong>:
If you see a message including the text <strong>Access denied due to invalid subscription key</strong>, then check your subscription key to Azure Maps.</p>
    </blockquote>
  </li>
  <li>
    <p>On the dashboard <strong>Location</strong> tile, verify that your truck is on its way.</p>

    <p>You might have to wait a short time for the two apps to sync up.</p>
  </li>
  <li>
    <p>Verify that event text is updating in the Event tile.</p>
  </li>
  <li>
    <p>Take a moment to watch the map update, and your truck deliver its contents.</p>
  </li>
</ol>

<h4 id="task-6-confirm-the-command-to-recall-the-truck-works-as-expected">Task 6. Confirm the command to recall the truck works as expected</h4>

<ol>
  <li>
    <p>Verify that when the truck returns to base and is reloaded with contents, that the Truck state is updated to <strong>ready</strong>.</p>

    <p>Try issuing another delivery command. Choose a different customer ID.</p>
  </li>
  <li>
    <p>Issue a recall command before the truck reaches its customer.</p>
  </li>
  <li>
    <p>Verify that the truck responds to this command.</p>
  </li>
</ol>

<h4 id="task-7-check-customer-and-conflict-events-are-transmitted-correctly">Task 7. Check customer and conflict events are transmitted correctly</h4>

<p>To test a conflict event, you can send a command that you know doesn’t make sense.</p>

<ol>
  <li>
    <p>With your truck at the base, issue a Recall command.</p>
  </li>
  <li>
    <p>Verify that the truck responds with the “already at base” event.</p>
  </li>
</ol>

<h4 id="task-8-check-the-truck-properties-and-change-the-optimal-temperature">Task 8. Check the truck properties, and change the optimal temperature</h4>

<ol>
  <li>
    <p>Verify that the <strong>Truck ID</strong> tile displays <strong>Truck number 1</strong>.</p>

    <p>This Property is on of the simplest things to test.</p>

    <p>Testing a writable property is more complex, The <strong>OptimalTemperature</strong> property is a writable property, so that will be the next test.</p>
  </li>
  <li>
    <p>On the left side navigation menu, click <strong>Jobs</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Jobs</strong>, click <strong>+ New</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Jobs</strong>, to replace <strong>Enter new job name</strong>, enter <strong>Set optimal temperature to -10</strong></p>
  </li>
  <li>
    <p>In the <strong>Device group</strong> dropdown, click <strong>RefrigeratedTruck - All devices</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Job type</strong> dropdown, click <strong>Property</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Name</strong> dropdown, click <strong>Optimal Temperature</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Value</strong> textbox, enter <strong>-10</strong></p>

    <p>When you run this job it should set the optimal temperature for all trucks in the device group, just one in our case.</p>
  </li>
  <li>
    <p>At the top of the window, click <strong>Run</strong>.</p>
  </li>
  <li>
    <p>Notice that after a short time, the <strong>Status</strong> of the job to change from <strong>Pending</strong> to <strong>Completed</strong>.</p>

    <p>This change should only take a few seconds.</p>
  </li>
  <li>
    <p>Navigate back, via <strong>Devices</strong> to your dashboard.</p>
  </li>
  <li>
    <p>Verify the <strong>Optimal temperature</strong> has been set to -10, in the <strong>Optimal Temperature</strong> tile of your dashboard.</p>
  </li>
</ol>

<p>With the testing for one truck complete, it is time to consider expanding our IoT Central system.</p>

<h3 id="exercise-7-create-multiple-devices">Exercise 7: Create multiple devices</h3>

<p>In this exercise, you will complete the steps required to add multiple trucks to your fleet.</p>

<h4 id="task-1-add-multiple-devices-to-the-iot-central-app">Task 1: Add multiple devices to the IoT Central app</h4>

<ol>
  <li>
    <p>Ensure that your IoT Central app is open.</p>

    <p>If necessary, open the <a href="https://apps.azureiotcentral.com/?azure-portal=true">Azure IoT Central</a> app</p>
  </li>
  <li>
    <p>On the left side navigation menu, click <strong>Devices</strong>.</p>
  </li>
  <li>
    <p>Under <strong>Devices</strong>, click <strong>RefrigeratedTruck</strong>.</p>

    <p>This ensures the devices you create will use this device template. The device template you select will be shown in bold text.</p>
  </li>
  <li>
    <p>Under <strong>RefrigeratedTruck</strong>, click <strong>+ New</strong>.</p>

    <p>Verify that the default device name includes the <strong>RefrigeratedTruck</strong> text. If it doesn’t, you’ve not selected the right device template.</p>
  </li>
  <li>
    <p>On the <strong>Create new device</strong> dialog, under <strong>Device ID</strong>, enter <strong>RefrigeratedTruck2</strong></p>
  </li>
  <li>
    <p>Under <strong>Device name</strong>, enter <strong>RefrigeratedTruck - 2</strong></p>
  </li>
  <li>
    <p>At the bottom of the <strong>Create new device</strong> dialog, click <strong>Create</strong>.</p>

    <p>You can repeat the process above to additional trucks if you want.</p>
  </li>
</ol>

<h4 id="task-2-provision-the-new-devices">Task 2: Provision the new devices</h4>

<ol>
  <li>
    <p>Under <strong>Device name</strong>, double-click <strong>RefrigeratedTruck - 2</strong>.</p>
  </li>
  <li>
    <p>In the top right of the page, click <strong>Connect</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Device Connection</strong> dialog, copy the <strong>Device ID</strong> and the <strong>Primary Key</strong> to your text file, noting that they are for the second truck.</p>

    <p>There is no need to copy the <strong>ID scope</strong>, as this value is identical to the value for the first truck (it identifies your app, not an individual device).</p>
  </li>
  <li>
    <p>At the bottom of the <strong>Device Connection</strong> dialog, click <strong>Close</strong>.</p>
  </li>
  <li>
    <p>Back on the <strong>Devices</strong> page, repeat the process for any other devices you created, copying their <strong>Device ID</strong> and <strong>Primary Key</strong> to your text file.</p>
  </li>
  <li>
    <p>When you have completed connecting all new trucks, notice that the <strong>Provisioning Status</strong> is still <strong>Registered</strong>.</p>

    <p>This will not change until you make the connection.</p>
  </li>
</ol>

<h4 id="task-3-create-new-apps-for-each-new-device">Task 3: Create new apps for each new device</h4>

<p>Each truck will be simulated by a separately running instance of your simulated device app. So, you need multiple versions of your app running at the same time.</p>

<ol>
  <li>
    <p>To create the new simulated device apps, repeat the <strong>Create a programming project for a real device</strong> task for each of the new trucks you created in your IoT Central app.</p>
  </li>
  <li>
    <p>Verify that you have replaced the <strong>Device ID</strong> and <strong>Primary Key</strong> with the values for the new truck.</p>

    <p>The <strong>Scope ID</strong> and <strong>Azure Maps Account Primary Key</strong> should identical for all devices.</p>
  </li>
  <li>
    <p>Remember to load the necessary libraries for each new project.</p>
  </li>
  <li>
    <p>Change the <code>truckNum</code> in each project to a different value.</p>
  </li>
  <li>
    <p>For each project, use the Terminal command <code>dotnet run</code> to start the app.</p>
  </li>
</ol>

<h4 id="task-4-verify-the-telemetry-from-all-the-devices">Task 4: Verify the telemetry from all the devices</h4>

<ol>
  <li>
    <p>Verify that the one dashboard you created works for all trucks.</p>
  </li>
  <li>
    <p>Using the dashboard for each truck, try ordering the trucks to different customers.</p>
  </li>
  <li>
    <p>Using the <strong>Location</strong> map on each dashboard, verify the trucks are heading in the right direction.</p>

    <p>Congratulations on completing the lab!</p>
  </li>
  <li>
    <p>Clean up your resources.</p>
  </li>
</ol>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-220-Microsoft-Azure-IoT-Developer" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-220-Microsoft-Azure-IoT-Developer
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../../assets/js/script_v%3Dfdcd20e7353e74116ec5bb7c4b9ad222d1bd751d.js"></script>



</body></html>