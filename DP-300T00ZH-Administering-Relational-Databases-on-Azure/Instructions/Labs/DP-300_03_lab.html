<!DOCTYPE html><html lang="en"><head>
        <title>
            DP-300T00ZH-Administering-Relational-Databases-on-Azure
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                DP-300T00ZH-Administering-Relational-Databases-on-Azure
            </a>
            <a href="https://github.com/MicrosoftLearning/DP-300T00ZH-Administering-Relational-Databases-on-Azure" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    </ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="实验室-3---实现安全环境">实验室 3 - 实现安全环境</h1>

<p><strong>预计用时</strong>： 60 分钟</p>

<p><strong>必备项</strong>： 在实验室中为模块 2 创建的 Azure SQL 服务器。订阅中的 Azure Active Directory 访问。</p>

<p><strong>实验室文件</strong>： 此实验室的文件位于“D:\Labfiles\Secure Environment”文件夹中。</p>

<h1 id="实验室概述">实验室概述</h1>

<p>学生将利用从课程中获取的信息，在 Azure 门户和 AdventureWorks 数据库中进行配置，随后实现安全性。</p>

<h1 id="实验室目标">实验室目标</h1>

<p>完成本实验室后，你将能够：</p>

<ol>
  <li>
    <p>配置 Azure SQL 数据库防火墙</p>
  </li>
  <li>
    <p>使用 Azure Active Directory 授权对 Azure SQL 数据库的访问</p>
  </li>
  <li>
    <p>管理对数据库对象的访问</p>
  </li>
</ol>

<h1 id="应用室场景">应用室场景</h1>

<p>你已被聘为高级数据库管理员，帮助确保数据库环境的安全。这些任务侧重于 Azure SQL 数据库。</p>

<p><strong>备注：</strong> 练习让你复制并粘贴 T-SQL 代码。请在执行代码前，验证代码是否正确复制并具有恰当的换行符。</p>

<h2 id="练习-1配置-azure-sql-数据库防火墙并连接到新数据库">练习 1：配置 Azure SQL 数据库防火墙并连接到新数据库</h2>

<ol>
  <li>
    <p>在实验室虚拟机中，启动浏览器会话并导航到 <a href="https://portal.azure.com/">https://portal.azure.com</a>。提供适当的凭据。</p>

    <p><a href="../images/dp-3300-module-33-lab-01.png" target="_blank"><img src="../images/dp-3300-module-33-lab-01.png" alt="手机的屏幕截图；描述自动生成"></a></p>
  </li>
  <li>
    <p>在 Azure 门户顶部的搜索栏中，键入 SQL。SQL 服务器图标将出现。单击 SQL 服务器。单击服务器名称，前往你在实验室 2 中创建的服务器的详细信息页面</p>

    <p><a href="../images/dp-3300-module-33-lab-02.png" target="_blank"><img src="../images/dp-3300-module-33-lab-02.png" alt="社交媒体帖子屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>在 SQL Server 的详细信息屏幕中，将鼠标移到服务器名称右侧，然后单击“复制到剪贴板”按钮，如下所示。</p>

    <p><a href="../images/dp-3300-module-33-lab-03.png" target="_blank"><img src="../images/dp-3300-module-33-lab-03.png" alt="图片 2"></a></p>
  </li>
  <li>
    <p>单击“显示防火墙设置”（在你刚复制的服务器名称上方）。单击下面突出显示的“<strong>+ 添加客户端 IP</strong>”，然后单击“保存”。</p>

    <p><a href="../images/dp-3300-module-33-lab-04.png" target="_blank"><img src="../images/dp-3300-module-33-lab-04.png" alt="图片 3"></a></p>

    <p>这将你能够使用 SQL Server Management Studio 或任何其他客户端工具连接到 Azure SQL 数据库服务器。<strong>重要提示：</strong> 记下你的客户端 IP 地址，稍后将在此任务中使用它。</p>
  </li>
  <li>
    <p>在实验室 VM 上打开 SQL Server Management Studio。粘贴你的 Azure SQL 数据库服务器名称，并使用在实验室 2 中创建的凭据登录：</p>

    <ul>
      <li>
        <p>服务器名称：<strong>&lt;<em>在此处粘贴你的 Azure SQL 数据库服务器名称</em>&gt;</strong></p>
      </li>
      <li>
        <p>身份验证：<strong>SQL Server 身份验证</strong></p>
      </li>
      <li>
        <p>服务器管理员登录名： <strong>dp300admin</strong></p>
      </li>
      <li>
        <p>密码： <strong>dp300P@ssword!</strong></p>
      </li>
    </ul>

    <p><a href="../images/dp-3300-module-33-lab-05.png" target="_blank"><img src="../images/dp-3300-module-33-lab-05.png" alt="手机的屏幕截图；描述自动生成"></a></p>

    <p>单击“<strong>连接</strong>”。</p>
  </li>
  <li>
    <p>在“对象资源管理器”中，展开服务器节点，然后右键单击数据库。单击“导入数据层应用程序”。</p>

    <p><a href="../images/dp-3300-module-33-lab-06.png" target="_blank"><img src="../images/dp-3300-module-33-lab-06.png" alt="社交媒体帖子屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>在“导入数据层应用程序”对话框中，点击第一个屏幕中的“下一步”。</p>

    <p><a href="../images/dp-3300-module-33-lab-07.png" target="_blank"><img src="../images/dp-3300-module-33-lab-07.png" alt="手机的屏幕截图；描述自动生成"></a></p>
  </li>
  <li>
    <p>在“导入设置”屏幕中，单击“浏览”并导航到“D:\Labfiles\Secure Environment”文件夹，再单击 AdventureWorks.bacpac 文件，然后单击“打开”。然后在“导入数据层应用程序”屏幕中，单击 <strong>“下一步”</strong>。</p>

    <p><a href="../images/dp-3300-module-33-lab-08.png" target="_blank"><img src="../images/dp-3300-module-33-lab-08.png" alt="图片 996777398"></a></p>

    <p><a href="../images/dp-3300-module-33-lab-09.png" target="_blank"><img src="../images/dp-3300-module-33-lab-09.png" alt="社交媒体帖子屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>在数据库设置屏幕上，将 Azure SQL 数据库的版本更改为“常规用途”。将“服务目标”更改为 <strong>GP_Gen5_2</strong>，然后单击“<strong>下一步</strong>”。</p>

    <p><a href="../images/dp-3300-module-33-lab-10.png" target="_blank"><img src="../images/dp-3300-module-33-lab-10.png" alt="手机的屏幕截图；描述自动生成"></a></p>
  </li>
  <li>
    <p>在“摘要”屏幕中，单击“<strong>完成</strong>”。导入完成后，你将看到以下结果。
    <a href="../images/dp-3300-module-33-lab-11.png" target="_blank"><img src="../images/dp-3300-module-33-lab-11.png" alt="手机的屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>在“对象资源管理器”中，展开“数据库”文件夹。然后右键单击 AdventureWorks，然后单击“新建查询”。</p>

    <p><a href="../images/dp-3300-module-33-lab-12.png" target="_blank"><img src="../images/dp-3300-module-33-lab-12.png" alt="手机的屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>通过将文本粘贴到查询窗口中来执行以下 T-SQL 查询。<strong>重要提示：</strong> 将 192.168.1.1. 替换为步骤 4 中的客户端 IP 地址。单击“执行”或按 F5。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_set_database_firewall_rule @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'ContosoFirewallRule'</span></span>,

@start_ip_address = <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, @end_ip_address = <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>
</code></pre>
  </li>
  <li>
    <p>接下来，将在 AdventureWorks 数据库中创建一个包含用户。单击“新建查询”，然后执行以下 T-SQL。确保仍在使用 AdventureWorks 数据库。如果在下面数据库名称框中看到主实例，则可以下拉并切换到 AdventureWorks。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> containeddemo <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'P@ssw0rd!'</span></span>
</code></pre>
    <p><a href="../images/dp-3300-module-33-lab-13.png" target="_blank"><img src="../images/dp-3300-module-33-lab-13.png" alt="手机的屏幕截图 描述自动生成"></a></p>

    <p>单击“<strong>执行</strong>”以运行此命令。此命令会在 AdventureWorks 数据库中创建一个包含的用户。将在下一步中使用此用户名和密码登录。</p>
  </li>
  <li>
    <p>导航到“对象资源管理器”。依次单击“<strong>连接</strong>”、“<strong>数据库引擎</strong>”。</p>

    <p><a href="../images/dp-3300-module-33-lab-14.png" target="_blank"><img src="../images/dp-3300-module-33-lab-14.png" alt="图片 1960831949"></a></p>
  </li>
  <li>尝试使用步骤 13 创建的凭据建立连接。 
你将需要使用以下信息：
    <ul>
      <li>
<strong>登录名：</strong> containeddemo</li>
      <li>
<strong>密码：</strong>  P@ssw0rd!</li>
    </ul>

    <p>单击“<strong>连接</strong>”。</p>

    <p>将看到以下错误。</p>

    <p><a href="../images/dp-3300-module-33-lab-15.png" target="_blank"><img src="../images/dp-3300-module-33-lab-15.png" alt="手机的屏幕截图 描述自动生成"></a></p>

    <p>生成此错误是因为该连接尝试登录 master 数据库，而不是创建用户的 AdventureWorks。若要更改连接上下文，请单击“确定”退出错误消息，然后单击“连接到服务器”对话框中的“选项”，如下所示。</p>

    <p><a href="../images/dp-3300-module-33-lab-16.png" target="_blank"><img src="../images/dp-3300-module-33-lab-16.png" alt="图片 9"></a></p>
  </li>
  <li>
    <p>在“连接选项”选项卡上，键入数据库名称“AdventureWorks”。单击“<strong>连接</strong>”。</p>

    <p><a href="../images/dp-3300-module-33-lab-17.png" target="_blank"><img src="../images/dp-3300-module-33-lab-17.png" alt="社交媒体帖子屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>另一个数据库应该出现在对象资源管理器中。</p>

    <p><a href="../images/dp-3300-module-33-lab-18.png" target="_blank"><img src="../images/dp-3300-module-33-lab-18.png" alt="图片 10"></a></p>

    <p>确保选择保留在新添加的数据库上。然后从“对象资源管理器”和“<strong>数据库引擎</strong>”中单击“<strong>连接</strong>”。 
再次输入以下内容：</p>
    <ul>
      <li>登录名：<strong>containeddemo</strong>
</li>
      <li>
<strong>密码</strong>：  P@ssw0rd!</li>
    </ul>

    <p>单击“<strong>连接</strong>”。</p>

    <p>这次，连接将绕过 master 数据库，并直接登录到 AdventureWorks，这是新创建的用户可以访问的唯一数据库。</p>
  </li>
</ol>

<h2 id="练习-2使用-azure-active-directory-授权对-azure-sql-数据库的访问">练习 2：使用 Azure Active Directory 授权对 Azure SQL 数据库的访问</h2>

<ol>
  <li>
    <p>导航到 Azure 门户，然后在屏幕右上角单击你的用户名。</p>

    <p><a href="../images/dp-3300-module-33-lab-19.png" target="_blank"><img src="../images/dp-3300-module-33-lab-19.png" alt="包含瓶子、黑色、照片、橙色的图片 自动生成的描述"></a></p>

    <p>记下该用户名。</p>

    <p><strong>重要提示：</strong> Azure SQL 数据库的 Azure Active Directory 管理员不支持 Microsoft 帐户（例如 Outlook、Gmail、Hotmail 或 Yahoo 的用户帐户）。你可以使用一种变通方法，即创建一个名为 DBA 的 Azure Active Directory 组，然后将你的用户帐户添加到其中。或者，你可以跳过练习 2。</p>
  </li>
  <li>
    <p>在 Azure 门户中，导航到 Azure SQL 数据库服务器 <strong>dp300-lab-xx</strong>，然后单击“Active Directory 管理员”旁边的“<strong>未配置</strong>”。</p>

    <p><a href="../images/dp-3300-module-33-lab-20.png" target="_blank"><img src="../images/dp-3300-module-33-lab-20.png" alt="图片 11"></a></p>

    <p>在下一个屏幕上，单击“<strong>设置管理员</strong>”。</p>

    <p><a href="../images/dp-3300-module-33-lab-21.png" target="_blank"><img src="../images/dp-3300-module-33-lab-21.png" alt="手机的屏幕截图 描述自动生成"></a></p>
  </li>
  <li>
    <p>在“设置管理员”屏幕中，搜索你的用户名。找到后，单击以突出显示该用户名，然后单击“<strong>选择</strong>”。这将返回到上面的 Active Directory 管理员屏幕。单击“<strong>保存</strong>”完成该过程。这样，你的用户名将成为服务器的 Azure Active Directory 管理员，如下所示</p>

    <p><a href="../images/dp-3300-module-33-lab-22.png" target="_blank"><img src="../images/dp-3300-module-33-lab-22.png" alt="图片 12"></a></p>
  </li>
  <li>
    <p>打开 SQL Server Management Studio，然后依次单击“<strong>连接</strong>”、“<strong>数据库引擎</strong>”。在“服务器名称”中，输入你的服务器名称。将身份验证类型更改为“Azure Active Directory 通用且具有 MFA 支持”。</p>

    <p><a href="../images/dp-3300-module-33-lab-23.png" target="_blank"><img src="../images/dp-3300-module-33-lab-23.png" alt="手机的屏幕截图 描述自动生成"></a></p>

    <p>按提示输入 Azure Active Directory 密码，然后单击“<strong>连接</strong>”登录数据库。</p>
  </li>
</ol>

<h2 id="练习-3管理对数据库对象的访问">练习 3：管理对数据库对象的访问</h2>

<ol>
  <li>
    <p>在此练习中，你将管理对数据库及其对象的访问。导航回到 SQL Server Management Studio。首先要做的是在 AdventureWorks 数据库中创建两个用户。</p>

    <p>在“对象资源管理器”中，右键单击 AdventureWorks 数据库，然后选择“<strong>新建查询</strong>”。在新建查询窗口中，将以下 T-SQL 复制并粘贴到其中。验证是否已正确复制代码。</p>
  </li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> [DP300User1] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'Azur3Pa$$'</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> [DP300User2] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'Azur3Pa$$'</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<p>你会注意到这些用户是在数据库范围内创建的。因此，如果尝试使用其中一个用户登录，则需要在连接字符串中指定 AdventureWorks 数据库。</p>

<ol>
  <li>接下来，你将创建一个自定义角色并向其添加用户。在与步骤 1 相同的查询窗口中执行以下 T-SQL。单击“<strong>执行</strong>”以运行。</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> [SalesReader]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> [SalesReader] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> [DP300User1]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> [SalesReader] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> [DP300User2]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>下一步是为该角色授予权限。在本例中，要为 Sales 架构分配 SELECT 和 EXECUTE。清除上一个查询的窗口。然后在同一窗口中，单击“<strong>执行</strong>”以运行以下 T-SQL。从而授予角色权限。</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SCHEMA</span></span>::Sales <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [SalesReader]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>接下来，将在 Sales 架构中创建一个新的存储过程。你会注意到此过程会访问 Product 架构中的一个表。清除上一个查询的窗口。在查询窗口中执行以下 T-SQL。</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> Sales.DemoProc

<span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> P.Name, <span class="hljs-keyword"><span class="hljs-keyword">Sum</span></span>(SOD.LineTotal) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalSales ,SOH.OrderDate 

<span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Production.Product P

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderDetail SOD <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOD.ProductID = P.ProductID

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderHeader SOH <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOH.SalesOrderID = SOD.SalesOrderID

<span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> P.Name, SOH.OrderDate

<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TotalSales <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>接下来，将使用 EXECUTE AS USER 命令测试刚刚建立的安全性。这使数据库引擎可以在你的用户上下文中执行查询。清除上一个查询的窗口。在查询窗口中执行以下查询。</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> = <span class="hljs-string"><span class="hljs-string">'DP300User1'</span></span>


<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> P.Name, <span class="hljs-keyword"><span class="hljs-keyword">Sum</span></span>(SOD.LineTotal) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalSales ,SOH.OrderDate 

<span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Production.Product P

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderDetail SOD <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOD.ProductID = P.ProductID

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderHeader SOH <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOH.SalesOrderID = SOD.SalesOrderID

<span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> P.Name, SOH.OrderDate

<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TotalSales <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>
</code></pre>

<p>该查询将失败，并显示一条错误消息，提示对 Production.Product 表的 SELECT 权限遭到拒绝。用户 DP300User1 所属的角色在 Sales 架构中具有 SELECT 权限，但在 Production 架构中则不具有此权限。</p>

<p>但是，如果在相同的上下文中执行存储过程，查询将完成。清除给出错误消息的查询。然后执行以下 T-SQL。</p>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> = <span class="hljs-string"><span class="hljs-string">'DP300User1'</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> Sales.DemoProc
</code></pre>

<p>这是因为存储过程利用了一种称为“所有权链接”的功能，向没有数据库对象直接访问权限的用户提供数据访问权限。对于属于同一所有者的所有对象，数据库引擎仅检查过程的 EXECUTE 权限，而不检查基础对象的这一权限。</p>

<p><strong>请不要删除本实验室中创建的任何资源，因为它们将在后续的实验室练习中使用。</strong></p>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/DP-300T00ZH-Administering-Relational-Databases-on-Azure" target="_blank" class="ml-2">
                    MicrosoftLearning/DP-300T00ZH-Administering-Relational-Databases-on-Azure
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D.js"></script>



</body></html>