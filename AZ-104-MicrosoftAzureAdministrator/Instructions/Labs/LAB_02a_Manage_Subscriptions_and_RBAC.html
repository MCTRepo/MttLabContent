<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-104-MicrosoftAzureAdministrator
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D907526b117000ffdbc71b1bcc102e524d83415a3.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-104-MicrosoftAzureAdministrator
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#exercise-1">Exercise 1</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="lab-02a---manage-subscriptions-and-rbac">Lab 02a - Manage Subscriptions and RBAC</h1>
<h1 id="student-lab-manual">Student lab manual</h1>

<h2 id="lab-requirements">Lab requirements:</h2>

<p>This lab requires permissions to create Azure Active Directory (Azure AD) users, create custom Azure Role Based Access Control (RBAC) roles, and assign these roles to Azure AD users. Not all lab hosters may provide this capability. Ask your instructor for the availability of this lab.</p>

<h2 id="lab-scenario">Lab scenario</h2>

<p>In order to improve management of Azure resources in Contoso, you have been tasked with implementing the following functionality:</p>

<ul>
  <li>
    <p>creating a management group that would include all of Contoso’s Azure subscriptions</p>
  </li>
  <li>
    <p>granting permissions to submit support requests for all subscriptions in the management group to a designated Azure Active Directory user. That user’s permissions should be limited only to:</p>

    <ul>
      <li>creating support request tickets</li>
      <li>viewing resource groups</li>
    </ul>
  </li>
</ul>

<h2 id="objectives">Objectives</h2>

<p>In this lab, you will:</p>

<ul>
  <li>Task 1: Implement Management Groups</li>
  <li>Task 2: Create custom RBAC roles</li>
  <li>Task 3: Assign RBAC roles</li>
</ul>

<h2 id="estimated-timing-30-minutes">Estimated timing: 30 minutes</h2>

<h2 id="architecture-diagram">Architecture diagram</h2>

<p><a href="../media/lab02a.png" target="_blank"><img src="../media/lab02a.png" alt="image"></a></p>

<h2 id="instructions">Instructions</h2>

<h3 id="exercise-1">Exercise 1</h3>

<h4 id="task-1-implement-management-groups">Task 1: Implement Management Groups</h4>

<p>In this task, you will create and configure management groups.</p>

<ol>
  <li>
    <p>Sign in to the <a href="https://portal.azure.com">Azure portal</a>.</p>
  </li>
  <li>
    <p>Search for and select <strong>Management groups</strong> to navigate to the <strong>Management groups</strong> blade.</p>
  </li>
  <li>
    <p>Review the messages at the top of the <strong>Management groups</strong> blade. If you are seeing the message stating <strong>You are registered as a directory admin but do not have the necessary permissions to access the root management group</strong>, perfom the following sequence of steps:</p>

    <ol>
      <li>
        <p>In the Azure portal, search for and select <strong>Azure Active Directory</strong>.</p>
      </li>
      <li>
        <p>On the blade displaying properties of your Azure Active Directory tenant, in the vertical menu on the left side, in the <strong>Manage</strong> section, select <strong>Properties</strong>.</p>
      </li>
      <li>
        <p>On the <strong>Properties</strong> blade of your your Azure Active Directory tenant, in the <strong>Access management for Azure resources</strong> section, select <strong>Yes</strong> and then select <strong>Save</strong>.</p>
      </li>
      <li>
        <p>Navigate back to the <strong>Management groups</strong> blade, and select <strong>Refresh</strong>.</p>
      </li>
    </ol>
  </li>
  <li>
    <p>On the <strong>Management groups</strong> blade, click <strong>+ Create</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If you have not previously created Management Groups, select <strong>Start using management groups</strong></p>
    </blockquote>
  </li>
  <li>
    <p>Create a management group with the following settings:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Management group ID</td>
          <td><strong>az104-02-mg1</strong></td>
        </tr>
        <tr>
          <td>Management group display name</td>
          <td><strong>az104-02-mg1</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>In the list of management groups, click the entry representing the newly created management group.</p>
  </li>
  <li>
    <p>On the <strong>az104-02-mg1</strong> blade, click <strong>Subscriptions</strong>.</p>
  </li>
  <li>
    <p>On the <strong>az104-02-mg1 | Subscriptions</strong> blade, click <strong>+ Add</strong>, on the <strong>Add subscription</strong> blade, in the <strong>Subscription</strong> drop-down list, select the subscription you are using in this lab and click <strong>Save</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: On the <strong>az104-02-mg1 | Subscriptions</strong> blade, copy the ID of your Azure subscription into Clipboard. You will need it in the next task.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-create-custom-rbac-roles">Task 2: Create custom RBAC roles</h4>

<p>In this task, you will create a definition of a custom RBAC role.</p>

<ol>
  <li>
    <p>From the lab computer, open the file <strong>\Allfiles\Labs\02\az104-02a-customRoleDefinition.json</strong> in Notepad and review its content:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-json hljs">{
   <span class="hljs-attr"><span class="hljs-attr">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Support Request Contributor (Custom)"</span></span>,
   <span class="hljs-attr"><span class="hljs-attr">"IsCustom"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>,
   <span class="hljs-attr"><span class="hljs-attr">"Description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allows to create support requests"</span></span>,
   <span class="hljs-attr"><span class="hljs-attr">"Actions"</span></span>: [
       <span class="hljs-string"><span class="hljs-string">"Microsoft.Resources/subscriptions/resourceGroups/read"</span></span>,
       <span class="hljs-string"><span class="hljs-string">"Microsoft.Support/*"</span></span>
   ],
   <span class="hljs-attr"><span class="hljs-attr">"NotActions"</span></span>: [
   ],
   <span class="hljs-attr"><span class="hljs-attr">"AssignableScopes"</span></span>: [
       <span class="hljs-string"><span class="hljs-string">"/providers/Microsoft.Management/managementGroups/az104-02-mg1"</span></span>,
       <span class="hljs-string"><span class="hljs-string">"/subscriptions/SUBSCRIPTION_ID"</span></span>
   ]
}
</code></pre>
    <blockquote>
      <p><strong>Note</strong>: If you are not sure where the files are stored locally in your lab environment, please ask your instructor.</p>
    </blockquote>
  </li>
  <li>
    <p>Replace the <code>SUBSCRIPTION_ID</code> placeholder in the JSON file with the subscription ID you copied into Clipboard and save the change.</p>
  </li>
  <li>
    <p>In the Azure portal, open <strong>Cloud Shell</strong> pane by clicking on the toolbar icon directly to the right of the search textbox.</p>
  </li>
  <li>
    <p>If prompted to select either <strong>Bash</strong> or <strong>PowerShell</strong>, select <strong>PowerShell</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is the first time you are starting <strong>Cloud Shell</strong> and you are presented with the <strong>You have no storage mounted</strong> message, select the subscription you are using in this lab, and click <strong>Create storage</strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>In the toolbar of the Cloud Shell pane, click the <strong>Upload/Download files</strong> icon, in the drop-down menu click <strong>Upload</strong>, and upload the file <strong>\Allfiles\Labs\02\az104-02a-customRoleDefinition.json</strong> into the Cloud Shell home directory.</p>
  </li>
  <li>
    <p>From the Cloud Shell pane, run the following to create the custom role definition:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-powershell">New-AzRoleDefinition -InputFile $HOME/az104-02a-customRoleDefinition.json
</code></pre>
  </li>
  <li>
    <p>Close the Cloud Shell pane.</p>
  </li>
</ol>

<h4 id="task-3-assign-rbac-roles">Task 3: Assign RBAC roles</h4>

<p>In this task, you will create an Azure Active Directory user, assign the RBAC role you created in the previous task to that user, and verify that the user can perform the task specified in the RBAC role definition.</p>

<ol>
  <li>
    <p>In the Azure portal, search for and select <strong>Azure Active Directory</strong>, on the Azure Active Directory blade, click <strong>Users</strong>, and then click <strong>+ New user</strong>.</p>
  </li>
  <li>
    <p>Create a new user with the following settings (leave others with their defaults):</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>User name</td>
          <td><strong>az104-02-aaduser1</strong></td>
        </tr>
        <tr>
          <td>Name</td>
          <td><strong>az104-02-aaduser1</strong></td>
        </tr>
        <tr>
          <td>Let me create the password</td>
          <td>enabled</td>
        </tr>
        <tr>
          <td>Initial password</td>
          <td><strong>Pa55w.rd1234</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>Note</strong>: <strong>Copy to clipboard</strong> the full <strong>User name</strong>. You will need it later in this lab.</p>
    </blockquote>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the <strong>az104-02-mg1</strong> management group and display its <strong>details</strong>.</p>
  </li>
  <li>
    <p>Click <strong>Access control (IAM)</strong>, click <strong>+ Add</strong> followed by <strong>Role assignment</strong>, and assign the <strong>Support Request Contributor (Custom)</strong> role to the newly created user account.</p>
  </li>
  <li>
    <p>Open an <strong>InPrivate</strong> browser window and sign in to the <a href="https://portal.azure.com">Azure portal</a> using the newly created user account. When prompted to update the password, change the password for the user.</p>

    <blockquote>
      <p><strong>Note</strong>: Rather than typing the user name, you can paste the content of Clipboard.</p>
    </blockquote>
  </li>
  <li>
    <p>In the <strong>InPrivate</strong> browser window, in the Azure portal, search and select <strong>Resource groups</strong> to verify that the az104-02-aaduser1 user can see all resource groups.</p>
  </li>
  <li>
    <p>In the <strong>InPrivate</strong> browser window, in the Azure portal, search and select <strong>All resources</strong> to verify that the az104-02-aaduser1 user cannot see any resources.</p>
  </li>
  <li>
    <p>In the <strong>InPrivate</strong> browser window, in the Azure portal, search and select <strong>Help + support</strong> and then click <strong>+ Create a support request</strong>.</p>
  </li>
  <li>
    <p>In the <strong>InPrivate</strong> browser window, on the <strong>Problem Desription/Summary</strong> tab of the <strong>Help + support - New support request</strong> blade, type <strong>Service and subscription limits</strong> in the Summary field and select the <strong>Service and subscription limits (quotas)</strong> issue type. Note that the subscription you are using in this lab is listed in the <strong>Subscription</strong> drop-down list.</p>

    <blockquote>
      <p><strong>Note</strong>: The presence of the subscription you are using in this lab in the <strong>Subscription</strong> drop-down list indicates that the account you are using has the permissions required to create the subscription-specific support request.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: If you do not see the <strong>Service and subscription limits (quotas)</strong> option, sign out from the Azure portal and sign in back.</p>
    </blockquote>
  </li>
  <li>
    <p>Do not continue with creating the support request. Instead, sign out as the az104-02-aaduser1 user from the Azure portal and close the InPrivate browser window.</p>
  </li>
</ol>

<h4 id="clean-up-resources">Clean up resources</h4>

<blockquote>
  <p><strong>Note</strong>: Remember to remove any newly created Azure resources that you no longer use.</p>
</blockquote>

<blockquote>
  <p><strong>Note</strong>: Removing unused resources ensures you will not see unexpected charges, although, resources created in this lab do not incur extra cost.</p>
</blockquote>

<ol>
  <li>
    <p>In the Azure portal, search for and select <strong>Azure Active Directory</strong>, on the Azure Active Directory blade, click <strong>Users</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Users - All users</strong> blade, click <strong>az104-02-aaduser1</strong>.</p>
  </li>
  <li>
    <p>On the <strong>az104-02-aaduser1 - Profile</strong> blade, copy the value of <strong>Object ID</strong> attribute.</p>
  </li>
  <li>
    <p>In the Azure portal, start a <strong>PowerShell</strong> session within the <strong>Cloud Shell</strong>.</p>
  </li>
  <li>
    <p>From the Cloud Shell pane, run the following to remove the assignment of the custom role definition (replace the <code>[object_ID]</code> placeholder with the value of the <strong>object ID</strong> attribute of the <strong>az104-02-aaduser1</strong> Azure Active Directory user account you copied earlier in this task):</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-powershell">$scope = (Get-AzRoleAssignment -RoleDefinitionName 'Support Request Contributor (Custom)').Scope

Remove-AzRoleAssignment -ObjectId '[object_ID]' -RoleDefinitionName 'Support Request Contributor (Custom)' -Scope $scope
</code></pre>
  </li>
  <li>
    <p>From the Cloud Shell pane, run the following to remove the custom role definition:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-powershell">Remove-AzRoleDefinition -Name 'Support Request Contributor (Custom)' -Force
</code></pre>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the <strong>Users - All users</strong> blade of the <strong>Azure Active Directory</strong>, and delete the <strong>az104-02-aaduser1</strong> user account.</p>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the <strong>Management groups</strong> blade.</p>
  </li>
  <li>
    <p>On the <strong>Management groups</strong> blade, select the <strong>ellipsis</strong> icon next to your subscription under the <strong>az104-02-mg1</strong> management group and select <strong>Move</strong> to move the subscription to the <strong>Tenant Root management group</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: It is likely that the target management group is the <strong>Tenant Root management group</strong>, unless you created a custom management group hierarchy before running this lab.</p>
    </blockquote>
  </li>
  <li>
    <p>Select <strong>Refresh</strong> to verify that the subscription has successfully moved to the <strong>Tenant Root management group</strong>.</p>
  </li>
  <li>
    <p>Navigate back to the <strong>Management groups</strong> blade, right click the <strong>ellipsis</strong> icon to the right of the <strong>az104-02-mg1</strong> management group and click <strong>Delete</strong>.</p>
  </li>
</ol>

<h4 id="review">Review</h4>

<p>In this lab, you have:</p>

<ul>
  <li>Implemented Management Groups</li>
  <li>Created custom RBAC roles</li>
  <li>Assigned RBAC roles</li>
</ul>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D907526b117000ffdbc71b1bcc102e524d83415a3.js"></script>



</body></html>