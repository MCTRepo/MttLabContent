<!DOCTYPE html><html lang="en"><head>
        <title>
            DP-203-Data-Engineer
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D928deb11f009d00944c1feae30c16de739b6478a.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                DP-203-Data-Engineer
            </a>
            <a href="https://github.com/MicrosoftLearning/DP-203-Data-Engineer" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#task-1-create-mapping-data-flow">Task 1: Create mapping data flow</a></li><li class="nav-item"><a class="nav-link active" href="#task-2-create-pipeline">Task 2: Create pipeline</a></li><li class="nav-item"><a class="nav-link" href="#task-3-trigger-the-pipeline">Task 3: Trigger the pipeline</a></li><li class="nav-item"><a class="nav-link" href="#task-1-create-notebook">Task 1: Create notebook</a></li><li class="nav-item"><a class="nav-link" href="#task-2-add-the-notebook-to-the-pipeline">Task 2: Add the Notebook to the pipeline</a></li><li class="nav-item"><a class="nav-link" href="#task-3-run-the-updated-pipeline">Task 3: Run the updated pipeline</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="lab-7---integrate-data-from-notebooks-with-azure-data-factory-or-azure-synapse-pipelines">Lab 7 - Integrate data from notebooks with Azure Data Factory or Azure Synapse Pipelines</h1>

<p>You will learn how to create linked services, and orchestrate data movement and transformation in Azure Synapse Pipelines.</p>

<p>After completing this lab, you will be able to:</p>

<ul>
  <li>Orchestrate data movement and transformation in Azure Synapse Pipelines</li>
</ul>

<h2 id="lab-setup-and-pre-requisites">Lab setup and pre-requisites</h2>

<p>Before starting this lab, you should complete <strong>Lab 6: <em>Transform data with Azure Data Factory or Azure Synapse Pipelines</em></strong>.</p>

<blockquote>
  <p><strong>Note</strong>: If you have <strong><em>not</em></strong> completed lab 6, but you <u>have</u> completed the lab setup for this course, you can complete these steps to create the required linked services and datasets.</p>

  <ol>
    <li>In Synapse Studio, on the <strong>Manage</strong> hub, add a new <strong>Linked service</strong> for <strong>Azure Cosmos DB (SQL API)</strong> with the following settings:
      <ul>
        <li>
<strong>Name</strong>: asacosmosdb01</li>
        <li>
<strong>Cosmos DB account name</strong>: asacosmosdb<em>xxxxxxx</em>
</li>
        <li>
<strong>Database name</strong>: CustomerProfile</li>
      </ul>
    </li>
    <li>On the <strong>Data</strong> hub, create the following <strong>Integration datasets</strong>:
      <ul>
        <li>asal400_customerprofile_cosmosdb:
          <ul>
            <li>
<strong>Source</strong>: Azure Cosmos DB (SQL API)</li>
            <li>
<strong>Name</strong>: asal400_customerprofile_cosmosdb</li>
            <li>
<strong>Linked service</strong>: asacosmosdb01</li>
            <li>
<strong>Collection</strong>: OnlineUserProfile01</li>
          </ul>
        </li>
        <li>asal400_ecommerce_userprofiles_source
          <ul>
            <li>
<strong>Source</strong>: Azure Data Lake Storage Gen2</li>
            <li>
<strong>Format</strong>: JSON</li>
            <li>
<strong>Name</strong>: asal400_ecommerce_userprofiles_source</li>
            <li>
<strong>Linked service</strong>: asadatalake<em>xxxxxxx</em>
</li>
            <li>
<strong>File path</strong>: wwi-02/online-user-profiles-02</li>
            <li>
<strong>Import schema</strong>: From connection/store</li>
          </ul>
        </li>
      </ul>
    </li>
  </ol>
</blockquote>

<h2 id="exercise-1---create-mapping-data-flow-and-pipeline">Exercise 1 - Create mapping data flow and pipeline</h2>

<p>In this exercise, you create a mapping data flow that copies user profile data to the data lake, then create a pipeline that orchestrates executing the data flow, and later on, the Spark notebook you create later in this lab.</p>

<h3 id="task-1-create-mapping-data-flow">Task 1: Create mapping data flow</h3>

<ol>
  <li>Open Synapse Studio (<a href="https://web.azuresynapse.net/">https://web.azuresynapse.net/</a>).</li>
  <li>
    <p>Navigate to the <strong>Develop</strong> hub.</p>

    <p><a href="images/develop-hub.png" target="_blank"><img src="images/develop-hub.png" alt="The Develop menu item is highlighted." title="Develop hub"></a></p>
  </li>
  <li>
    <p>In the <strong>+</strong> menu, select <strong>Data flow</strong> to create a new data flow.</p>

    <p><a href="images/new-data-flow-link.png" target="_blank"><img src="images/new-data-flow-link.png" alt="The new data flow link is highlighted." title="New data flow"></a></p>
  </li>
  <li>
    <p>In the <strong>General</strong> settings of the <strong>Properties</strong> blade of the new data flow, update the <strong>Name</strong> to <code>user_profiles_to_datalake</code>. Make sure the name exactly matches exactly.</p>

    <p><a href="images/data-flow-user-profiles-name.png" target="_blank"><img src="images/data-flow-user-profiles-name.png" alt="The name field is populated with the defined value." title="Name"></a></p>
  </li>
  <li>
    <p>Select the <strong>{} Code</strong> button at the top-right above the data flow properties.</p>

    <p><a href="images/data-flow-code-button.png" target="_blank"><img src="images/data-flow-code-button.png" alt="The code button is highlighted." title="Code"></a></p>
  </li>
  <li>
    <p>Replace the existing code with the following, changing <strong><em>SUFFIX</em></strong> in the <strong>asadatalake<em>SUFFIX</em></strong> sink reference name on line 25 to the unique suffix for your Azure resources in this lab:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="hljs json"> {
     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"user_profiles_to_datalake"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: {
         <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"MappingDataFlow"</span></span>,
         <span class="hljs-attr"><span class="hljs-attr">"typeProperties"</span></span>: {
             <span class="hljs-attr"><span class="hljs-attr">"sources"</span></span>: [
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"dataset"</span></span>: {
                         <span class="hljs-attr"><span class="hljs-attr">"referenceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"asal400_ecommerce_userprofiles_source"</span></span>,
                         <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DatasetReference"</span></span>
                     },
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"EcommerceUserProfiles"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"dataset"</span></span>: {
                         <span class="hljs-attr"><span class="hljs-attr">"referenceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"asal400_customerprofile_cosmosdb"</span></span>,
                         <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"DatasetReference"</span></span>
                     },
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"UserProfiles"</span></span>
                 }
             ],
             <span class="hljs-attr"><span class="hljs-attr">"sinks"</span></span>: [
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"linkedService"</span></span>: {
                         <span class="hljs-attr"><span class="hljs-attr">"referenceName"</span></span>: <span class="hljs-string"><span class="hljs-string">"asadatalakeSUFFIX"</span></span>,
                         <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"LinkedServiceReference"</span></span>
                     },
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"DataLake"</span></span>
                 }
             ],
             <span class="hljs-attr"><span class="hljs-attr">"transformations"</span></span>: [
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"userId"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"UserTopProducts"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"DerivedProductColumns"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"UserPreferredProducts"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"JoinTopProductsWithPreferredProducts"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"DerivedColumnsForMerge"</span></span>
                 },
                 {
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Filter1"</span></span>
                 }
             ],
             <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: <span class="hljs-string"><span class="hljs-string">"source(output(\n\t\tvisitorId as string,\n\t\ttopProductPurchases as (productId as string, itemsPurchasedLast12Months as string)[]\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tdocumentForm: 'arrayOfDocuments',\n\twildcardPaths:['online-user-profiles-02/*.json']) ~&gt; EcommerceUserProfiles\nsource(output(\n\t\tcartId as string,\n\t\tpreferredProducts as integer[],\n\t\tproductReviews as (productId as integer, reviewDate as string, reviewText as string)[],\n\t\tuserId as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'document') ~&gt; UserProfiles\nEcommerceUserProfiles derive(visitorId = toInteger(visitorId)) ~&gt; userId\nuserId foldDown(unroll(topProductPurchases),\n\tmapColumn(\n\t\tvisitorId,\n\t\tproductId = topProductPurchases.productId,\n\t\titemsPurchasedLast12Months = topProductPurchases.itemsPurchasedLast12Months\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~&gt; UserTopProducts\nUserTopProducts derive(productId = toInteger(productId),\n\t\titemsPurchasedLast12Months = toInteger(itemsPurchasedLast12Months)) ~&gt; DerivedProductColumns\nUserProfiles foldDown(unroll(preferredProducts),\n\tmapColumn(\n\t\tpreferredProductId = preferredProducts,\n\t\tuserId\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~&gt; UserPreferredProducts\nDerivedProductColumns, UserPreferredProducts join(visitorId == userId,\n\tjoinType:'outer',\n\tpartitionBy('hash', 30,\n\t\tproductId\n\t),\n\tbroadcast: 'left')~&gt; JoinTopProductsWithPreferredProducts\nJoinTopProductsWithPreferredProducts derive(isTopProduct = toBoolean(iif(isNull(productId), 'false', 'true')),\n\t\tisPreferredProduct = toBoolean(iif(isNull(preferredProductId), 'false', 'true')),\n\t\tproductId = iif(isNull(productId), preferredProductId, productId),\n\t\tuserId = iif(isNull(userId), visitorId, userId)) ~&gt; DerivedColumnsForMerge\nDerivedColumnsForMerge filter(!isNull(productId)) ~&gt; Filter1\nFilter1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delta',\n\tcompressionType: 'snappy',\n\tcompressionLevel: 'Fastest',\n\tfileSystem: 'wwi-02',\n\tfolderPath: 'top-products',\n\ttruncate:true,\n\tmergeSchema: false,\n\tautoCompact: false,\n\toptimizedWrite: false,\n\tvacuum: 0,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tmapColumn(\n\t\tvisitorId,\n\t\tproductId,\n\t\titemsPurchasedLast12Months,\n\t\tpreferredProductId,\n\t\tuserId,\n\t\tisTopProduct,\n\t\tisPreferredProduct\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~&gt; DataLake"</span></span>
         }
     }
 }
</code></pre>
  </li>
  <li>
    <p>Select <strong>OK</strong>.</p>
  </li>
  <li>
    <p>The data flow should look like the following:</p>

    <p><a href="images/user-profiles-data-flow.png" target="_blank"><img src="images/user-profiles-data-flow.png" alt="The completed data flow is displayed." title="Completed data flow"></a></p>
  </li>
</ol>

<h3 id="task-2-create-pipeline">Task 2: Create pipeline</h3>

<p>In this step, you create a new integration pipeline to execute the data flow.</p>

<ol>
  <li>
    <p>On the <strong>Integrate</strong> hub, in the <strong>+</strong> menu, select <strong>Pipeline</strong>.</p>

    <p><a href="images/new-pipeline.png" target="_blank"><img src="images/new-pipeline.png" alt="The new pipeline menu item is highlighted." title="New pipeline"></a></p>
  </li>
  <li>
    <p>In the <strong>General</strong> section of the <strong>Properties</strong> pane of the new data flow, update the <strong>Name</strong> to <code>User Profiles to Datalake</code>. Then select the <strong>Properties</strong> button to hide the pane.</p>

    <p><a href="images/pipeline-user-profiles-general.png" target="_blank"><img src="images/pipeline-user-profiles-general.png" alt="The name is displayed." title="General properties"></a></p>
  </li>
  <li>
    <p>Expand <strong>Move &amp; transform</strong> within the Activities list, then drag the <strong>Data flow</strong> activity onto the pipeline canvas.</p>

    <p><a href="images/pipeline-drag-data-flow.png" target="_blank"><img src="images/pipeline-drag-data-flow.png" alt="Drag the data flow activity onto the pipeline canvas." title="Pipeline canvas"></a></p>
  </li>
  <li>
    <p>Under the <strong>General</strong> tab beneath the pipeline canvas, set the Name to <code>user_profiles_to_datalake</code>.</p>

    <p><a href="images/pipeline-data-flow-general-datalake.png" target="_blank"><img src="images/pipeline-data-flow-general-datalake.png" alt="The name is set on the general tab as described." title="Name on the General tab"></a></p>
  </li>
  <li>
    <p>On the <strong>Settings</strong> tab, select the <strong>user_profiles_to_datalake</strong> data flow, ensure <strong>AutoResolveIntegrationRuntime</strong> is selected. Choose the <strong>Basic (General purpose)</strong> compute type and set the core count to <strong>4 (+ 4 Driver cores)</strong>.</p>

    <p><a href="images/pipeline-user-profiles-datalake-data-flow-settings.png" target="_blank"><img src="images/pipeline-user-profiles-datalake-data-flow-settings.png" alt="The mapping data flow activity settings are configured as described." title="Mapping data flow activity settings"></a></p>
  </li>
  <li>
    <p>Select <strong>Publish all</strong> then <strong>Publish</strong> to save your pipeline.</p>

    <p><a href="images/publish-all-1.png" target="_blank"><img src="images/publish-all-1.png" alt="Publish all is highlighted." title="Publish all"></a></p>
  </li>
</ol>

<h3 id="task-3-trigger-the-pipeline">Task 3: Trigger the pipeline</h3>

<ol>
  <li>
    <p>At the top of the pipeline, select <strong>Add trigger</strong>, then <strong>Trigger now</strong>.</p>

    <p><a href="images/pipeline-user-profiles-new-trigger.png" target="_blank"><img src="images/pipeline-user-profiles-new-trigger.png" alt="The pipeline trigger option is highlighted." title="Trigger now"></a></p>
  </li>
  <li>
    <p>There are no parameters for this pipeline, so select <strong>OK</strong> to run the trigger.</p>

    <p><a href="images/pipeline-run-trigger.png" target="_blank"><img src="images/pipeline-run-trigger.png" alt="The OK button is highlighted." title="Pipeline run"></a></p>
  </li>
  <li>
    <p>Navigate to the <strong>Monitor</strong> hub.</p>

    <p><a href="images/monitor-hub.png" target="_blank"><img src="images/monitor-hub.png" alt="The Monitor hub menu item is selected." title="Monitor hub"></a></p>
  </li>
  <li>
    <p>Select <strong>Pipeline runs</strong> and wait for the pipeline run to successfully complete (which will take some time). You may need to refresh the view.</p>

    <p><a href="images/pipeline-user-profiles-run-complete.png" target="_blank"><img src="images/pipeline-user-profiles-run-complete.png" alt="The pipeline run succeeded." title="Pipeline runs"></a></p>
  </li>
</ol>

<h2 id="exercise-2---create-synapse-spark-notebook-to-find-top-products">Exercise 2 - Create Synapse Spark notebook to find top products</h2>

<p>Tailwind Traders uses a Mapping Data flow in Synapse Analytics to process, join, and import user profile data. Now they want to find the top 5 products for each user, based on which ones are both preferred and top, and have the most purchases in the past 12 months. Then, they want to calculate the top 5 products overall.</p>

<p>In this exercise, you will create a Synapse Spark notebook to make these calculations.</p>

<h3 id="task-1-create-notebook">Task 1: Create notebook</h3>

<ol>
  <li>
    <p>Select the <strong>Data</strong> hub.</p>

    <p><a href="images/data-hub.png" target="_blank"><img src="images/data-hub.png" alt="The Data menu item is highlighted." title="Data hub"></a></p>
  </li>
  <li>
    <p>On the <strong>Linked</strong> tab, expand <strong>Azure Data Lake Storage Gen2</strong> and the primary data lake storage account, and select the <strong>wwi-02</strong> container. Then navigate to the <strong>top-products</strong> folder in the root of this container (If you don’t see the folder, select <strong>Refresh</strong>). Finally, right-click any Parquet file, select the <strong>New notebook</strong> menu item, then select <strong>Load to DataFrame</strong>.</p>

    <p><a href="images/synapse-studio-top-products-folder.png" target="_blank"><img src="images/synapse-studio-top-products-folder.png" alt="The Parquet file and new notebook option are highlighted." title="New notebook"></a></p>
  </li>
  <li>
    <p>Select the <strong>Properties</strong> button at the top-right corner of the notebook, and enter <code>Calculate Top 5 Products</code> for the <strong>Name</strong>. Then click the <strong>Properties</strong> button again to hide the pane.</p>
  </li>
  <li>
    <p>Attach the notebook is attached to your <strong>SparkPool01</strong> Spark pool.</p>

    <p><a href="images/notebook-top-products-attach-pool.png" target="_blank"><img src="images/notebook-top-products-attach-pool.png" alt="The attach to Spark pool menu item is highlighted." title="Select Spark pool"></a></p>
  </li>
  <li>
    <p>In the Python code, replace the Parquet file name with <code>*.parquet</code> to select all Parquet files in the <strong>top-products</strong> folder. For example, the path should be similar to:    abfss://wwi-02@asadatalakexxxxxxx.dfs.core.windows.net/top-products/*.parquet.</p>

    <p><a href="images/notebook-top-products-filepath.png" target="_blank"><img src="images/notebook-top-products-filepath.png" alt="The filename is highlighted." title="Folder path"></a></p>
  </li>
  <li>
    <p>Select <strong>Run all</strong> on the notebook toolbar to run the notebook.</p>

    <p><a href="images/notebook-top-products-cell1results.png" target="_blank"><img src="images/notebook-top-products-cell1results.png" alt="The cell results are displayed." title="Cell 1 results"></a></p>

    <blockquote>
      <p><strong>Note:</strong> The first time you run a notebook in a Spark pool, Synapse creates a new session. This can take approximately 2-3 minutes.</p>
    </blockquote>
  </li>
  <li>
    <p>Create a new code cell underneath by selecting the <strong>+ Code</strong> button.</p>
  </li>
  <li>
    <p>Enter and execute the following in the new cell to populate a new dataframe called <strong>topPurchases</strong>, create a new temporary view named <strong>top_purchases</strong>, and show the first 100 rows:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-python hljs"> topPurchases = df.select(
     <span class="hljs-string"><span class="hljs-string">"UserId"</span></span>, <span class="hljs-string"><span class="hljs-string">"ProductId"</span></span>,
     <span class="hljs-string"><span class="hljs-string">"ItemsPurchasedLast12Months"</span></span>, <span class="hljs-string"><span class="hljs-string">"IsTopProduct"</span></span>,
     <span class="hljs-string"><span class="hljs-string">"IsPreferredProduct"</span></span>)

 <span class="hljs-comment"><span class="hljs-comment"># Populate a temporary view so we can query from SQL</span></span>
 topPurchases.createOrReplaceTempView(<span class="hljs-string"><span class="hljs-string">"top_purchases"</span></span>)

 topPurchases.show(<span class="hljs-number"><span class="hljs-number">100</span></span>)
</code></pre>

    <p>The output should look similar to the following:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="hljs ruby"> +------+---------+--------------------------+------------+------------------+
 <span class="hljs-params"><span class="hljs-params">|UserId|</span></span>ProductId<span class="hljs-params"><span class="hljs-params">|ItemsPurchasedLast12Months|</span></span>IsTopProduct<span class="hljs-params"><span class="hljs-params">|IsPreferredProduct|</span></span>
 +------+---------+--------------------------+------------+------------------+
 <span class="hljs-params"><span class="hljs-params">|   148|</span></span>     <span class="hljs-number"><span class="hljs-number">2717</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   148|</span></span>     <span class="hljs-number"><span class="hljs-number">4002</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   148|</span></span>     <span class="hljs-number"><span class="hljs-number">1716</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   148|</span></span>     <span class="hljs-number"><span class="hljs-number">4520</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   148|</span></span>      <span class="hljs-number"><span class="hljs-number">951</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   148|</span></span>     <span class="hljs-number"><span class="hljs-number">1817</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   463|</span></span>     <span class="hljs-number"><span class="hljs-number">2634</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   463|</span></span>     <span class="hljs-number"><span class="hljs-number">2795</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">1946</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">4431</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>      <span class="hljs-number"><span class="hljs-number">566</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">2179</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">3758</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">2434</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">1793</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">1620</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   471|</span></span>     <span class="hljs-number"><span class="hljs-number">1572</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   833|</span></span>      <span class="hljs-number"><span class="hljs-number">957</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   833|</span></span>     <span class="hljs-number"><span class="hljs-number">3140</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
 <span class="hljs-params"><span class="hljs-params">|   833|</span></span>     <span class="hljs-number"><span class="hljs-number">1087</span></span><span class="hljs-params"><span class="hljs-params">|                      null|</span></span>       <span class="hljs-literal"><span class="hljs-literal">false</span></span><span class="hljs-params"><span class="hljs-params">|              </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">true</span></span></span><span class="hljs-params">|</span></span>
</code></pre>
  </li>
  <li>
    <p>Run the following in a new code cell to create a new DataFrame to hold only top preferred products where both <strong>IsTopProduct</strong> and <strong>IsPreferredProduct</strong> are true:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyspark.sql.functions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> *

 topPreferredProducts = (topPurchases
     .filter( col(<span class="hljs-string"><span class="hljs-string">"IsTopProduct"</span></span>) == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)
     .filter( col(<span class="hljs-string"><span class="hljs-string">"IsPreferredProduct"</span></span>) == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)
     .orderBy( col(<span class="hljs-string"><span class="hljs-string">"ItemsPurchasedLast12Months"</span></span>).desc() ))

 topPreferredProducts.show(<span class="hljs-number"><span class="hljs-number">100</span></span>)
</code></pre>

    <p><a href="images/notebook-top-products-top-preferred-df.png" target="_blank"><img src="images/notebook-top-products-top-preferred-df.png" alt="The cell code and output are displayed." title="Notebook cell"></a></p>
  </li>
  <li>
    <p>Run the following in a new code cell to create a new temporary view by using SQL:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-sql hljs">%%sql

<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TEMPORARY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> top_5_products
<span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> UserId, ProductId, ItemsPurchasedLast12Months
    <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> *,
                row_number() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UserId <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ItemsPurchasedLast12Months <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> seqnum
        <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> top_purchases
        ) a
    <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> seqnum &lt;= <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> IsTopProduct == <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> IsPreferredProduct = <span class="hljs-literal"><span class="hljs-literal">true</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> a.UserId
</code></pre>

    <p>Note that there is no output for the above query. The query uses the <strong>top_purchases</strong> temporary view as a source and applies a <strong>row_number() over</strong> method to apply a row number for the records for each user where <strong>ItemsPurchasedLast12Months</strong> is greatest. The <strong>where</strong> clause filters the results so we only retrieve up to five products where both <strong>IsTopProduct</strong> and <strong>IsPreferredProduct</strong> are set to true. This gives us the top five most purchased products for each user where those products are <em>also</em> identified as their favorite products, according to their user profile stored in Azure Cosmos DB.</p>
  </li>
  <li>
    <p>Run the following in a new code cell to create and display a new DataFrame that stores the results of the <strong>top_5_products</strong> temporary view you created in the previous cell:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-python hljs">top5Products = sqlContext.table(<span class="hljs-string"><span class="hljs-string">"top_5_products"</span></span>)

top5Products.show(<span class="hljs-number"><span class="hljs-number">100</span></span>)
</code></pre>

    <p>You should see an output similar to the following, which displays the top five preferred products per user:</p>

    <p><a href="images/notebook-top-products-top-5-preferred-output.png" target="_blank"><img src="images/notebook-top-products-top-5-preferred-output.png" alt="The top five preferred products are displayed per user." title="Top 5 preferred products"></a></p>
  </li>
  <li>
    <p>Run the following in a new code cell to compare the number of top preferred products to the top five preferred products per customer:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-python hljs">print(<span class="hljs-string"><span class="hljs-string">'before filter: '</span></span>, topPreferredProducts.count(), <span class="hljs-string"><span class="hljs-string">', after filter: '</span></span>, top5Products.count())
</code></pre>

    <p>The output should be similar to:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">before</span></span> filter:  <span class="hljs-number"><span class="hljs-number">997817</span></span> , after filter:  <span class="hljs-number"><span class="hljs-number">85015</span></span>
</code></pre>
  </li>
  <li>
    <p>Run the following in a new code cell to calculate the top five products overall, based on those that are both preferred by customers and purchased the most</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-python hljs">top5ProductsOverall = (top5Products.select(<span class="hljs-string"><span class="hljs-string">"ProductId"</span></span>,<span class="hljs-string"><span class="hljs-string">"ItemsPurchasedLast12Months"</span></span>)
    .groupBy(<span class="hljs-string"><span class="hljs-string">"ProductId"</span></span>)
    .agg( sum(<span class="hljs-string"><span class="hljs-string">"ItemsPurchasedLast12Months"</span></span>).alias(<span class="hljs-string"><span class="hljs-string">"Total"</span></span>) )
    .orderBy( col(<span class="hljs-string"><span class="hljs-string">"Total"</span></span>).desc() )
    .limit(<span class="hljs-number"><span class="hljs-number">5</span></span>))

top5ProductsOverall.show()
</code></pre>

    <p>In this cell, we grouped the top five preferred products by product ID, summed up the total items purchased in the last 12 months, sorted that value in descending order, and returned the top five results. Your output should be similar to the following:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="hljs ruby">+---------+-----+
<span class="hljs-params"><span class="hljs-params">|ProductId|</span></span>Total<span class="hljs-params"><span class="hljs-params">|
+---------+-----+
|</span></span>      <span class="hljs-number"><span class="hljs-number">347</span></span><span class="hljs-params"><span class="hljs-params">| 4523|</span></span>
<span class="hljs-params"><span class="hljs-params">|     4833|</span></span> <span class="hljs-number"><span class="hljs-number">4314</span></span><span class="hljs-params"><span class="hljs-params">|
|</span></span>     <span class="hljs-number"><span class="hljs-number">3459</span></span><span class="hljs-params"><span class="hljs-params">| 4233|</span></span>
<span class="hljs-params"><span class="hljs-params">|     2486|</span></span> <span class="hljs-number"><span class="hljs-number">4135</span></span><span class="hljs-params"><span class="hljs-params">|
|</span></span>     <span class="hljs-number"><span class="hljs-number">2107</span></span><span class="hljs-params"><span class="hljs-params">| 4113|</span></span>
+---------+-----+
</code></pre>
  </li>
  <li>
    <p>We are going to execute this notebook from a pipeline. We want to pass in a parameter that sets a <strong>runId</strong> variable value that will be used to name the Parquet file. Run the following in a new code cell:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> uuid

<span class="hljs-comment"><span class="hljs-comment"># Generate random GUID</span></span>
runId = uuid.uuid4()
</code></pre>

    <p>We are using the <strong>uuid</strong> library that comes with Spark to generate a random GUID. We want to override the <code>runId</code> variable with a parameter passed in by the pipeline. To do this, we need to toggle this as a parameter cell.</p>
  </li>
  <li>
    <p>Select the actions ellipses <strong>(…)</strong> in the mini toolbar above the cell, then select <strong>Toggle parameter cell</strong>.</p>

    <p><a href="images/toggle-parameter-cell.png" target="_blank"><img src="images/toggle-parameter-cell.png" alt="The menu item is highlighted." title="Toggle parameter cell"></a></p>

    <p>After toggling this option, you will see the word <strong>Parameters</strong> at the bottom right of the cell, indicating it is a parameter cell.</p>
  </li>
  <li>
    <p>Add the following code to a new code cell to use the <strong>runId</strong> variable as the Parquet filename in the <em>/top5-products/</em> path in the primary data lake account. Replace <strong><em>SUFFIX</em></strong> in the path with the unique suffix of your primary data lake account - you’ll find this in <strong>Cell 1</strong> at the top of the page. When you’ve updated the code, run the cell.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="language-python hljs">%%pyspark

top5ProductsOverall.write.parquet(<span class="hljs-string"><span class="hljs-string">'abfss://wwi-02@asadatalakeSUFFIX.dfs.core.windows.net/top5-products/'</span></span> + str(runId) + <span class="hljs-string"><span class="hljs-string">'.parquet'</span></span>)
</code></pre>

    <p><a href="images/datalake-path-in-cell.png" target="_blank"><img src="images/datalake-path-in-cell.png" alt="The path is updated with the name of the primary data lake account." title="Data lake name"></a></p>
  </li>
  <li>
    <p>Verify that the file was written to the data lake. In the <strong>Data</strong> hub, select the <strong>Linked</strong> tab. Expand the primary data lake storage account and select the <strong>wwi-02</strong> container. Navigate to the <strong>top5-products</strong> folder (refresh the folders in the root of the container of necessary). You should see a folder for the Parquet file in the directory with a GUID as the file name.</p>

    <p><a href="images/top5-products-parquet.png" target="_blank"><img src="images/top5-products-parquet.png" alt="The parquet file is highlighted." title="Top 5 products parquet"></a></p>
  </li>
  <li>
    <p>Return to the notebook. Select <strong>Stop session</strong> on the upper-right of the notebook, and confirm you want to stop the session now when prompted. We want to stop the session to free up the compute resources for when we run the notebook inside the pipeline in the next section.</p>

    <p><a href="images/notebook-stop-session.png" target="_blank"><img src="images/notebook-stop-session.png" alt="The stop session button is highlighted." title="Stop session"></a></p>
  </li>
</ol>

<h3 id="task-2-add-the-notebook-to-the-pipeline">Task 2: Add the Notebook to the pipeline</h3>

<p>Tailwind Traders wants to execute this notebook after the Mapping Data Flow runs as part of their orchestration process. To do this, we will add this notebook to our pipeline as a new Notebook activity.</p>

<ol>
  <li>
    <p>Return to the <strong>Calculate Top 5 Products</strong> notebook.</p>
  </li>
  <li>
    <p>Select the <strong>Add to pipeline</strong> button at the top-right corner of the notebook, then select <strong>Existing pipeline</strong>.</p>

    <p><a href="images/add-to-pipeline.png" target="_blank"><img src="images/add-to-pipeline.png" alt="The add to pipeline button is highlighted." title="Add to pipeline"></a></p>
  </li>
  <li>
    <p>Select the <strong>User Profiles to Datalake</strong> pipeline, then select <strong>Add</strong>.</p>
  </li>
  <li>
    <p>Synapse Studio adds the Notebook activity to the pipeline. Rearrange the <strong>Notebook activity</strong> so it sits to the right of the <strong>Data flow activity</strong>. Select the <strong>Data flow activity</strong> and drag a <strong>Success</strong> activity pipeline connection <strong>green box</strong> to the <strong>Notebook activity</strong>.</p>

    <p><a href="images/success-activity-datalake.png" target="_blank"><img src="images/success-activity-datalake.png" alt="The green arrow is highlighted." title="Success activity"></a></p>

    <p>The Success activity arrow instructs the pipeline to execute the Notebook activity after the Data flow activity successfully runs.</p>
  </li>
  <li>
    <p>Select the <strong>Notebook activity</strong>, select the <strong>Settings</strong> tab, expand <strong>Base parameters</strong>, and select <strong>+ New</strong>. Enter <strong><code>runId</code></strong> in the <strong>Name</strong> field. Set the the <strong>Type</strong> to <strong>String</strong> and the <strong>Value</strong> to <strong>Add dynamic content</strong>.</p>

    <p><a href="images/notebook-activity-settings-datalake.png" target="_blank"><img src="images/notebook-activity-settings-datalake.png" alt="The settings are displayed." title="Settings"></a></p>
  </li>
  <li>
    <p>In the <strong>Add dynamic content</strong> pane, expand <strong>System variables</strong>, and select <strong>Pipeline run ID</strong>. This adds <em><a href="https://github.com/pipeline" class="user-mention">@pipeline</a>().RunId</em> to the dynamic content box. Then click <strong>OK</strong> to close the dialog.</p>

    <p>The Pipeline run ID value is a unique GUID assigned to each pipeline run. We will use this value for the name of the Parquet file by passing this value in as the <code>runId</code> Notebook parameter. We can then look through the pipeline run history and find the specific Parquet file created for each pipeline run.</p>
  </li>
  <li>
    <p>Select <strong>Publish all</strong> then <strong>Publish</strong> to save your changes.</p>

    <p><a href="images/publish-all-1.png" target="_blank"><img src="images/publish-all-1.png" alt="Publish all is highlighted." title="Publish all"></a></p>
  </li>
</ol>

<h3 id="task-3-run-the-updated-pipeline">Task 3: Run the updated pipeline</h3>

<blockquote>
  <p><strong>Note</strong>: The updated pipeline can take 10 minutes or more to run!</p>
</blockquote>

<ol>
  <li>
    <p>After publishing is complete, select <strong>Add trigger</strong>, then <strong>Trigger now</strong> to run the updated pipeline.</p>

    <p><a href="images/trigger-updated-pipeline-datalake.png" target="_blank"><img src="images/trigger-updated-pipeline-datalake.png" alt="The trigger menu item is highlighted." title="Trigger pipeline"></a></p>
  </li>
  <li>
    <p>Select <strong>OK</strong> to run the trigger.</p>

    <p><a href="images/pipeline-run-trigger.png" target="_blank"><img src="images/pipeline-run-trigger.png" alt="The OK button is highlighted." title="Pipeline run"></a></p>
  </li>
  <li>
    <p>Navigate to the <strong>Monitor</strong> hub.</p>

    <p><a href="images/monitor-hub.png" target="_blank"><img src="images/monitor-hub.png" alt="The Monitor hub menu item is selected." title="Monitor hub"></a></p>
  </li>
  <li>
    <p>Select <strong>Pipeline runs</strong> and wait for the pipeline run to successfully complete. You may need to refresh the view.</p>

    <p><a href="images/pipeline-user-profiles-updated-run-complete.png" target="_blank"><img src="images/pipeline-user-profiles-updated-run-complete.png" alt="The pipeline run succeeded." title="Pipeline runs"></a></p>

    <blockquote>
      <p>It can take over 10 minutes for the run to complete with the addition of the notebook activity.</p>
    </blockquote>
  </li>
  <li>
    <p>Select the name of the pipeline (<strong>User profiles to Datalake</strong>) to view the pipeline’s activity runs.</p>
  </li>
  <li>
    <p>This time, we see both the <strong>Data flow</strong> activity, and the new <strong>Notebook</strong> activity. Make note of the <strong>Pipeline run ID</strong> value. We will compare this to the Parquet file name generated by the notebook. Select the <strong>Calculate Top 5 Products</strong> notebook name to view its details.</p>

    <p><a href="images/pipeline-run-details-datalake.png" target="_blank"><img src="images/pipeline-run-details-datalake.png" alt="The pipeline run details are displayed." title="Write User Profile Data to ASA details"></a></p>
  </li>
  <li>
    <p>Here we see the notebook run details. You can select the <strong>Playback</strong> button to watch a playback of the progress through the <strong>jobs</strong>. At the bottom, you can view the <strong>Diagnostics</strong> and <strong>Logs</strong> with different filter options. Hover over a stage to view its details, such as the duration, total tasks, data details, etc. Select the <strong>View details</strong> link on the <strong>stage</strong> to view its details.</p>

    <p><a href="images/notebook-run-details.png" target="_blank"><img src="images/notebook-run-details.png" alt="The run details are displayed." title="Notebook run details"></a></p>
  </li>
  <li>
    <p>The Spark application UI opens in a new tab where we can see the stage details. Expand the <strong>DAG Visualization</strong> to view the stage details.</p>

    <p><a href="images/spark-stage-details.png" target="_blank"><img src="images/spark-stage-details.png" alt="The Spark stage details are displayed." title="Stage details"></a></p>
  </li>
  <li>
    <p>Close the Spark details tab, and in Synapse Studio, navigate back to the <strong>Data</strong> hub.</p>

    <p><a href="images/data-hub.png" target="_blank"><img src="images/data-hub.png" alt="Data hub." title="Data hub"></a></p>
  </li>
  <li>
    <p>Select the <strong>Linked</strong> tab, select the <strong>wwi-02</strong> container on the primary data lake storage account, navigate to the <strong>top5-products</strong> folder, and verify that a folder exists for the Parquet file whose name matches the <strong>Pipeline run ID</strong>.</p>

    <p><a href="images/parquet-from-pipeline-run.png" target="_blank"><img src="images/parquet-from-pipeline-run.png" alt="The file is highlighted." title="Parquet file from pipeline run"></a></p>

    <p>As you can see, we have a file whose name matches the <strong>Pipeline run ID</strong> we noted earlier:</p>

    <p><a href="images/pipeline-run-id.png" target="_blank"><img src="images/pipeline-run-id.png" alt="The Pipeline run ID is highlighted." title="Pipeline run ID"></a></p>

    <p>These values match because we passed in the Pipeline run ID to the <strong>runId</strong> parameter on the Notebook activity.</p>
  </li>
</ol>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/DP-203-Data-Engineer" target="_blank" class="ml-2">
                    MicrosoftLearning/DP-203-Data-Engineer
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D928deb11f009d00944c1feae30c16de739b6478a.js"></script>



</body></html>