<!DOCTYPE html><html lang="en"><head>
        <title>
            dp-080-Transact-SQL
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D2df2a36a02d76b7c7d5687e30ec4acf097392490.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                dp-080-Transact-SQL
            </a>
            <a href="https://github.com/MicrosoftLearning/dp-080-Transact-SQL" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#use-a-transaction-to-insert-data-into-multiple-tables">Use a transaction to insert data into multiple tables</a></li><li class="nav-item"><a class="nav-link" href="#use-a-transaction-to-insert-data-into-multiple-tables-1">Use a transaction to insert data into multiple tables</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="implement-transactions-with-transact-sql">Implement transactions with Transact SQL</h1>

<p>In this lab, you’ll use T-SQL statements to see the impact of using transactions in the <strong>AdventureWorks</strong> database. For your reference, the following diagram shows the tables in the database (you may need to resize the pane to see them clearly).</p>

<p><a href="images/adventureworks-erd.png" target="_blank"><img src="images/adventureworks-erd.png" alt="An entity relationship diagram of the AdventureWorks database"></a></p>

<blockquote>
  <p><strong>Note</strong>: If you’re familiar with the standard <strong>AdventureWorks</strong> sample database, you may notice that in this lab we are using a simplified version that makes it easier to focus on learning Transact-SQL syntax.</p>
</blockquote>

<h2 id="insert-data-without-transactions">Insert data without transactions</h2>

<p>Consider a website that needs to store customer information. As part of the customer registration, data about a customer and their address need to stored. A customer without an address will cause problems for the shipping when orders are made.</p>

<p>In this exercise you’ll use a transaction to ensure that when a row is inserted into the <strong>Customer</strong> and <strong>Address</strong> tables, a row is also added to the <strong>CustomerAddress</strong> table. If one insert fails, then all will fail.</p>

<ol>
  <li>Start Azure Data Studio.</li>
  <li>In the <strong>Connections</strong> pane, double-click the <strong>AdventureWorks</strong> server. A green dot will appear when the connection is successful.</li>
  <li>Right click the <strong>AdventureWorks</strong> server and select <strong>New Query</strong>. A new query window is displayed with a connection to the AdventureWorks database.</li>
  <li>Enter the following T-SQL code into the query window:</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt,    rowguid, ModifiedDate) 
<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,  <span class="hljs-string"><span class="hljs-string">'Norman'</span></span>,<span class="hljs-string"><span class="hljs-string">'Newcustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'norman0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,    ModifiedDate) 
<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, rowguid, ModifiedDate)
<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, NEWID(), <span class="hljs-string"><span class="hljs-string">'12-1-20212'</span></span>); 
</code></pre>

<ol>
  <li>Select <strong>⏵Run</strong> at the top of the query window, or press the <kbd>F5</kbd> key to run the code.</li>
  <li>Note the output messages, which should look like this:</li>
</ol>

<blockquote>
  <p>(1 row affected)</p>

  <p>(1 row affected)</p>

  <p>Conversion failed when converting date and/or time from character string.</p>
</blockquote>

<p>Two of the statements appear to have succeeded, but the third failed.</p>

<ol>
  <li>Right click the <strong>AdventureWorks</strong> server and select <strong>New Query</strong>. A new query window is displayed with a connection to the AdventureWorks database.</li>
  <li>Enter the following T-SQL code into the new query window:</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SalesLT.Customer <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ModifiedDate <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;
</code></pre>

<p>A row for <em>Norman Newcustomer</em> was inserted into the Customer table (and anotherw as in serted into the Address table). However, the insert for the CustomerAddress table failed with a duplicate key error. The database is now inconsistent as there’s no link between the new customer and their address.</p>

<p>To fix this, you’ll need to delete the two rows that were inserted.</p>

<ol>
  <li>Right click the <strong>AdventureWorks</strong> server and select <strong>New Query</strong>. A new query window is displayed with a connection to the AdventureWorks database.</li>
  <li>Enter the following T-SQL code into the new query window and run it to delete the inconsistent data:</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SalesLT.Customer
<span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> CustomerID = <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>);

<span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> SalesLT.Address
<span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> AddressID = <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>);
</code></pre>

<blockquote>
  <p><strong>Note</strong>: This code only works because you are the only user working in the database. In a real scenario, you would need to ascertain the IDs of the records that were inserted and specify them explicitly in case new customer and address records had been inserted since you ran your original code.</p>
</blockquote>

<h2 id="insert-data-as-using-a-transaction">Insert data as using a transaction</h2>

<p>All of these statements need to run as a single atomic transaction. If any one of them fails, then all statements should fail. Let’s group them together in a transaction.</p>

<ol>
  <li>Switch back to the original query window with the INSERT statements, and modify the code to enclose the original INSERT statements in a transaction, like this:</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt,    rowguid, ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,  <span class="hljs-string"><span class="hljs-string">'Norman'</span></span>,<span class="hljs-string"><span class="hljs-string">'Newcustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'norman0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,    ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, rowguid, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, NEWID(), <span class="hljs-string"><span class="hljs-string">'12-1-20212'</span></span>);

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
</code></pre>

<ol>
  <li>Run the code, and review the output message:</li>
</ol>

<blockquote>
  <p>(1 row affected)</p>

  <p>(1 row affected)</p>

  <p>Msg 241, Level 16, State 1, Line 9
Conversion failed when converting date and/or time from character string.</p>
</blockquote>

<p>Again, it looks like the first two statements succeeded and the third one failed.</p>

<ol>
  <li>Switch to the query containing the SELECT statement to check for a new customer record, and run it. This time, there should be no record for <em>Norman Newcustomer</em>. Using a transaction with these statements has triggered an automatic rollback. The level 16 conversion error is high enough to cause all statements to be rolled back.</li>
</ol>

<h2 id="handle-errors-and-explicitly-rollback-transactions">Handle errors and explicitly rollback transactions</h2>

<p>Lower level errors can require that you explicitly handle the error and rollback any active transactions.</p>

<ol>
  <li>Switch back to the original INSERT query script, and modify the transaction as follows:</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt,    rowguid, ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,  <span class="hljs-string"><span class="hljs-string">'Norman'</span></span>,<span class="hljs-string"><span class="hljs-string">'Newcustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'norman0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,    ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, rowguid, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, <span class="hljs-string"><span class="hljs-string">'16765338-dbe4-4421-b5e9-3836b9278e63'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
</code></pre>

<ol>
  <li>Run the modified code. The output message this time is:</li>
</ol>

<blockquote>
  <p>(1 row affected)</p>

  <p>(1 row affected)</p>

  <p>Msg 2627, Level 14, State 1, Line 9
Violation of UNIQUE KEY constraint ‘AK_CustomerAddress_rowguid’. Cannot insert duplicate key in object ‘SalesLT.CustomerAddress’. The duplicate key value is (16765338-dbe4-4421-b5e9-3836b9278e63).</p>
</blockquote>

<ol>
  <li>
    <p>Switch back to the query window containing the SELECT customer statement and run the query to see if the <em>Norman Newcustomer</em> row was added.</p>

    <p>Even though an error occurred in the transaction, a new record has been added and the database is once again inconsistent.</p>
  </li>
  <li>
    <p>Switch back to the query window containing the DELETE statements, and run it to delete the new inconsistent data.</p>

    <p>Enclosing the statements in a transaction isn’t enough to deal with lower priority errors. You need to catch these errors and explicitly use a ROLLBACK statement. We need to combine batch error handling and transactions to resolve our data consistency issue.</p>
  </li>
  <li>
    <p>Switch back to the original query window, and modify the code to enclose the transaction in a TRY/CATCH block, and use the ROLLBACK TRANSACTION statement if an error occurs.</p>
  </li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt,    rowguid, ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,  <span class="hljs-string"><span class="hljs-string">'Norman'</span></span>,<span class="hljs-string"><span class="hljs-string">'Newcustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'norman0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,    ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, rowguid, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, <span class="hljs-string"><span class="hljs-string">'16765338-dbe4-4421-b5e9-3836b9278e63'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
PRINT 'Transaction committed.';

<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH
    <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
    PRINT 'Transaction rolled back.';
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;    
</code></pre>

<ol>
  <li>Run the code and review the results:</li>
</ol>

<blockquote>
  <p>Started executing query at Line 1</p>

  <p>(1 row affected)</p>

  <p>(1 row affected)</p>

  <p>(0 rows affected)</p>
</blockquote>

<p>Now there isn’t any error message so it looks like two rows were affected.</p>

<ol>
  <li>
    <p>Switch back to the query window containing the SELECT customer statement and run the query to see if the <em>Norman Newcustomer</em> row was added.</p>

    <p>Note that the most recently modified customer record is <u>not</u> for <em>Norman Newcustomer</em> - the INSERT statement that succeeded has been rolled back to ensure the database remains consistent.</p>
  </li>
</ol>

<h2 id="check-the-transaction-state-before-rolling-back">Check the transaction state before rolling back</h2>

<p>The CATCH block will handle errors that occur anywhere in the TRY block, so if an error were to occur outside of the BEGIN TRANSACTION…COMMIT TRANSACTION block, there would be no active transaction to roll back. To avoid this issue, you can check the current transaction state with XACT_STATE(), which returns one of the following values:</p>

<ul>
  <li>
<strong>-1</strong>: There is an active transaction in process that cannot be committed.</li>
  <li>
<strong>0</strong>: There are no transactions in process.</li>
  <li>
<strong>1</strong>: There is an active transaction in process that can be committed or rolled back.</li>
</ul>

<ol>
  <li>Back in the original query window, surround the ROLLBACK statements with an IF statement checking the value, so your code looks like this.</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt, rowguid, ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Norman'</span></span>,<span class="hljs-string"><span class="hljs-string">'Newcustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'norman0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,  ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, rowguid, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, <span class="hljs-string"><span class="hljs-string">'16765338-dbe4-4421-b5e9-3836b9278e63'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
PRINT 'Transaction committed.';

<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH
  PRINT <span class="hljs-string"><span class="hljs-string">'An error occurred.'</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (XACT_STATE()) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>
      PRINT <span class="hljs-string"><span class="hljs-string">'Transaction in process.'</span></span>
      <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
      PRINT 'Transaction rolled back.';
  <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH
</code></pre>

<ol>
  <li>
    <p>Run the modified code, and review the output - noting that an in-process transaction was detected and rolled back.</p>
  </li>
  <li>
    <p>Modify the code as follows to avoid specifying an explicit <strong>rowid</strong> (which was caused the duplicate key error)</p>
  </li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt, rowguid, ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Norman'</span></span>,<span class="hljs-string"><span class="hljs-string">'Newcustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'norman0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,  ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
PRINT 'Transaction committed.';
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH
  PRINT <span class="hljs-string"><span class="hljs-string">'An error occurred.'</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (XACT_STATE()) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>
      PRINT <span class="hljs-string"><span class="hljs-string">'Transaction in process.'</span></span>
      <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
      PRINT 'Transaction rolled back.';
  <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH
</code></pre>

<ol>
  <li>
    <p>Run the code, and note that this time, all three INSERT statement succeed.</p>
  </li>
  <li>
    <p>Switch back to the query window containing the SELECT customer statement and run the query to verify that the <em>Norman Newcustomer</em> row was added.</p>
  </li>
  <li>
    <p>Back in the original query window, modify the code to insert another customer - this time throwing an error within the TRY block after the transaction has been committed:</p>
  </li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt, rowguid, ModifiedDate)     <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'Ann'</span></span>,<span class="hljs-string"><span class="hljs-string">'Othercustomr'</span></span>,<span class="hljs-string"><span class="hljs-string">'ann0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,  ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'6388 Lake City Way'</span></span>, <span class="hljs-string"><span class="hljs-string">'Burnaby'</span></span>,<span class="hljs-string"><span class="hljs-string">'British Columbia'</span></span>,<span class="hljs-string"><span class="hljs-string">'Canada'</span></span>,<span class="hljs-string"><span class="hljs-string">'V5A 3A6'</span></span>,NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
PRINT 'Transaction committed.';

THROW 51000, 'Some kind of error', 1;

<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH
  PRINT <span class="hljs-string"><span class="hljs-string">'An error occurred.'</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (XACT_STATE()) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>
      PRINT <span class="hljs-string"><span class="hljs-string">'Transaction in process.'</span></span>
      <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
      PRINT 'Transaction rolled back.';
  <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH
</code></pre>

<ol>
  <li>
    <p>Run the code and review the output. All three INSERT statements should succeed, but an error is caught by the CATCH block.</p>
  </li>
  <li>
    <p>Switch back to the query window containing the SELECT customer statement and run the query to verify that a record for <em>Ann Othercustomer</em> has been inserted. The transaction succeeded and was not rolled back, even though an error subsequently occurred.</p>
  </li>
</ol>

<h2 id="explore-transaction-concurrency">Explore transaction concurrency</h2>

<p>Isolation levels determine the visibility of data modifications made in transactions across multiple sessions with the database. On-premises SQL Server has a default isolation level of <strong>READ_COMMITTED_SNAPSHOT_OFF</strong>. This level of isolation will hold locks on rows while a transaction is acting on it. For example, inserting a customer into the customer table. If the update takes a long time to run, any queries on that table from other sessions will be blocked from running until the transaction is committed or rolled back.</p>

<ol>
  <li>In Azure Data Studio, close all open query panes.</li>
  <li>In the <strong>Connections</strong> pane, ensure that the <strong>AdventureWorks</strong> server has a green icon indicating an active connection. Then, in the header for the <strong>Servers</strong> section, use the <strong>new Connection</strong> icon to create a new connection with the following properties:
    <ul>
      <li>
<strong>Connection type</strong>: Microsoft SQL Server</li>
      <li>
<strong>Server</strong>: (local)\sqlexpress</li>
      <li>
<strong>Authentication type</strong>: Windows Authentication</li>
      <li>
<strong>Database</strong>: adventureworks</li>
    </ul>
  </li>
  <li>After the new connection has been made, verify that the <strong>Connections</strong> pane now includes two connections (which represent two different connections to the same database):
    <ul>
      <li><strong>AdventureWorks</strong></li>
      <li><strong>(local)\sqlexpress</strong></li>
    </ul>
  </li>
  <li>Right-click the <strong>AdventureWorks</strong> and create a new query. Then enter the following code (but do <u>not</u> run it yet):</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Customer (NameStyle, FirstName, LastName, EmailAddress, PasswordHash, PasswordSalt,    rowguid, ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,  <span class="hljs-string"><span class="hljs-string">'Yeta'</span></span>,<span class="hljs-string"><span class="hljs-string">'Nothercustomer'</span></span>,<span class="hljs-string"><span class="hljs-string">'yeta0@adventure-works.com'</span></span>,<span class="hljs-string"><span class="hljs-string">'U1/CrPqSzwLTtwgBehfpIl7f1LHSFpZw1qnG1sMzFjo='</span></span>,<span class="hljs-string"><span class="hljs-string">'QhHP+y8='</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.Address (AddressLine1, City, StateProvince, CountryRegion, PostalCode, rowguid,    ModifiedDate) 
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'2067 Park Lane'</span></span>, <span class="hljs-string"><span class="hljs-string">'Redmond'</span></span>,<span class="hljs-string"><span class="hljs-string">'Washington'</span></span>,<span class="hljs-string"><span class="hljs-string">'United States'</span></span>,<span class="hljs-string"><span class="hljs-string">'98007'</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

    <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.CustomerAddress (CustomerID, AddressID, AddressType, rowguid, ModifiedDate)
    <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Customer'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">IDENT_CURRENT</span></span>(<span class="hljs-string"><span class="hljs-string">'SalesLT.Address'</span></span>), <span class="hljs-string"><span class="hljs-string">'Home'</span></span>, NEWID(), <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>());

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
</code></pre>

<ol>
  <li>Right-click the <strong>(loval)\sqlexpress</strong> connection and create a new query. Then enter the following code:</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SalesLT.Customer
</code></pre>

<ol>
  <li>
    <p>Run the SELECT COUNT(*) query and note the number of counted rows. Notice the query returns results quickly.</p>
  </li>
  <li>
    <p>Return the transaction query for the <strong>AdventureWorks</strong> connection and highlight BEGIN TRANSACTION and INSERT statements (but <u>not</u> the COMMIT TRANSACTION; statement) Then use the <strong>⏵Run</strong> to run only thr highlighted code.</p>

    <p>As this is in a transaction that hasn’t been committed, running the SELECT COUNT(*) query in the other window will be blocked.</p>
  </li>
  <li>
    <p>In the other query pane, run the SELECT COUNT(*) query and note that the query doesn’t finish.</p>
  </li>
  <li>
    <p>To prove the query is blocked by the transaction, highlight and run the COMMIT TRANSACTION; statement in the other window.</p>
  </li>
  <li>
    <p>Switch back to the SELECT COUNT(*)`query, and verify that it completes and returns the correct number of customers.</p>
  </li>
</ol>

<h2 id="change-how-concurrency-is-handled-on-a-database">Change how concurrency is handled on a database</h2>

<p>Concurrency can be changed to allow database queries on tables while there are transactions inserting or updating them. To change this enable READ_COMMITTED_SNAPSHOT_ON.</p>

<ol>
  <li>Create a new query from the <strong>AdventureWorks</strong> connection, and run this Transact-SQL code in it.</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> AdventureWorks <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> READ_COMMITTED_SNAPSHOT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IMMEDIATE</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>Switch to the transaction query pane that’s connected to the <strong>AdventureWorks</strong> connection, and once again highlight the BEGIN TRANSACTION and INSERT statements (but <u>not</u> the COMMIT TRANSACTION; statement) and run the ighlighted code.</li>
  <li>Switch to the query pane with the SELECT COUNT(*) query (connected to the <strong>(local)\sqlexpress</strong> connection) and run it. The query results reflect the current state of the database as the INSERT statement hasn’t been committed yet.</li>
  <li>In the transaction query pane, highlight the COMMIT TRANSACTION; statement and run it.</li>
  <li>Re-run the SELECT COUNT(*) query and note that the total customers has increased by 1.</li>
</ol>

<p>Be careful when selecting what isolation levels to use in a database. In some scenarios returning the current state of data before a transaction has been committed is worse than a query being blocked and waiting for all the data to be in the correct state.</p>

<h2 id="challenge">Challenge</h2>

<p>Now it’s time to try using what you’ve learned.</p>

<blockquote>
  <p><strong>Tip</strong>: Try to determine the appropriate solution for yourself. If you get stuck, a suggested solution is provided at the end of this lab.</p>
</blockquote>

<h3 id="use-a-transaction-to-insert-data-into-multiple-tables">Use a transaction to insert data into multiple tables</h3>

<p>When a sales order header is inserted, it must have at least one corresponding sales order detail record. Currently, you use the following code to accomplish this:</p>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment">-- Get the highest order ID and add 1</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @OrderID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @OrderID = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(SalesOrderID) + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SalesLT.SalesOrderHeader;

<span class="hljs-comment"><span class="hljs-comment">-- Insert the order header</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.SalesOrderHeader (SalesOrderID, OrderDate, DueDate, CustomerID, ShipMethod)
<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@OrderID, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">month</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'CARGO TRANSPORT'</span></span>);

<span class="hljs-comment"><span class="hljs-comment">-- Insert one or more order details</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.SalesOrderDetail (SalesOrderID, OrderQty, ProductID, UnitPrice)
<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@OrderID, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">712</span></span>, <span class="hljs-number"><span class="hljs-number">8.99</span></span>);
</code></pre>

<p>You need to encapsulate this code in a transaction so that all inserts succeed or fail as an atomic unit or work.</p>

<h2 id="challenge-solution">Challenge solution</h2>

<h3 id="use-a-transaction-to-insert-data-into-multiple-tables-1">Use a transaction to insert data into multiple tables</h3>

<p>The following code encloses the logic to insert a new order and order detail in a transaction, rolling back the transaction if an error occurs.</p>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">-- Get the highest order ID and add 1</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @OrderID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>;
  <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @OrderID = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(SalesOrderID) + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SalesLT.SalesOrderHeader;

  <span class="hljs-comment"><span class="hljs-comment">-- Insert the order header</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.SalesOrderHeader (SalesOrderID, OrderDate, DueDate, CustomerID, ShipMethod)
  <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@OrderID, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">month</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'CARGO TRANSPORT'</span></span>);
  
  <span class="hljs-comment"><span class="hljs-comment">-- Insert one or more order details</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.SalesOrderDetail (SalesOrderID, OrderQty, ProductID, UnitPrice)
  <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@OrderID, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">712</span></span>, <span class="hljs-number"><span class="hljs-number">8.99</span></span>);

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
PRINT 'Transaction committed.';

<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH
  PRINT <span class="hljs-string"><span class="hljs-string">'An error occurred.'</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (XACT_STATE()) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>
      PRINT <span class="hljs-string"><span class="hljs-string">'Transaction in process.'</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
    PRINT 'Transaction rolled back.'; 
  <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH
</code></pre>

<p>To test the transaction, try to insert an order detail with an invalid product ID, like this:</p>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">-- Get the highest order ID and add 1</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @OrderID <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>;
  <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @OrderID = <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(SalesOrderID) + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> SalesLT.SalesOrderHeader;

  <span class="hljs-comment"><span class="hljs-comment">-- Insert the order header</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.SalesOrderHeader (SalesOrderID, OrderDate, DueDate, CustomerID, ShipMethod)
  <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@OrderID, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>(), <span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">month</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GETDATE</span></span>()), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'CARGO TRANSPORT'</span></span>);
  
  <span class="hljs-comment"><span class="hljs-comment">-- Insert one or more order details</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> SalesLT.SalesOrderDetail (SalesOrderID, OrderQty, ProductID, UnitPrice)
  <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@OrderID, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'Invalid product'</span></span>, <span class="hljs-number"><span class="hljs-number">8.99</span></span>);

<span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
PRINT 'Transaction committed.';

<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY
<span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH
  PRINT <span class="hljs-string"><span class="hljs-string">'An error occurred.'</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (XACT_STATE()) &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>
      PRINT <span class="hljs-string"><span class="hljs-string">'Transaction in process.'</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>;
    PRINT 'Transaction rolled back.'; 
  <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH
</code></pre>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/dp-080-Transact-SQL" target="_blank" class="ml-2">
                    MicrosoftLearning/dp-080-Transact-SQL
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D2df2a36a02d76b7c7d5687e30ec4acf097392490.js"></script>



</body></html>