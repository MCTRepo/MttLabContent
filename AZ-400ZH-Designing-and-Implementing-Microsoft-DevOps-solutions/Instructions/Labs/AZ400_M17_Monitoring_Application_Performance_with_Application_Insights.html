<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-400ZH-Designing-and-Implementing-Microsoft-DevOps-solutions
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-400ZH-Designing-and-Implementing-Microsoft-DevOps-solutions
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-400ZH-Designing-and-Implementing-Microsoft-DevOps-solutions" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#准备工作">准备工作</a></li><li class="nav-item"><a class="nav-link" href="#练习-0配置实验室先决条件">练习 0：配置实验室先决条件</a></li><li class="nav-item"><a class="nav-link" href="#练习-1使用-azure-application-insights-监视-azure-应用服务-web-应用">练习 1：使用 Azure Application Insights 监视 Azure 应用服务 Web 应用</a></li><li class="nav-item"><a class="nav-link" href="#练习-2删除-azure-实验室资源">练习 2：删除 Azure 实验室资源</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="实验室-17-使用-application-insights-监视应用程序性能">实验室 17： 使用 Application Insights 监视应用程序性能</h1>
<h1 id="学生实验室手册">学生实验室手册</h1>

<h2 id="实验室概述">实验室概述</h2>

<p>Application Insights 是一种可扩展的应用程序性能管理 (APM) 服务，适用于多个平台上的 Web 开发人员。你可以使用它来监视实时 Web 应用程序。它将自动检测性能异常，并且包含了强大的分析工具来帮助诊断问题，并帮助持续改进性能和可用性。它适用于各种平台（包括 .NET、Node.js 和 Java EE）上的应用，托管在本地、混合或公有云上。它通过各种开发工具中的可用连接点与 DevOps 流程集成。它还允许通过与 Visual Studio App Center 集成来监视和分析来自移动应用的遥测。</p>

<p>在本实验室中，你将了解如何将 Application Insights 添加到现有 Web 应用程序，以及如何通过 Azure 门户监视应用程序。</p>

<h2 id="目标">目标</h2>

<p>完成本实验室后，你将能够：</p>

<ul>
  <li>部署 Azure 应用服务 Web 应用</li>
  <li>使用 Application Insights 生成和监视 Azure Web 应用应用程序流量</li>
  <li>使用 Application Insights 调查 Azure Web 应用性能</li>
  <li>使用 Application Insights 跟踪 Azure Web 应用使用情况</li>
  <li>使用 Application Insights 创建 Azure Web 应用警报</li>
</ul>

<h2 id="实验室持续时间">实验室持续时间</h2>

<ul>
  <li>预计用时：<strong>60 分钟</strong></li>
</ul>

<h2 id="说明">说明</h2>

<h3 id="准备工作">准备工作</h3>

<h4 id="登录到实验室虚拟机">登录到实验室虚拟机</h4>

<p>请确保已使用以下凭据登录到 Windows 10 虚拟机：</p>

<ul>
  <li>用户名：<strong>Student</strong></li>
  <li>密码：<strong>Pa55w.rd</strong></li>
</ul>

<h4 id="查看本实验室所需的应用程序">查看本实验室所需的应用程序</h4>

<p>确定你将在本实验室中使用的应用程序：</p>

<ul>
  <li>Microsoft Edge</li>
</ul>

<h4 id="设置-azure-devops-组织">设置 Azure DevOps 组织。</h4>

<p>如果还没有可用于本实验室的 Azure DevOps 组织，请按照<a href="https://docs.microsoft.com/zh-cn/azure/devops/organizations/accounts/create-organization?view=azure-devops">创建组织或项目集合</a>中的说明创建一个。</p>

<h4 id="准备-azure-订阅">准备 Azure 订阅</h4>

<ul>
  <li>标识现有的 Azure 订阅或创建一个新的 Azure 订阅。</li>
  <li>验证你拥有 Microsoft 帐户或 Azure AD 帐户，该帐户在 Azure 订阅中具有所有者角色并且在与 Azure 订阅关联的 Azure AD 租户中具有全局管理员角色。有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/role-assignments-list-portal">使用 Azure 门户列出 Azure 角色分配</a>和<a href="https://docs.microsoft.com/zh-cn/azure/active-directory/roles/manage-roles-portal#view-my-roles">在 Azure Active Directory 中查看和分配管理员角色</a>。</li>
</ul>

<h3 id="练习-0配置实验室先决条件">练习 0：配置实验室先决条件</h3>

<p>在本练习中，你将设置实验室先决条件，包括基于 Azure DevOps 演示生成器模板和 Azure 资源（包括 Azure Web 应用和 Azure SQL 数据库）的预配置的 Parts Unlimited 团队项目。</p>

<h4 id="任务-1配置团队项目">任务 1：配置团队项目</h4>

<p>在此任务中，你将使用 Azure DevOps 演示生成器，基于 <strong>Parts Unlimited</strong> 模板生成一个新项目。</p>

<ol>
  <li>
    <p>在实验室计算机上，启动 Web 浏览器并导航到 <a href="https://azuredevopsdemogenerator.azurewebsites.net">Azure DevOps 演示生成器</a>。此实用工具将对以下过程进行自动化：在你的帐户中创建预填充了实验室所需内容（工作项、存储库等）的 Azure DevOps 项目。</p>

    <blockquote>
      <p><strong>备注</strong>：有关该站点的详细信息，请参阅 https://docs.microsoft.com/zh-cn/azure/devops/demo-gen。</p>
    </blockquote>
  </li>
  <li>单击 <strong>“登录”</strong>，并使用与你的 Azure DevOps 订阅相关联的 Microsoft 帐户登录。</li>
  <li>如果需要，在 <strong>“Azure DevOps 演示生成器”</strong> 页面上，单击 <strong>“接受”</strong> 以接受访问 Azure DevOps 订阅的权限请求。</li>
  <li>在 <strong>“新建项目”</strong> 页面上的页面的 <strong>“新建项目名称”</strong> 文本框中，键入 <strong>“监视应用程序性能”</strong>，在 <strong>“选择组织”</strong> 下拉列表中选择你的 Azure DevOps 组织，然后单击 <strong>“选择模板”</strong>。</li>
  <li>在模板列表中，选择 <strong>“PartsUnlimited”</strong> 模板，然后单击 <strong>“选择模板”</strong>。</li>
  <li>
    <p>返回 <strong>“新建项目”</strong> 页面，单击 <strong>“创建项目”</strong></p>

    <blockquote>
      <p><strong>备注</strong>：等待此过程完成。该过程大约需要 2 分钟。如果该过程失败，请导航到你的 DevOps 组织，删除项目并重试。</p>
    </blockquote>
  </li>
  <li>在 <strong>“新建项目”</strong> 页面上，单击 <strong>“导航到项目”</strong>。</li>
</ol>

<h4 id="任务-2创建-azure-资源">任务 2：创建 Azure 资源</h4>

<p>在此任务中，你将在 Azure 门户中使用 Cloud Shell 创建 Azure Web 应用和 Azure SQL 数据库。</p>

<blockquote>
  <p><strong>备注</strong>：本实验室涉及将 Parts Unlimited 站点部署到 Azure 应用服务。为满足此需求，你需要启动必要的基础结构。</p>
</blockquote>

<ol>
  <li>从实验室计算机启动 Web 浏览器，导航到 <a href="https://portal.azure.com"><strong>Azure 门户</strong></a>，并使用用户帐户登录，该帐户在本实验室中将使用的 Azure 订阅中具有所有者角色，并在与此订阅关联的 Azure AD 租户中具有全局管理员角色。</li>
  <li>在 Azure 门户的工具栏中，单击搜索文本框右侧的“<strong>Cloud Shell</strong>”图标。</li>
  <li>如果提示选择“<strong>Bash</strong>”或“<strong>PowerShell</strong>”，请选择“<strong>Bash</strong>”。
    <blockquote>
      <p><strong>备注</strong>：如果这是第一次启动 <strong>Cloud Shell</strong>，并看到“<strong>未装载任何存储</strong>”消息，请选择在本实验室中使用的订阅，然后选择“<strong>创建存储</strong>”。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>Cloud Shell</strong> 窗格中的 Bash 提示符下，运行以下命令以创建资源组（将 <code>&lt;region&gt;</code> 占位符替换为离你最近的 Azure 区域的名称，例如“<strong>eastus</strong>”）。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-bash hljs">RESOURCEGROUPNAME=<span class="hljs-string"><span class="hljs-string">'az400m17l01a-RG'</span></span>
LOCATION=<span class="hljs-string"><span class="hljs-string">'&lt;region&gt;'</span></span>
az group create --name <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --location <span class="hljs-variable"><span class="hljs-variable">$LOCATION</span></span>
</code></pre>
  </li>
  <li>
    <p>通过运行以下命令创建 Windows 应用服务计划：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-bash hljs">SERVICEPLANNAME=<span class="hljs-string"><span class="hljs-string">'az400l17-sp'</span></span>
az appservice plan create --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
    --name <span class="hljs-variable"><span class="hljs-variable">$SERVICEPLANNAME</span></span> --sku B3 
</code></pre>
    <blockquote>
      <p><strong>备注</strong>：如果 <code>az appservice plan create</code> 命令失败并显示以 <code>ModuleNotFoundError: No module named 'vsts_cd_manager'</code>开头的错误消息：那么请运行以下命令，然后重新运行失败的命令。</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-bash hljs">az extension remove --name appservice-kube
az extension add --yes --<span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"https://aka.ms/appsvc/appservice_kube-latest-py2.py3-none-any.whl"</span></span>
</code></pre>
  </li>
  <li>
    <p>创建具有唯一名称的 Web 应用。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-bash hljs">WEBAPPNAME=partsunlimited<span class="hljs-variable"><span class="hljs-variable">$RANDOM</span></span><span class="hljs-variable"><span class="hljs-variable">$RANDOM</span></span>
az webapp create --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --plan <span class="hljs-variable"><span class="hljs-variable">$SERVICEPLANNAME</span></span> --name <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span> 
</code></pre>

    <blockquote>
      <p><strong>备注</strong>：记录该 Web 应用的名称。稍后将在本实验室用到它。</p>
    </blockquote>
  </li>
  <li>
    <p>现在，创建 Application Insights 实例。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-bash hljs"> az monitor app-insights component create --app <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span> \
     --location <span class="hljs-variable"><span class="hljs-variable">$LOCATION</span></span> \
     --kind web --application-type web \
     --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span>
</code></pre>

    <blockquote>
      <p><strong>备注</strong>：如果出现“命令需要 application-insights 扩展。是否立即安装？”提示，键入 Y 并按 Enter。</p>
    </blockquote>
  </li>
  <li>
    <p>让我们将 Application Insights 连接到 Web 应用程序。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-bash hljs"> az monitor app-insights component connect-webapp --app <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span> \
     --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --web-app <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span>
</code></pre>
  </li>
  <li>
    <p>接下来，创建 Azure SQL Server。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-bash hljs">USERNAME=<span class="hljs-string"><span class="hljs-string">"Student"</span></span>
SQLSERVERPASSWORD=<span class="hljs-string"><span class="hljs-string">"Pa55w.rd1234"</span></span>
SERVERNAME=<span class="hljs-string"><span class="hljs-string">"partsunlimitedserver</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RANDOM</span></span></span><span class="hljs-string">"</span></span>
    
az sql server create --name <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
--location <span class="hljs-variable"><span class="hljs-variable">$LOCATION</span></span> --admin-user <span class="hljs-variable"><span class="hljs-variable">$USERNAME</span></span> --admin-password <span class="hljs-variable"><span class="hljs-variable">$SQLSERVERPASSWORD</span></span>
</code></pre>
  </li>
  <li>
    <p>Web 应用需要能够访问 SQL Server，因此我们需要允许访问 SQL Server 防火墙规则中的 Azure 资源。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-bash hljs">STARTIP=<span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>
ENDIP=<span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>
az sql server firewall-rule create --server <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
--name AllowAzureResources --start-ip-address <span class="hljs-variable"><span class="hljs-variable">$STARTIP</span></span> --end-ip-address <span class="hljs-variable"><span class="hljs-variable">$ENDIP</span></span>
</code></pre>
  </li>
  <li>
    <p>现在，在该服务器中创建数据库。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-bash hljs">az sql db create --server <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> --name PartsUnlimited \
--service-objective S0
</code></pre>
  </li>
  <li>
    <p>创建的 Web 应用在其配置中需要数据库连接字符串，因此请运行以下命令来准备该字符串，并将其添加到 Web 应用的应用设置中。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-bash hljs">CONNSTRING=$(az sql db show-connection-string --name PartsUnlimited --server <span class="hljs-variable"><span class="hljs-variable">$SERVERNAME</span></span> \
--client ado.net --output tsv)
CONNSTRING=<span class="hljs-variable"><span class="hljs-variable">${CONNSTRING//&lt;username&gt;/$USERNAME}</span></span>
CONNSTRING=<span class="hljs-variable"><span class="hljs-variable">${CONNSTRING//&lt;password&gt;/$SQLSERVERPASSWORD}</span></span>
az webapp config connection-string <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --name <span class="hljs-variable"><span class="hljs-variable">$WEBAPPNAME</span></span> --resource-group <span class="hljs-variable"><span class="hljs-variable">$RESOURCEGROUPNAME</span></span> \
-t SQLAzure --settings <span class="hljs-string"><span class="hljs-string">"DefaultConnectionString=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CONNSTRING</span></span></span><span class="hljs-string">"</span></span> 
</code></pre>
  </li>
</ol>

<h3 id="练习-1使用-azure-application-insights-监视-azure-应用服务-web-应用">练习 1：使用 Azure Application Insights 监视 Azure 应用服务 Web 应用</h3>

<p>在本练习中，你将使用 Azure DevOps 管道将 Web 应用部署到 Azure 应用服务，生成针对 Web 应用的流量，并使用 Application Insights 查看 Web 流量、调查应用程序性能、跟踪应用程序使用情况和配置警报。</p>

<h4 id="任务-1使用-azure-devops-将-web-应用部署到-azure-应用服务">任务 1：使用 Azure DevOps 将 Web 应用部署到 Azure 应用服务</h4>

<p>在此任务中，你将使用 Azure DevOps 管道将 Web 应用部署到 Azure。</p>

<blockquote>
  <p><strong>备注</strong>： 我们在本实验室中使用的示例项目包括一个持续集成生成，我们将在不进行任何修改的情况下使用该生成。此外，还有一个持续交付发布管道，该管道需要进行一些细微更改，才能部署到你在上一任务中实现的 Azure 资源。</p>
</blockquote>

<ol>
  <li>切换到显示 Azure DevOps 门户中 <strong>“监视应用程序性能”</strong> 项目的 Web 浏览器窗口，在垂直导航窗格中，选择 <strong>“管道”</strong>，然后在 <strong>“管道”</strong> 部分中选择 <strong>“发布”</strong>。</li>
  <li>在发布管道列表中的 <strong>“PartsUnlimitedE2E”</strong> 窗格上，单击 <strong>“编辑”</strong>。</li>
  <li>在 <strong>“所有管道 &gt; PartsUnlimitedE2E”</strong> 窗格上，单击表示 <strong>“开发”</strong> 阶段的矩形，在 <strong>“开发”</strong> 窗格上，单击 <strong>“删除”</strong>，然后在 <strong>“删除阶段”</strong> 对话框中，单击 <strong>“确认”</strong>。</li>
  <li>返回 <strong>“所有管道 &gt; PartsUnlimitedE2E”</strong> 窗格，单击表示 <strong>QA</strong> 阶段的矩形，在 <strong>“QA”</strong> 窗格上，单击 <strong>“删除”</strong>，然后在 <strong>“删除阶段”</strong> 对话框中，单击 <strong>“确认”</strong>。</li>
  <li>返回 <strong>“所有管道 &gt; PartsUnlimitedE2E”</strong> 窗格，在表示 <strong>“生产”</strong> 阶段的矩形中，单击 <strong>“1 个作业，1 项任务”</strong> 链接。</li>
  <li>在显示 <strong>“生产”</strong> 阶段任务列表的窗格中，单击表示 <strong>“Azure 应用服务部署”</strong> 任务的条目。</li>
  <li>在 <strong>“Azure 应用服务部署”</strong> 窗格的 <strong>“Azure 订阅”</strong> 下拉列表中，选择表示你在本实验室中使用的 Azure 订阅的条目，然后单击 <strong>“授权”</strong> 以创建相应的服务连接。出现提示时，使用在 Azure 订阅中具有“所有者”角色并且在与 Azure 订阅关联的 Azure AD 租户中具有“全局管理员”角色的帐户登录。</li>
  <li>在 <strong>“所有管道 &gt; PartsUnlimitedE2E”</strong> 窗格的 <strong>“任务”</strong> 选项卡处于活动状态后，单击 <strong>“管道”</strong> 选项卡标头以返回管道图表。</li>
  <li>在图表中，单击矩形左侧表示 <strong>“生产”</strong> 阶段的 <strong>“预部署条件”</strong> 椭圆符号。</li>
  <li>
    <p>在 <strong>“预部署条件”</strong> 窗格的 <strong>“选择触发器”</strong> 部分中，选择 <strong>“发布后”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这将在项目的生成管道成功后调用发布管道。</p>
    </blockquote>
  </li>
  <li>在 <strong>“所有管道 &gt; PartsUnlimitedE2E”</strong> 窗格的 <strong>“管道”</strong> 选项卡处于活动状态后，单击 <strong>“变量”</strong> 选项卡标头。</li>
  <li>在变量列表中，将 <strong>WebsiteName</strong> 变量的值设置为与你先前在本实验室中创建的 Azure 应用服务 Web 应用的名称匹配。</li>
  <li>
    <p>在窗格右上角，单击 <strong>“保存”</strong>，出现提示时，在 <strong>“保存”</strong> 对话框中再次单击 <strong>“确定”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 现在，发布管道已就位，我们可以预料对主分支的任何提交都将触发生成和发布管道。</p>
    </blockquote>
  </li>
  <li>在显示 Azure DevOps 门户的 Web 浏览器窗口中，在垂直导航窗格中单击 <strong>“存储库”</strong>。</li>
  <li>
    <p>在 <strong>“文件”</strong> 窗格中，导航到并选择 <strong>PartsUnlimited-aspnet45/src/PartsUnlimitedWebsite/Web.config</strong> 文件。</p>

    <blockquote>
      <p><strong>备注</strong>： 此应用程序已有 Application Insights 密钥和 SQL 连接的配置设置。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>Web.config</strong> 窗格上，查看引用 Application Insights 密钥以及 SQL 连接的行：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">xml</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Keys:ApplicationInsights:InstrumentationKey"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0839cc6f-b99b-44b1-9d74-4e408b7aee29"</span></span></span><span class="hljs-tag"> /&gt;</span></span>
</code></pre>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">xml</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="language-xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionStrings</span></span></span><span class="hljs-tag">&gt;</span></span>
    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DefaultConnectionString"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">connectionString</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Server=(localdb)\mssqllocaldb;Database=PartsUnlimitedWebsite;Integrated Security=True;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">providerName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> /&gt;</span></span>
 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionStrings</span></span></span><span class="hljs-tag">&gt;</span></span>
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 部署后，你将在 Azure 门户中修改这些设置的值，以表示你先前在实验室中部署的 Azure Application Insights 和 Azure SQL 数据库。</p>
    </blockquote>

    <blockquote>
      <p><strong>备注</strong>： 现在，只需在文件末尾添加一个空行，即可触发生成和发布过程，而无需修改任何相关代码</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“Web.config”</strong> 窗格上，单击 <strong>“编辑”</strong>，在文件末尾添加一个空行，单击 <strong>“提交”</strong>，然后在 <strong>“提交”</strong> 窗格中再次单击 <strong>“提交”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 将开始新的生成并最终导致部署到 Azure。不要等待它完成，而是继续执行下一步。</p>
    </blockquote>
  </li>
  <li>切换到显示 Azure 门户的 Web 浏览器，并导航到你先前在实验室中预配的应用服务 Web 应用。</li>
  <li>在应用服务 Web 应用边栏选项卡上，在左侧的垂直菜单中单击，在 <strong>“设置”</strong> 部分中，单击 <strong>“配置”</strong> 选项卡。</li>
  <li>在“<strong>应用程序设置</strong>”列表中，单击 <strong>APPINSIGHTS_INSTRUMENTATIONKEY</strong> 条目。（如果没有看到此条目，请选择“<strong>设置</strong>”下的“<strong>Application Insights</strong>”并将其启用，然后选择“<strong>应用</strong>”。）</li>
  <li>
    <p>在 <strong>“添加/编辑应用程序设置”</strong> 边栏选项卡上，复制 <strong>“值”</strong> 文本框中的文本，然后单击 <strong>“取消”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这是在部署应用服务 Web 应用期间添加的默认设置，已包含 Application Insights ID。我们需要添加应用预期的新设置，赋予其不同的名称和相同的值。这是本示例的特殊要求。</p>
    </blockquote>
  </li>
  <li>在 <strong>“应用程序设置”</strong> 部分，单击 <strong>“+ 新建应用程序设置”</strong>。</li>
  <li>
    <p>在“<strong>添加/编辑应用程序设置</strong>”边栏选项卡的“<strong>名称</strong>”文本框中，键入 <strong>Keys:ApplicationInsights:InstrumentationKey</strong>，在“<strong>值</strong>”文本框中，键入复制到剪贴板中的字符串，然后单击“<strong>确定</strong>”。选择“<strong>保存</strong>”。</p>

    <blockquote>
      <p><strong>备注</strong>： 对应用程序设置和连接字符串进行更改将触发重启 Web 应用。</p>
    </blockquote>
  </li>
  <li>切换回显示 Azure DevOps 门户的 Web 浏览器窗口，在垂直导航窗格中，选择 <strong>“管道”</strong>，然后在 <strong>“管道”</strong> 部分中单击表示最近运行的生成管道的条目。</li>
  <li>如果生成尚未完成，跟踪生成直至完成，然后在垂直导航窗格中的 <strong>“管道”</strong> 部分中单击 <strong>“发布”</strong>，在 <strong>“PartsUnlimiteE2E”</strong> 窗格中单击 <strong>“Release-1”</strong>，并按照发布管道进行操作直至发布完成。</li>
  <li>切换到显示 Azure 门户的 Web 浏览器窗口，然后在 <strong>“应用服务 Web 应用”</strong> 边栏选项卡左侧的垂直菜单栏中单击 <strong>“概述”</strong>。</li>
  <li>在右侧的 <strong>“Essentials”</strong> 部分中，单击 <strong>URL</strong> 链接。这将自动打开另一显示 <strong>Parts Unlimited</strong> 网站的 Web 浏览器标签页
。</li>
  <li>验证 <strong>Parts Unlimited</strong> 网站是否按预期加载。</li>
</ol>

<h4 id="任务-2生成和查看应用程序流量">任务 2：生成和查看应用程序流量</h4>

<p>在此任务中，你将生成针对你在上一任务中部署的应用服务 Web 应用的流量，并查看由与 Web 应用关联的 Application Insights 资源收集的数据。</p>

<ol>
  <li>在显示 <strong>Parts Unlimited</strong> 网站的 Web 浏览器窗口中，浏览其页面以生成一些流量。</li>
  <li>在 <strong>Parts Unlimited</strong> 网站上，单击 <strong>“Brakes”</strong> 菜单项。</li>
  <li>
    <p>在浏览器窗口顶部的 URL 文本框中，将 <strong>1</strong> 附加到 URL 字符串的末尾，然后按 <strong>Enter</strong>，有效将 <strong>CategoryId</strong> 参数设置为 <strong>11</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这将触发服务器错误，因为该类别不存在。请多次刷新页面以生成更多错误。</p>
    </blockquote>
  </li>
  <li>返回显示 Azure 门户的 Web 浏览器标签页。</li>
  <li>
    <p>在显示 Azure 门户的 Web 浏览器标签页中，在 <strong>“应用服务”</strong> Web 应用边栏选项卡左侧的垂直菜单栏中的 <strong>“设置”</strong> 部分，单击 <strong>“Application Insights”</strong> 条目以显示 <strong>“Application Insights”</strong> 配置边栏选项卡。</p>

    <blockquote>
      <p><strong>备注</strong>： 此边栏选项卡包括用于将 Application Insights 与不同类型的应用集成的设置。虽然默认体验为跟踪和监视应用生成了大量数据，但 API 为更专业的场景和自定义事件跟踪提供了支持。</p>
    </blockquote>
  </li>
  <li>在 <strong>“Application Insights”</strong> 配置边栏选项卡上，单击 <strong>“查看 Application Insights 数据”</strong> 链接。</li>
  <li>
    <p>查看生成的 <strong>“Application Insights”</strong> 边栏选项卡，该边栏选项卡显示了其中显示所收集数据的不同特征的图表，包括生成的流量和你在此任务早期触发的失败请求。</p>

    <blockquote>
      <p><strong>备注</strong>：如果未立即看到任何内容，只需等待几分钟并刷新页面，直到概述部分开始显示日志。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-3调查应用程序性能">任务 3：调查应用程序性能</h4>

<p>在此任务中，你将使用 Application Insights 来调查应用服务 Web 应用的性能。</p>

<ol>
  <li>
    <p>在 <strong>“Application Insights”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“调查”</strong> 部分，单击 <strong>“应用程序映射”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 应用程序映射可帮助你发现分布式应用程序的所有组件的性能瓶颈或故障热点。映射的每个节点表示应用程序组件或其依赖项，以及运行状况 KPI 和警报状态。你可单击任何组件获得更详细的诊断，例如 Application Insights 事件。如果你的应用使用了 Azure 服务，你还可以单击进入与这些服务相关的 Azure 诊断，例如 SQL 数据库顾问建议。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“Application Insights”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“调查”</strong> 部分，单击 <strong>“智能检测”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 当 Web 应用程序中存在潜在性能问题时，智能检测会自动向你发出警告。它会对应用发送至 Application Insights 的遥测数据执行主动分析。如果失败率中存在骤升或者客户端或服务器性能中存在异常模式，将收到警报。此功能不需要任何配置。它会在应用程序发送足够的遥测时运行。但是，由于应用刚刚才部署完毕，因此还没有任何数据。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“Application Insights”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“调查”</strong> 部分，单击 <strong>“实时指标”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 实时指标流让你能够探测生产中的实时 Web 应用程序的检测信号。你可以选择并筛选指标和性能计数器进行实时监视，且服务不会受到任何影响。你还可以从失败请求和异常的样本中检查堆栈跟踪。</p>
    </blockquote>
  </li>
  <li>返回显示 <strong>Parts Unlimited</strong> 网站的 Web 浏览器，浏览其页面以生成一些流量，包括一些服务器错误。</li>
  <li>返回显示 Azure 门户的 Web 浏览器，以在实时流量到达时查看该流量。</li>
  <li>
    <p>在 <strong>“Application Insights”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“调查”</strong> 部分，单击 <strong>“事务搜索”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 事务搜索提供了一个灵活的界面来定位你需要回答问题的确切遥测。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“事务搜索”</strong> 边栏选项卡上，单击 <strong>“查看最近 24 小时内的所有数据”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 结果包括所有遥测数据，可按多种属性对这些数据进行筛选。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“事务搜索”</strong> 边栏选项卡上，在边栏选项卡中间，结果列表的正上方，单击 <strong>“分组的结果”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这些结果根据常见属性进行了分组。</p>
    </blockquote>
  </li>
  <li>在 <strong>“事务搜索”</strong> 边栏选项卡上，在边栏选项卡中间，结果列表的正上方，单击 <strong>“结果”</strong> 以返回原始视图，列出所有结果。</li>
  <li>
    <p>在 <strong>“事务搜索”</strong> 边栏选项卡顶部，单击 <strong>“事件类型 = 选择的所有项”</strong>，在下拉列表中，清除 <strong>“全选”</strong> 复选框，然后在事件类型列表中选择 <strong>“异常”</strong> 复选框。</p>

    <blockquote>
      <p><strong>备注</strong>： 应显示一些表示你之前生成的错误的异常。</p>
    </blockquote>
  </li>
  <li>在结果列表中，单击其中一项异常。这将显示 <strong>“端到端事务详细信息”</strong> 边栏选项卡，其中提供了请求上下文中异常的完整时间线视图。</li>
  <li>
    <p>在 <strong>“端到端事务详细信息”</strong> 边栏选项卡底部，单击 <strong>“查看所有遥测”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： <strong>“遥测”</strong> 视图提供了相同的数据，但数据格式不同。在 <strong>“端到端事务详细信息”</strong> 边栏选项卡右侧，还可以查看异常本身的详细信息，例如其属性和调用堆栈。</p>
    </blockquote>
  </li>
  <li>
    <p>关闭 <strong>“端到端事务详细信息”</strong> 边栏选项卡，返回 <strong>“事务搜索”</strong> 边栏选项卡，在左侧的垂直菜单中，在 <strong>“调查”</strong> 部分中单击 <strong>“可用性”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 将 Web 应用或网站部署到任何服务器后，可以设置测试，以监视其可用性和响应性。Application Insights 将来自全球各地的 Web 请求定期发送到应用程序。如果应用程序无响应或响应慢，它会提醒你。</p>
    </blockquote>
  </li>
  <li>在 <strong>“可用性”</strong> 边栏选项卡的工具栏中，单击 <strong>“添加测试”</strong>。</li>
  <li>
    <p>在 <strong>“创建测试”</strong> 边栏选项卡的 <strong>“测试名称”</strong> 文本框中，键入 <strong>“主页”</strong>，将 URL 设置为应用服务 Web 应用的根目录，然后单击 <strong>“创建”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 测试不会立即运行，因此不会有任何数据。如果稍后再返回查看，应可看到已更新可用性数据，反映针对实时站点的测试。现在不要等待更新。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“可用性”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“调查”</strong> 部分，单击 <strong>“失败”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： “失败”视图将所有异常报表聚合到单个仪表板中。在这里，你可以根据依赖项或异常等筛选条件轻松定位相关数据。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“失败”</strong> 边栏选项卡右上角的 <strong>“排名前 3 的响应代码”</strong> 列表中，单击表示 <strong>500</strong> 错误数的链接。</p>

    <blockquote>
      <p><strong>备注</strong>： 这将显示一个与此 HTTP 响应代码匹配的异常列表。选择建议的异常将显示与你先前查看的异常视图相同的异常视图。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“失败”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“调查”</strong> 部分，单击 <strong>“性能”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： “性能”视图提供了一个仪表板，该仪表板根据收集的遥测数据简化了应用程序性能的详细信息。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“性能”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“监视”</strong> 部分，单击 <strong>“指标”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： Application Insights 中的指标是从应用程序遥测功能发送的度量值和事件计数。它们可帮助检测性能问题，观察应用程序的用法趋势。标准指标的范围很广泛，也可以创建自己的自定义指标和事件。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“指标”</strong> 边栏选项卡的筛选器部分中，单击“ <strong>选择指标”</strong>，然后在下拉列表中选择 <strong>“服务器请求”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 还可以使用拆分对数据进行分段。</p>
    </blockquote>
  </li>
  <li>
    <p>在新显示的图表顶部，单击 <strong>“应用拆分”</strong>，在生成的筛选器中的 <strong>“选择值”</strong> 下拉列表中，选择 <strong>“操作名称”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这将根据服务器请求引用的页面（由图表中的不同颜色表示）拆分服务器请求。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-4跟踪应用程序使用情况">任务 4：跟踪应用程序使用情况</h4>

<blockquote>
  <p><strong>备注</strong>： Application Insights 提供了一组广泛的功能来跟踪应用程序使用情况。</p>
</blockquote>

<ol>
  <li>
    <p>在 <strong>“指标”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“用户”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 虽然应用程序的用户还不多，但有一些可用数据。</p>
    </blockquote>
  </li>
  <li>在 <strong>“用户”</strong> 边栏选项卡上的主图下，单击 <strong>“查看更多见解”</strong>。这将显示额外的数据，向下扩展边栏选项卡。</li>
  <li>
    <p>向下滚动以查看有关地理位置、操作系统和浏览器的详细信息。</p>

    <blockquote>
      <p><strong>备注</strong>： 还可以深入了解特定于用户的数据，以更好地了解特定于用户的使用模式。</p>
    </blockquote>
  </li>
  <li>在 <strong>“用户”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“事件”</strong>。</li>
  <li>
    <p>在 <strong>“事件”</strong> 边栏选项卡上的主图下，单击 <strong>“查看更多见解”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 显示内容将包括目前基于站点使用情况引发的一系列内置事件。可以通过编程方式添加包含自定义数据的自定义事件，以满足你的需要。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“事件”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“漏斗图”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 了解客户体验对你的业务而言至关重要。如果应用程序的使用涉及多个步骤，则你需要了解大多数客户是否遵循了预期的流程。Web 应用程序中通过一系列步骤完成的进度被称为“漏斗图”。Azure Application Insights 漏斗图可用于深入了解你的用户，并监视分步转换率。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“漏斗图”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“用户流”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 用户流工具从你指定的初始页面视图、自定义事件或异常启动。基于此给定的初始事件，用户流显示相应用户会话期间发生在其之前和之后的事件。不同粗细的线显示用户遵循每条路径的次数。 <strong>“会话启动”</strong> 节点表示会话的开始。<strong>“会话结束”</strong> 节点显示有多少用户在上一个节点之后没有生成页面视图或自定义事件，这可能与离开你的站点的用户相对应。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“用户流”</strong> 边栏选项卡上，单击 <strong>“选择事件”</strong>，在 <strong>“编辑”</strong> 窗格的 <strong>“初始事件”</strong> 下拉列表中的 <strong>“页面视图”</strong> 部分，选择 <strong>“主页 - Parts Unlimited”</strong> 条目，然后单击 <strong>“创建图”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“用户流”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“保留期”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： Application Insights 中的“留存情况”功能可以帮助分析有多少用户回归到应用，以及他们以何频率执行特定的任务或达成目标。例如，如果运行游戏网站，则可以将在输掉游戏后回归到网站的用户数与在获胜后回归的用户数进行比较。此信息有助于改进用户体验和业务策略。</p>
    </blockquote>

    <blockquote>
      <p><strong>备注</strong>： “用户保留期分析”体验已转换为 Azure 工作簿</p>
    </blockquote>
  </li>
  <li>在 <strong>“保留期”</strong> 边栏选项卡上，单击 <strong>“保留期分析工作簿”</strong>，查看 <strong>“整体保留期”</strong> 图表，然后关闭边栏选项卡。</li>
  <li>
    <p>在 <strong>“保留期”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“影响”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： “影响”分析网站属性（如加载时间）如何影响应用各个部件的转换率。更准确地说，它可以发现页面视图的任何维度、自定义事件或请求对页面视图或自定义事件造成的影响。</p>
    </blockquote>

    <blockquote>
      <p><strong>备注</strong>： “影响分析”体验已转换为 Azure 工作簿</p>
    </blockquote>
  </li>
  <li>在 <strong>“影响”</strong> 边栏选项卡上，单击 <strong>“影响分析工作簿”</strong>，在 <strong>“影响”</strong> 边栏选项卡上的 <strong>“选择的事件”</strong> 下拉列表中的 <strong>“页面视图”</strong> 部分，选择 <strong>“主页 - Parts Unlimited”</strong>，在 <strong>“影响事件”</strong> 中，选择 <strong>“浏览产品 - Parts Unlimited”</strong>，查看结果，然后关闭边栏选项卡。</li>
  <li>
    <p>在 <strong>“影响”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“队列”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 队列是具有某种共性的用户、会话、事件或操作集。在 Application Insights 中，队列由 Analytics 查询定义。在需要反复分析一组特定用户或事件的情况下，队列可为你提供更大的灵活性，让你可以准确表达感兴趣的用户或事件集。队列的使用方式类似于筛选器，但队列定义通过自定义的 Analytics 查询构建，因此其适应性更强，复杂程度也更大。与筛选器不同，队列可以保存，因此可供其他团队成员重复使用。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“队列”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“使用情况”</strong> 部分，单击 <strong>“更多”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 此边栏选项卡包括供查看的各种报表和模板。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“更多| 库”</strong> 边栏选项卡上的 <strong>“使用情况”</strong> 部分，单击 <strong>“页面视图分析”</strong> 并查看相应边栏选项卡的内容。</p>

    <blockquote>
      <p><strong>备注</strong>： 此特定报表提供了有关页面视图的见解。默认情况下，还有许多其他可用报表，你可以自定义和保存新的报表。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-5配置-web-应用警报">任务 5：配置 Web 应用警报</h4>

<ol>
  <li>
    <p>在 <strong>“更多| 库”</strong> 边栏选项卡左侧垂直菜单中的 <strong>“监视”</strong> 部分，单击 <strong>“警报”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 通过警报，可以设置在 Application Insights 度量值达到指定条件时执行操作的触发器。</p>
    </blockquote>
  </li>
  <li>在 <strong>“警报”</strong> 边栏选项卡的工具栏中，单击 <strong>“+ 新建警报规则”</strong>。</li>
  <li>在 <strong>“创建警报规则”</strong> 边栏选项卡上，请注意，在 <strong>“范围”</strong> 部分，默认情况下将选中当前 Application Insights 资源。</li>
  <li>在“<strong>创建警报规则</strong>”边栏选项卡的“<strong>条件</strong>”部分，单击“<strong>添加条件</strong>”。</li>
  <li>在 <strong>“配置信号逻辑”</strong> 边栏选项卡上，搜索并选择 <strong>“失败的请求”</strong> 指标。</li>
  <li>
    <p>在 <strong>“配置信号逻辑”</strong> 边栏选项卡上，向下滚动到 <strong>“警报逻辑”</strong> 部分，确保 <strong>“阈值”</strong> 设置为 <strong>“静态”</strong> 并将 <strong>“阈值的值”</strong> 设置为 <strong>1</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这将在报告第二个失败的请求时触发警报。默认情况下，将基于过去 5 分钟内的度量值聚合每分钟评估一次条件。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“配置信号逻辑”</strong> 边栏选项卡上，单击 <strong>“完成”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 创建条件后，需要为它定义一个要执行的 <strong>“操作组”</strong>。</p>
    </blockquote>
  </li>
  <li>返回 <strong>“创建警报规则”</strong> 边栏选项卡，在 <strong>“操作”</strong> 部分中，单击 <strong>“选择操作组”</strong>，然后在 <strong>“选择要附加到此警报规则的操作组”</strong> 上，单击 <strong>“创建操作组”</strong>。</li>
  <li>
    <p>在 <strong>“创建操作组”</strong> 边栏选项卡的 <strong>“基本”</strong> 选项卡上，指定以下设置并单击 <strong>“下一步: 通知 &gt;”</strong> ：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>订阅</td>
          <td>在本实验室中使用的 Azure 订阅的名称</td>
        </tr>
        <tr>
          <td>资源组</td>
          <td>新资源组名称 <strong>az400m17l01b-RG</strong></td>
        </tr>
        <tr>
          <td>操作组名称</td>
          <td><strong>az400m17-action-group</strong></td>
        </tr>
        <tr>
          <td>显示名称</td>
          <td><strong>az400m17-ag</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>在 <strong>“创建操作组”</strong> 边栏选项卡的 <strong>“通知”</strong> 选项卡上，在 <strong>“通知类型”</strong> 下拉列表中选择 <strong>“电子邮件/短信消息/推送/语音”</strong>。 <strong>“电子邮件/短信消息/推送/语音”</strong> 边栏选项卡随即打开。</li>
  <li>在 <strong>“电子邮件/短信消息/推送/语音”</strong> 边栏选项卡上，选择 <strong>“电子邮件”</strong> 复选框，在 <strong>“电子邮件”</strong> 文本框中，键入电子邮件地址，然后单击 <strong>“确定”</strong>。</li>
  <li>返回 <strong>“创建操作组”</strong> 边栏选项卡的 <strong>“通知”</strong> 选项卡，在 <strong>“名称”</strong> 文本框中，键入 <strong>“电子邮件”</strong> 并单击 <strong>“下一步: 操作 &gt;”</strong> ：</li>
  <li>在 <strong>“创建操作组”</strong> 边栏选项卡的 <strong>“操作”</strong> 选项卡上，选择 <strong>“操作组”</strong> 下拉列表，查看可用选项而不进行任何更改，然后单击 <strong>“查看 + 创建”</strong>。</li>
  <li>在 <strong>“创建操作组”</strong> 边栏选项卡的 <strong>“查看 + 创建”</strong> 选项卡中，单击 <strong>“创建”</strong></li>
  <li>返回 <strong>“创建警报规则”</strong> 边栏选项卡，在 <strong>“警报规则详细信息”</strong> 部分的 <strong>“警报规则名称”</strong> 文本框中，键入 <strong>“az400m17 实验室警报规则”</strong>，查看其余警报规则设置而不修改它们，然后单击 <strong>“创建警报规则”</strong>。</li>
  <li>切换到显示 <strong>“Parts Unlimited”</strong> 网站的 Web 浏览器窗口，在 <strong>“Parts Unlimited”</strong> 网站上，单击 <strong>“Brakes”</strong> 菜单项。</li>
  <li>
    <p>在浏览器窗口顶部的 URL 文本框中，将 <strong>1</strong> 附加到 URL 字符串的末尾，然后按 <strong>Enter</strong>，有效将 <strong>CategoryId</strong> 参数设置为 <strong>11</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 这将触发服务器错误，因为该类别不存在。请多次刷新页面以生成更多错误。</p>
    </blockquote>
  </li>
  <li>大约五分钟后，检查你的电子邮件帐户，验证是否收到一封指示你定义的警报已触发的电子邮件。</li>
</ol>

<h3 id="练习-2删除-azure-实验室资源">练习 2：删除 Azure 实验室资源</h3>

<p>在本练习中，你将删除在本实验室中预配的 Azure 资源，避免产生意外费用。</p>

<blockquote>
  <p><strong>备注</strong>： 请记得删除不再使用的所有新创建的 Azure 资源。删除未使用的资源，确保不产生意外费用。</p>
</blockquote>

<h4 id="任务-1删除-azure-实验室资源">任务 1：删除 Azure 实验室资源</h4>

<p>在此任务中，你将使用 Azure Cloud Shell 删除在本实验室中预配的 Azure 资源，避免产生不必要的费用。</p>

<ol>
  <li>在 Azure 门户中，在 <strong>Cloud Shell</strong> 窗格中打开 <strong>Bash</strong> Shell 会话。</li>
  <li>
    <p>运行以下命令，列出在本模块各实验室中创建的所有资源组：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="language-sh hljs bash">az group list --query <span class="hljs-string"><span class="hljs-string">"[?starts_with(name,'az400m17l01')].name"</span></span> --output tsv
</code></pre>
  </li>
  <li>
    <p>运行以下命令，删除在本模块各个实验室中创建的所有资源组：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="language-sh hljs bash">az group list --query <span class="hljs-string"><span class="hljs-string">"[?starts_with(name,'az400m17l01')].[name]"</span></span> --output tsv | xargs -L1 bash -c <span class="hljs-string"><span class="hljs-string">'az group delete --name $0 --no-wait --yes'</span></span>
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 该命令以异步方式执行（由 –nowait 参数决定），因此，虽然你随后可在同一 Bash 会话中立即运行另一个 Azure CLI 命令，但实际上要花几分钟才能删除资源组。</p>
    </blockquote>
  </li>
</ol>

<h2 id="回顾">回顾</h2>

<p>在本练习中，你已使用 Azure DevOps 管道将 Web 应用部署到 Azure 应用服务，生成针对 Web 应用的流量，并使用 Application Insights 查看 Web 流量、调查应用程序性能、跟踪应用程序使用情况和配置警报。</p>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-400ZH-Designing-and-Implementing-Microsoft-DevOps-solutions" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-400ZH-Designing-and-Implementing-Microsoft-DevOps-solutions
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D.js"></script>



</body></html>