<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-104ZH-MicrosoftAzureAdministrator
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-104ZH-MicrosoftAzureAdministrator
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-104ZH-MicrosoftAzureAdministrator" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link active" href="#练习-1">练习 1</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="实验室-08---管理虚拟机">实验室 08 - 管理虚拟机</h1>
<h1 id="学生实验室手册">学生实验室手册</h1>

<h2 id="实验室场景">实验室场景</h2>

<p>你的任务是确定用于部署和配置 Azure 虚拟机的不同选项。首先，你需要确定在使用 Azure 虚拟机时可以采用的各种计算和存储复原与缩放选项。接下来，你需要研究使用 Azure 虚拟机规模集时可用的计算和存储复原与缩放选项。你还希望探索使用 Azure 虚拟机自定义脚本扩展自动配置虚拟机和虚拟机规模集的功能。</p>

<h2 id="目标">目标</h2>

<p>在本实验室中，你将：</p>

<ul>
  <li>任务 1：使用 Azure 门户和 Azure 资源管理器模板部署可复原区域的 Azure 虚拟机</li>
  <li>任务 2：使用虚拟机扩展配置 Azure 虚拟机</li>
  <li>任务 3：缩放 Azure 虚拟机的计算和存储</li>
  <li>任务 4：注册 Microsoft.Insights 和 Microsoft.AlertsManagement 资源提供程序</li>
  <li>任务 5：使用 Azure 门户部署可复原区域的 Azure 虚拟机规模集</li>
  <li>任务 6：使用虚拟机扩展配置 Azure 虚拟机规模集</li>
  <li>任务 7：缩放 Azure 虚拟机规模集的计算和存储（可选）</li>
</ul>

<h2 id="预计用时50-分钟">预计用时：50 分钟</h2>

<h2 id="体系结构图">体系结构图</h2>

<p><a href="../media/lab08.png" target="_blank"><img src="../media/lab08.png" alt="图像"></a></p>

<h2 id="说明">说明</h2>

<h3 id="练习-1">练习 1</h3>

<h4 id="任务-1使用-azure-门户和-azure-资源管理器模板部署可复原区域的-azure-虚拟机">任务 1：使用 Azure 门户和 Azure 资源管理器模板部署可复原区域的 Azure 虚拟机</h4>

<p>在此任务中，你将使用 Azure 门户和 Azure 资源管理器模板将 Azure 虚拟机部署到不同的可用性区域。</p>

<ol>
  <li>
    <p>登录到 <a href="http://portal.azure.com">Azure 门户</a>。</p>
  </li>
  <li>
    <p>在 Azure 门户中，搜索并选择“<strong>虚拟机</strong>”，在“<strong>虚拟机</strong>”边栏选项卡上，单击“<strong>+ 创建</strong>”。</p>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机”</strong> 边栏选项卡的 <strong>“基本信息”</strong> 选项卡上，指定以下设置（将其他设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>订阅</td>
          <td>本实验室将使用的 Azure 订阅的名称</td>
        </tr>
        <tr>
          <td>资源组</td>
          <td>新资源组名称 <strong>“az104-08-rg01”</strong></td>
        </tr>
        <tr>
          <td>虚拟机名称</td>
          <td><strong>az104-08-vm0</strong></td>
        </tr>
        <tr>
          <td>区域</td>
          <td>选择其中一个支持可用性区域且可预配 Azure 虚拟机的区域</td>
        </tr>
        <tr>
          <td>可用性选项</td>
          <td><strong>可用性区域</strong></td>
        </tr>
        <tr>
          <td>可用性区域</td>
          <td><strong>1</strong></td>
        </tr>
        <tr>
          <td>映像</td>
          <td><strong>Windows Server 2019 Datacenter - Gen1/Gen2</strong></td>
        </tr>
        <tr>
          <td>Azure Spot 实例</td>
          <td><strong>否</strong></td>
        </tr>
        <tr>
          <td>大小</td>
          <td><strong>Standard D2s v3</strong></td>
        </tr>
        <tr>
          <td>用户名</td>
          <td><strong>Student</strong></td>
        </tr>
        <tr>
          <td>密码</td>
          <td><strong>Pa55w.rd1234</strong></td>
        </tr>
        <tr>
          <td>公共入站端口</td>
          <td><strong>无</strong></td>
        </tr>
        <tr>
          <td>你是否要使用现有 Windows Server 许可证？</td>
          <td><strong>否</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“下一步: 磁盘 &gt;”</strong>，在 <strong>“创建虚拟机”</strong> 边栏选项卡的 <strong>“磁盘”</strong> 选项卡上，指定以下设置（其余设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>操作系统磁盘类型</td>
          <td><strong>高级 SSD</strong></td>
        </tr>
        <tr>
          <td>启用超级磁盘兼容性</td>
          <td><strong>否</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“下一步:  联网 &gt;”</strong>，在 <strong>“创建虚拟机”</strong> 边栏选项卡的 <strong>“网络”</strong> 选项卡上，单击 <strong>“虚拟网络”</strong> 文本框下面的 <strong>“新建”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“创建虚拟网络”</strong> 边栏选项卡上，指定以下设置（将其他设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>名称</td>
          <td><strong>az104-08-rg01-vnet</strong></td>
        </tr>
        <tr>
          <td>地址范围</td>
          <td><strong>10.80.0.0/20</strong></td>
        </tr>
        <tr>
          <td>子网名</td>
          <td><strong>subnet0</strong></td>
        </tr>
        <tr>
          <td>子网范围</td>
          <td><strong>10.80.0.0/24</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“确认”</strong> 回到 <strong>“创建虚拟机”</strong> 边栏选项卡的 <strong>“网络”</strong> 选项卡上，指定以下设置（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>子网</td>
          <td><strong>subnet0</strong></td>
        </tr>
        <tr>
          <td>公共 IP</td>
          <td><strong>默认</strong></td>
        </tr>
        <tr>
          <td>NIC 网络安全组</td>
          <td><strong>基本</strong></td>
        </tr>
        <tr>
          <td>公共入站端口</td>
          <td><strong>无</strong></td>
        </tr>
        <tr>
          <td>加速网络</td>
          <td><strong>关闭</strong></td>
        </tr>
        <tr>
          <td>将此虚拟机置于现有负载均衡解决方案之后？</td>
          <td><strong>否</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“下一步: 管理 &gt;”</strong>，在 <strong>“创建虚拟机”</strong> 边栏选项卡的 <strong>“管理”</strong> 选项卡上，指定以下设置（其余设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>引导诊断</td>
          <td><strong>使用自定义存储帐户启用</strong></td>
        </tr>
        <tr>
          <td>诊断存储帐户</td>
          <td>接受默认值</td>
        </tr>
        <tr>
          <td>修补业务流程选项</td>
          <td><strong>手动更新</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： 如有必要，请在下拉列表中选择现有存储帐户。记录存储帐户的名称。你将在下一个任务中使用它。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“下一步: 高级 &gt;”</strong>，在 <strong>“创建虚拟机”</strong> 边栏选项卡的 <strong>“高级”</strong> 选项卡上，查看可用设置（不做任何修改），然后单击 <strong>“查看 + 创建”</strong>。</p>
  </li>
  <li>
    <p>单击 <strong>“查看 + 创建”</strong> 边栏选项卡上的 <strong>“创建”</strong>。</p>
  </li>
  <li>
    <p>单击“部署”边栏选项卡上的 <strong>“模板”</strong>。</p>
  </li>
  <li>
    <p>查看代表正在进行的部署的模板，然后单击 <strong>“部署”</strong>。</p>

    <blockquote>
      <p><strong>注意</strong>： 将使用此选项部署具有匹配配置（可用性区域除外）的第二个虚拟机。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“自定义部署”</strong> 边栏选项卡上，指定以下设置（其余设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>资源组</td>
          <td><strong>az104-08-rg01</strong></td>
        </tr>
        <tr>
          <td>网络接口名称</td>
          <td><strong>az104-08-vm1-nic1</strong></td>
        </tr>
        <tr>
          <td>公共 IP 地址名称</td>
          <td><strong>az104-08-vm1-ip</strong></td>
        </tr>
        <tr>
          <td>虚拟机名称</td>
          <td><strong>az104-08-vm1</strong></td>
        </tr>
        <tr>
          <td>虚拟机计算机名称</td>
          <td><strong>az104-08-vm1</strong></td>
        </tr>
        <tr>
          <td>管理员用户名</td>
          <td><strong>Student</strong></td>
        </tr>
        <tr>
          <td>管理员密码</td>
          <td><strong>Pa55w.rd1234</strong></td>
        </tr>
        <tr>
          <td>启用热补丁</td>
          <td><strong>false</strong></td>
        </tr>
        <tr>
          <td>区域</td>
          <td><strong>2</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： 需使用模板修改与所部署的不同资源之属性相对应的参数，包括虚拟机及其网络接口。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“查看 + 创建”</strong>，在 <strong>“查看 + 创建”</strong> 边栏选项卡上，单击 <strong>“创建”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 等待两个部署完成，然后继续进行下一个任务。该过程大约需要 5 分钟。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-2使用虚拟机扩展配置-azure-虚拟机">任务 2：使用虚拟机扩展配置 Azure 虚拟机</h4>

<p>在此任务中，将使用自定义脚本虚拟机扩展将 Windows Server Web 服务器角色安装在上一个任务中部署的两个 Azure 虚拟机上。</p>

<ol>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“存储帐户”</strong>，然后在 <strong>“存储帐户”</strong> 边栏选项卡上，单击代表在上一个任务中创建的诊断存储帐户的条目。</p>
  </li>
  <li>
    <p>在存储帐户边栏选项卡上的 <strong>“数据存储”</strong> 部分，依次单击 <strong>“容器”</strong> 和 <strong>“+容器”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“新建容器”</strong> 边栏选项卡上，指定以下设置（其他设置保留默认值），然后单击 <strong>“创建”</strong>：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>名称</td>
          <td><strong>脚本</strong></td>
        </tr>
        <tr>
          <td>公共访问级别</td>
          <td><strong>专用（不允许匿名访问</strong>）</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>返回到显示容器列表的“存储帐户”边栏选项卡，单击 <strong>“脚本”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“脚本”</strong> 边栏选项卡上，单击 <strong>“上传”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“上传 blob”</strong> 边栏选项卡上，单击文件夹图标，在 <strong>“打开”</strong> 对话框中，导航到 <strong>“\Allfiles\Labs\08”</strong> 文件夹，选择 <strong>“az104-08-install_IIS.ps1”</strong>，单击 <strong>“打开”</strong>，然后返回到 <strong>“上传 blob”</strong> 边栏选项卡，单击 <strong>“上传”</strong>。</p>
  </li>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“虚拟机”</strong>，然后在 <strong>“虚拟机”</strong> 边栏选项卡上，单击 <strong>“az104-08-vm0”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>az104-08-vm0</strong> 虚拟机边栏选项卡的 <strong>“设置”</strong> 部分，单击 <strong>“扩展”</strong>，然后单击 <strong>“+ 添加”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“新建资源”</strong> 边栏选项卡上，单击 <strong>“自定义脚本扩展”</strong>，然后单击 <strong>“创建”</strong>。</p>
  </li>
  <li>
    <p>从 <strong>“安装扩展”</strong> 边栏选项卡中，单击 <strong>“浏览”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“存储帐户”</strong> 边栏选项卡上，单击 <strong>az104-08-install_IIS.ps1</strong> 脚本上传到的存储帐户的名称，在 <strong>“容器”</strong> 边栏选项卡上，单击 <strong>“脚本”</strong>，在 <strong>“脚本”</strong> 边栏选项卡上，单击 <strong>“az104-08-install_IIS.ps1”</strong>，然后单击 <strong>“选择”</strong>。</p>
  </li>
  <li>
    <p>返回“<strong>安装扩展</strong>”边栏选项卡，单击“<strong>查看 + 创建</strong>”，然后单击“<strong>创建</strong>”。</p>
  </li>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“虚拟机”</strong>，然后在 <strong>“虚拟机”</strong> 边栏选项卡上，单击 <strong>“az104-08-vm1”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az104-08-vm1”</strong> 边栏选项卡的 <strong>“自动化”</strong> 部分，单击 <strong>“导出模板”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az104-08-vm1 - 导出模板”</strong> 边栏选项卡上，单击 <strong>“部署”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“自定义部署”</strong> 边栏选项卡上，单击 <strong>“编辑模板”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 忽略此消息： <strong>“资源组位于模板中一个或多个资源不支持的位置。 请选择其他资源组”</strong>。 这是在预料之中的，在这种情况下可以忽略。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“编辑模板”</strong> 边栏选项卡上显示模板内容的部分，从第 <strong>20</strong> 行开始（在 <code>"resources": [</code> 这一行的正下方）插入以下代码：</p>

    <blockquote>
      <p><strong>备注</strong>： 如果使用逐行粘贴代码的工具，IntelliSense 可能会添加多余的括号，从而导致验证错误。可能需要先将代码粘贴到记事本中，再将其粘贴到第 20 行中。</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-json hljs">     {
         <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Microsoft.Compute/virtualMachines/extensions"</span></span>,
         <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"az104-08-vm1/customScriptExtension"</span></span>,
         <span class="hljs-attr"><span class="hljs-attr">"apiVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-06-01"</span></span>,
         <span class="hljs-attr"><span class="hljs-attr">"location"</span></span>: <span class="hljs-string"><span class="hljs-string">"[resourceGroup().location]"</span></span>,
         <span class="hljs-attr"><span class="hljs-attr">"dependsOn"</span></span>: [
             <span class="hljs-string"><span class="hljs-string">"az104-08-vm1"</span></span>
         ],
         <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: {
             <span class="hljs-attr"><span class="hljs-attr">"publisher"</span></span>: <span class="hljs-string"><span class="hljs-string">"Microsoft.Compute"</span></span>,
             <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"CustomScriptExtension"</span></span>,
             <span class="hljs-attr"><span class="hljs-attr">"typeHandlerVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.7"</span></span>,
             <span class="hljs-attr"><span class="hljs-attr">"autoUpgradeMinorVersion"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>,
             <span class="hljs-attr"><span class="hljs-attr">"settings"</span></span>: {
                 <span class="hljs-attr"><span class="hljs-attr">"commandToExecute"</span></span>: <span class="hljs-string"><span class="hljs-string">"powershell.exe Install-WindowsFeature -name Web-Server -IncludeManagementTools &amp;&amp; powershell.exe remove-item 'C:\\inetpub\\wwwroot\\iisstart.htm' &amp;&amp; powershell.exe Add-Content -Path 'C:\\inetpub\\wwwroot\\iisstart.htm' -Value $('Hello World from ' + $env:computername)"</span></span>
           }
         }
     },

</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 模板的此部分定义了先前通过 Azure PowerShell 部署到第一台虚拟机的同一 Azure 虚拟机自定义脚本扩展。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“保存”</strong>，返回 <strong>“自定义模板”</strong> 边栏选项卡，单击 <strong>“查看 + 创建”</strong>，然后在 <strong>“查看 + 创建”</strong> 边栏选项卡上，单击 <strong>“创建”</strong></p>

    <blockquote>
      <p><strong>备注</strong>： 等待模板部署完成。可从 <strong>az104-08-vm0</strong> 和 <strong>az104-08-vm1</strong> 虚拟机的 <strong>“扩展”</strong> 边栏选项卡监控进度。所需时长应该不超过 3 分钟。</p>
    </blockquote>
  </li>
  <li>
    <p>要验证基于自定义脚本扩展的配置是否成功，请导航回 <strong>“az104-08-vm1”</strong> 边栏选项卡，单击 <strong>“操作”</strong> 部分的 <strong>“运行命令”</strong>，然后单击命令列表中的 <strong>“RunPowerShellScript”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“运行命令脚本”</strong> 边栏选项卡中键入以下内容，单击 <strong>“运行”</strong> 访问托管在 <strong>az104-08-vm0</strong>上的网站 ：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-powershell">Invoke-WebRequest -URI http://10.80.0.4 -UseBasicParsing
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： <strong>-UseBasicParsing</strong> 参数对消除 Internet Explorer 上的依赖项以完成 cmdlet 的执行来说很有必要</p>
    </blockquote>

    <blockquote>
      <p><strong>注意</strong>： 你还可连接到 <strong>az104-08-vm0</strong> 并运行 <code>Invoke-WebRequest -URI http://10.80.0.5 -UseBasicParsing</code> 以访问托管在 <strong>az104-08-vm1</strong> 上的网站。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-3缩放-azure-虚拟机的计算和存储">任务 3：缩放 Azure 虚拟机的计算和存储</h4>

<p>在此任务中，将通过更改 Azure 虚拟机的大小来缩放计算，并通过附加和配置数据磁盘来缩放其存储。</p>

<ol>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“虚拟机”</strong>，在 <strong>“虚拟机”</strong> 边栏选项卡上，单击 <strong>“az104-08-vm0”</strong>。</p>
  </li>
  <li>
    <p>单击 <strong>az104-08-vm0</strong> 虚拟机边栏选项卡上的 <strong>“大小”</strong>，将虚拟机大小设置为 <strong>“标准 DS1_v2”</strong>，然后单击 <strong>“调整大小”</strong></p>

    <blockquote>
      <p><strong>注意</strong>： 如果 <strong>“DS1_v2 标准”</strong> 不可用，请选择其他大小。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“az104-08-vm0”</strong> 虚拟机边栏选项卡上的 <strong>“磁盘”</strong>，单击 <strong>“数据磁盘”</strong> 下方的 <strong>“+ 创建并附加新磁盘”</strong>。</p>
  </li>
  <li>
    <p>使用以下设置创建托管磁盘（其余设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>磁盘名称</td>
          <td><strong>az104-08-vm0-datadisk-0</strong></td>
        </tr>
        <tr>
          <td>存储类型</td>
          <td><strong>高级 SSD</strong></td>
        </tr>
        <tr>
          <td>大小 (GiB)</td>
          <td><strong>1024</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>回到 <strong>“az104-08-vm0 - 磁盘”</strong> 边栏选项卡，在 <strong>“数据磁盘”</strong> 下方单击 <strong>“+ 创建并附加新磁盘”</strong>。</p>
  </li>
  <li>
    <p>使用以下设置创建托管磁盘（其他设置保留默认值），并保存更改：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>磁盘名称</td>
          <td><strong>az104-08-vm0-datadisk-1</strong></td>
        </tr>
        <tr>
          <td>存储类型</td>
          <td><strong>高级 SSD</strong></td>
        </tr>
        <tr>
          <td>大小 (GiB)</td>
          <td><strong>1024 GiB</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>回到 <strong>“az104-08-vm0 - 磁盘”</strong> 边栏选项卡，单击 <strong>“保存”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az104-08-vm0”</strong> 边栏选项卡的 <strong>“操作”</strong> 部分单击 <strong>“运行命令”</strong>，然后单击命令列表中的 <strong>“RunPowerShellScript”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“运行命令脚本”</strong> 边栏选项卡中键入以下命令，单击 <strong>“运行”</strong> 创建驱动器 Z:（由两个新附加的布局简单和预配固定的磁盘组成）：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-powershell">New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 等待确认命令已成功完成。</p>
    </blockquote>
  </li>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“虚拟机”</strong>，然后在 <strong>“虚拟机”</strong> 边栏选项卡上，单击 <strong>“az104-08-vm1”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az104-08-vm1”</strong> 边栏选项卡的 <strong>“自动化”</strong> 部分，单击 <strong>“导出模板”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az104-08-vm1 - 导出模板”</strong> 边栏选项卡上，单击 <strong>“部署”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“自定义部署”</strong> 边栏选项卡上，单击 <strong>“编辑模板”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 忽略此消息： <strong>“资源组位于模板中一个或多个资源不支持的位置。请选择其他资源组”</strong>。这是在预料之中的，在这种情况下可以忽略。</p>
    </blockquote>
  </li>
  <li>
    <p>在“<strong>编辑模板</strong>”边栏选项卡上显示模板内容的部分，将第 <strong>30</strong> 行（<code>"vmSize": "Standard_D2s_v3"</code>) 替换为以下行：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-json hljs">                 <span class="hljs-string"><span class="hljs-string">"vmSize"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard_DS1_v2"</span></span>

</code></pre>

    <blockquote>
      <p><strong>备注</strong>：模板此部分定义的 Azure 虚拟机大小与通过 Azure 门户为第一台虚拟机指定的大小相同。</p>
    </blockquote>
  </li>
  <li>
    <p>在“<strong>编辑模板</strong>”边栏选项卡上显示模板内容的部分，将第 <strong>50</strong> 行（<code>"dataDisks": [ ]</code>) 替换为以下代码：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-json hljs">                 <span class="hljs-string"><span class="hljs-string">"dataDisks"</span></span>: [
                   {
                     <span class="hljs-attr"><span class="hljs-attr">"lun"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"az104-08-vm1-datadisk0"</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"diskSizeGB"</span></span>: <span class="hljs-string"><span class="hljs-string">"1024"</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"caching"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReadOnly"</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"createOption"</span></span>: <span class="hljs-string"><span class="hljs-string">"Empty"</span></span>
                   },
                   {
                     <span class="hljs-attr"><span class="hljs-attr">"lun"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"az104-08-vm1-datadisk1"</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"diskSizeGB"</span></span>: <span class="hljs-string"><span class="hljs-string">"1024"</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"caching"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReadOnly"</span></span>,
                     <span class="hljs-attr"><span class="hljs-attr">"createOption"</span></span>: <span class="hljs-string"><span class="hljs-string">"Empty"</span></span>
                   }
                 ]
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 如果使用逐行粘贴代码的工具，IntelliSense 可能会添加多余的括号，从而导致验证错误。可能需要先将代码粘贴到记事本中，再将其粘贴到第 49 行中。</p>
    </blockquote>

    <blockquote>
      <p><strong>注意</strong>： 模板此部分创建两个托管磁盘并将其附加到 <strong>az104-08-vm1</strong>，类似于通过 Azure 门户对第一台虚拟机进行的存储配置。</p>
    </blockquote>
  </li>
  <li>
    <p>单击“保存”，返回“自定义模板”边栏选项卡，单击“查看 + 创建”，然后在“查看 + 创建”边栏选项卡上，单击“创建”。</p>

    <blockquote>
      <p><strong>注意</strong>： 等待模板部署完成。从 <strong>az104-08-vm1</strong> 虚拟机的 <strong>“磁盘”</strong> 边栏选项卡可以监控进度。所需时长应该不超过 3 分钟。</p>
    </blockquote>
  </li>
  <li>
    <p>回到 <strong>“az104-08-vm1”</strong> 边栏选项卡，单击 <strong>“操作”</strong> 部分的 <strong>“运行命令”</strong>， 然后单击命令列表中的 <strong>“RunPowerShellScript”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“运行命令脚本”</strong> 边栏选项卡中键入以下内容，单击 <strong>“运行”</strong> 创建驱动器 Z:（由两个新附加的布局简单和预配固定的磁盘组成）：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-powershell">New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 等待确认命令已成功完成。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-4注册-microsoftinsights-和-microsoftalertsmanagement-资源提供程序">任务 4：注册 Microsoft.Insights 和 Microsoft.AlertsManagement 资源提供程序</h4>

<ol>
  <li>
    <p>在 Azure 门户中，单击 Azure 门户右上方的图标，打开 <strong>Azure Cloud Shell</strong>。</p>
  </li>
  <li>
    <p>提示选择 <strong>“Bash”</strong> 或 <strong>“PowerShell”</strong> 时，选择 <strong>“PowerShell”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 如果这是第一次启动 <strong>Cloud Shell</strong>，并看到 <strong>“未装载任何存储”</strong> 消息，请选择在本实验室中使用的订阅，然后选择 <strong>“创建存储”</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>在“Cloud Shell”窗格中，运行以下命令以注册 Microsoft.Insights 和 Microsoft.AlertsManagement 资源提供程序。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-powershell">Register-AzResourceProvider -ProviderNamespace Microsoft.Insights

Register-AzResourceProvider -ProviderNamespace Microsoft.AlertsManagement
</code></pre>
  </li>
</ol>

<h4 id="任务-5使用-azure-门户部署可复原区域的-azure-虚拟机规模集">任务 5：使用 Azure 门户部署可复原区域的 Azure 虚拟机规模集</h4>

<p>在此任务中，将使用 Azure 门户跨可用性区域部署 Azure 虚拟机规模集。</p>

<ol>
  <li>
    <p>在 Azure 门户中搜索并选择 <strong>“虚拟机规模集”</strong>，然后在 <strong>“虚拟机规模集”</strong> 边栏选项卡上单击 <strong>“+添加”</strong> （或 <strong>“+创建”</strong>）。</p>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“基本信息”</strong> 选项卡上，指定以下设置（其他设置保留默认值），然后单击 <strong>“下一步: 磁盘 &gt;”</strong>：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>订阅</td>
          <td>在本实验室中使用的 Azure 订阅的名称</td>
        </tr>
        <tr>
          <td>资源组</td>
          <td>新资源组的名称 <strong>“az104-08-rg02”</strong></td>
        </tr>
        <tr>
          <td>虚拟机规模集名称</td>
          <td><strong>az10408vmss0</strong></td>
        </tr>
        <tr>
          <td>区域</td>
          <td>选择其中一个支持可用性区域且可预配 Azure 虚拟机的区域，该区域与之前在本实验室中部署虚拟机的区域不同</td>
        </tr>
        <tr>
          <td>可用性区域</td>
          <td><strong>区域 1、2、3</strong></td>
        </tr>
        <tr>
          <td>映像</td>
          <td><strong>Windows Server 2019 Datacenter - Gen2</strong></td>
        </tr>
        <tr>
          <td>Azure Spot 实例</td>
          <td><strong>否</strong></td>
        </tr>
        <tr>
          <td>大小</td>
          <td><strong>标准 D2s_v3</strong></td>
        </tr>
        <tr>
          <td>用户名</td>
          <td><strong>Student</strong></td>
        </tr>
        <tr>
          <td>密码</td>
          <td><strong>Pa55w.rd1234</strong></td>
        </tr>
        <tr>
          <td>已有 Windows Server 许可证？</td>
          <td><strong>否</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： 有关支持将 Windows 虚拟机部署到可用性区域的 Azure 区域列表，请参阅 <a href="https://docs.microsoft.com/zh-cn/azure/availability-zones/az-overview">Azure 中的可用性区域是什么？</a></p>
    </blockquote>
  </li>
  <li>
    <p>接受 <strong>“创建虚拟机规模集”</strong> 边栏选项卡 <strong>“磁盘”</strong> 选项卡上的默认值，然后单击 <strong>“下一步: 网络 &gt;”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“网络”</strong> 选项卡，单击 <strong>“虚拟网络”</strong> 文本框下方的 <strong>“创建虚拟网络”</strong> 链接，使用以下设置创建新的虚拟网络（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>名称</td>
          <td><strong>az104-08-rg02-vnet</strong></td>
        </tr>
        <tr>
          <td>地址范围</td>
          <td><strong>10.82.0.0/20</strong></td>
        </tr>
        <tr>
          <td>子网名</td>
          <td><strong>subnet0</strong></td>
        </tr>
        <tr>
          <td>子网范围</td>
          <td><strong>10.82.0.0/24</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： 创建新的虚拟网络并返回到 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“网络”</strong> 选项卡后， <strong>“虚拟网络”</strong> 值将自动设置为 <strong>“az104-08-rg02-vnet”</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>回到 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“网络”</strong> 选项卡，单击网络接口条目右侧的 <strong>“编辑网络接口”</strong> 图标。</p>
  </li>
  <li>
    <p>在 <strong>“编辑网络接口”</strong> 边栏选项卡上的 <strong>“NIC 网络安全组”</strong> 部分，单击 <strong>“高级”</strong>，然后单击 <strong>“配置网络安全组”</strong> 下拉列表下的 <strong>“新建”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“创建网络安全组”</strong> 边栏选项卡上，指定以下设置（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>名称</td>
          <td><strong>az10408vmss0-nsg</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“添加入站规则”</strong>，使用以下设置添加入站安全规则（其余设置保留为默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>源</td>
          <td><strong>任何</strong></td>
        </tr>
        <tr>
          <td>源端口范围</td>
          <td><strong>*</strong></td>
        </tr>
        <tr>
          <td>目标</td>
          <td><strong>任何</strong></td>
        </tr>
        <tr>
          <td>目标端口范围</td>
          <td><strong>80</strong></td>
        </tr>
        <tr>
          <td>协议</td>
          <td><strong>TCP</strong></td>
        </tr>
        <tr>
          <td>操作</td>
          <td><strong>允许</strong></td>
        </tr>
        <tr>
          <td>优先级</td>
          <td><strong>1010</strong></td>
        </tr>
        <tr>
          <td>名称</td>
          <td><strong>custom-allow-http</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“添加”</strong>，回到 <strong>“创建网络安全组”</strong> 边栏选项卡，单击 <strong>“确认”</strong>。</p>
  </li>
  <li>
    <p>回到 <strong>“编辑网络接口”</strong> 边栏选项卡，单击 <strong>“公用 IP 地址”</strong> 部分的 <strong>“已启用”</strong>，然后单击 <strong>“确认”</strong>。</p>
  </li>
  <li>
    <p>返回到 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“网络”</strong> 选项卡，在 <strong>“负载均衡”</strong> 部分下，确保选中 <strong>“使用负载均衡器”</strong> 条目，并指定以下负载均衡设置（其他设置保留默认值），然后单击 <strong>“下一步: 缩放 &gt;”</strong>：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>负载均衡选项</td>
          <td><strong>Azure 负载均衡器</strong></td>
        </tr>
        <tr>
          <td>选择负载均衡器</td>
          <td><strong>（新）az10408vmss0-lb</strong></td>
        </tr>
        <tr>
          <td>选择后端池</td>
          <td><strong>（新）bepool</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“缩放”</strong> 选项卡上，指定以下设置（其他设置保留默认值），然后单击 <strong>“下一步: 管理 &gt;”</strong>：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>初始实例计数</td>
          <td><strong>2</strong></td>
        </tr>
        <tr>
          <td>缩放策略</td>
          <td><strong>手动</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“管理”</strong> 选项卡上，指定以下设置（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>引导诊断</td>
          <td><strong>使用自定义存储帐户启用</strong></td>
        </tr>
        <tr>
          <td>诊断存储帐户</td>
          <td>接受默认值</td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： 下一个任务会用到此存储帐户的名称。</p>
    </blockquote>

    <p>单击 <strong>“下一步: 运行状况 &gt;”</strong>：</p>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“运行状况”</strong> 选项卡中查看默认设置，但不做任何修改，然后单击 <strong>“下一步: 高级 &gt;”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“高级”</strong> 选项卡中，指定以下设置（其他设置保留默认值），然后单击 <strong>“查看 + 创建”</strong>。</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>传播算法</td>
          <td><strong>固定传播（不推荐用于区域）</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： <strong>“最大传播”</strong> 设置当前不起作用。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“创建虚拟机规模集”</strong> 边栏选项卡的 <strong>“查看 + 创建”</strong> 选项卡上确保验证通过，然后单击 <strong>“创建”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 等待虚拟机规模集部署完成。该过程需要约 5 分钟。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-6使用虚拟机扩展配置-azure-虚拟机规模集">任务 6：使用虚拟机扩展配置 Azure 虚拟机规模集</h4>

<p>在此任务中，将使用自定义脚本虚拟机扩展将 Windows Server Web 服务器角色安装在上一个任务中部署的 Azure 虚拟机规模集的实例上。</p>

<ol>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“存储帐户”</strong>，然后在 <strong>“存储帐户”</strong> 边栏选项卡上，单击代表在上一个任务中创建的诊断存储帐户的条目。</p>
  </li>
  <li>
    <p>在存储帐户边栏选项卡上的 <strong>“数据存储”</strong> 部分，依次单击 <strong>“容器”</strong> 和 <strong>“+容器”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“新建容器”</strong> 边栏选项卡上，指定以下设置（其他设置保留默认值），然后单击 <strong>“创建”</strong>：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>名称</td>
          <td><strong>脚本</strong></td>
        </tr>
        <tr>
          <td>公共访问级别</td>
          <td><strong>专用（不允许匿名访问</strong>）</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>返回到显示容器列表的“存储帐户”边栏选项卡，单击 <strong>“脚本”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“脚本”</strong> 边栏选项卡上，单击 <strong>“上传”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“上传 blob”</strong> 边栏选项卡上，单击文件夹图标，在 <strong>“打开”</strong> 对话框中，导航到 <strong>“\Allfiles\Labs\08”</strong> 文件夹，选择 <strong>“az104-08-install_IIS.ps1”</strong>，单击 <strong>“打开”</strong>，然后返回到 <strong>“上传 blob”</strong> 边栏选项卡，单击 <strong>“上传”</strong>。</p>
  </li>
  <li>
    <p>在 Azure 门户中导航回 <strong>“虚拟机规模集”</strong> 边栏选项卡，然后单击 <strong>“az10408vmss0”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az10408vmss0”</strong> 边栏选项卡的 <strong>“设置”</strong> 部分，单击 <strong>“扩展”</strong>，然后单击 <strong>“+ 添加”</strong>。</p>
  </li>
  <li>
    <p>在“<strong>新建资源</strong>”边栏选项卡上，单击“<strong>自定义脚本扩展</strong>”，然后单击“<strong>下一步</strong>”。</p>
  </li>
  <li>
    <p>从 <strong>“安装扩展”</strong> 边栏选项卡，浏览并选择之前在本任务中上传至存储账户脚本容器的 <strong>“az104-08-install_IIS.ps1”</strong> 脚本，然后单击 <strong>“确定”</strong>。</p>

    <blockquote>
      <p><strong>注意</strong>： 等待扩展安装完成，再继续下一步。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“az10408vmss0”</strong> 边栏选项卡 <strong>“设置”</strong> 部分的 <strong>“实例”</strong>，选中虚拟机规模集两个实例旁边的复选框，单击 <strong>“升级”</strong>，然后在提示确认时，单击 <strong>“是”</strong>。</p>

    <blockquote>
      <p><strong>注意</strong>： 等待升级完成，再继续下一步。</p>
    </blockquote>
  </li>
  <li>
    <p>在 Azure 门户中，搜索并选择 <strong>“负载均衡器”</strong>，然后在负载均衡器列表中，单击 <strong>“az10408vmss0”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“az10408vmss0”</strong> 边栏选项卡上，记下分配给负载均衡器前端的 <strong>“公共 IP 地址”</strong> 的值，打开新的浏览器标签页，然后导航到该 IP 地址。</p>

    <blockquote>
      <p><strong>备注</strong>： 验证浏览器页面是否显示 Azure 虚拟机扩展集 <strong>az10408vmss0</strong> 的一个实例的名称。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-7缩放-azure-虚拟机规模集的计算和存储">任务 7：缩放 Azure 虚拟机规模集的计算和存储</h4>

<p>在此任务中，你将更改虚拟机规模集实例的大小，配置其自动缩放设置，并为其附加磁盘。</p>

<ol>
  <li>
    <p>在 Azure 门户中搜索并选择 <strong>“虚拟机规模集”</strong>，然后选择 <strong>“az10408vmss0”</strong> 规模集</p>
  </li>
  <li>
    <p>在 <strong>“az10408vmss0”</strong> 边栏选项卡的 <strong>“设置”</strong> 部分，单击 <strong>“大小”</strong>。</p>
  </li>
  <li>
    <p>在可用大小列表中，选择 <strong>“DS1_v2 标准”</strong>，然后单击 <strong>“调整大小”</strong>。</p>
  </li>
  <li>
    <p>单击 <strong>“设置”</strong> 部分的 <strong>“实例”</strong>，选中虚拟机规模集的两个实例旁边的复选框，单击 <strong>“升级”</strong>，然后在提示确认时单击 <strong>“是”</strong>。</p>
  </li>
  <li>
    <p>在实例列表中，单击代表第一个实例的条目，然后注意其在规模集实例边栏选项卡上的 <strong>“位置”</strong> （其应该是已部署 Azure 虚拟机规模集的目标 Azure 区域中的其中一个区域）。</p>
  </li>
  <li>
    <p>返回到 <strong>“az10408vmss0 - 实例”</strong> 边栏选项卡，单击代表第二个实例的条目，然后注意其在规模集实例边栏选项卡上的 <strong>“位置”</strong> （其应该是已部署 Azure 虚拟机规模集的目标 Azure 区域中的其他两个区域之一）。</p>
  </li>
  <li>
    <p>返回 <strong>“az10408vmss0”</strong> - <strong>“实例”</strong> 边栏选项卡，然后在 <strong>“设置”</strong> 部分单击 <strong>“缩放”</strong>。</p>
  </li>
  <li>
    <p>选择 <strong>“az10408vmss0 - 缩放”</strong> 边栏选项卡上的 <strong>“自定义自动缩放”</strong> 选项，使用以下设置配置自动缩放（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>缩放模式</td>
          <td><strong>根据指标进行缩放</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“+ 添加规则”</strong> 链接，在 <strong>“缩放规则”</strong> 边栏选项卡上，指定以下设置（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>指标源</td>
          <td><strong>当前资源 (az10480vmss0)</strong></td>
        </tr>
        <tr>
          <td>时间聚合</td>
          <td><strong>平均值</strong></td>
        </tr>
        <tr>
          <td>指标命名空间</td>
          <td><strong>虚拟机主机</strong></td>
        </tr>
        <tr>
          <td>指标名称</td>
          <td><strong>网络流入量总计</strong></td>
        </tr>
        <tr>
          <td>运算符</td>
          <td><strong>大于</strong></td>
        </tr>
        <tr>
          <td>触发缩放操作的指标阈值</td>
          <td><strong>10</strong></td>
        </tr>
        <tr>
          <td>持续时间（以分钟为单位）</td>
          <td><strong>1</strong></td>
        </tr>
        <tr>
          <td>时间粒度统计信息</td>
          <td><strong>平均值</strong></td>
        </tr>
        <tr>
          <td>操作</td>
          <td><strong>计数增加</strong></td>
        </tr>
        <tr>
          <td>实例计数</td>
          <td><strong>1</strong></td>
        </tr>
        <tr>
          <td>冷却（分钟）</td>
          <td><strong>5</strong></td>
        </tr>
      </tbody>
    </table>

    <blockquote>
      <p><strong>备注</strong>： 显然，这些值并不代表实际配置，因为它们的目的是在不延长等待时间的情况下尽快触发自动缩放。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“添加”</strong>，回到 <strong>“az10408vmss0”</strong> - <strong>“缩放”</strong> 边栏选项卡，指定以下设置（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>实例限制（最小）</td>
          <td><strong>1</strong></td>
        </tr>
        <tr>
          <td>实例限制（最大）</td>
          <td><strong>3</strong></td>
        </tr>
        <tr>
          <td>实例限制（默认）</td>
          <td><strong>1</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>单击 <strong>“保存”</strong>。</p>
  </li>
  <li>
    <p>在 Azure 门户中，单击 Azure 门户右上方的图标，打开 <strong>Azure Cloud Shell</strong>。</p>
  </li>
  <li>
    <p>提示选择 <strong>“Bash”</strong> 或 <strong>“PowerShell”</strong> 时，选择 <strong>“PowerShell”</strong>。</p>
  </li>
  <li>
    <p>在“Cloud Shell”窗格中运行以下命令，以标识 Azure 虚拟机规模集 <strong>az10408vmss0</strong> 前面的负载均衡器的公共 IP 地址。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-powershell">$rgName = 'az104-08-rg02'

$lbpipName = 'az10408vmss0-ip'

$pip = (Get-AzPublicIpAddress -ResourceGroupName $rgName -Name $lbpipName).IpAddress
</code></pre>
  </li>
  <li>
    <p>在“Cloud Shell”窗格中运行以下命令启动无限循环，该循环将 HTTP 请求发送至托管在 Azure 虚拟机规模集 <strong>az10408vmss0</strong> 实例上的网站。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-powershell">while ($true) { Invoke-WebRequest -Uri "http://$pip" }
</code></pre>
  </li>
  <li>
    <p>最小化“Cloud Shell”窗格但勿关闭，切换回 <strong>“az10408vmss0”-“实例”</strong> 边栏选项卡，并监视实例数。</p>

    <blockquote>
      <p><strong>注意</strong>： 可能需要等待几分钟，然后单击 <strong>“刷新”</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>预配第三个实例后，导航至其边栏选项卡确定其<strong>位置</strong> （其应该与之前在此任务中标识的前两个区域不同）。</p>
  </li>
  <li>
    <p>关闭“Cloud Shell”窗格。</p>
  </li>
  <li>
    <p>在 <strong>“az10408vmss0”</strong> 边栏选项卡的 <strong>“设置”</strong> 部分，依次单击 <strong>“磁盘”</strong> 和 <strong>“+ 创建并附加新磁盘”</strong>，然后使用以下设置附加新的托管磁盘（其他设置保留默认值）：</p>

    <table>
      <thead>
        <tr>
          <th>设置</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>LUN</td>
          <td><strong>0</strong></td>
        </tr>
        <tr>
          <td>存储类型</td>
          <td><strong>标准 HDD</strong></td>
        </tr>
        <tr>
          <td>大小 (GiB)</td>
          <td><strong>32</strong></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>保存更改，在 <strong>“az10408vmss0”</strong> 边栏选项卡的 <strong>“设置”</strong> 部分，单击 <strong>“实例”</strong>，选中虚拟机规模集实例旁边的复选框，然后单击 <strong>“升级”</strong>，在提示确认时单击 <strong>“是”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 上一步中附加的磁盘是原始磁盘。在使用之前需要创建一个分区、创建文件系统并进行装载。为此，将使用 Azure 虚拟机自定义脚本扩展。首先，需要删除现有的自定义脚本扩展。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“az10408vmss0”</strong> 边栏选项卡的 <strong>“设置”</strong> 部分，单击 <strong>“扩展”</strong>，单击 <strong>“CustomScriptExtension”</strong>，然后单击 <strong>“卸载”</strong>。</p>

    <blockquote>
      <p><strong>备注</strong>： 等待卸载完成。</p>
    </blockquote>
  </li>
  <li>
    <p>在 Azure 门户中，单击 Azure 门户右上方的图标，打开 <strong>Azure Cloud Shell</strong>。</p>
  </li>
  <li>
    <p>提示选择 <strong>“Bash”</strong> 或 <strong>“PowerShell”</strong> 时，选择 <strong>“PowerShell”</strong>。</p>
  </li>
  <li>
    <p>在“Cloud Shell”窗格的工具栏中单击 <strong>“上传/下载文件”</strong> 图标，在下拉菜单中单击 <strong>“上传”</strong>，然后将文件 <strong>\Allfiles\Labs\08\az104-08-configure_VMSS_disks.ps1</strong> 上传到 Cloud Shell 主目录中。</p>
  </li>
  <li>
    <p>在 Cloud Shell 窗格中运行下列命令以显示脚本内容：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-powershell">Set-Location -Path $HOME

Get-Content -Path ./az104-08-configure_VMSS_disks.ps1
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 该脚本将安装配置附加磁盘的自定义脚本扩展。</p>
    </blockquote>
  </li>
  <li>
    <p>在“Cloud Shell”窗格中，运行以下命令执行脚本并配置 Azure 虚拟机规模集的磁盘：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-powershell">./az104-08-configure_VMSS_disks.ps1
</code></pre>
  </li>
  <li>
    <p>关闭 Cloud Shell 窗格。</p>
  </li>
  <li>
    <p>单击 <strong>“az10408vmss0”</strong> 边栏选项卡 <strong>“设置”</strong> 部分的 <strong>“实例”</strong>，选中虚拟机规模集实例旁边的复选框，单击 <strong>“升级”</strong>，然后在提示确认时，单击 <strong>“是”</strong>。</p>
  </li>
</ol>

<h4 id="清理资源">清理资源</h4>

<blockquote>
  <p><strong>备注</strong>： 请记得删除任何新创建而不会再使用的 Azure 资源。删除未使用的资源，确保不产生意外费用。</p>
</blockquote>

<ol>
  <li>
    <p>在 Azure 门户中，在 <strong>“Cloud Shell”</strong> 窗格中打开 <strong>“PowerShell”</strong> 会话。</p>
  </li>
  <li>
    <p>通过运行以下命令删除 az104-08-configure_VMSS_disks.ps1：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="language-powershell">rm ~\az104-08*
</code></pre>
  </li>
  <li>
    <p>运行以下命令，列出在本模块各实验室中创建的所有资源组：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="language-powershell">Get-AzResourceGroup -Name 'az104-08*'
</code></pre>
  </li>
  <li>
    <p>运行以下命令，删除在本模块各个实验室中创建的所有资源组：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="language-powershell">Get-AzResourceGroup -Name 'az104-08*' | Remove-AzResourceGroup -Force -AsJob
</code></pre>

    <blockquote>
      <p><strong>备注</strong>： 该命令异步执行（由 -AsJob 参数确定），因此尽管此后可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上要花几分钟才能删除资源组。</p>
    </blockquote>
  </li>
</ol>

<h4 id="回顾">回顾</h4>

<p>在本实验室中，你已：</p>

<ul>
  <li>使用 Azure 门户和 Azure 资源管理器模板部署可复原区域的 Azure 虚拟机</li>
  <li>使用虚拟机扩展配置 Azure 虚拟机</li>
  <li>缩放 Azure 虚拟机的计算和存储</li>
  <li>使用 Azure 门户部署可复原区域的 Azure 虚拟机规模集</li>
  <li>使用虚拟机扩展配置 Azure 虚拟机规模集</li>
  <li>缩放 Azure 虚拟机规模集的计算和存储</li>
</ul>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-104ZH-MicrosoftAzureAdministrator" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-104ZH-MicrosoftAzureAdministrator
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D.js"></script>



</body></html>