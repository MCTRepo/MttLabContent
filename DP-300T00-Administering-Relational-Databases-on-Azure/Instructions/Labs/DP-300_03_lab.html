<!DOCTYPE html><html lang="en"><head>
        <title>
            DP-300T00-Administering-Relational-Databases-on-Azure
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D525e69932921e8ce30e81ee0f98ad4a87cda64ea.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                DP-300T00-Administering-Relational-Databases-on-Azure
            </a>
            <a href="https://github.com/MicrosoftLearning/DP-300T00-Administering-Relational-Databases-on-Azure" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    </ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="lab-3--implement-a-secure-environment">Lab 3 – Implement a Secure Environment</h1>

<p><strong>Estimated Time</strong>: 60 minutes</p>

<p><strong>Prerequisites</strong>: An Azure SQL server you created in the lab for Module 2. Azure Active Directory access in the subscription.</p>

<p><strong>Lab files</strong>: The files for this lab are in the D:\Labfiles\Secure Environment folder.</p>

<h1 id="lab-overview">Lab overview</h1>

<p>The students will take the information gained in the lessons to configure and subsequently implement security in the Azure Portal and within the AdventureWorks database.</p>

<h1 id="lab-objectives">Lab objectives</h1>

<p>After completing this lab, you will be able to:</p>

<ol>
  <li>
    <p>Configure an Azure SQL Database Firewall</p>
  </li>
  <li>
    <p>Authorize Access to Azure SQL Database with Azure Active Directory</p>
  </li>
  <li>
    <p>Manage access to database objects</p>
  </li>
</ol>

<h1 id="scenario">Scenario</h1>

<p>You have been hired as a Senior Database Administrator help ensure the security of the database environment. These tasks will focus on Azure SQL Database.</p>

<p><strong>Note:</strong> The exercises ask you to copy and paste T-SQL code. Please verify that the code has been copied correctly, with the proper line breaks, before executing the code.</p>

<h2 id="exercise-1-configure-an-azure-sql-database-firewall-and-connect-to-a-new-database">Exercise 1: Configure an Azure SQL Database Firewall and connect to a new database</h2>

<ol>
  <li>
    <p>From the lab virtual machine, start a browser session and navigate to <a href="https://portal.azure.com/">https://portal.azure.com</a>. Provide appropriate credentials.</p>

    <p><a href="/DP-300T00-Administering-Relational-Databases-on-Azure/Instructions/images/dp-3300-module-33-lab-01.png" target="_blank"><img src="/DP-300T00-Administering-Relational-Databases-on-Azure/Instructions/images/dp-3300-module-33-lab-01.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>
  </li>
  <li>
    <p>In the search bar at the top of the Azure Portal, type SQL. The SQL servers icon will appear. Click on SQL servers. Click on the server name to be taken to the detail page for the server you created in Lab 2</p>

    <p><a href="../images/dp-3300-module-33-lab-02.png" target="_blank"><img src="../images/dp-3300-module-33-lab-02.png" alt="A screenshot of a social media post Description automatically generated"></a></p>
  </li>
  <li>
    <p>In the detail screen for your SQL server, move your mouse to the right of the server name, and click copy to clipboard button as shown below.</p>

    <p><a href="../images/dp-3300-module-33-lab-03.png" target="_blank"><img src="../images/dp-3300-module-33-lab-03.png" alt="Picture 2"></a></p>
  </li>
  <li>
    <p>Click on Show firewall settings (above the server name that you just copied). Click on <strong>+ Add client IP</strong> as highlighted below and then click Save.</p>

    <p><a href="../images/dp-3300-module-33-lab-04.png" target="_blank"><img src="../images/dp-3300-module-33-lab-04.png" alt="Picture 3"></a></p>

    <p>This will allow you to connect to your Azure SQL Database server using SQL Server Management Studio or any other client tools. <strong>Important:</strong> Make note of your client IP address, you will use it later in this task.</p>
  </li>
  <li>
    <p>Open SQL Server Management Studio on the lab VM. Paste in the name of your Azure SQL database server and login with the credentials you created in Lab 2:</p>

    <ul>
      <li>
        <p>Server name: <strong>&lt;<em>paste your Azure SQL database server name here</em>&gt;</strong></p>
      </li>
      <li>
        <p>Authentication: <strong>SQL Server Authentication</strong></p>
      </li>
      <li>
        <p>Server admin login: <strong>dp300admin</strong></p>
      </li>
      <li>
        <p>Password: <strong>dp300P@ssword!</strong></p>
      </li>
    </ul>

    <p><a href="../images/dp-3300-module-33-lab-05.png" target="_blank"><img src="../images/dp-3300-module-33-lab-05.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>

    <p>Click <strong>Connect</strong>.</p>
  </li>
  <li>
    <p>In Object Explorer expand the server node, and right click on databases. Click Import a Data-tier Application.</p>

    <p><a href="../images/dp-3300-module-33-lab-06.png" target="_blank"><img src="../images/dp-3300-module-33-lab-06.png" alt="A screenshot of a social media post Description automatically generated"></a></p>
  </li>
  <li>
    <p>In the Import Data Tier Application dialog, click Next on the first screen.</p>

    <p><a href="../images/dp-3300-module-33-lab-07.png" target="_blank"><img src="../images/dp-3300-module-33-lab-07.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>
  </li>
  <li>
    <p>In the Import Settings screen, click Browse and navigate to D:\Labfiles\Secure Environment folder and click on the AdventureWorks.bacpac file and click open. Then in the Import Data-tier application screen click <strong>Next</strong>.</p>

    <p><a href="../images/dp-3300-module-33-lab-08.png" target="_blank"><img src="../images/dp-3300-module-33-lab-08.png" alt="Picture 996777398"></a></p>

    <p><a href="../images/dp-3300-module-33-lab-09.png" target="_blank"><img src="../images/dp-3300-module-33-lab-09.png" alt="A screenshot of a social media post Description automatically generated"></a></p>
  </li>
  <li>
    <p>On the database settings screen, change the edition of Azure SQL Database to General Purpose. Change the Service Objective to <strong>GP_Gen5_2</strong> and click <strong>Next</strong>.</p>

    <p><a href="../images/dp-3300-module-33-lab-10.png" target="_blank"><img src="../images/dp-3300-module-33-lab-10.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>
  </li>
  <li>
    <p>On the Summary screen click <strong>Finish</strong>. When your import completes you will see the results below.
    <a href="../images/dp-3300-module-33-lab-11.png" target="_blank"><img src="../images/dp-3300-module-33-lab-11.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>
  </li>
  <li>
    <p>In Object Explorer, expand the Databases folder. Then right-click on AdventureWorks and click on new query.</p>

    <p><a href="../images/dp-3300-module-33-lab-12.png" target="_blank"><img src="../images/dp-3300-module-33-lab-12.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>
  </li>
  <li>
    <p>Execute the following T-SQL query by pasting the text into your query window. <strong>Important:</strong> Replace 192.168.1.1. with your client IP address from Step 4. Click execute or press F5.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_set_database_firewall_rule @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'ContosoFirewallRule'</span></span>,

@start_ip_address = <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>, @end_ip_address = <span class="hljs-string"><span class="hljs-string">'192.168.1.1'</span></span>
</code></pre>
  </li>
  <li>
    <p>Next you will create a contained user in the AdventureWorks database. Click New Query and execute the following T-SQL. Ensure that you are still using the AdventureWorks database. If you see master in the database name box below, you can pull down and switch to AdventureWorks.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> containeddemo <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'P@ssw0rd!'</span></span>
</code></pre>
    <p><a href="../images/dp-3300-module-33-lab-13.png" target="_blank"><img src="../images/dp-3300-module-33-lab-13.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>

    <p>Click <strong>Execute</strong> to run this command. This command creates a contained user within the AdventureWorks database. You will login using the username and password in the next step.</p>
  </li>
  <li>
    <p>Navigate to the Object Explorer. Click on <strong>Connect</strong> and then <strong>Database Engine</strong>.</p>

    <p><a href="../images/dp-3300-module-33-lab-14.png" target="_blank"><img src="../images/dp-3300-module-33-lab-14.png" alt="Picture 1960831949"></a></p>
  </li>
  <li>Attempt to connect with the credentials you created in step 13. 
You will need to use the following information:
    <ul>
      <li>
<strong>Login:</strong> containeddemo</li>
      <li>
<strong>Password:</strong>  P@ssw0rd!</li>
    </ul>

    <p>Click <strong>Connect</strong>.</p>

    <p>You will see the following error.</p>

    <p><a href="../images/dp-3300-module-33-lab-15.png" target="_blank"><img src="../images/dp-3300-module-33-lab-15.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>

    <p>This error is generated because the connection attempted to login to the master database and not AdventureWorks where the user was created. Change the connection context by clicking <strong>OK</strong> to exit the error message and then clicking on <strong>Options&nbsp;»</strong> in the Connect to Server dialog box as shown below.</p>

    <p><a href="../images/dp-3300-module-33-lab-16.png" target="_blank"><img src="../images/dp-3300-module-33-lab-16.png" alt="Picture 9"></a></p>
  </li>
  <li>
    <p>On the connection options tab, type the database name AdventureWorks. Click <strong>Connect</strong>.</p>

    <p><a href="../images/dp-3300-module-33-lab-17.png" target="_blank"><img src="../images/dp-3300-module-33-lab-17.png" alt="A screenshot of a social media post Description automatically generated"></a></p>
  </li>
  <li>
    <p>Another database should appear in the Object Explorer.</p>

    <p><a href="../images/dp-3300-module-33-lab-18.png" target="_blank"><img src="../images/dp-3300-module-33-lab-18.png" alt="Picture 10"></a></p>

    <p>Make sure the selection stays on the newly added database. Then click <strong>Connect</strong> from the Object Explorer and <strong>Database Engine</strong>. 
Enter the following again:</p>
    <ul>
      <li>
<strong>Login:</strong> containeddemo</li>
      <li>
<strong>Password:</strong>  P@ssw0rd!</li>
    </ul>

    <p>Click <strong>Connect</strong>.</p>

    <p>This time the connection bypasses the master database and logs you directly into AdventureWorks, which is the only database to which the newly created user has access.</p>
  </li>
</ol>

<h2 id="exercise-2-authorize-access-to-azure-sql-database-with-azure-active-directory">Exercise 2: Authorize Access to Azure SQL Database with Azure Active Directory</h2>

<ol>
  <li>
    <p>Navigate to the Azure Portal, and click on your user name in the top right corner of the screen.</p>

    <p><a href="../images/dp-3300-module-33-lab-19.png" target="_blank"><img src="../images/dp-3300-module-33-lab-19.png" alt="A picture containing bottle, black, photo, orange Description automatically generated"></a></p>

    <p>Make note of the user name.</p>

    <p><strong>Important:</strong> A Microsoft account (a user account from Outlook, Gmail, Hotmail or Yahoo, for example) is <strong>not supported</strong> for the Azure Active Directory administrator for Azure SQL Database. As a workaround, you can create an Azure Active Directory group named DBA and add your user account to it. Alternatively, you can skip Exercise 2.</p>
  </li>
  <li>
    <p>In the Azure Portal navigate to your Azure SQL Database server <strong>dp300-lab-xx</strong> and click on <strong>Not Configured</strong> next to Active Directory Admin.</p>

    <p><a href="../images/dp-3300-module-33-lab-20.png" target="_blank"><img src="../images/dp-3300-module-33-lab-20.png" alt="Picture 11"></a></p>

    <p>On the next screen, click <strong>Set admin</strong>.</p>

    <p><a href="../images/dp-3300-module-33-lab-21.png" target="_blank"><img src="../images/dp-3300-module-33-lab-21.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>
  </li>
  <li>
    <p>In the Set admin screen, search for your username. When you have found it, click on it to highlight the username, and then click <strong>Select</strong>. You will be returned to the above Active Directory Admin screen. Click <strong>Save</strong> to complete the process. This will make your username the Azure Active Directory admin for the server as shown below</p>

    <p><a href="../images/dp-3300-module-33-lab-22.png" target="_blank"><img src="../images/dp-3300-module-33-lab-22.png" alt="Picture 12"></a></p>
  </li>
  <li>
    <p>Open SQL Server Management Studio and click <strong>Connect</strong>, then <strong>Database Engine</strong>. In the server name enter the name of your server. Change the authentication type to Azure Active Directory Universal with MFA.</p>

    <p><a href="../images/dp-3300-module-33-lab-23.png" target="_blank"><img src="../images/dp-3300-module-33-lab-23.png" alt="A screenshot of a cell phone Description automatically generated"></a></p>

    <p>You will be prompted to enter your Azure Active Directory password, and will you click <strong>Connect</strong>, you’ll be logged in to your database.</p>
  </li>
</ol>

<h2 id="exercise-3-manage-access-to-database-objects">Exercise 3: Manage access to database objects</h2>

<ol>
  <li>
    <p>In this exercise, you will manage access to the database and its objects. Navigate back to SQL Server Management Studio. The first thing you will do is create two users in the AdventureWorks database.</p>

    <p>In the Object Explorer, right click on the AdventureWorks database and select <strong>New Query</strong>. In the new query window, copy and paste the following T-SQL into it. Verify that the code has been copied correctly.</p>
  </li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> [DP300User1] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'Azur3Pa$$'</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> [DP300User2] <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'Azur3Pa$$'</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<p>You will note these users are created in the scope of the database. So if you were to try to login with one of these users, you would need to specify the AdventureWorks database in your connection string.</p>

<ol>
  <li>Next you will create a custom role and add the users to it. Add the following T-SQL in the same query window as in step 1. Click <strong>Execute</strong> to run.</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> [SalesReader]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> [SalesReader] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> [DP300User1]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> [SalesReader] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMBER</span></span> [DP300User2]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>Next you will grant permissions to the role. In this case you are assigning SELECT and EXECUTE on the Sales schema. Clear the window of the previous query. Then in the same window, click <strong>Execute</strong> to run the below T-SQL to grant the permissions to the role.</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SCHEMA</span></span>::Sales <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> [SalesReader]

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>Next you will create a new stored procedure in the Sales schema. You will note this procedure access a table in the Product schema. Clear the window of the previous query. Execute the below T-SQL in your query window.</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> Sales.DemoProc

<span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> P.Name, <span class="hljs-keyword"><span class="hljs-keyword">Sum</span></span>(SOD.LineTotal) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalSales ,SOH.OrderDate 

<span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Production.Product P

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderDetail SOD <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOD.ProductID = P.ProductID

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderHeader SOH <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOH.SalesOrderID = SOD.SalesOrderID

<span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> P.Name, SOH.OrderDate

<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TotalSales <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">GO</span></span>
</code></pre>

<ol>
  <li>Next you will use the EXECUTE AS USER command to test out the security you just created. This allows the database engine to execute a query in the context of your user. Clear the window of the previous query. Execute the below query in your query window.</li>
</ol>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> = <span class="hljs-string"><span class="hljs-string">'DP300User1'</span></span>


<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> P.Name, <span class="hljs-keyword"><span class="hljs-keyword">Sum</span></span>(SOD.LineTotal) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TotalSales ,SOH.OrderDate 

<span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Production.Product P

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderDetail SOD <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOD.ProductID = P.ProductID

<span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Sales.SalesOrderHeader SOH <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SOH.SalesOrderID = SOD.SalesOrderID

<span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> P.Name, SOH.OrderDate

<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TotalSales <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>
</code></pre>

<p>This query will fail, with an error message saying the SELECT permission was denied on the Production.Product table. The role that user DP300User1 is a member of has SELECT permission in the Sales schema, but not in the Production schema.</p>

<p>However, if you execute the stored procedure in that same context, the query will complete. Clear the query that gave an error message. Then execute the following T-SQL.</p>

<div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">sql</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> = <span class="hljs-string"><span class="hljs-string">'DP300User1'</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> Sales.DemoProc
</code></pre>

<p>This happens because stored procedures take advantage a feature called ownership chaining to provide data access to users who do not have direct permissions to access database objects. For all objects that have the same owner, the database engine only checks the EXECUTE permission on the procedure and not the underlying objects.</p>

<p><strong>Do not remove any of the resources created in this lab as they will be used in subsequent lab exercises.</strong></p>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/DP-300T00-Administering-Relational-Databases-on-Azure" target="_blank" class="ml-2">
                    MicrosoftLearning/DP-300T00-Administering-Relational-Databases-on-Azure
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D525e69932921e8ce30e81ee0f98ad4a87cda64ea.js"></script>



</body></html>