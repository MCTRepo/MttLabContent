<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-220ZH-Microsoft-Azure-IoT-Developer
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D653337691cd169b6aa5719d4ea66f4e6a878a19c.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-220ZH-Microsoft-Azure-IoT-Developer
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-220ZH-Microsoft-Azure-IoT-Developer" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#练习-1验证实验室先决条件">练习 1：验证实验室先决条件</a></li><li class="nav-item"><a class="nav-link" href="#练习-2使用-azure-门户创建-azure-iot-中心设备-id">练习 2：使用 Azure 门户创建 Azure IoT 中心设备 ID</a></li><li class="nav-item"><a class="nav-link" href="#练习-3创建和测试模拟设备-c">练习 3：创建和测试模拟设备 (C#)</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="将-iot-设备连接到-azure">将 IoT 设备连接到 Azure</h1>

<h2 id="实验室场景">实验室场景</h2>

<p>Contoso 以生产高质量的奶酪而闻名。由于公司的知名度和销售量都在迅速增长，他们希望采取措施来确保其奶酪保持其客户期望的高质量水平。</p>

<p>过去，温度和湿度数据是在每次轮班期间由工厂工人收集。该公司担心，随着新设施上线，工厂扩建将需要加强监控，而用于收集数据的手动流程将无法缩放。</p>

<p>Contoso 已决定启动使用 IoT 设备监控温度和湿度的自动化系统。遥测数据的通信速率将可调整，随着批量奶酪通过对环境敏感的处理流程，确保其制造过程受到控制。</p>

<p>为了在全面实施之前评估此资产监视解决方案，你需要将 IoT 设备（包括温度和湿度传感器）连接到 IoT 中心。</p>

<blockquote>
  <p><strong>备注：</strong> 基于实验目的，在本实验室中，将创建可模拟物理 IoT 设备和传感器的 .NET Core 控制台应用程序。模拟设备将实现 IoT 设备 SDK，并采用与物理设备一样的方式连接到 IoT 中心。模拟设备还将使用物理设备使用的相同 SDK 资源传递遥测值，但传感器读数是生成的值，而不是从温度和湿度传感器读取的实际值。</p>
</blockquote>

<p>将创建以下资源：</p>

<p><a href="media/LAB_AK_04-architecture.png" target="_blank"><img src="media/LAB_AK_04-architecture.png" alt="实验室 4 基础结构"></a></p>

<h2 id="本实验室概览">本实验室概览</h2>

<p>在本实验室中，你首先将查看实验室先决条件，并根据需要运行脚本来确保你的 Azure 订阅包含所需的资源。然后，使用 Azure 门户向 Azure IoT 中心注册设备 ID，并在 Visual Studio Code 中开发相应的模拟设备应用。然后，将连接字符串（在注册设备时由 IoT 中心创建）插入模拟设备代码中，并运行应用以测试连接，验证遥测是否已按预期到达 IoT 中心。本实验室包括以下练习：</p>

<ul>
  <li>验证实验室先决条件</li>
  <li>使用 Azure 门户创建 Azure IoT 中心设备 ID</li>
  <li>创建和测试模拟设备 (C#)</li>
</ul>

<h2 id="实验室说明">实验室说明</h2>

<h3 id="练习-1验证实验室先决条件">练习 1：验证实验室先决条件</h3>

<p>本实验室假定以下 Azure 资源可用：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">资源类型</th>
      <th style="text-align: left">资源名称</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">资源组</td>
      <td style="text-align: left">rg-az220</td>
    </tr>
    <tr>
      <td style="text-align: left">IoT 中心</td>
      <td style="text-align: left">iot-az220-training-{your-id}</td>
    </tr>
  </tbody>
</table>

<p>如果这些资源不可用，请按照以下说明运行 <strong>“lab04-setup.azcli”</strong> 脚本，然后再前往练习 2。脚本文件包含在本地克隆作为开发环境配置（实验室 3）的 GitHub 存储库中。</p>

<blockquote>
  <p><strong>备注：</strong>  写入 <strong>lab04-setup.azcli</strong> 脚本，并在 <strong>Bash</strong> shell 环境中运行，执行此操作最简便的方法是在 Azure Cloud Shell 中执行。</p>
</blockquote>

<ol>
  <li>
    <p>使用浏览器，打开 <a href="https://shell.azure.com/">Azure Cloud Shell</a>，并使用本课程使用的 Azure 订阅登录。</p>
  </li>
  <li>
    <p>如果系统提示设置 Cloud Shell 的存储，请接受默认设置。</p>
  </li>
  <li>
    <p>验证 Cloud Shell 是否在使用 <strong>Bash</strong>。</p>

    <p>Azure Cloud Shell 页面左上角的下拉菜单用于选择环境。验证所选的下拉值是否为 <strong>Bash</strong>。</p>
  </li>
  <li>
    <p>在 Cloud Shell 工具栏上，单击 <strong>“上传/下载文件”</strong> （从右数第四个按钮）。</p>
  </li>
  <li>
    <p>在下拉菜单中，单击 <strong>“上传”</strong>。</p>
  </li>
  <li>
    <p>在“文件选择”对话框中，导航到配置开发环境时下载的 GitHub 实验室文件的文件夹位置。</p>

    <p>在本课程的实验室 3（“设置开发环境”）中，通过下载 ZIP 文件并在本地提取内容来克隆包含实验室资源的 GitHub 存储库。提取的文件夹结构包括以下文件夹路径：</p>

    <ul>
      <li>Allfiles
        <ul>
          <li>实验室
            <ul>
              <li>04-将 IoT 设备连接到 Azure
                <ul>
                  <li>设置</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>

    <p>lab04-setup.azcli 脚本文件位于实验室 4 的 Setup 文件夹中。</p>
  </li>
  <li>
    <p>选择 <strong>“lab04-setup.azcli”</strong> 文件，然后单击 <strong>“打开”</strong>。</p>

    <p>文件上传完成后，系统将显示一条通知。</p>
  </li>
  <li>
    <p>要验证是否上传了正确的文件，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-bash hljs"> ls
</code></pre>

    <p>使用 <code>ls</code> 命令列出当前目录的内容。你应该会看到列出的 lab04-setup.azcli 文件。</p>
  </li>
  <li>
    <p>若要为此实验室创建一个包含安装脚本的目录，然后移至该目录，请输入以下 Bash 命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-bash hljs"> mkdir lab4
 mv lab04-setup.azcli lab4
 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> lab4
</code></pre>

    <p>这些命令将为此实验室创建一个目录，将 <strong>lab04-setup.azcli</strong> 文件放入该目录，然后将当前工作目录更改为该新目录。</p>
  </li>
  <li>
    <p>为确保 <strong>“lab04-setup.azcli”</strong> 具有执行权限，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-bash hljs"> chmod +x lab04-setup.azcli
</code></pre>
  </li>
  <li>
    <p>在 Cloud Shell 工具栏上，请单击 <strong>“打开编辑器”</strong> （右侧的第二个按钮 - <strong>{ }</strong>）以启用对 lab04-setup.azcli 文件的访问。</p>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 列表中，要展开 lab4 文件夹并打开脚本文件，请先单击 <strong>“lab4”</strong>，再单击 <strong>“lab04-setup.azcli”</strong>。</p>

    <p>编辑器现在将显示 <strong>“lab04-setup.azcli”</strong> 文件的内容。</p>
  </li>
  <li>
    <p>在编辑器中，更新 <code>{your-id}</code> 和 <code>{your-location}</code> 变量的值。</p>

    <p>以下面的示例为例，需要将 <code>{your-id}</code> 设置为在本课程开始时创建的唯一 ID（即 <strong>cah191211</strong>），然后将 <code>{your-location}</code> 设置为对你的资源有意义的位置。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash</span></span>

 <span class="hljs-comment"><span class="hljs-comment"># 更改这些值！</span></span>
 YourID=<span class="hljs-string"><span class="hljs-string">"{your-id}"</span></span>
 Location=<span class="hljs-string"><span class="hljs-string">"{your-location}"</span></span>
</code></pre>

    <blockquote>
      <p><strong>备注：</strong>  应将 <code>{your-location}</code> 变量设置为要部署所有资源的区域的短名称。输入以下命令，可以看到可用位置及其短名称的列表（<strong>“名称”</strong> 列）：</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-bash hljs"> az account list-locations -o Table

 DisplayName           Latitude    Longitude    Name
 --------------------  ----------  -----------  ------------------
 East Asia             22.267      114.188      eastasia
 Southeast Asia        1.283       103.833      southeastasia
 Central US            41.5908     -93.6208     centralus
 East US               37.3719     -79.8164     eastus
 East US 2             36.6681     -78.3889     eastus2
</code></pre>
  </li>
  <li>
    <p>要保存对文件所做的更改并关闭编辑器，请单击编辑器窗口右上角的 <strong>“…”</strong>，然后单击 <strong>“关闭编辑器”</strong>。</p>

    <p>如果提示保存，请单击 <strong>“保存”</strong>，编辑器将会关闭。</p>

    <blockquote>
      <p><strong>备注：</strong>  可以使用 <strong>Ctrl+S</strong> 随时保存，使用 <strong>Ctrl+Q</strong> 关闭编辑器。</p>
    </blockquote>
  </li>
  <li>
    <p>要创建本实验室所需的资源，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-bash hljs"> ./lab04-setup.azcli
</code></pre>

    <p>运行将花费几分钟时间。每个步骤完成时，你都会看到输出。</p>
  </li>
</ol>

<p>脚本完成后，就可以继续实验室的内容。</p>

<h3 id="练习-2使用-azure-门户创建-azure-iot-中心设备-id">练习 2：使用 Azure 门户创建 Azure IoT 中心设备 ID</h3>

<p>在本课程中，将使用 IoT 中心的功能来帮助为 Contoso 构建功能齐全的可缩放 IoT 解决方案，但在本实验室中，侧重于使用 IoT 中心在 IoT 中心和 IoT 设备之间建立可靠安全的双向通信。</p>

<p>在本练习中，将在 Azure 门户中打开 IoT 中心，将新的 IoT 设备添加到设备注册表中，然后获取 IoT 中心为设备创建的连接字符串的副本（实验室稍后将在设备代码中使用该字符串）。</p>

<h4 id="任务-1创建设备">任务 1：创建设备</h4>

<ol>
  <li>
    <p>如有必要，使用 Azure 帐户凭据登录到 <a href="https://portal.azure.com">portal.azure.com</a>。</p>

    <p>如果有多个 Azure 帐户，请确保使用与本课程要使用的订阅绑定的帐户登录。</p>
  </li>
  <li>
    <p>验证是否正在显示 AZ-220 仪表板。</p>
  </li>
  <li>
    <p>在 <strong>rg-az220</strong> 资源组磁贴上，单击 <strong>“iot-az220-training-{your-id}”</strong></p>
  </li>
  <li>
    <p>在 <strong>“IoT 中心”</strong> 边栏选项卡左侧菜单中的 <strong>“资源管理器”</strong> 下，单击 <strong>“IoT 设备”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“IoT 设备”</strong> 窗格顶部，单击 <strong>“+ 新建”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“设备 ID”</strong> 字段中，输入 <strong>“sensor-th-0001”</strong></p>

    <p>设备标识（设备 ID）用于设备身份验证和访问控制。</p>

    <p>为设备标识创建某种形式的命名约定会很有帮助。有几个原因，其中一个原因是设备 ID 是 IoT 中心用来表示设备的值。设备 ID 可以简洁明了地将设备与其他设备进行区分，因此很有用。</p>

    <p>上面建议使用的命名约定“sensor-th-0001”将此设备标识为具有传感功能的设备 (<em>sensor</em>)，该设备报告温度和湿度值 (<em>-th</em>)，并且是该类型的一系列设备（多达 9999 个）中的第一个(<em>-0001</em>)__。Contoso 可安装 200 或 5000 个此类设备，用于报告工厂车间的环境状况，设备标识将是可用于识别设备的方式之一。</p>
  </li>
  <li>
    <p>确保在 <strong>“身份验证类型”</strong> 下，选中 <strong>“对称密钥”</strong>。</p>

    <p>请注意，有三种类型的身份验证可用。在本实验室中，将使用三种中最简单的一种：对称密钥。X.509 证书及如何在身份验证中使用将在后面的实验室中介绍。</p>
  </li>
  <li>
    <p>请注意，<strong>“主密钥”</strong> 和 <strong>“辅助密钥”</strong> 字段处于禁用状态。</p>
  </li>
  <li>
    <p>在 <strong>“自动生成密钥”</strong> 下，确保选中此复选框。</p>

    <p>选中 <strong>“自动生成密钥”</strong> 后，会禁用 <strong>“主密钥”</strong> 和 <strong>“辅助密钥”</strong> 字段，系统会在保存记录后自动填充这些字段。取消选择 <strong>“自动生成密钥”</strong> 后，这些字段会恢复启用状态，可以直接在其中输入值。</p>
  </li>
  <li>
    <p>在 <strong>“将此设备连接到 IoT 中心”</strong> 下，确保选中 <strong>“启用”</strong>。</p>

    <p>如果要在推出之前创建设备条目，可以在设备初始创建期间在此处选择“禁用”选项。如果想要保留设备记录，但又想阻止关联的设备连接到 IoT 中心，也可以在将来的某个时间将此值设置为“禁用”。</p>
  </li>
  <li>
    <p>在 <strong>“父设备”</strong> 下，将值保留为 <strong>“无父设备”</strong>。</p>

    <p>IoT 设备可能会充当其他设备（如 IoT Edge 设备）的父设备。在本课程的后面部分，你将有机会实现“父-子”设备关系。</p>
  </li>
  <li>
    <p>要将此设备记录添加到 IoT 中心，请单击 <strong>“保存”</strong>。</p>

    <p>片刻之后， <strong>“IoT 设备”</strong> 窗格将刷新并列出新设备。</p>

    <blockquote>
      <p><strong>提示</strong>： 可能需要手动刷新 - 单击页面上的 <strong>“刷新”</strong> 按钮，而不是刷新浏览器</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-2获取设备连接字符串">任务 2：获取设备连接字符串</h4>

<p>设备如果要连接到 IoT 中心，它需要先建立连接。在本实验室中，将使用连接字符串将设备直接连接到 IoT 中心（相应的身份验证通常称为对称密钥身份验证）。使用对称密钥身份验证时，有两个可用的连接字符串 - 一个使用主密钥，另一个使用辅助密钥。如上所述，仅在设备记录保存后才生成主密钥和辅助密钥。因此，要获取其中某个连接字符串，必须先保存记录（在上面的任务中执行的操作），然后重新打开设备记录（要执行的操作）。</p>

<ol>
  <li>
    <p>在 IoT 中心的 <strong>“IoT 设备”</strong> 窗格的 <strong>“设备 ID”</strong> 下，单击 <strong>“sensor-th-0001”</strong>。</p>
  </li>
  <li>
    <p>花一些时间查看 <strong>“sensor-th-0001”</strong> 设备详细信息边栏选项卡中的内容。</p>

    <p>除了设备属性之外，请注意，还可通过设备详细信息边栏选项卡，在边栏选项卡顶部查看一系列设备相关功能（例如“直接方法”和“设备孪生”）。</p>
  </li>
  <li>
    <p>请注意，密钥和连接字符串值已填充。</p>

    <p>默认情况下，这些值可能稍显混乱，可以单击每个字段右侧的“眼睛”图标来显示这些值或隐藏这些值。</p>
  </li>
  <li>
    <p>在 <strong>“主连接字符串”</strong> 字段右侧，单击 <strong>“复制”</strong>。</p>

    <p>可以将鼠标指针悬停在按钮图标上以显示其名称；“复制”按钮在最右侧。</p>

    <blockquote>
      <p><strong>备注：</strong> 稍后在实验室中需要使用“主连接字符串”值，因此建议将其保存到便于访问的位置（可以将其粘贴到记事本等文本编辑器中）。</p>
    </blockquote>

    <p>连接字符串采用以下格式：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-text"> HostName={IoTHubName}.azure-devices.net;DeviceId=sensor-th-0001;SharedAccessKey={SharedAccessKey}
</code></pre>
  </li>
</ol>

<h3 id="练习-3创建和测试模拟设备-c">练习 3：创建和测试模拟设备 (C#)</h3>

<p>借助 Azure IoT 设备 SDK 可以使用设备客户端构建在 IoT 设备上运行的应用。可借助 SDK 中的工具建立安全连接、打包消息和实现与 IoT 中心的通信。还可借助设备 SDK 从 IoT 中心接收消息、作业、方法或设备孪生更新。</p>

<p>在本练习中，将使用 Visual Studio Code 和 Azure IoT 设备 SDK 创建模拟设备应用程序。将使用在上一个练习中创建的设备 ID 和共享访问密钥（主连接字符串）将设备连接到 Azure IoT 中心。然后，测试安全的设备连接和通信，确保 IoT 中心按预期从设备接收模拟的温度和湿度值。</p>

<blockquote>
  <p><strong>备注：</strong> 将使用 C# 编程语言编写模拟设备代码，如果你的编程技能有点生疏或更习惯使用其他编程语言，也无需担心，相关说明中的步骤很容易操作。重要的是让你了解 IoT 设备 SDK 是如何在代码中实现的（会详细讲解）。</p>
</blockquote>

<h4 id="任务-1创建初始项目">任务 1：创建初始项目</h4>

<ol>
  <li>
    <p>打开一个新的命令行/终端窗口。</p>

    <p>例如，可以使用 Windows <strong>命令提示符</strong>命令行应用程序。</p>
  </li>
  <li>
    <p>导航到要用于创建模拟设备应用程序的文件夹位置。</p>

    <p>根文件夹的位置并不重要，重点是使用短文件夹路径可以轻松查找内容，这会很有用。</p>
  </li>
  <li>
    <p>在命令提示符下，输入以下命令，创建一个名为“CaveDevice”的目录并将当前目录更改为该目录：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-bash hljs">mkdir CaveDevice
<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> CaveDevice
</code></pre>
  </li>
  <li>
    <p>要创建新的 .NET 控制台应用程序，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-bash hljs"> dotnet new console
</code></pre>

    <p>此命令将在文件夹中创建一个 <strong>Program.cs</strong> 文件以及一个项目文件。</p>
  </li>
  <li>
    <p>若要安装模拟设备应用所需的 Azure IoT 设备 SDK 和代码库，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-bash hljs"> dotnet add package Microsoft.Azure.Devices.Client
</code></pre>

    <blockquote>
      <p><strong>备注：</strong> <strong>Microsoft.Azure.Devices.Client</strong> 包包含适用于 .NET 的 Azure IoT 设备 SDK，并且有一个作为依赖项的 <strong>Newtonsoft.Json</strong> 包。<strong>Newtonsoft.Json</strong> 包包含可帮助创建和操作 JSON 的 API。</p>
    </blockquote>

    <p>在下一个任务中，你将构建并测试你的模拟设备应用。</p>
  </li>
  <li>
    <p>若要确保下载了所有应用程序依赖项，请输入以下命令</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-bash hljs"> dotnet restore
</code></pre>
  </li>
  <li>
    <p>打开 <strong>Visual Studio Code</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 菜单上，单击 <strong>“打开文件夹”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“打开文件夹”</strong> 对话框中，导航到 <strong>CaveDevice</strong> 目录的创建位置。</p>
  </li>
  <li>
    <p>在文件夹列表中，单击 <strong>“CaveDevice”</strong>，然后单击 <strong>“选择文件夹”</strong>。</p>

    <p>Visual Studio Code 的“资源管理器”窗格现在应列出了两个 C# 项目文件：</p>

    <ul>
      <li>CaveDevice.csproj</li>
      <li>Program.cs</li>
    </ul>

    <blockquote>
      <p><strong>备注：</strong> 如果看到消息 <strong>“<code>CaveDevice</code>中缺少生成和调试所需的资产。 是否添加？”</strong>，可以单击 <strong>“是”</strong> 以继续。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-2了解应用程序">任务 2：了解应用程序</h4>

<p>如上所述，应用程序目前由两个文件组成：</p>

<ul>
  <li>CaveDevice.csproj</li>
  <li>Program.cs</li>
</ul>

<p>在此任务中，将使用 Visual Studio Code 查看这两个应用程序文件的内容和用途。</p>

<ol>
  <li>
    <p>在 <strong>“资源管理器”</strong> 窗格中，单击 <strong>“CaveDevice.csproj”</strong> 打开应用程序项目文件。</p>

    <p>现在，<strong>CaveDevice.csproj</strong> 文件应已在代码编辑器窗格中打开。</p>
  </li>
  <li>
    <p>花点时间查看 <strong>“CaveDevice.csproj”</strong> 文件的内容。</p>

    <p>文件内容应如下所示：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">xml</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="language-xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sdk</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.NET.Sdk"</span></span></span><span class="hljs-tag">&gt;</span></span>

     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span>
         <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">OutputType</span></span></span><span class="hljs-tag">&gt;</span></span>Exe<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">OutputType</span></span></span><span class="hljs-tag">&gt;</span></span>
         <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp3.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span>

     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span>
         <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.Azure.Devices.Client"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.*"</span></span></span><span class="hljs-tag"> /&gt;</span></span>
     <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span>

 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span>
</code></pre>

    <blockquote>
      <p><strong>备注：</strong> 文件中的包版本号可以与上面显示的版本号不同。</p>
    </blockquote>

    <p>项目文件 (.csproj) 是一个 XML 文档，用于指定要使用的项目的类型。在本例中，项目是一个 <strong>SDK</strong> 样式的项目。</p>

    <p>正如你所见，项目定义包含两个部分 - <strong>PropertyGroup</strong> 和 <strong>ItemGroup</strong>。</p>

    <p><strong>PropertyGroup</strong> 定义构建此项目将产生的输出的类型。在本例中，你将构建面向.NET Core 3.1 的可执行文件。</p>

    <p><strong>ItemGroup</strong> 指定应用程序所需的任何外部库。这些特定的引用适用于 NuGet 包，每个包引用都指定了包名称和版本。<code>dotnet add package</code> 命令（上述步骤中输入的）将这些引用添加到了项目文件中，而 <code>dotnet restore</code> 命令确保了下载所有依赖项。</p>

    <blockquote>
      <p><strong>提示</strong>： 可以在<a href="https://docs.microsoft.com/zh-cn/nuget/what-is-nuget">此处</a>详细了解 NuGet。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“资源管理器”</strong> 窗格中，单击 <strong>“Program.cs”</strong>。</p>

    <p>现在，<strong>Program.cs</strong> 文件应已在代码编辑器窗格中打开。</p>
  </li>
  <li>
    <p>花些时间查看 <strong>Program.cs</strong> 文件的内容。</p>

    <p>文件内容应如下所示：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System;

 <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">CaveSensor</span></span>
 {
     <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span>
     {
         <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)
         </span></span>{
             Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>);
         }
     }
 }
</code></pre>

    <p>此程序只需在命令行窗口中写入“Hello World!”。虽然这里没有太多代码，但仍有一些值得注意的地方：</p>

    <ul>
      <li>
        <p><code>using</code> 区域 - 源文件会列出代码正在<strong>使用</strong>的命名空间（通常在文件顶部列出，与这里一样）。在此示例中，代码指定将使用 <code>System</code>。这意味着当代码使用 <strong>System</strong> 命名空间中包含的组件时，不必在该代码行中显式列出 <strong>System</strong> 一词。例如，在上面的代码中，<code>Console</code> 类用于写出“Hello World!”。<code>Console</code> 类是 System 命名空间的一部分，但在使用 <code>Console</code> 时，不必包括 <code>System</code> 一词。如果某些命名空间嵌套得非常深（五个或五个以上的级别很常见），这样做的好处会更明显。再次参考上面的代码，如果没有指定 <code>using System;</code>，则必须将控制台行编写为：</p>

        <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="language-csharp hljs">  System.Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>);
</code></pre>
      </li>
      <li>
        <p><code>namespace</code> 区域 - 指定命名空间之后使用 <code>{ }</code> 包含的类是该命名空间的一部分。因此，与控制台是 <strong>System</strong> 命名空间的一部分类似，在上面的示例中，<strong>Program</strong> 类是 <strong>CaveSensor</strong> 命名空间的一部分，其全名是 <strong>CaveSensor.Program</strong>。</p>
      </li>
      <li>
        <p><code>class</code> 区域 - 定义 <strong>Program</strong> 类的内容。一个源文件中可以有多个类</p>
      </li>
    </ul>

    <blockquote>
      <p><strong>备注：</strong> 开发人员通常会将类分离到他们自己的源文件中（每个源文件一个类），尤其是在较大的项目中。但是，在本课程的实验室中，每个文件中将包含多个类。这有助于简化实验室说明，但这并不是最佳做法。</p>
    </blockquote>
  </li>
  <li>
    <p>在 Visual Studio Code 的 <strong>“视图”</strong> 菜单上，单击 <strong>“终端”</strong>。</p>

    <p>这将在 Visual Studio Code 窗口的底部打开集成终端。将使用“终端”窗口来编译和运行控制台应用程序。</p>
  </li>
  <li>
    <p>在“终端”窗格中，确保将当前目录路径设置为 <code>CaveDevice</code> 文件夹。</p>

    <p>终端命令提示符包括当前目录路径。输入的命令在当前位置运行，因此请确保位于 <code>CaveDevice</code> 文件夹中。</p>
  </li>
  <li>
    <p>要生成并运行 <strong>CaveDevice</strong> 项目，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="language-cmd/sh"> dotnet run
</code></pre>
  </li>
  <li>
    <p>请注意，随即会显示 <strong>“Hello World!”</strong>。</p>

    <p>片刻之后，应会看到 <strong>“Hello World!”</strong> 显示在输入的 <code>dotnet run</code> 命令正下方的行上。</p>

    <p>将在模拟设备应用程序中使用相同的 <code>Console.WriteLine</code> 方法在本地显示信息，这有助于查看发送到 IoT 中心的信息并跟踪设备正在完成的进程。</p>

    <p>虽然此 Hello World 应用演示了一些基本概念，但它显然不是模拟设备。在下一个任务中，要将此代码替换为模拟设备的代码。</p>
  </li>
</ol>

<h4 id="任务-3实现模拟设备代码">任务 3：实现模拟设备代码</h4>

<p>在此任务中，将使用 Visual Studio Code 输入利用 Azure IoT 设备 SDK 连接到 IoT 中心资源的代码。</p>

<ol>
  <li>
    <p>在 <strong>“资源管理器”</strong> 窗格中，单击 <strong>“Program.cs”</strong>。</p>
  </li>
  <li>
    <p>选中所有现有代码，然后将其删除。</p>
  </li>
  <li>
    <p>在代码编辑器窗格中，为创建模拟设备应用程序的基本结构，输入以下代码：</p>

    <blockquote>
      <p><strong>重要说明</strong>： 如果要将代码粘贴到 LODS 等学习环境中，需要注意以下几点：</p>

      <ul>
        <li><strong>“键入文本 -&gt; 键入剪贴板文本”</strong> 缓冲区是有限的，因此它可能会截断复制的代码 - 请仔细检查并添加任何缺失的字符。</li>
        <li>当 <strong>“键入剪贴板文本”</strong> 模拟键入操作时，Visual Studio Code 中的默认设置将自动缩进代码并插入右括号（<code>)</code>、<code>}</code> 和 <code>]</code>），这会导致字符重复和错误缩进。可以使用以下设置关闭这些操作：
          <ul>
            <li><strong>编辑器：自动插入右括号</strong></li>
            <li><strong>编辑器：自动缩进</strong></li>
          </ul>
        </li>
        <li>可以随时使用 <strong>F1</strong> 并输入 <strong>“格式化文档”</strong> 或按 <strong>SHIFT + ALT + F</strong> 重新格式化源</li>
      </ul>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock15" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock15" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-comment"><span class="hljs-comment">// 在下方插入 using 语句</span></span>

 <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">CaveDevice</span></span>
 {
     <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span>
     {
         <span class="hljs-comment"><span class="hljs-comment">// 在下方插入变量</span></span>

         <span class="hljs-comment"><span class="hljs-comment">// 在下方插入 Main 方法</span></span>

         <span class="hljs-comment"><span class="hljs-comment">// 在下方插入 SendDeviceToCloudMessagesAsync 方法</span></span>

         <span class="hljs-comment"><span class="hljs-comment">// 在下方插入 CreateMessageString 方法</span></span>

     }

     <span class="hljs-comment"><span class="hljs-comment">// 在下方插入 EnvironmentSensor 类</span></span>

 }
</code></pre>

    <blockquote>
      <p><strong>备注：</strong> 可以看见，命名空间和类已保留，但其他项是占位符注释。在以下步骤中，将在文件中特定注释下方插入代码。</p>
    </blockquote>

    <blockquote>
      <p><strong>提示</strong>： 要在 Visual Studio Code 中重新格式化粘贴的文本，请按 <strong>SHIFT + ALT + F</strong>，或按 <strong>F1</strong> 打开命令面板并搜索 <strong>“格式化文档”</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>找到注释 <code>// INSERT using statements below here</code>。</p>
  </li>
  <li>
    <p>若要指定应用程序代码将使用的命名空间，请输入以下代码：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock16" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock16" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Client;
 <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json;
</code></pre>

    <p>请注意，除了指定 System 之外，你还声明了代码将使用的其他命名空间，例如用于编码字符串的 <strong>System.Text</strong>、用于异步任务的 <strong>System.Threading.Tasks</strong> 和用于之前添加的两个包的命名空间。</p>

    <blockquote>
      <p><strong>提示</strong>： 插入代码时，代码布局可能不理想。通过在代码编辑器窗格中右键单击，然后单击 <strong>“设置文档格式”</strong>，可以让 Visual Studio Code 为你设置文档格式。可以通过打开 <strong>“任务”</strong> 窗格（按 <strong>F1</strong>），键入 <strong>“设置文档格式”</strong>，然后按 <strong>Enter</strong> 来获得相同的结果。在 Windows 上，此任务的快捷方式是 <strong>Shift+Alt+F</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>找到注释 <code>// INSERT variables below here</code>。</p>
  </li>
  <li>
    <p>若要指定程序正在使用的变量，请输入以下代码：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock17" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock17" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-comment"><span class="hljs-comment">// 包含设备可用于向 IoT 中心发送消息和从 IoT 中心接收消息的方法。</span></span>
 <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DeviceClient deviceClient;

 <span class="hljs-comment"><span class="hljs-comment">// 用于通过 IoT 中心对设备进行身份验证的设备连接字符串。</span></span>
 <span class="hljs-comment"><span class="hljs-comment">// 备注：在实际应用程序中，不会“硬编码”连接字符串</span></span>
 <span class="hljs-comment"><span class="hljs-comment">// 可以将其存储在环境变量中，通过命令行传入或</span></span>
 <span class="hljs-comment"><span class="hljs-comment">// 安全存储在 TPM 模块中。</span></span>
 <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString = <span class="hljs-string"><span class="hljs-string">"{Your device connection string here}"</span></span>;
</code></pre>
  </li>
  <li>
    <p>花点时间检查你刚刚输入的代码（和代码注释）。</p>

    <p><strong>deviceClient</strong> 变量用于存储 <strong>DeviceClient</strong> 的实例 - 该类来自 Azure IoT 设备 SDK，并且包含设备可用于向 IoT 中心发送消息和从 IoT 中心接收消息的方法。</p>

    <p><strong>connectionString</strong> 变量将包含之前创建的设备的连接字符串。 <strong>DeviceClient</strong> 使用此值连接到 IoT 中心。</p>

    <blockquote>
      <p><strong>重要说明</strong>： 在本课程中，你将在本实验室和其他实验室中看到相关示例，其中连接字符串、密码和其他配置信息均硬编码到应用程序中。这样做只是为了简化实验室，我们<strong>并不</strong>推荐这种做法。实验室中遇到的这类安全问题都要尽可能解决。讲师在讲解过程中以及《学生手册》内容中将以支持整个课程进度的方式介绍安全主题（及其他重要注意事项）。讲师和手册中介绍的内容可能并不总是完全一致。因此，你可能会在实验室中接触到一些直到课程后期才会详细介绍的主题。</p>
    </blockquote>

    <p>如代码注释中所述，连接字符串和类似的配置值应通过其他方式提供，例如环境变量、命令行参数，或者最好是存储在受信任的平台模块 (TPM) 等安全硬件中。</p>
  </li>
  <li>
    <p>在刚刚输入的代码中，使用从 IoT 中心复制的主连接字符串更新 <strong>connectionString</strong> 的值。</p>

    <p>更新后，<strong>connectionString</strong> 变量行应类似于以下所示：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock18" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock18" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString = <span class="hljs-string"><span class="hljs-string">"HostName=iot-az220-training-dm200420.azure-devices.net;DeviceId=sensor-th-0001;SharedAccessKey=hfavUmFgoCPA9feWjyfTx23SUHr+dqG9X193ctdEd90="</span></span>;
</code></pre>
  </li>
  <li>
    <p>找到注释 <code>// INSERT Main method below here</code>。</p>
  </li>
  <li>
    <p>要构造模拟设备应用程序的 <strong>Main</strong> 方法，请输入以下代码：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock19" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock19" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)
 </span></span>{
     Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"IoT 中心 C# 模拟的奶酪储藏室设备。按 CTRL+C 退出。\n"</span></span>);

     <span class="hljs-comment"><span class="hljs-comment">// 使用 MQTT 协议连接到 IoT 中心</span></span>
     deviceClient = DeviceClient.CreateFromConnectionString(connectionString, TransportType.Mqtt);
     SendDeviceToCloudMessagesAsync();
     Console.ReadLine();
 }
</code></pre>

    <p><strong>Main</strong> 方法是应用启动后应用程序运行的第一部分。</p>
  </li>
  <li>
    <p>花一些时间检查刚输入的代码（和代码注释）。</p>

    <p>下面是一个简单的设备应用的基本结构：</p>

    <ul>
      <li>连接到 IoT 中心</li>
      <li>将遥测发送到应用（设备到云消息）</li>
    </ul>

    <p>请注意，<strong>deviceClient</strong> 变量使用 <strong>DeviceClient</strong> 静态方法 <strong>CreateFromConnectionString</strong> 的结果进行初始化。此方法使用之前指定的连接字符串，并选择设备用于发送遥测的协议 - 在本例中为 MQTT。</p>

    <blockquote>
      <p><strong>备注：</strong> 在生产应用程序中，异常处理代码中会包含 <strong>CreateFromConnectionString</strong> 方法调用，用于合理有效地处理任何连接问题。此代码和其他实验室代码都很简洁，旨在突出要点，出于此目的省略了大多数错误处理内容。</p>
    </blockquote>

    <p>连接后，将调用 <strong>SendDeviceToCloudMessagesAsync</strong> 方法。你可能会注意到方法名称标有“红色波浪”型下划线，这是因为 Visual Studio Code 已经注意到还未实现 <strong>SendDeviceToCloudMessagesAsync</strong>。我们将很快添加该方法。</p>

    <p>最后，应用程序等待用户输入。</p>

    <blockquote>
      <p><strong>信息</strong>： <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.azure.devices.client.deviceclient?view=azure-dotnet">此处</a>介绍了 <strong>DeviceClient</strong> 类。</p>

      <p><strong>信息</strong>： <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.azure.devices.client.deviceclient.createfromconnectionstring?view=azure-dotnet#Microsoft_Azure_Devices_Client_DeviceClient_CreateFromConnectionString_System_String_Microsoft_Azure_Devices_Client_TransportType_">此处</a>介绍了 <strong>CreateFromConnectionString</strong> 类。</p>

      <p><strong>信息</strong>： <a href="https://docs.microsoft.com/zh-cn/azure/iot-hub/iot-hub-devguide-protocols">此处</a>介绍了受支持的传输协议。</p>
    </blockquote>
  </li>
  <li>
    <p>找到注释 <code>// INSERT - SendDeviceToCloudMessagesAsync below here</code>。</p>
  </li>
  <li>
    <p>输入以下代码以构造 <strong>SendDeviceToCloudMessagesAsync</strong> 方法：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock20" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock20" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendDeviceToCloudMessagesAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
 </span></span>{
     <span class="hljs-comment"><span class="hljs-comment">// 创建传感器实例</span></span>
     <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sensor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnvironmentSensor();

     <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>)
     {
         <span class="hljs-comment"><span class="hljs-comment">// 从传感器读取数据</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTemperature = sensor.ReadTemperature();
         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentHumidity = sensor.ReadHumidity();

         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageString = CreateMessageString(currentTemperature, currentHumidity);

         <span class="hljs-comment"><span class="hljs-comment">// 使用 ASCII 编码从消息字符串创建字节数组</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Message(Encoding.ASCII.GetBytes(messageString));

         <span class="hljs-comment"><span class="hljs-comment">// 将自定义应用程序属性添加到消息中。</span></span>
         <span class="hljs-comment"><span class="hljs-comment">// IoT 中心可以在这些属性上进行筛选，而无需访问消息正文。</span></span>
         message.Properties.Add(<span class="hljs-string"><span class="hljs-string">"temperatureAlert"</span></span>, (currentTemperature &gt; <span class="hljs-number"><span class="hljs-number">30</span></span>) ? <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-string"><span class="hljs-string">"false"</span></span>);

         <span class="hljs-comment"><span class="hljs-comment">// 发送遥测消息</span></span>
         <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> deviceClient.SendEventAsync(message);
         Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"{0} &gt; Sending message: {1}"</span></span>, DateTime.Now, messageString);

         <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>);
     }
 }
</code></pre>

    <p>请注意，<strong>SendDeviceToCloudMessagesAsync</strong> 方法的声明包含关键字 <code>async</code>。这指定了该方法包含使用 <code>await</code> 关键字的异步代码，并指示编译器处理回调管道。</p>
  </li>
  <li>
    <p>花一些时间检查刚输入的代码（和代码注释）。</p>

    <p>此方法实现典型的消息循环：</p>

    <ul>
      <li>从一个或多个传感器读取</li>
      <li>创建要发送的消息</li>
      <li>发送消息</li>
      <li>等待一段时间，或等待事件发生等。</li>
      <li>重复循环</li>
    </ul>

    <p>下面的说明更详细地解释了该方法代码：</p>

    <ul>
      <li>
        <p>该代码执行的第一项操作是创建 <strong>EnvironmentSensor</strong> 类的实例。此操作在循环外完成，用于支持模拟循环内的传感器数据。接着快速添加 <strong>EnvironmentSensor</strong> 类。</p>
      </li>
      <li>
        <p>然后启动一个无限循环 - <code>while(true) {}</code> 将一直重复，直到用户按下 <strong>CTRL+C</strong>。</p>
      </li>
      <li>
        <p>在循环中，执行的第一项操作是从传感器中读取温度和湿度值，并使用这些值来创建消息字符串，稍后将添加 <strong>CreateMessageString</strong> 的代码。</p>
      </li>
      <li>
        <p>然后创建要发送到 IoT 中心的真实<strong>消息</strong>。可以通过从 Azure IoT 设备 SDK 创建 <strong>Message</strong> 类的实例来实现此目的 - 数据结构表示用于与 Iot 中心交互的消息（IoT 中心接受特定格式的消息）。用于 <strong>Message</strong> 类的构造函数需要将消息字符串编码为字节数组。</p>
      </li>
      <li>
        <p>接下来，使用其他属性扩充消息 - 例如，在此处，如果 <strong>currentTemperature</strong> 大于 30，则将 <strong>temperatureAlert</strong> 属性设置为 true，否则设置为 false。</p>
      </li>
      <li>
        <p>然后通过 <code>await deviceClient.SendEventAsync(message);</code> 调用来发送遥测消息。请注意，此行包含 <code>await</code> 关键字。这会指示编译器以下代码是异步的，并将在未来的某个时间完成 - 当它完成时，此方法将继续执行下一行。</p>
      </li>
      <li>
        <p>最后，将消息字符串写入本地控制台窗口以显示遥测已发送到 IoT 中心，然后等待 1000 毫秒（1 秒）再重复该循环。</p>
      </li>
    </ul>

    <blockquote>
      <p><strong>信息</strong>： 可以在<a href="https://docs.microsoft.com/zh-cn/dotnet/csharp/async">此处</a>详细了解 C# 中的 <code>async</code>、<code>await</code> 和异步编程。</p>
    </blockquote>

    <blockquote>
      <p><strong>信息</strong>： <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.azure.devices.client.message?view=azure-dotnet">此处</a>介绍了 <strong>Message</strong> 类。</p>
    </blockquote>
  </li>
  <li>
    <p>找到注释 <code>// INSERT CreateMessageString method below here</code>。</p>
  </li>
  <li>
    <p>为构造根据传感器读数创建 JSON 字符串的 <strong>CreateMessageString</strong> 方法，输入以下代码：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock21" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock21" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateMessageString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> temperature, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> humidity</span></span></span><span class="hljs-function">)
 </span></span>{
     <span class="hljs-comment"><span class="hljs-comment">// 创建与要发送的数据结构相匹配的匿名对象</span></span>
     <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> telemetryDataPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>
     {
         temperature = temperature,
         humidity = humidity
     };

     <span class="hljs-comment"><span class="hljs-comment">// 从匿名对象创建 JSON 字符串</span></span>
     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonConvert.SerializeObject(telemetryDataPoint);
 }
</code></pre>

    <p>此方法创建具有温度和湿度属性的匿名对象，并将其分配给 <strong>telemetryDataPoint</strong>。</p>

    <p>然后，<strong>telemetryDataPoint</strong> 的值通过 <strong>JsonConvert</strong> 类转换为 JSON 字符串，该类是之前添加的 <strong>Newtonsoft.Json</strong> 包的一部分。然后返回 JSON 字符串值，充当消息中的有效负载。</p>
  </li>
  <li>
    <p>找到注释 <code>// INSERT EnvironmentSensor class below here</code>。</p>
  </li>
  <li>
    <p>为构造 <strong>EnvironmentSensor</strong> 类，输入以下代码：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock22" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock22" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span></span>
 <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> 此类表示传感器</span></span>
 <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> 实际的传感器包含要初始化的代码</span></span>
 <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> 设备或多个设备并保持内部状态</span></span>
 <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> 可在以下链接中找到真实示例：https://bit.ly/IoT-BME280</span></span>
 <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span></span>
 内部类 EnvironmentSensor
 {
     <span class="hljs-comment"><span class="hljs-comment">// 初始遥测值</span></span>
     <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> minTemperature = <span class="hljs-number"><span class="hljs-number">20</span></span>;
     <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> minHumidity = <span class="hljs-number"><span class="hljs-number">60</span></span>;
     Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random();

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnvironmentSensor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
     </span></span>{
         <span class="hljs-comment"><span class="hljs-comment">// 设备初始化可能会在此处发生</span></span>
     }

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadTemperature</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> minTemperature + rand.NextDouble() * <span class="hljs-number"><span class="hljs-number">15</span></span>;
     }

     <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadHumidity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
     </span></span>{
         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> minHumidity + rand.NextDouble() * <span class="hljs-number"><span class="hljs-number">20</span></span>;
     }
 }
</code></pre>

    <p>这是一个非常简单的类，它使用随机数来返回表示温度和湿度的值。在实际中，与传感器的交互通常要复杂得多，尤其是需要在较细化的层面与其进行通信并获得度量值（而不是以合适的单位获取直接读数）的情况下。</p>

    <blockquote>
      <p><strong>信息</strong>： 可以在<a href="https://bit.ly/IoT-BME280">此处</a>查看与简单温度、湿度和压力传感器交互的代码的更具代表性的示例。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 菜单中，单击 <strong>“保存”</strong>。</p>
  </li>
  <li>
    <p>花一分钟时间浏览已完成的应用程序。</p>

    <p>已完成的应用程序代表一个简单的模拟设备。它演示如何将设备连接到 IoT 中心以及如何发送从设备到云的消息。</p>

    <p>现已准备好测试应用程序</p>
  </li>
</ol>

<h4 id="任务-4测试应用程序">任务 4：测试应用程序</h4>

<ol>
  <li>
    <p>在 Visual Studio Code“资源管理器”窗格中的 <strong>“视图”</strong> 菜单上，单击 <strong>“终端”</strong>。</p>

    <p>验证所选的终端 shell 是 Windows 命令提示符。</p>
  </li>
  <li>
    <p>在“终端”视图的命令提示符下，输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock23" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock23" class="mt-0"><code class="language-cmd/sh"> dotnet run
</code></pre>

    <p>该命令将生成并运行“模拟设备”应用程序。确保将终端位置设置为 <code>CaveDevice.cs</code> 文件所在的目录。</p>

    <blockquote>
      <p><strong>备注：</strong>  如果命令输出 <code>Malformed Token</code> 或其他错误消息，请确保将 <strong>“主连接字符串”</strong> 值正确配置为 <code>connectionString</code> 变量的值。</p>
    </blockquote>

    <p>如果收到其他错误消息，可以通过参考本实验室的 <strong>Final</strong> 文件夹中可供参考的完整解决方案代码来验证是否正确构建了代码。此 <strong>Final</strong> 文件夹位于在实验室 3 中设置开发环境时下载的实验室资源文件中。文件夹路径为：</p>

    <blockquote>

      <ul>
        <li>Allfiles
          <ul>
            <li>实验室
              <ul>
                <li>LAB_AK_04-connect-iot-device-to-azure
                  <ul>
                    <li>最后</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </blockquote>
  </li>
  <li>
    <p>观察终端中显示的消息字符串输出。</p>

    <p>模拟设备应用程序运行后，会向 Azure IoT 中心发送事件消息，其中包括 <code>temperature</code> 和 <code>humidity</code> 值，并在控制台中显示消息字符串输出。</p>

    <p>终端输出类似于以下内容：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock24" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock24" class="mt-0"><code class="language-text"> IoT Hub C# Simulated Cave Device. Ctrl-C to exit.

 10/25/2019 6:10:12 PM &gt; Sending message: {"temperature":27.714212817472504,"humidity":63.88147743599558}
 10/25/2019 6:10:13 PM &gt; Sending message: {"temperature":20.017463779085066,"humidity":64.53511070671263}
 10/25/2019 6:10:14 PM &gt; Sending message: {"temperature":20.723927165718717,"humidity":74.07808918230147}
 10/25/2019 6:10:15 PM &gt; Sending message: {"temperature":20.48506045736608,"humidity":71.47250854944461}
 10/25/2019 6:10:16 PM &gt; Sending message: {"temperature":25.027703996760632,"humidity":69.21247714628115}
 10/25/2019 6:10:17 PM &gt; Sending message: {"temperature":29.867399432634656,"humidity":78.19206098010395}
 10/25/2019 6:10:18 PM &gt; Sending message: {"temperature":33.29597232085465,"humidity":62.8990878830194}
 10/25/2019 6:10:19 PM &gt; Sending message: {"temperature":25.77350195766124,"humidity":67.27347029711747}
</code></pre>

    <blockquote>
      <p><strong>备注：</strong> 暂时先让模拟设备应用运行。下一个任务是验证 IoT 中心是否正在接收遥测消息。</p>
    </blockquote>
  </li>
</ol>

<h4 id="任务-3验证发送到-azure-iot-中心的遥测数据流">任务 3：验证发送到 Azure IoT 中心的遥测数据流</h4>

<p>在此任务中，你将使用 Azure CLI 验证 Azure IoT 中心正在接收由模拟设备发送的遥测。</p>

<ol>
  <li>
    <p>使用浏览器，打开 <a href="https://shell.azure.com/">Azure Cloud Shell</a>，并使用本课程使用的 Azure 订阅登录。</p>
  </li>
  <li>
    <p>为监视 IoT 中心正在接收的事件消息，请在 Azure Cloud Shell 中输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock25" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock25" class="mt-0"><code class="language-cmd/sh"> az iot hub monitor-events --hub-name {IoTHubName} --device-id sensor-th-0001
</code></pre>

    <p><em>请务必将 <strong>“{IoTHubName}”</strong> 占位符替换为 Azure IoT 中心的名称。</em></p>

    <blockquote>
      <p><strong>备注：</strong> 在运行 Azure CLI 命令时，如果收到消息指出“需要更新 IoT 扩展版本依赖项”，则按 <code>y</code> 键接受更新，然后按 <code>Enter</code>__。这将使命令按预期继续执行。</p>
    </blockquote>

    <p><code>monitor-events</code> 命令（在 <code>az iot hub</code> Azure CLI 模块中）提供了监视发送到 Azure IoT 中心的设备遥测和其他类型消息的功能。该命令在代码开发过程中是一个非常有用的工具，而且命令行接口也非常便捷。</p>

    <p><code>--device-id</code> 参数是可选的，使你可以监视单个设备事件。如果省略该参数，该命令将监视发送到指定 Azure IoT 中心的所有事件。</p>
  </li>
  <li>
    <p>请注意，<code>az iot hub monitor-events</code> Azure CLI 命令会输出一个到达指定 Azure IoT 中心的事件的 JSON 表示形式。</p>

    <p>通过此命令，你可以监视正在发送到 IoT 中心的事件。你还正在验证设备能否连接到 IoT 中心并与之通信。</p>

    <p>你会看到类似于以下内容的消息显示：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock26" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock26" class="mt-0"><code class="language-cmd/sh"> 启动事件监视，并筛选设备：sensor-th-0001，按 ctrl-c 可停止...
 {
     "event": {
         "origin": "sensor-th-0001",
         "payload": "{\"temperature\":25.058683971901743,\"humidity\":67.54816981383979}"
     }
 }
 {
     "event": {
         "origin": "sensor-th-0001",
         "payload": "{\"temperature\":29.202181296051563,\"humidity\":69.13840303623043}"
     }
 }
</code></pre>
  </li>
  <li>
    <p>一旦确认 IoT 中心正在接收遥测，请在“Azure Cloud Shell”和“Visual Studio Code”窗口中按下 <strong>“Ctrl-C”</strong> 。</p>

    <p>Ctrl-C 用于停止正在运行的应用。总是记得关闭不必要的应用和作业。</p>
  </li>
</ol>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-220ZH-Microsoft-Azure-IoT-Developer" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-220ZH-Microsoft-Azure-IoT-Developer
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D653337691cd169b6aa5719d4ea66f4e6a878a19c.js"></script>



</body></html>