<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-220ZH-Microsoft-Azure-IoT-Developer
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D653337691cd169b6aa5719d4ea66f4e6a878a19c.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-220ZH-Microsoft-Azure-IoT-Developer
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-220ZH-Microsoft-Azure-IoT-Developer" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#练习-1验证实验室先决条件">练习 1：验证实验室先决条件</a></li><li class="nav-item"><a class="nav-link" href="#练习-2通过-iot-中心设置和使用指标和诊断日志">练习 2：通过 IoT 中心设置和使用指标和诊断日志</a></li><li class="nav-item"><a class="nav-link" href="#练习-3配置警报">练习 3：配置警报</a></li><li class="nav-item"><a class="nav-link" href="#练习-4模拟传感器">练习 4：模拟传感器</a></li><li class="nav-item"><a class="nav-link" href="#练习-5模拟设备">练习 5：模拟设备</a></li><li class="nav-item"><a class="nav-link" href="#练习-6查看指标警报和存档">练习 6：查看指标、警报和存档</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="如何管理你的-azure-iot-中心">如何管理你的 Azure IoT 中心</h1>

<h2 id="实验室场景">实验室场景</h2>

<p>Contoso 的资产监视和跟踪解决方案运行良好。该系统在整个包装和运输过程中提供持续监控。你已经在 DPS 中实现了组注册，以大规模预配设备，并且当集装箱到达目的地时，IoT 设备通过 DPS“解除授权”，以便可以将其重新用于以后的装运。</p>

<p>为了帮助管理设备利用率和解决方案的其他特征，IT 部门已要求你的团队在 IoT 解决方案中实现 Azure 监视和日志记录服务。</p>

<p>你同意首先实现一些简单的指标，这些指标可以在你承担任何其他工作负荷之前由 IT 人员进行审查。</p>

<p>在本实验室中，你将实现监视以跟踪已连接的设备和已发送的遥测消息的数量，并将连接事件发送到日志。此外，你还将创建一个警报，当连接的设备数量超过阈值限制时会触发该警报。要测试系统，你将配置 9 个模拟的 IoT 设备，这些设备将使用在根 CA 证书链上生成的设备 CA 证书向 DPS 进行身份验证。IoT 设备将配置为将遥测发送到 IoT 中心。</p>

<p>将创建以下资源：</p>

<p><a href="media/LAB_AK_17-architecture.png" target="_blank"><img src="media/LAB_AK_17-architecture.png" alt="实验室 17 基础结构"></a></p>

<h2 id="本实验室概览">本实验室概览</h2>

<p>在本实验室中，你将完成以下活动：</p>

<ul>
  <li>验证是否满足实验室先决条件（具有必需的 Azure 资源）。</li>
  <li>启用诊断日志。</li>
  <li>启用指标。</li>
  <li>针对这些指标设置警报。</li>
  <li>下载并运行一个应用，该应用模拟通过 X.509 连接并将消息发送到中心的 IoT 设备。</li>
  <li>运行该应用，直至警报开始触发。</li>
  <li>观察指标并检查诊断日志。</li>
</ul>

<h2 id="实验室说明">实验室说明</h2>

<h3 id="练习-1验证实验室先决条件">练习 1：验证实验室先决条件</h3>

<p>本实验室假定以下 Azure 资源可用：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">资源类型</th>
      <th style="text-align: left">资源名称</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">资源组</td>
      <td style="text-align: left">rg-az220</td>
    </tr>
    <tr>
      <td style="text-align: left">IoT 中心</td>
      <td style="text-align: left">iot-az220-training-{your-id}</td>
    </tr>
    <tr>
      <td style="text-align: left">设备预配服务</td>
      <td style="text-align: left">dps-az220-training-{your-id}</td>
    </tr>
    <tr>
      <td style="text-align: left">存储帐户</td>
      <td style="text-align: left">staz220training{your-id}</td>
    </tr>
  </tbody>
</table>

<p>如果这些资源不可用，请按照以下说明运行 <strong>“lab17-setup.azcli”</strong> 脚本，然后再前往练习 2。脚本文件包含在本地克隆作为开发环境配置（实验室 3）的 GitHub 存储库中。</p>

<p>写入 <strong>lab17-setup.azcli</strong> 脚本，并在 <strong>Bash</strong> shell 环境中运行，执行此操作最简便的方法是在 Azure Cloud Shell 中。</p>

<ol>
  <li>
    <p>使用浏览器，打开 <a href="https://shell.azure.com/">Azure Cloud Shell</a>，并使用本课程使用的 Azure 订阅登录。</p>

    <p>如果系统提示设置 Cloud Shell 的存储，请接受默认设置。</p>
  </li>
  <li>
    <p>验证 Cloud Shell 是否在使用 <strong>Bash</strong>。</p>
  </li>
  <li>
    <p>在 Cloud Shell 工具栏上，单击 <strong>“上传/下载文件”</strong> （从右数第四个按钮）。</p>
  </li>
  <li>
    <p>在下拉菜单中，单击 <strong>“上传”</strong>。</p>
  </li>
  <li>
    <p>在“文件选择”对话框中，导航到配置开发环境时下载的 GitHub 实验室文件的文件夹位置。</p>

    <p>在“实验室 3：<em>设置开发环境</em>，你可以通过下载 ZIP 文件并从本地提取内容来克隆包含实验室资源的 GitHub 存储库。提取的文件夹结构包括以下文件夹路径：</p>

    <ul>
      <li>Allfiles
        <ul>
          <li>实验室
            <ul>
              <li>17 - 如何管理 Azure IoT 中心
                <ul>
                  <li>设置</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>

    <p>lab17-setup.azcli 脚本文件位于实验室 17 的 Setup 文件夹中。</p>
  </li>
  <li>
    <p>选择 <strong>“lab17-setup.azcli”</strong> 文件，然后单击 <strong>“打开”</strong>。</p>

    <p>文件上传完成后，系统将显示一条通知。</p>
  </li>
  <li>
    <p>若要验证在 Azure Cloud Shell 中已上传了正确文件，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="language-bash hljs"> ls
</code></pre>

    <p>使用 <code>ls</code> 命令列出当前目录的内容。你应该会看到列出的 lab17-setup.azcli 文件。</p>
  </li>
  <li>
    <p>若要为此实验室创建一个包含安装脚本的目录，然后移至该目录，请输入以下 Bash 命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="language-bash hljs"> mkdir lab17
 mv lab17-setup.azcli lab17
 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> lab17
</code></pre>
  </li>
  <li>
    <p>为了确保 <strong>lab17-setup.azcli</strong> 脚本具有执行权限，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="language-bash hljs"> chmod +x lab17-setup.azcli
</code></pre>
  </li>
  <li>
    <p>在“Cloud Shell”工具栏上，请单击 <strong>“打开编辑器”</strong> （右侧的第二个按钮 - <strong>{ }</strong>）以启用对 lab17-setup.azcli 文件的访问。</p>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 列表中，要展开 lab17 文件夹并打开脚本文件，请先单击 <strong>“lab17”</strong>，再单击 <strong>“lab17-setup.azcli”</strong>。</p>

    <p>编辑器现在将显示 <strong>“lab17-setup.azcli”</strong> 文件的内容。</p>
  </li>
  <li>
    <p>在编辑器中，更新 <code>{your-id}</code> 和 <code>{your-location}</code> 变量的值。</p>

    <p>以下面的示例为例，需要将 <code>{your-id}</code> 设置为在本课程开始时创建的唯一 ID（即 <strong>cah191211</strong>），然后将 <code>{your-location}</code> 设置为对你的资源有意义的位置。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="language-bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash</span></span>

 <span class="hljs-comment"><span class="hljs-comment"># 更改这些值！</span></span>
 YourID=<span class="hljs-string"><span class="hljs-string">"{your-id}"</span></span>
 Location=<span class="hljs-string"><span class="hljs-string">"{your-location}"</span></span>
</code></pre>

    <blockquote>
      <p><strong>备注：</strong>  应将 <code>{your-location}</code> 变量设置为要部署所有资源的区域的短名称。输入以下命令，可以看到可用位置及其短名称的列表（<strong>“名称”</strong> 列）：</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="language-bash hljs"> az account list-locations -o Table

 DisplayName           Latitude    Longitude    Name
 --------------------  ----------  -----------  ------------------
 East Asia             22.267      114.188      eastasia
 Southeast Asia        1.283       103.833      southeastasia
 Central US            41.5908     -93.6208     centralus
 East US               37.3719     -79.8164     eastus
 East US 2             36.6681     -78.3889     eastus2
</code></pre>
  </li>
  <li>
    <p>要保存对文件所做的更改并关闭编辑器，请单击编辑器窗口右上角的 “<strong>…</strong>”，然后单击 <strong>“关闭编辑器”</strong>。</p>

    <p>如果提示保存，请单击 <strong>“保存”</strong>，编辑器将会关闭。</p>

    <blockquote>
      <p><strong>备注：</strong>  可以使用 <strong>Ctrl+S</strong> 随时保存，使用 <strong>Ctrl+Q</strong> 关闭编辑器。</p>
    </blockquote>
  </li>
  <li>
    <p>要创建本实验室所需的资源，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-bash hljs"> ./lab17-setup.azcli
</code></pre>

    <p>运行此脚本可能需要几分钟。每个步骤完成时，你都会看到输出。</p>

    <p>该脚本将首先创建一个名为 <strong>“rg-az220”</strong> 的资源组，然后将你的 IoT 中心命名为 <strong>“iot-az220-training-{your-id}”</strong>，并将设备预配服务命名为 <strong>“dps-az220-training-{your-id}”</strong>。如果服务已经存在，将显示相应的消息。该脚本将链接你的 IoT 中心和 DPS。然后，脚本将创建一个名为 <strong>“staz220training{your-id}”</strong> 的存储帐户。</p>

    <p>现在，你应该可以继续进行本实验室的练习 2。</p>
  </li>
</ol>

<h3 id="练习-2通过-iot-中心设置和使用指标和诊断日志">练习 2：通过 IoT 中心设置和使用指标和诊断日志</h3>

<p>Azure 资源日志是 Azure 资源发出的描述其内部操作的平台日志。所有资源日志共享一个通用的顶级架构，每个服务都可以灵活地为自己的事件发出独特的属性。</p>

<p>如果有 IoT 中心解决方案在生产中运行时，你需要设置各种指标并启用诊断日志。然后，如果出现问题，则可以查看数据，这将有助于你诊断问题并更快地解决问题。</p>

<p>在本练习中，将启用诊断日志并使用该日志检查错误。还将设置一些要监视的指标，并在指标达到特定边界标准时发出警报。</p>

<h4 id="任务-1启用诊断">任务 1：启用诊断</h4>

<ol>
  <li>
    <p>如有必要，请使用 Azure 帐户凭据登录到 Azure 门户。</p>

    <p>如果有多个 Azure 帐户，请确保使用与本课程要使用的订阅绑定的帐户登录。</p>
  </li>
  <li>
    <p>在 Azure 仪表板上，单击 <strong>“iot-az220-training-{your-id}”</strong>。</p>

    <p>你的仪表板应在 rg-az220 资源组磁贴上具有指向 IoT 中心的链接。</p>
  </li>
  <li>
    <p>在左侧菜单中，在 <strong>“监视”</strong> 下，单击 <strong>“诊断设置”</strong>。</p>

    <blockquote>
      <p><strong>备注：</strong> 当前文档建议默认情况下可能禁用“诊断”。如果是这样，你可能需要“打开诊断”才能为 IoT 中心收集诊断数据。单击 <strong>“打开诊断”</strong> 时，会打开 <strong>“诊断设置”</strong> 窗格。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“诊断设置”</strong> 窗格的 <strong>“名称”</strong> 下，单击 <strong>“添加诊断设置”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“诊断设置名称”</strong> 文本框中，输入 <strong>“diags-hub”</strong></p>
  </li>
  <li>
    <p>花一点时间查看 <strong>“目标详细信息”</strong> 下面列出的选项。</p>

    <p>你会看到有 3 个可用于路由指标的选项 - 你可以通过以下链接了解每个指标的详细信息：</p>

    <ul>
      <li><a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/resource-logs-collect-storage">将 Azure 资源日志存档到存储帐户</a></li>
      <li><a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/stream-monitoring-data-event-hubs">将 Azure 监视数据流式传输到事件中心</a></li>
      <li><a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/resource-logs-collect-workspace">在 Azure Monitor 的 Log Analytics 工作区中收集 Azure 资源日志</a></li>
    </ul>

    <p>在本实验室中，将使用存储帐户选项。</p>
  </li>
  <li>
    <p>在 <strong>“目标详细信息”</strong> 下，单击 <strong>“存档到存储帐户”</strong>。</p>

    <p>选择此目标选项后，其他字段将变为可用，包括用于指定日志类别的 <strong>“保留期(天)”</strong> 的选项。</p>

    <blockquote>
      <p><strong>备注：</strong> 花一点时间查看有关存储帐户和成本的备注。</p>
    </blockquote>
  </li>
  <li>
    <p>对于 <strong>“订阅”</strong> 字段，请选择用于创建 IoT 中心的订阅。</p>
  </li>
  <li>
    <p>对于 <strong>“存储帐户”</strong> 字段，请选择 <strong>staz220training{your-id}</strong> 存储帐户。</p>

    <p>该帐户是由 lab17-setup.azcli 脚本创建的。如果下拉列表中未列出该帐户，则可能需要手动创建一个帐户（请与你的讲师联系）。</p>
  </li>
  <li>
    <p>在 <strong>“诊断设置”</strong> 边栏选项卡的 <strong>“类别详细信息”</strong> 下，单击 <strong>“连接”</strong>，然后单击 <strong>“DeviceTelemetry”</strong>。</p>
  </li>
  <li>
    <p>对于你选择的每个日志类别，在 <strong>“保留期(天)”</strong> 字段中，输入 <strong>“7”</strong></p>
  </li>
  <li>
    <p>在边栏选项卡顶部，单击 <strong>“保存”</strong>，然后关闭边栏选项卡</p>

    <p>你现在应该处于 IoT 中心的 <strong>“诊断设置”</strong> 窗格中，并应该看到 <strong>“诊断设置”</strong> 已更新，用以显示你刚刚创建的 <strong>“diags-hub”</strong> 设置。</p>

    <p>随后在查看诊断日志时，就可以看到设备的连接和断开连接日志记录。</p>
  </li>
</ol>

<h4 id="任务-2设置指标">任务 2：设置指标</h4>

<p>在本任务中，你将设置各种指标，以监视何时将消息发送到你的 IoT 中心。</p>

<ol>
  <li>
    <p>确保已打开 IoT 中心边栏选项卡。</p>

    <p>在上一任务结束时，你停留在 IoT 中心边栏选项卡的 <strong>“诊断设置”</strong> 窗格。</p>
  </li>
  <li>
    <p>在左侧菜单中，在 <strong>“监控”</strong> 下方，单击 <strong>“指标”</strong>。</p>

    <p>将显示一个显示新的空图表的 <strong>“指标”</strong> 窗格。</p>
  </li>
  <li>
    <p>在屏幕右上角，要更改图表的时间范围和时间粒度，请单击 <strong>“过去 24 小时（自动）”</strong>。</p>
  </li>
  <li>
    <p>在出现的上下文菜单的 <strong>“时间范围”</strong> 下，单击 <strong>“过去 4 小时”</strong>。</p>
  </li>
  <li>
    <p>在同一上下文菜单的 <strong>“时间粒度”</strong> 下拉列表中，单击 <strong>“1 分钟”</strong>，并在 <strong>“显示时间为”</strong> 下，确保选中 <strong>“本地”</strong>。</p>
  </li>
  <li>
    <p>要保存你的时间设置，请单击 <strong>“应用”</strong>。</p>
  </li>
  <li>
    <p>花一分钟时间检查用于指定图表指标的设置。</p>

    <p>在 <strong>“图表标题”</strong> 和图表工具栏下，你将看到一个指定指标的区域。</p>

    <ul>
      <li>请注意，<strong>“范围”</strong> 已经设置为 <strong>“iot-az220-training-{your-id}”</strong>。</li>
      <li>请注意， <strong>“指标命名空间”</strong> 已经设置为 <strong>“IoT 中心标准指标”</strong>。</li>
    </ul>

    <blockquote>
      <p><strong>备注：</strong> 默认情况下，只有一个指标命名空间可用。命名空间可将类似的指标分类或分组到一起。使用命名空间能够在可收集不同见解或性能指标的指标组之间实现隔离。例如，你可能有一个名为 <strong>“az220memorymetrics”</strong> 的命名空间，用于跟踪应用配置文件的内存使用指标。另一个命名空间称为 <strong>“az220apptransaction”</strong> 可能会跟踪有关应用程序中用户交易的所有指标。你可以在<a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/metrics-custom-overview?toc=%2Fazure%2Fazure-monitor%2Ftoc.json#namespace">此处</a>了解有关自定义指标和命名空间的更多信息。</p>
    </blockquote>

    <p>接下来的步骤是添加一个指标，用于监控已发送到 IoT 中心的遥测消息的数量。</p>
  </li>
  <li>
    <p>在 <strong>“指标”</strong> 下拉列表中，单击 <strong>“已发送遥测信息”</strong>。</p>

    <p>请注意，你可以从中选择大量指标！</p>
  </li>
  <li>
    <p>在 <strong>“聚合”</strong> 下，确保选中 <strong>“总和”</strong>。</p>

    <p>请注意，有 4 个聚合操作可用 - <em>平均值</em>、<em>最小值</em>、<em>最大值</em>和<em>总和</em>。</p>
  </li>
  <li>
    <p>请花费片刻时间查看你的图表。</p>

    <p>请注意，图表标题已更新以体现所选的指标。</p>

    <p>你已完成对第一个指标的说明。接下来，你将添加另一个指标来监视连接的设备数量。</p>
  </li>
  <li>
    <p>在图表标题的工具栏上，单击 <strong>“添加指标”</strong>。</p>

    <p>将会出现一个新指标。请注意，<strong>“范围”</strong> 和 <strong>“指标命名空间”</strong> 值已预先填充。</p>
  </li>
  <li>
    <p>在 <strong>“指标”</strong> 下拉列表中，单击 <strong>“已连接的设备(预览)”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“聚合”</strong> 下，确保选中 <strong>“平均值”</strong>。</p>

    <p>你的屏幕现在应会显示发送的遥测消息的最小指标，以及平均连接设备的新指标。请注意，图表标题已更新以反映两个指标。</p>

    <blockquote>
      <p><strong>备注：</strong> 要编辑图表标题，请单击标题右侧的<strong>铅笔</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>在工具栏右侧的 <strong>“图表标题”</strong> 下，单击 <strong>“固定到仪表板”</strong>， 然后单击 <strong>“固定到当前仪表板”</strong></p>

    <blockquote>
      <p><strong>备注：</strong> 为了保留刚创建的图表，<strong>必须</strong> 将其固定到仪表板上。</p>
    </blockquote>
  </li>
  <li>
    <p>导航到“AZ-220”仪表板，并确认已显示该图表。</p>

    <blockquote>
      <p><strong>备注：</strong> 你可以使用拖放操作来自定义图表的大小和位置。</p>
    </blockquote>
  </li>
</ol>

<p>现在，你已启用日志记录并设置图表以监控指标，现在是设置警报的好时机。</p>

<h3 id="练习-3配置警报">练习 3：配置警报</h3>

<p>警报用于在监控数据中发现重要情况时主动通知你。有了警报，就可以在系统的用户注意到问题之前确定和解决这些问题。</p>

<p>在你的资产跟踪方案中，你使用传感器来跟踪要配送给客户的容器。每次在装运容器中添加传感器时，都会通过 DPS 自动配置传感器。</p>

<p>对于即将进行的概念验证演示，你希望创建一个警报，在当前正在传输的容器数量接近容量限制时触发。要触发警报，你将使用 IoT 中心的“已连接设备”事件数量。</p>

<p>在本练习中，你将添加一个将在连接 5 个或更多设备时触发的警报。</p>

<ol>
  <li>
    <p>如有必要，请使用 Azure 帐户凭据登录到 Azure 门户。</p>

    <p>如果有多个 Azure 帐户，请确保使用与本课程要使用的订阅绑定的帐户登录。</p>
  </li>
  <li>
    <p>在 Azure 仪表板上，单击 <strong>“iot-az220-training-{your-id}”</strong>。</p>

    <p>你的仪表板应在 rg-az220 资源组磁贴上具有指向 IoT 中心的链接。</p>
  </li>
  <li>
    <p>在左侧菜单中，在 <strong>“监控”</strong> 下方，单击 <strong>“警报”</strong>。</p>

    <p>将显示空的 <strong>“警报”</strong> 窗格。请注意，<strong>“订阅”</strong>、 <strong>“资源组”</strong>、 <strong>“资源”</strong> 和 <strong>“时间范围”</strong> 字段已预先填充。</p>
  </li>
  <li>
    <p>在 <strong>“时间范围”</strong> 下拉列表中，单击 <strong>“过去一个小时”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“警报”</strong> 窗格顶部，单击 <strong>“+新建警报规则”</strong></p>

    <p>此时应显示 <strong>“创建警报规则”</strong> 边栏选项卡。</p>
  </li>
  <li>
    <p>花点时间查看 <strong>“创建警报规则”</strong> 边栏选项卡。</p>

    <p>边栏选项卡包括四个部分：“范围”、“条件”、“操作组”和“警报规则详细信息”。在“范围”部分可以看到两个字段 -“资源”和“层次结构”。请注意，这些字段已预填充 IoT 中心的属性。如果需要，可以编辑预选资源。</p>
  </li>
  <li>
    <p>在 <strong>“条件”</strong> 下单击 <strong>“添加条件”</strong>。</p>

    <p>此时应显示 <strong>“配置信号逻辑”</strong> 窗格。请注意，显示了可用信号的分页表。表格上方的字段用于筛选表格，以帮助查找所需的信号类型。</p>
  </li>
  <li>
    <p>在 <strong>“信号类型”</strong> 下，确保选中 <strong>“全部”</strong>。</p>

    <p>如果打开“信号类型”下拉列表，则会看到有 3 个可用选项： <em>“全部”</em>、 <em>“指标”</em> 和 <em>“活动日志”</em>。</p>

    <blockquote>
      <p><strong>备注：</strong> 用于监测的信号类型因所选目标而异。信号类型可以是指标，日志搜索查询或活动日志。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“监视器服务”</strong> 下，确保选中 <strong>“全部”</strong>。</p>

    <p>如果打开“监视服务”下拉菜单，你会看到有 3 个可用选项： <em>“所有”</em>、 <em>“平台”</em> 和 <em>“活动日志 - 管理”</em>。</p>

    <blockquote>
      <p><strong>备注：</strong> 平台服务提供有关服务利用率的指标，活动日志跟踪管理活动。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“按信号名称搜索”</strong> 文本框中，键入 <strong>“已连接”</strong></p>
  </li>
  <li>
    <p>请注意，信号列表会根据你的输入立即进行筛选。</p>
  </li>
  <li>
    <p>在 <strong>“信号名称”</strong> 下，单击 <strong>“连接的设备”</strong>。</p>

    <p>窗格将更新以显示与你为 <strong>“指标”</strong> 创建的图表类似的图表。图表显示与选定信号相关的值（在本例中为<em>已连接设备（预览）</em>）。</p>

    <p>图表下方是定义 <strong>“警报逻辑”</strong> 的区域。</p>
  </li>
  <li>
    <p>花些时间查看 <strong>“警报逻辑”</strong> 下的选项</p>

    <p>注意，<strong>阈值</strong>有两个可能的选择 - <em>静态</em>和<em>动态</em>。另请注意，<strong>静态</strong>处于选中状态，而<strong>动态</strong>不适用于该信号类型。</p>

    <blockquote>
      <p><strong>备注：</strong>  顾名思义，<em>静态阈值</em>为阈值指定一个常量表达式，而<em>动态阈值</em>检测利用高级机器学习 (ML) 来学习指标的历史行为，识别指示可能的服务问题的模式和异常。你可以在<a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/alerts-dynamic-thresholds">此处</a>详细了解<em>动态阈值</em> 。</p>
    </blockquote>

    <p>将创建一个静态阈值，它会在每次 <em>“连接的设备数(预览)”</em> 信号等于或大于 5 时触发警报。</p>
  </li>
  <li>
    <p>在 <strong>“运算符”</strong> 下拉菜单中，单击 <strong>“大于或等于”</strong>。</p>

    <p>你可能需要记录此字段和其他字段的其他选项。</p>
  </li>
  <li>
    <p>在 <strong>“聚合类型”</strong> 选项下，确保 <strong>“平均值”</strong> 已选定。</p>
  </li>
  <li>
    <p>在 <strong>“阈值”</strong> 文本框中，输入 <strong>“5”</strong></p>

    <blockquote>
      <p><strong>备注：</strong> <strong>“条件预览”</strong> 向你显示用于刷新显示内容的条件，显示内容会根据你输入的“运算符”、“聚合类型”和“阈值”设置来进行刷新。 <strong>“条件预览”</strong> 下面是 <strong>“评估依据”</strong> 区域。这些值确定使用上面选择的 <strong>“聚合类型”</strong> 聚合的历史时间段，以及评估条件的频率。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“单元”</strong> 下，选择 <strong>“计数”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“聚合粒度(周期)”</strong> 下，确保选择 <strong>“5 分钟”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“评估频率”</strong> 下，确保选择 <strong>“每 1 分钟”</strong>。</p>

    <blockquote>
      <p><strong>备注：</strong> 由于<strong>计算频率</strong>要比<strong>聚合粒度（周期）</strong> 短，这会导致出现滑动窗口计算。这意味着前 5 分钟内每分钟的值都将被聚合（在此情况下，被平均），然后针对条件进行计算。一分钟后，前 5 分钟的数据将再次聚合 - 包括一分钟的新数据和四分钟的已计算数据。因此，滑动窗口每次向前移动一分钟，但始终包含 4 分钟在上一个窗口已计算的数据。</p>
    </blockquote>
  </li>
  <li>
    <p>若要配置警报条件，请在 <strong>“配置信号逻辑”</strong> 窗格的底部，单击 <strong>“完成”</strong>。</p>

    <p><strong>“配置信号逻辑”</strong> 窗格关闭，并显示 <strong>“创建警报规则”</strong> 边栏选项卡。请注意， <strong>“条件”</strong> 现已填充，并且显示 <strong>“每月预估成本”</strong>。写入时，警报条件的预估成本为 0.10 美元 (USD)。</p>

    <p>接下来，你需要配置满足警报条件时采取的操作。</p>
  </li>
  <li>
    <p>花点时间查看一下 <strong>“操作组”</strong> 区域。</p>

    <p>请注意，未选择任何操作组。有一个 <strong>“选择操作组”</strong> 选项。</p>

    <blockquote>
      <p><strong>备注：</strong> 操作组是 Azure 订阅的所有者定义的通知首选项的集合。操作组名称必须是关联的资源组内唯一的。Azure Monitor 和服务运行状况警报使用操作组通知用户已触发警报。根据用户要求，不同警报可使用相同操作组或不同操作组。可以在订阅中最多配置 2,000 个操作组。你可以<a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/action-groups">在此</a>了解有关创建和管理操作组的更多信息。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“操作”</strong> 下，单击 <strong>“添加操作组”</strong>。</p>

    <p>随即显示 <strong>“选择要附加到此警报规则的操作组”</strong> 窗格。如果所选订阅中有可用的现有操作组，窗格中会列出。请注意，可更改订阅并筛选列表。在此实验室中，将创建一个新操作组。</p>
  </li>
  <li>
    <p>在 <strong>“选择要附加到此警报规则的操作组”</strong> 窗格上，单击 <strong>“创建操作组”</strong>。</p>

    <p>随即显示 <strong>“创建操作组”</strong> 窗格。</p>
  </li>
  <li>
    <p>在 <strong>“基本信息”</strong> 选项卡的 <strong>“订阅”</strong> 下，确保选择了本实验室要使用的订阅。</p>
  </li>
  <li>
    <p>在 <strong>“资源组”</strong> 下拉列表中，单击 <strong>“rg-az220”</strong>。</p>

    <blockquote>
      <p><strong>备注：</strong> 操作组通常可在整个订阅范围内共享，并且可能由 Azure 订阅所有者集中管理。这样，它们更有可能包含在公共资源组中，而不是项目特定的资源组（例如“rg-az220”）中。我们正在使用“rg-az220”来简化实验室结束后清理资源的过程。</p>
    </blockquote>

    <p>下一个区域 <strong>“实例详细信息”</strong> 用于指定组的完整名称和显示名称。</p>
  </li>
  <li>
    <p>在 <strong>“操作组名称”</strong> 下，输入 <strong>AZ-220 电子邮件操作组</strong></p>

    <blockquote>
      <p><strong>备注：</strong> 操作组名称在与其关联的资源组中必须是唯一的。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“显示名称”</strong> 下，输入 <strong>“AZ220EmailAG”</strong></p>

    <blockquote>
      <p><strong>备注：</strong> 当使用此组发送通知时，将使用显示名称代替完整的操作组名称，并且最大限制为 12 个字符。</p>
    </blockquote>
  </li>
  <li>
    <p>单击 <strong>“下一步: 通知”</strong>，以查看操作组通知字段。</p>
  </li>
  <li>
    <p>打开 <strong>“通知类型”</strong> 下拉菜单，然后查看可用选项。</p>
  </li>
  <li>
    <p>在 <strong>“通知类型”</strong> 下拉菜单中，单击 <strong>“电子邮件/短信/推送/语音”</strong>。</p>

    <blockquote>
      <p><strong>备注：</strong> 选择通知类型后，将添加一个新的空白行，用于添加多个通知。具有值的每行的右侧显示有 <strong>“编辑详细信息”</strong> 和 <strong>“删除”</strong> 图标。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“名称”</strong> 下，输入 <strong>“AZ220Notifications”</strong></p>
  </li>
  <li>
    <p>在当前通知的右侧，可单击 <strong>“编辑详细信息”</strong> 输入通知的详细信息。</p>

    <p>随即打开 <strong>“电子邮件/短信/推送/语音”</strong> 窗格。</p>
  </li>
  <li>
    <p>在 <strong>“电子邮件/短信/推送/语音”</strong> 边栏选项卡上，单击 <strong>“电子邮件”</strong>，然后输入你可以轻松访问的电子邮件地址。</p>
  </li>
  <li>
    <p>单击 <strong>“短信”</strong>，然后为你希望用于接收短信警报的手机输入 <strong>“国家/地区代码”</strong> 和 <strong>“电话号码”</strong>。</p>
  </li>
  <li>
    <p>跳过 <strong>“Azure 应用推送通知”</strong> 和 <strong>“语音”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“启用通用警报架构”</strong> 下，单击 <strong>“是”</strong>。</p>

    <blockquote>
      <p><strong>备注：</strong>  使用通用警报架构好处众多。它将当今 Azure 中警报通知的使用体验标准化。从历史上看，目前 Azure 中的三种警报类型（指标、日志和活动日志）一直都有各自的电子邮件模板、Webhook 架构等。现在，借助通用警报架构，你可以接收架构一致的警报通知。欲进一步了解通用 ALert6 架构，请点击<a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/alerts-common-schema">这里</a>。</p>
    </blockquote>

    <blockquote>
      <p><strong>重要说明：</strong> 鉴于通用警报架构有这么多好处，你可能在想为什么不设置为默认启用模式呢 - 嗯，那是因为当选择 <strong>“是”</strong> 时，你会看到一个警告 <strong>“启用通用警报架构可能会破坏任何现有的集成”</strong>。在自己的环境中请记住这点。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“电子邮件/短信/推送/语音”</strong> 边栏选项卡底部，单击 <strong>“确定”</strong>，保存操作配置。</p>

    <p>通知行中现在应显示了已选择的电子邮件和短信。如果需要进一步更改，可以单击 <strong>“编辑详细信息”</strong> 图标。</p>
  </li>
  <li>
    <p>单击 <strong>“下一步: 操作”</strong>，以查看操作组操作字段。</p>
  </li>
  <li>
    <p>打开 <strong>“操作类型”</strong> 下拉菜单，然后查看可用选项。</p>

    <p>此时，如果我们需要通过 <em>“WebHook”</em> 或 <em>“Azure 函数”</em> 启动一些业务集成，则可以添加多个操作，但对本实验室而言，一个简单的通知已经足够。</p>
  </li>
  <li>
    <p>在 <strong>“添加操作组”</strong> 边栏选项卡底部，单击 <strong>“查看 + 创建”</strong> 以验证此操作组。</p>
  </li>
  <li>
    <p>验证完成后，单击 <strong>“创建”</strong>。</p>

    <p>同时会发生一些事情。首先， <strong>“添加操作组”</strong> 边栏选项卡会关闭，你会留在 <strong>“创建规则”</strong> 边栏选项卡，且新的操作组已添加到 <strong>“操作”</strong> 列表。</p>

    <p>然后，你将很快收到一则短信通知和一封电子邮件，这两者都会通知你已被添加到 <strong>“AZ220EmailAG”</strong> 操作组。在短信中，你将注意到你可以回复此消息以停止接收今后的通知等（可在<a href="https://docs.microsoft.com/zh-cn/azure/azure-monitor/platform/alerts-sms-behavior">此处</a>深入了解各种选项）。电子邮件中包含可以单击并查看操作组详细信息的链接，在电子邮件底部（在小字体处），可以看到取消订阅选项。</p>

    <p>接下来，将配置 <strong>“警报规则详细信息”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“创建警报规则”</strong> 边栏选项卡的 <strong>“警报规则名称”</strong> 字段中，输入 <strong>“已连接设备数大于或等于 5”</strong></p>

    <p>名称应具有充分的描述性，以便能够识别警报。</p>
  </li>
  <li>
    <p>在 <strong>“描述”</strong> 字段中，输入 <strong>“当连接到 iot-az220-training-{your-id} 中心的设备数大于或等于 5 时，触发此警报”</strong>。</p>

    <p>描述字段是可选的，但建议填写。</p>
  </li>
  <li>
    <p>在 <strong>“将警报保存到资源组”</strong> 字段中，确保选择了所需的资源组 - 即 <strong>“rg-az220”</strong>。</p>
  </li>
  <li>
    <p>请确保在 <strong>“严重性”</strong> 字段中选择了 <strong>“3 - 信息性”</strong>。</p>

    <p>在我们的情形下，此警报是<em>信息性</em>的，并不表示有任何严重故障，因此 <strong>“严重性 3”</strong> 是正确的选择。</p>

    <blockquote>
      <p><strong>备注：</strong> 严重性级别选项的范围为 <strong>“0 严重”</strong> 到 <strong>“4 - 详细”</strong>。</p>
    </blockquote>
  </li>
  <li>
    <p>对于 <strong>“创建时启用警报规则”</strong> 字段，确保勾选（选中）相应的复选框。</p>

    <blockquote>
      <p><strong>备注：</strong> 指标警报规则最多可能需要 10 分钟才能生效。</p>
    </blockquote>
  </li>
  <li>
    <p>在边栏选项卡底部，单击 <strong>“创建预警规则”</strong>。</p>

    <p>现在应显示 IoT 中心的 <strong>“警报”</strong> 窗格。中间的消息应该会告诉你没有警报，你应该会看到在该状态消息下面添加了一个 <strong>“管理警报规则(1)”</strong> 按钮。</p>

    <blockquote>
      <p><strong>备注：</strong> 如果窗格尚未自动更新，请单击 <strong>“刷新”</strong>。</p>
    </blockquote>
  </li>
</ol>

<p>现在是时候配置触发警报所需的环境了。</p>

<h3 id="练习-4模拟传感器">练习 4：模拟传感器</h3>

<p>要模拟 Contoso 的资产跟踪系统，你需要模拟放置在装运集装箱中的 IoT 设备。激活每个设备后，应使用自动设备预配连接到 IoT 解决方案并开始发送遥测。为了能够自动连接，每个设备都需要自己的 X.509 证书，该证书是用于创建组注册的根证书链的一部分。</p>

<p>在本练习中，你将验证现有环境，执行必要的设置，生成 9 个设备证书以及配置将模拟 9 个设备的控制台应用程序。</p>

<blockquote>
  <p><strong>备注：</strong> 在本课程的实验室 6 中（<strong>实验室 6 - DPS 中的设备自动注册</strong>），你已配置 DPS 以使用 X.509 资源。如果你仍然可以使用该配置，则可以跳过以下一项或多项任务。</p>
</blockquote>

<h4 id="任务-1验证-dps-配置">任务 1：验证 DPS 配置</h4>

<ol>
  <li>
    <p>在浏览器中，导航到 <a href="https://portal.azure.com/">“Azure 门户”</a>，并登录你的订阅。</p>
  </li>
  <li>
    <p>在 <strong>rg-az220</strong> 资源组磁贴上，单击 <strong>“dps-az220-training-{your-id}”</strong>。</p>
  </li>
  <li>
    <p>在左侧菜单的 <strong>“设置”</strong> 下，单击 <strong>“证书”</strong>。</p>
  </li>
  <li>
    <p>这会打开 <strong>“证书”</strong> 窗格，然后请按照以下说明操作：</p>

    <ul>
      <li>如果证书列表为空，请直接转到本练习的任务 2 - <strong>任务 2： 验证 OpenSSL</strong>。</li>
      <li>如果已列出名为 <strong>root-ca-cert</strong> 的证书，请继续下一步。</li>
    </ul>
  </li>
  <li>
    <p>对于列出的证书，请检查 <strong>“状态”</strong> 下面的值，并按照以下说明进行操作：</p>

    <ul>
      <li>如果证书状态为 <strong>“未验证”</strong>：
        <ul>
          <li>单击证书以查看详细信息，然后单击 <strong>“删除”</strong>。</li>
          <li>输入 <strong>“证书名称”</strong> 确认删除，然后单击 <strong>“确定”</strong>。</li>
          <li>直接前往本练习的任务 2 - <strong>任务 2： 验证 OpenSSL</strong>。</li>
        </ul>
      </li>
      <li>如果证书状态为 <strong>“已验证”</strong>，请继续进行下一步。</li>
    </ul>
  </li>
  <li>
    <p>在左侧菜单 <strong>“设置”</strong> 下，单击 <strong>“管理注册”</strong></p>
  </li>
  <li>
    <p>在 <strong>“管理注册”</strong> 窗格，单击 <strong>“注册组</strong>，以查看 DPS 中的注册组列表。</p>
  </li>
  <li>
    <p>如果列出了 <strong>simulated-devices</strong> 注册组，请直接进入下一个练习 - <strong>练习 5： 模拟设备</strong></p>
  </li>
  <li>
    <p>如果 <strong>simulated-devices</strong> 注册组不存在，请按照以下说明进行操作：</p>

    <ul>
      <li>如果你有名为 <strong>root-ca-cert</strong> 的经验证的证书，请直接转到本练习的任务 5 - <strong>任务 5：创建注册组</strong>。</li>
      <li>如果你在上面没有找到已验证证书，请继续执行任务 2 - <strong>任务 2： 验证 OpenSSL</strong>。</li>
    </ul>
  </li>
</ol>

<h4 id="任务-2验证-openssl">任务 2：验证 OpenSSL</h4>

<p>在以下步骤中，你将验证在上一个实验室中安装的 OpenSSL 工具仍然可用。</p>

<ol>
  <li>
    <p>在浏览器中，导航到 <a href="https://shell.azure.com/">Azure Cloud Shell</a>并登录到你的订阅。</p>
  </li>
  <li>
    <p>在 shell 提示符下，输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-bash hljs"> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/certificates
</code></pre>
  </li>
  <li>
    <p>如果上面的命令产生一个错误，指出 <strong>“无此文件或目录”</strong> ，请直接前往本练习的任务 3 - <strong>任务 3： 安装 OpenSSL 工具</strong>。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符下，输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-bash hljs"> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> certs
</code></pre>

    <p>如果你看到一个错误，指出 <strong>“无此文件或目录”</strong>，请直接前往本练习的任务 4 - <strong>任务 4： 使用 OpenSSL 生成和配置 x.509 CA 证书</strong>。</p>
  </li>
  <li>
    <p>如果 <strong>certs</strong> 文件夹可用，请直接转到本练习的任务 5 - <strong>任务 5： 创建注册组</strong>。</p>
  </li>
</ol>

<h4 id="任务-3安装-openssl-工具">任务 3：安装 OpenSSL 工具</h4>

<ol>
  <li>
    <p>在 Cloud Shell 中，输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-bash hljs"> mkdir ~/certificates

 ＃导航到证书目录
 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/certificates

 <span class="hljs-comment"><span class="hljs-comment"># 下载帮助程序脚本文件</span></span>
 curl https://raw.githubusercontent.com/Azure/azure-iot-sdk-c/master/tools/CACertificates/certGen.sh --output certGen.sh
 curl https://raw.githubusercontent.com/Azure/azure-iot-sdk-c/master/tools/CACertificates/openssl_device_intermediate_ca.cnf --output openssl_device_intermediate_ca.cnf
 curl https://raw.githubusercontent.com/Azure/azure-iot-sdk-c/master/tools/CACertificates/openssl_root_ca.cnf --output openssl_root_ca.cnf

 ＃更新脚本权限，以便用户可以读取、写入和执行它
 chmod 700 certGen.sh
</code></pre>
  </li>
</ol>

<h4 id="任务-4使用-openssl-生成和配置-x509-ca-证书">任务 4：使用 OpenSSL 生成和配置 x.509 CA 证书</h4>

<p>所需的第一批 X.509 证书是 CA 和中间证书。可以通过传递 <code>create_root_and_intermediate</code> 选项并使用 <code>certGen.sh</code> 帮助程序脚本来生成它们。</p>

<ol>
  <li>
    <p>在 Cloud Shell 中，确保你位于 <strong>~/certificates</strong> 目录中。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符处，要生成 CA 和中间证书，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-sh hljs bash"> ./certGen.sh create_root_and_intermediate
</code></pre>

    <p>该命令会生成一个名为<code>azure-iot-test-only.root.ca.cert.pem</code>的 CA 根证书，并将其放置在 <code>./certs</code> 目录中。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符下，输入以下命令以将 <code>azure-iot-test-only.root.ca.cert.pem</code> 证书下载到本地计算机（以便可以将其上传到 DPS）：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="language-sh hljs bash"> download ~/certificates/certs/azure-iot-test-only.root.ca.cert.pem
</code></pre>
  </li>
  <li>
    <p>在 Azure 门户中，打开 <strong>“dps-az220-training-{your-id}”</strong> 设备预配服务。</p>
  </li>
  <li>
    <p>在 <strong>“设备预配服务”</strong> 边栏选项卡上，在左侧菜单的 <strong>“设置”</strong> 下，单击 <strong>“证书”</strong>。</p>
  </li>
  <li>
    <p>如果发生有现有的 <strong>“root-ca-cert”</strong> 证书，请选中并删除它。</p>
  </li>
  <li>
    <p>在边栏选项卡顶部的 <strong>“证书”</strong> 窗格上，单击 <strong>“添加”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“添加证书”</strong> 窗格的 <strong>“证书 .pem 或 .cer 文件”</strong> 字段右侧，单击文件夹图标。</p>
  </li>
  <li>
    <p>在 <strong>“打开”</strong> 对话框中，导航到 downloads 文件夹，单击 <strong>“azure-iot-test-only.root.ca.cert.pem”</strong>，然后单击 <strong>“打开”</strong>。</p>

    <p>这是刚创建的 <code>azure-iot-test-only.root.ca.cert.pem</code> CA 证书。</p>
  </li>
  <li>
    <p>在 <strong>“证书名称”</strong> 字段中，输入 <strong>“root-ca-cert”</strong></p>

    <p>该名称可以与证书文件的名称相同，也可以不同。这是一个逻辑名称，与 x.509 CA 证书中的_公用名_没有关联。</p>
  </li>
  <li>
    <p>单击 <strong>“保存”</strong>。</p>

    <p>上传 x.509 CA 证书后， <strong>“证书”</strong> 窗格将显示该证书，并且 <strong>“状态”</strong> 为 <strong>“未验证”</strong>。在使用此 CA 证书对 DPS 的设备进行身份验证之前，你需要验证证书的 <strong>“所有权证明”</strong>。</p>
  </li>
  <li>
    <p>要开始验证证书的“所有权证明”，请单击 <strong>“root-ca-cert”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“证书详细信息”</strong> 窗格中，单击 <strong>“生成验证码”</strong>。</p>
  </li>
  <li>
    <p>复制新生成的<strong>验证码</strong>值。</p>

    <blockquote>
      <p><strong>备注：</strong> 生成验证证书时，需要保持<strong>打开</strong> <strong>“证书详细信息”</strong> 窗格。如果你关闭窗格，验证码就会失效，需要生成新的验证码。</p>
    </blockquote>
  </li>
  <li>
    <p>如果仍然无法在之前的基础上打开，则打开 <strong>Azure Cloud Shell</strong>，并导航到 <code>~/certificates</code> 目录。</p>

    <p>CA 证书的所<strong>有权证明</strong>是通过上传从 CA 证书生成的证书（其中包含刚在 DPS 中生成的验证代码）提供给 DPS 的。这是如何证明你实际拥有 CA 证书的方法。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符处，要创建<strong>验证证书</strong>（提供 <strong>验证码</strong> ），请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="language-sh hljs bash"> ./certGen.sh create_verification_certificate &lt;verification-code&gt;
</code></pre>

    <p>请务必将 <code>&lt;verification-code&gt;</code> 占位符替换为由 Azure 门户生成的<strong>验证码</strong>。</p>

    <p>例如，命令运行会类似于：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="language-sh hljs bash"> ./certGen.sh create_verification_certificate 49C900C30C78D916C46AE9D9C124E9CFFD5FCE124696FAEA
</code></pre>

    <p>该命令会生成一个通过验证码链接到 CA 证书的<strong>验证证书</strong>。生成的名为 <code>verification-code.cert.pem</code> 的验证证书位于 Azure Cloud Shell 的 <code>./certs</code> 目录中。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符下，要将此<strong>验证证书</strong>下载到本地计算机（以便将其上传到 DPS），请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">shell</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="language-sh hljs bash"> download ~/certificates/certs/verification-code.cert.pem
</code></pre>
  </li>
  <li>
    <p>在 Azure 门户中，导航回 <strong>“CA 证书”</strong> 的 <strong>“证书详细信息”</strong> 窗格。</p>
  </li>
  <li>
    <p>在 <strong>“验证证书 .pem 或 .cer 文件”</strong> 字段的右侧，单击文件夹图标。</p>
  </li>
  <li>
    <p>在 <strong>“打开”</strong> 对话框中，导航到 downloads 文件夹，单击 <strong>“verification-code.cert.pem”</strong>，然后单击 <strong>“打开”</strong>。</p>

    <p>这是你新创建并下载的<strong>验证证书</strong>文件。</p>
  </li>
  <li>
    <p>在 <strong>“证书详细信息”</strong> 窗格中，单击 <strong>“验证”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“证书”</strong> 窗格中，单击 <strong>“刷新”</strong>。</p>

    <p>完成 CA 证书的所<strong>有权证明</strong>后，请注意，root-ca-cert 证书的 <strong>“状态”</strong> 现在显示为 <strong>“已验证”</strong>。</p>
  </li>
</ol>

<h4 id="任务-5创建注册组">任务 5：创建注册组</h4>

<ol>
  <li>
    <p>在 Azure 门户中，确保 <strong>“dps-az220-training-{your-id}”</strong> 设备预配服务边栏选项卡处于打开状态。</p>
  </li>
  <li>
    <p>在左侧菜单 <strong>“设置”</strong> 下，单击 <strong>“管理注册”</strong>。</p>

    <p>不应列出任何注册组。</p>
  </li>
  <li>
    <p>在边栏选项卡顶部，单击 <strong>“添加注册组”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“添加注册组”</strong> 边栏选项卡中，在 <strong>“组名称”</strong> 字段中输入 <strong>“simulated-devices”</strong></p>
  </li>
  <li>
    <p>确保将 <strong>“认证类型”</strong> 设置为 <strong>“证书”</strong>。</p>
  </li>
  <li>
    <p>确保将 <strong>“证书类型”</strong> 字段设置为 <strong>“CA 证书”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“初级证书”</strong> 下拉列表中，单击 <strong>“root-ca-cert”</strong>。</p>

    <p>验证 <strong>“选择可以分配给该组的 IoT 中心”</strong> 下拉菜单中是否包括你的 <strong>“iot-az220-training-{your-id}”</strong> IoT 中心。这将确保在预配设备时将其添加到此 IoT 中心。</p>
  </li>
  <li>
    <p>在 Initial Device Twin State 字段中，修改 <code>properties.desired</code> JSON 对象以包括名为 <code>telemetryDelay</code> 的属性，其值为 <code>"1"</code>。设备将使用它设置读取传感器遥测并向 IoT 中心发送事件的时间延迟。</p>

    <p>最终的 JSON 如下所示：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">javascript</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="language-js hljs javascript"> {
     <span class="hljs-string"><span class="hljs-string">"tags"</span></span>: {},
     <span class="hljs-string"><span class="hljs-string">"properties"</span></span>: {
         <span class="hljs-string"><span class="hljs-string">"desired"</span></span>: {
             <span class="hljs-string"><span class="hljs-string">"telemetryDelay"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>
         }
     }
 }
</code></pre>
  </li>
  <li>
    <p>在边栏选项卡顶部，单击 <strong>“保存”</strong>。</p>
  </li>
</ol>

<p>现在已经设置好环境，是时候生成我们的设备证书了。</p>

<h3 id="练习-5模拟设备">练习 5：模拟设备</h3>

<p>在本练习中，你将从根证书生成 X.509 证书。然后，你将在控制台应用程序中使用这些证书，该应用程序将模拟连接到 DPS 并将遥测发送到 IoT 中心的 9 个设备。</p>

<h4 id="任务-1生成设备证书">任务 1：生成设备证书</h4>

<p>现在，你将生成并下载 9 个设备证书。</p>

<ol>
  <li>
    <p>打开“Azure Cloud Shell”<a href="https://shell.azure.com/"></a>并使用本课程使用的 Azure 订阅登录。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符下，要创建名为 <strong>“monitoring”</strong> 的目录并移至该目录 中，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock15" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock15" class="mt-0"><code class="language-bash hljs"> mkdir monitoring
 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> monitoring
</code></pre>
  </li>
  <li>
    <p>若要创建将在其中复制设备生成脚本的空文件，请输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock16" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock16" class="mt-0"><code class="language-bash hljs"> touch gen-dev-certs.sh
 chmod +x gen-dev-certs.sh
</code></pre>
  </li>
  <li>
    <p>在 Cloud Shell 工具栏上，单击 <strong>“打开编辑器”</strong>。</p>

    <p>用来打开 Cloud Shell 编辑器的按钮是 <strong>“{ }”</strong> 图标，即右数第二个。</p>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 选项下，要编辑“gen-dev-certs.sh”文件的内容，请单击 <strong>“监视”</strong>，然后单击 <strong>“gen-dev-certs.sh”</strong></p>

    <p><strong>gen-dev-certs.sh</strong> 文件当前为空。</p>
  </li>
  <li>
    <p>将以下代码粘贴到云编辑器中。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock17" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock17" class="mt-0"><code class="language-bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash</span></span>

 <span class="hljs-comment"><span class="hljs-comment"># Generate 9 device certificates</span></span>
 <span class="hljs-comment"><span class="hljs-comment"># Rename for each device</span></span>
 <span class="hljs-comment"><span class="hljs-comment"># download from the Cloud CLI</span></span>
 <span class="hljs-built_in"><span class="hljs-built_in">pushd</span></span> ~/certificates
 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {1..9}
 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>
     chmod +w ./certs/new-device.cert.pem
     ./certGen.sh create_device_certificate asset-track<span class="hljs-variable"><span class="hljs-variable">$i</span></span>
     sleep 5
     cp ./certs/new-device.cert.pfx ./certs/sensor-thl-200<span class="hljs-variable"><span class="hljs-variable">$i</span></span>.cert.pfx
     download ./certs/sensor-thl-200<span class="hljs-variable"><span class="hljs-variable">$i</span></span>.cert.pfx
 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>
 <span class="hljs-built_in"><span class="hljs-built_in">popd</span></span>
</code></pre>

    <p>该脚本将创建并下载 9 个设备证书。</p>
  </li>
  <li>
    <p>要保存已编辑的 <strong>“gen-dev-certs.sh”</strong> 文件，请按 <strong>CTRL-Q</strong>。</p>

    <p>如果在关闭编辑器之前提示保存更改，请单击 <strong>“保存”</strong>。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符处，要运行 <strong>“gen-dev-certs.sh”</strong> 脚本，输入以下命令：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock18" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock18" class="mt-0"><code class="language-bash hljs"> ./gen-dev-certs.sh
</code></pre>

    <p>脚本运行时，你将看到证书生成器的输出，然后浏览器将依次自动下载各个证书。</p>

    <blockquote>
      <p><strong>备注：</strong> 如果浏览器询问要对文件执行什么操作，请为每个文件单击 <strong>“保存”</strong>。</p>
    </blockquote>

    <p>完成后，你的浏览器下载位置将提供 9 个证书：</p>

    <ul>
      <li>sensor-thl-2001.cert.pfx</li>
      <li>sensor-thl-2002.cert.pfx</li>
      <li>sensor-thl-2003.cert.pfx</li>
      <li>sensor-thl-2004.cert.pfx</li>
      <li>sensor-thl-2005.cert.pfx</li>
      <li>sensor-thl-2006.cert.pfx</li>
      <li>sensor-thl-2007.cert.pfx</li>
      <li>sensor-thl-2008.cert.pfx</li>
      <li>sensor-thl-2009.cert.pfx</li>
    </ul>
  </li>
</ol>

<p>获取这些证书后，即可开始配置设备模拟器。</p>

<h4 id="任务-2将证书添加到模拟器">任务 2：将证书添加到模拟器</h4>

<ol>
  <li>
    <p>将所下载的“X.509 设备证书”文件复制到实验室 17 <strong>“Starter”</strong> 文件夹。</p>

    <p>在“实验室 3：<em>设置开发环境</em>，你可以通过下载 ZIP 文件并从本地提取内容来克隆包含实验室资源的 GitHub 存储库。提取的文件夹结构包括以下文件夹路径：</p>

    <ul>
      <li>Allfiles
        <ul>
          <li>实验室
            <ul>
              <li>17 - 如何管理 Azure IoT 中心
                <ul>
                  <li>入门</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>

    <p>实验室 17 的 Starter 文件夹包含 SimulatedDevice.csproj 和 Program.cs 文件。在向设备预配服务进行身份验证时，项目将需要访问此证书文件。这些文件需要位于项目文件夹的根目录下：</p>

    <p>复制后，证书文件将位于以下位置：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock19" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock19" class="mt-0"><code class="language-text"> /Starter/sensor-thl-2001.cert.pfx
 /Starter/sensor-thl-2002.cert.pfx
 /Starter/sensor-thl-2003.cert.pfx
 /Starter/sensor-thl-2004.cert.pfx
 /Starter/sensor-thl-2005.cert.pfx
 /Starter/sensor-thl-2006.cert.pfx
 /Starter/sensor-thl-2007.cert.pfx
 /Starter/sensor-thl-2008.cert.pfx
 /Starter/sensor-thl-2009.cert.pfx
</code></pre>
  </li>
  <li>
    <p>打开 Visual Studio Code。</p>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 菜单上，单击 <strong>“打开文件夹”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“打开文件夹”</strong> 对话框中，导航到实验室 17 的“Starter”文件夹，单击 <strong>“Starter”</strong>，然后单击 <strong>“选择文件夹”</strong>。</p>

    <blockquote>
      <p><strong>备注：</strong> 如果 Visual Studio Code 建议加载资产或执行还原，请遵循建议。</p>
    </blockquote>
  </li>
  <li>
    <p>在 <strong>“资源管理器”</strong> 窗格中，请单击 <strong>“Program.cs”</strong> 打开“Program.cs”文件。</p>

    <p>你还会看到列出的证书文件。</p>
  </li>
  <li>
    <p>在代码编辑器中，找到 <code>GlobalDeviceEndpoint</code> 变量。</p>

    <p>注意，其值设为 <code>global.azure-devices-provisioning.net</code>。这是公共 Azure 云中 Azure 设备预配服务 (DPS) 的 <strong>“全局设备终结点”</strong>。连接到 Azure DPS 的所有设备都将使用此全局设备终结点 DNS 名称进行配置。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock20" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock20" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GlobalDeviceEndpoint = <span class="hljs-string"><span class="hljs-string">"global.azure-devices-provisioning.net"</span></span>;
</code></pre>
  </li>
  <li>
    <p>找到 <code>dpsIdScope</code> 变量。</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock21" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock21" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> dpsIdScope = <span class="hljs-string"><span class="hljs-string">"&lt;DPS-ID-Scope&gt;"</span></span>;
</code></pre>

    <p>你需要将 <code>&lt;DPS-ID-Scope&gt;</code> 占位符值替换为实际值。</p>
  </li>
  <li>
    <p>返回到显示包含 Azure Cloud Shell 的浏览器窗口。</p>
  </li>
  <li>
    <p>在 Cloud Shell 命令提示符下，请输入以下命令显示 DPS 服务的 ID 范围：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock22" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock22" class="mt-0"><code class="language-bash hljs"> az iot dps show --name dps-az220-training-{your-id} --query properties.idScope
</code></pre>

    <blockquote>
      <p><strong>备注：</strong> 请务必将 {Yyour-id} 替换为你在本课程开始时创建的 ID</p>
    </blockquote>
  </li>
  <li>
    <p>复制上面的命令生成的输出。</p>

    <p>可以双击该值将其选中，然后正常复制。</p>
  </li>
  <li>
    <p>返回 Visual Studio Code。</p>
  </li>
  <li>
    <p>将 <code>&lt;DPS-ID-Scope&gt;</code> 值替换为从 Azure Cloud Shell 复制的值。</p>

    <p>代码应与以下所示类似：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock23" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock23" class="mt-0"><code class="language-csharp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> dpsIdScope = <span class="hljs-string"><span class="hljs-string">"0ne000A6D9B"</span></span>;
</code></pre>
  </li>
  <li>
    <p>在 <strong>“文件”</strong> 菜单中，单击 <strong>“保存”</strong>。</p>
  </li>
</ol>

<p>该应用与之前在实验室 <strong>L06-DPS 设备的自动注册</strong>中使用的应用非常相似。主要区别在于，它并不仅仅是注册一个设备模拟器然后发送遥测，而是注册 9 个设备，每 30 秒注册一个。然后，每个模拟设备将发送遥测。这将触发警报，并将监视数据记录到存储中。</p>

<h4 id="任务-3运行模拟器">任务 3：运行模拟器</h4>

<ol>
  <li>
    <p>在 Visual Studio Code 中，单击 <strong>“终端”</strong> 菜单上的 <strong>“新建终端”</strong>。</p>
  </li>
  <li>
    <p>在终端命令提示符下，请输入以下命令运行该应用：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock24" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock24" class="mt-0"><code class="language-bash hljs"> dotnet run
</code></pre>

    <p>你应该会看到显示第一个设备正通过 DPS 连接，然后发送遥测的输出。此后每隔 30 秒，将连接其他设备并开始发送遥测，直到所有 9 个设备均已连接并发送遥测。</p>
  </li>
  <li>
    <p>返回到 Azure 门户中的 DPS 组注册。</p>
  </li>
  <li>
    <p>在 <strong>“模拟设备”</strong> 注册组中，要查看连接的设备，请单击 <strong>“注册记录”</strong>。</p>

    <p>你应该会看到已连接设备的列表。你可以点击 <strong>“刷新”</strong> 以更新列表。</p>

    <p>现在，你已连接设备并发送遥测，一旦连接 5 个或更多设备的时间长达 5 分钟，就可以等待警报触发。你应该会收到一条类似于以下内容的短信：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock25" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock25" class="mt-0"><code class="language-text"> AZ220EmailAG:Fired:Sev3 Azure Monitor Alert Connected Devices Greater or Equal to 5 on &lt;your IoT Hub&gt;
</code></pre>
  </li>
  <li>
    <p>收到警报后，你就可以退出应用程序。</p>

    <p>你可以在 Visual Studio Code 终端中按 <strong>“CTRL+C”</strong>，或者关闭 Visual Studio Code。</p>

    <blockquote>
      <p><strong>备注：</strong> 设备断开连接后，你将收到消息，告知警报已解决。</p>
    </blockquote>
  </li>
</ol>

<p>现在应该检查存储帐户，并查看 Azure Monitor 是否已记录任何内容。</p>

<h3 id="练习-6查看指标警报和存档">练习 6：查看指标、警报和存档</h3>

<p>在本练习中，你将检查之前在本实验室中配置的一些报告和日志记录资源，并查看在过去的短时间内记录的事件数据。</p>

<h4 id="任务-1在门户中查看指标">任务 1：在门户中查看指标</h4>

<ol>
  <li>
    <p>在 Azure 门户中，单击图表标题，以打开固定到仪表板的“指标”图表。</p>

    <p>图表将打开并在页面上显示。</p>
  </li>
  <li>
    <p>将时间值更改为 <strong>“最近 30 分钟”</strong>。</p>

    <p>请注意，你可以看到 <em>“已发送的遥测消息”</em> 和<em>已连接设备（预览）</em> 值，最新数字位于图表底部，将鼠标指针悬停在图表上即可查看特定时间点的值。</p>
  </li>
</ol>

<h4 id="任务-2查看警报">任务 2：查看警报</h4>

<p>若要使用 Azure 门户查看警报，请完成以下步骤。</p>

<ol>
  <li>
    <p>在 Azure 门户中，导航回仪表板。</p>
  </li>
  <li>
    <p>在 Azure 门户工具栏的搜索框中，键入 <strong>“monitor”</strong></p>
  </li>
  <li>
    <p>在搜索结果窗格的 <strong>“服务”</strong> 下，单击 <strong>“监控器”</strong>。</p>

    <p>此时将显示 <strong>“监控器 - 概述”</strong> 页面。这是当前订阅的所有监控活动的概述。</p>
  </li>
  <li>
    <p>在左侧菜单中的列表顶部附近，单击 <strong>“警报”</strong>。</p>

    <p>此警报视图显示所有订阅的所有警报。让我们将此过滤到 IoT 中心。</p>
  </li>
  <li>
    <p>在边栏选项卡顶部附近的 <strong>“订阅”</strong> 下，选择用于该课程的订阅。</p>
  </li>
  <li>
    <p>在 <strong>“资源组”</strong> 下拉列表中，单击 <strong>“rg-az220”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“资源”</strong> 下拉列表中，单击 <strong>“iot-az220-training-{your-id}”</strong>。</p>
  </li>
  <li>
    <p>在 <strong>“时间范围”</strong> 下拉列表中，单击 <strong>“过去一个小时”</strong>。</p>

    <p>现在，你应该会看到过去一小时的警报摘要。在 <strong>“总警报规则”</strong> 下，你应该会看到 <strong>“1”</strong>，即你之前创建的警报。在下面，你将看到严重性类别的列表以及每个类别的警报计数。我们关注的警报是 <strong>“3 - 信息性”</strong>。你应该至少看到一个（如果已停止并重新启动设备模拟器，则可能会生成多个警报）。</p>
  </li>
  <li>
    <p>在严重性列表中，单击 <strong>“3 - 信息性”</strong>。</p>

    <p><strong>“所有警报”</strong> 页面将会打开。在页面顶部，你会看到许多筛选器字段 - 这些字段已填充上一屏幕中的值，因此仅显示所选 IoT 中心的 <strong>“3 - 信息性”</strong> 警报。此时会显示处于活动状态的警报，以及是否存在任何警告。</p>
  </li>
  <li>
    <p>在 <strong>“名称”</strong> 下，要选择“3 - 信息性”警报，请单击 <strong>“所连接设备大于或等于 5 个”</strong>。</p>

    <p>将打开一个窗格，显示警报详细信息的 <strong>“摘要”</strong>。其中包括一个说明警报触发原因的图表，虚线标示了受监视指标的阈值以及当前值。以下是 <strong>“条件”</strong> 的详细信息和其他详细信息。</p>
  </li>
  <li>
    <p>在窗格顶部，单击标题下方的 <strong>“历史记录”</strong>。</p>

    <p>在此视图中，可以看到警报触发时间、调用的操作组以及任何其他更改，例如警报解决时间等。</p>
  </li>
  <li>
    <p>在窗格顶部，单击标题下方的 <strong>“诊断”</strong>。</p>

    <p>如果存在与警报相关的任何问题，则会在此处显示其他详细信息。</p>
  </li>
</ol>

<h4 id="任务-3查看诊断日志">任务 3：查看诊断日志</h4>

<p>在本实验的前面部分，你将设置诊断日志以导出到 Blob 存储。现在是检查并查看所写内容的好时机。</p>

<ol>
  <li>
    <p>导航到仪表板，然后找到“g-az220”资源组磁贴。</p>
  </li>
  <li>
    <p>在资源列表中，选择之前创建的存储帐户 <strong>staz220training{your-id}</strong>。</p>

    <p>将会显示该存储帐户的 <strong>“概述”</strong>。</p>
  </li>
  <li>
    <p>向下滚动，直到你可以看到存储帐户的指标图表：<em>总出口</em>、<em>总入口</em>、<em>平均延迟</em>和<em>要求明细</em>。</p>

    <p>你应该看到显示了活动。</p>
  </li>
  <li>
    <p>在左侧菜单上，单击 <strong>“存储资源管理器（预览版）”</strong> 以查看已记录的数据。</p>
  </li>
  <li>
    <p>在 <strong>“存储资源管理器”</strong> 窗格中，展开 <strong>“BLOB 容器”</strong> 节点。</p>

    <p>当 Azure Monitor 首次将数据发送到存储帐户时，它将创建一个名为 <strong>“insights-logs-connection”</strong> 的容器。</p>
  </li>
  <li>
    <p>在 <strong>“BLOB 容器”</strong> 下，单击 <strong>“insights-logs-connection”</strong>。</p>

    <p>容器的内容将在右侧列出。</p>

    <p>日志以非常嵌套的方式写入容器。你将需要依次打开每个子文件夹以导航到实际的日志数据。结构与以下所示类似：</p>

    <ul>
      <li><strong>resourceId=</strong>
        <ul>
          <li><strong>SUBSCRIPTIONS</strong>
            <ul>
              <li>**<guid>** - 这是生成日志的订阅的 ID
</guid>                <ul>
                  <li><strong>RESOURCEGROUPS</strong> - 包含每个生成日志的资源组的文件夹
                    <ul>
                      <li>“RG-AZ220” - 包含 IoT 中心的资源组
                        <ul>
                          <li><strong>PROVIDERS</strong>
                            <ul>
                              <li><strong>MICROSOFT.DEVICES</strong>
                                <ul>
                                  <li><strong>IOTHUBS</strong>
                                    <ul>
                                      <li><strong>IOT-AZ220-TRAINING-{YOUR-INITIALS-AND-CURRENT-DATE}</strong> -  包含用于生成日志的文件夹，每年一个文件夹
                                        <ul>
                                          <li><strong>Y=2019</strong> -  包含用于日志生成的文件夹，每月一个文件夹
                                            <ul>
                                              <li><strong>m=12</strong> -  包含每天的文件夹，用作日志生成位置
                                                <ul>
                                                  <li><strong>d=15</strong> -  包含每小时的文件夹，用作日志生成位置
                                                    <ul>
                                                      <li><strong>h=15</strong> -  包含每分钟的文件夹，用作日志生成位置
                                                        <ul>
                                                          <li><strong>m=00</strong> -  包含该分钟的日志文件</li>
                                                        </ul>
                                                      </li>
                                                    </ul>
                                                  </li>
                                                </ul>
                                              </li>
                                            </ul>
                                          </li>
                                        </ul>
                                      </li>
                                    </ul>
                                  </li>
                                </ul>
                              </li>
                            </ul>
                          </li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>

    <p>向下钻取，直至抵达当前日期，选择最新的文件。</p>
  </li>
  <li>
    <p>选中文件后，在窗格顶部的工具栏上，单击 <strong>“下载”</strong>。</p>
  </li>
  <li>
    <p>在 Visual Studio Code 中打开已下载的文件。</p>

    <p>你应该会看到几行 JSON。</p>
  </li>
  <li>
    <p>要使 JSON 更易读取，请按 <strong>F1</strong>，输入 <strong>“设置文档格式”</strong>，然后从选项列表中选择 <strong>“设置文档格式”</strong>。</p>

    <p>JSON 将显示连接和断开连接事件的列表，类似于：</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock26" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock26" class="mt-0"><code class="language-json hljs"> {
     <span class="hljs-attr"><span class="hljs-attr">"time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-12-26T14:32:45Z"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"resourceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/iot-az220-training-cah191216"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"operationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceConnect"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connections"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"level"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: <span class="hljs-string"><span class="hljs-string">"{\"deviceId\":\"sensor-thl-2009\",\"protocol\":\"Amqp\",\"authType\":\"{\\\"scope\\\":\\\"device\\\",\\\"type\\\":\\\"x509Certificate\\\",\\\"issuer\\\":\\\"external\\\",\\\"acceptingIpFilterRule\\\":null}\",\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"location"</span></span>: <span class="hljs-string"><span class="hljs-string">"westus"</span></span>
 }
 {
     <span class="hljs-attr"><span class="hljs-attr">"time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-12-26T14:37:29Z"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"resourceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/iot-az220-training-cah191216"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"operationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceDisconnect"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connections"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"level"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: <span class="hljs-string"><span class="hljs-string">"{\"deviceId\":\"sensor-thl-2008\",\"protocol\":\"Amqp\",\"authType\":null,\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"location"</span></span>: <span class="hljs-string"><span class="hljs-string">"westus"</span></span>
 }
 {
     <span class="hljs-attr"><span class="hljs-attr">"time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2019-12-26T14:37:29Z"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"resourceId"</span></span>: <span class="hljs-string"><span class="hljs-string">"/SUBSCRIPTIONS/AE82FF3B-4BD0-462B-8449-D713DD18E11E/RESOURCEGROUPS/AZ-220/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/iot-az220-training-cah191216"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"operationName"</span></span>: <span class="hljs-string"><span class="hljs-string">"deviceDisconnect"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"category"</span></span>: <span class="hljs-string"><span class="hljs-string">"Connections"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"level"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: <span class="hljs-string"><span class="hljs-string">"{\"deviceId\":\"sensor-thl-2004\",\"protocol\":\"Amqp\",\"authType\":null,\"maskedIpAddress\":\"67.176.115.XXX\",\"statusCode\":null}"</span></span>,
     <span class="hljs-attr"><span class="hljs-attr">"location"</span></span>: <span class="hljs-string"><span class="hljs-string">"westus"</span></span>
 }
</code></pre>

    <p>请注意，每个条目都是一个 JSON 记录，但整个文档不是有效的 JSON 文档。在每个记录中，可以查看与始发 IoT 中心相关的详细信息以及每个事件的 <strong>“属性”</strong>。在 <strong>“属性”</strong> 对象内，可以看到正在连接（或正在断开连接）的 <strong>“deviceId”</strong>。</p>
  </li>
</ol>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-220ZH-Microsoft-Azure-IoT-Developer" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-220ZH-Microsoft-Azure-IoT-Developer
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D653337691cd169b6aa5719d4ea66f4e6a878a19c.js"></script>



</body></html>