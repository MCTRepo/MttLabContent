<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-204: Developing solutions for Microsoft Azure
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D64f540ac7c8eef33997aaf23b6af9bd5b858530e.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-204: Developing solutions for Microsoft Azure
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-204-DevelopingSolutionsforMicrosoftAzure" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#before-you-start">Before you start</a></li><li class="nav-item"><a class="nav-link" href="#exercise-1-creating-data-store-resources-in-azure">Exercise 1: Creating data store resources in Azure</a></li><li class="nav-item"><a class="nav-link active" href="#exercise-2-review-and-upload-data">Exercise 2: Review and upload data</a></li><li class="nav-item"><a class="nav-link" href="#exercise-3-configure-a-net-web-application">Exercise 3: Configure a .NET web application</a></li><li class="nav-item"><a class="nav-link" href="#exercise-4-clean-up-your-subscription">Exercise 4: Clean up your subscription</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="lab-04-construct-a-polyglot-data-solution">Lab 04: Construct a polyglot data solution</h1>

<h2 id="microsoft-azure-user-interface">Microsoft Azure user interface</h2>

<p>Given the dynamic nature of Microsoft cloud tools, you might experience Azure UI changes that occur after the development of this training content. As a result, the lab instructions and lab steps might not align correctly.</p>

<p>Microsoft updates this training course when the community alerts us to needed changes. However, cloud updates occur frequently, so you might encounter UI changes before this training content updates. <strong>If this occurs, adapt to the changes, and then work through them in the labs as needed.</strong></p>

<h2 id="instructions">Instructions</h2>

<h3 id="before-you-start">Before you start</h3>

<h4 id="sign-in-to-the-lab-environment">Sign in to the lab environment</h4>

<p>Sign in to your Windows 10 virtual machine (VM) by using the following credentials:</p>

<ul>
  <li>
    <p>Username: <strong>Admin</strong></p>
  </li>
  <li>
    <p>Password: <strong>Pa55w.rd</strong></p>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: Your instructor will provide instructions to connect to the virtual lab environment.</p>
</blockquote>

<h4 id="review-the-installed-applications">Review the installed applications</h4>

<p>Find the taskbar on your Windows 10 desktop. The taskbar contains the icons for the applications that you’ll use in this lab, including:</p>

<ul>
  <li>
    <p>Microsoft Edge</p>
  </li>
  <li>
    <p>File Explorer</p>
  </li>
  <li>
    <p>Visual Studio Code</p>
  </li>
</ul>

<h2 id="architecture-diagram">Architecture diagram</h2>

<p><a href="media/Lab04-Diagram.png" target="_blank"><img src="media/Lab04-Diagram.png" alt="Architecture diagram depicting a user constructing a polyglot data solution by creating an Azure storage account and an Azure Cosmos DB account."></a></p>

<h3 id="exercise-1-creating-data-store-resources-in-azure">Exercise 1: Creating data store resources in Azure</h3>

<h4 id="task-1-open-the-azure-portal">Task 1: Open the Azure portal</h4>

<ol>
  <li>
    <p>On the taskbar, select the <strong>Microsoft Edge</strong> icon.</p>
  </li>
  <li>
    <p>In the open browser window, browse to the Azure portal (<a href="https://portal.azure.com">portal.azure.com</a>), and then sign in with the account you will be using for this lab.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is your first time signing in to the Azure portal, you’ll be offered a tour of the portal. Select <strong>Get Started</strong> to skip the tour and begin using the portal.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-create-an-azure-cosmos-db-account-resource">Task 2: Create an Azure Cosmos DB account resource</h4>

<ol>
  <li>
    <p>In the Azure portal, use the <strong>Search resources, services, and docs</strong> text box to search for <strong>Azure Cosmos DB</strong> and then in the list of results, select <strong>Azure Cosmos DB</strong>.</p>
  </li>
  <li>
    <p>On the&nbsp;<strong>Azure Cosmos DB</strong> blade, select <strong>+ Create</strong>.</p>
  </li>
  <li>
    <p>On the&nbsp;<strong>Select API option</strong>&nbsp;blade, select <strong>Create</strong> in the <strong>Core (SQL) - Recommended</strong> box.</p>
  </li>
  <li>
    <p>On the <strong>Basics</strong> tab of the <strong>Create Azure Cosmos DB Account - Core (SQL)</strong> blade, perform the following actions, and then select <strong>Review + Create</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Subscription</strong> list</td>
          <td>Retain defaults.</td>
        </tr>
        <tr>
          <td><strong>Resource group</strong> section</td>
          <td>Select <strong>Create new</strong>.</td>
        </tr>
        <tr>
          <td><strong>Name</strong> text box</td>
          <td>Enter <strong>Polyglotdata</strong> and select <strong>OK</strong>.</td>
        </tr>
        <tr>
          <td><strong>AccountName</strong> text box</td>
          <td>Enter <strong>polycosmos</strong><em>[yourname]</em>.</td>
        </tr>
        <tr>
          <td><strong>Location</strong> drop-down list</td>
          <td>Select an Azure region that is closest to the location of your lab computer and where you can create a Cosmos DB account.</td>
        </tr>
        <tr>
          <td><strong>Capacity mode</strong>&nbsp;section</td>
          <td>Select <strong>Serverless</strong>.</td>
        </tr>
      </tbody>
    </table>

    <p>The following screenshot displays the configured settings on the <strong>Create Azure Cosmos DB Account - Core (SQL)</strong> blade.</p>

    <p><a href="media/l04_cosmosdb_create_summary.png" target="_blank"><img src="media/l04_cosmosdb_create_summary.png" alt="Screenshot displaying the options configured for creating an Azure Cosmos DB account"></a></p>
  </li>
  <li>
    <p>On the <strong>Review + Create</strong> tab of the <strong>Create Azure Cosmos DB Account - Core (SQL)</strong> blade, review the options that you selected during the previous steps.</p>
  </li>
  <li>
    <p>Select <strong>Create</strong> to create the Azure Cosmos DB account by using your specified configuration.</p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the creation task to complete before you move forward with this lab.</p>
    </blockquote>
  </li>
  <li>
    <p>Select <strong>Go to resource</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Azure Cosmos DB account</strong> blade, find the&nbsp;<strong>Settings</strong>&nbsp;section, and then select the&nbsp;<strong>Keys</strong>&nbsp;link.</p>
  </li>
  <li>
    <p>In the&nbsp;<strong>Keys</strong>&nbsp;pane, on the <strong>Read-write Keys</strong> tab, record the values of the <strong>URI</strong>, <strong>PRIMARY KEY</strong>, and <strong>PRIMARY CONNECTION STRING</strong> text boxes. You’ll use these values later in this lab.</p>
  </li>
</ol>

<h4 id="task-3-create-an-azure-storage-account-resource">Task 3: Create an Azure Storage account resource</h4>

<ol>
  <li>
    <p>In the Azure portal, use the <strong>Search resources, services, and docs</strong> text box to search for <strong>Storage accounts</strong> and, in the list of results, select <strong>Storage accounts</strong>.</p>
  </li>
  <li>
    <p>On the&nbsp;<strong>Storage accounts</strong>&nbsp;blade, select <strong>+ Create</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Basics</strong> tab of the <strong>Create a storage account</strong> blade, perform the following actions, and then select <strong>Review + Create</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Subscription</strong> list</td>
          <td>Retain defaults.</td>
        </tr>
        <tr>
          <td><strong>Resource group</strong> section</td>
          <td>Select <strong>PolyglotData</strong>.</td>
        </tr>
        <tr>
          <td><strong>Storage account name</strong> text box</td>
          <td>Enter <strong>polystor</strong><em>[yourname]</em>.</td>
        </tr>
        <tr>
          <td><strong>Region</strong>&nbsp;drop-down list</td>
          <td>Select the same region where you created the Cosmos DB account earlier in this exercise.</td>
        </tr>
        <tr>
          <td><strong>Performance</strong>&nbsp;section</td>
          <td>Select <strong>Standard</strong>.</td>
        </tr>
        <tr>
          <td><strong>Redundancy</strong>&nbsp;drop-down list</td>
          <td>Select <strong>Locally-redundant storage (LRS)</strong>.</td>
        </tr>
      </tbody>
    </table>

    <p>The following screenshot displays the configured settings on the <strong>Create a storage account</strong> blade.</p>

    <p><a href="media/l04_storage_create_summary.png" target="_blank"><img src="media/l04_storage_create_summary.png" alt="Screenshot displaying the options configured for creating an Azure storage account"></a></p>
  </li>
  <li>
    <p>On the <strong>Review + Create</strong> tab of the <strong>Create a storage account</strong> blade, review the options that you selected during the previous steps.</p>
  </li>
  <li>
    <p>Select <strong>Create</strong> to create the storage account by using your specified configuration.</p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the creation task to complete before you proceed with this lab.</p>
    </blockquote>
  </li>
</ol>

<h4 id="review">Review</h4>

<p>In this exercise, you created the Azure resources that you’ll need for the polyglot data solution you’ll implement in this lab. The Azure resources you created include an Azure Cosmos DB account and an Azure Storage account.</p>

<h3 id="exercise-2-review-and-upload-data">Exercise 2: Review and upload data</h3>

<h4 id="task-1-upload-images-to-azure-blob-storage">Task 1: Upload images to Azure Blob Storage</h4>

<ol>
  <li>
    <p>In the Azure portal’s navigation pane, navigate back to the <strong>Storage accounts</strong> blade, and then select the <strong>polystor</strong><em>[yourname]</em> storage account that you created in this lab’s previous exercise.</p>
  </li>
  <li>
    <p>On the <strong>polystor</strong><em>[yourname]</em> storage account blade, select the <strong>Containers</strong> link in the <strong>Data storage</strong> section.</p>
  </li>
  <li>
    <p>In the <strong>Containers</strong> section, select <strong>+ Container</strong>.</p>
  </li>
  <li>
    <p>In the <strong>New container</strong> pop-up window, perform the following actions, and then select <strong>Create</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Name</strong> text box</td>
          <td>Enter <strong>images</strong>.</td>
        </tr>
        <tr>
          <td><strong>Public access level</strong> drop-down list</td>
          <td>Select <strong>Blob (anonymous read access for blobs only)</strong>.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>Back in the <strong>Containers</strong> section, select the newly created <strong>images</strong> container.</p>
  </li>
  <li>
    <p>Find the <strong>Settings</strong> section on the <strong>Container</strong> blade, and then select the <strong>Properties</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Properties</strong> pane, note and record the value in the <strong>URL</strong> text box. You’ll use this value later in this lab.</p>
  </li>
  <li>
    <p>Find and select the <strong>Overview</strong> link on the blade.</p>
  </li>
  <li>
    <p>On the blade, select <strong>Upload</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Upload blob</strong> pop-up, perform the following actions:</p>

    <p>a.  In the <strong>Files</strong> section, select the <strong>Folder</strong> icon.</p>

    <p>b.  In the <strong>File Explorer</strong> window, browse to <strong>Allfiles (F):\Allfiles\Labs\04\Starter\Images</strong>, select all 42 individual <strong>.jpg</strong> image files, and then select <strong>Open</strong>.</p>

    <p>c.  Ensure that <strong>Overwrite if files already exist</strong> is selected, and then select <strong>Upload</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: Wait for all blobs to upload before you continue with this lab.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-review-json-data">Task 2: Review JSON data</h4>

<ol>
  <li>
    <p>From the lab computer, start Visual Studio Code.</p>
  </li>
  <li>
    <p>From the <strong>File</strong> menu, select <strong>Open File</strong>, browse to <strong>Allfiles (F):\Allfiles\Labs\04\Starter\AdventureWorks\AdventureWorks.Upload</strong>, select <strong>models.json</strong>, and then select <strong>Open</strong>.</p>
  </li>
  <li>
    <p>Review the format of the <strong>models.json</strong> file and note that it contains an array of JSON objects, with a nested array of objects that are part of the <strong>Products</strong> property.</p>

    <blockquote>
      <p><strong>Note</strong>: This will determine the classes you’ll define to deserialize the JSON file’s contents before uploading it to a Cosmos DB collection.</p>
    </blockquote>
  </li>
  <li>
    <p>Within the <strong>models.json</strong> file, note that one of the properties is named <strong>Category</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: You’ll use the <strong>Category</strong> property to define partitioning of the target Cosmos DB collection.</p>
    </blockquote>
  </li>
  <li>
    <p>Close Visual Studio Code.</p>
  </li>
</ol>

<h4 id="task-3-create-a-cosmos-db-database-and-collection-and-perform-a-json-data-upload">Task 3: Create a Cosmos DB database and collection, and perform a JSON data upload</h4>

<ol>
  <li>
    <p>On the <strong>Start</strong> screen, select the <strong>Visual Studio Code</strong> tile.</p>
  </li>
  <li>
    <p>From the <strong>File</strong> menu, select <strong>Open Folder</strong>.</p>
  </li>
  <li>
    <p>In the <strong>File Explorer</strong> window that opens, browse to <strong>Allfiles (F):\Allfiles\Labs\04\Starter\AdventureWorks</strong>, and then select <strong>Select Folder</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, select an empty area of the <strong>Explorer</strong> pane, activate the shortcut menu, and then select <strong>Open in Integrated Terminal</strong>.</p>
  </li>
  <li>
    <p>From the terminal prompt, verify that the current directory is set to <strong>AdventureWorks</strong> (or change it to that if it’s not), and then run the following command to switch your terminal context to the <strong>AdventureWorks.Upload</strong> folder:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .\AdventureWorks.Upload\
</code></pre>
  </li>
  <li>
    <p>From the terminal prompt, run the following command to add the Azure Cosmos DB .NET client library to the currently opened project:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dotnet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Azure</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Cosmos</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--version</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet add package</strong> command will add the <strong>Microsoft.Azure.Cosmos</strong> package from <strong>NuGet</strong>. For more information, refer to <a href="https://www.nuget.org/packages/Microsoft.Azure.Cosmos/3.20.1">Microsoft.Azure.Cosmos</a>.</p>
    </blockquote>
  </li>
  <li>
    <p>Observe the results of the build printed in the terminal. The build should complete successfully with no errors or warning messages.</p>
  </li>
  <li>
    <p>In the&nbsp;<strong>Explorer</strong>&nbsp;pane of the <strong>Visual Studio Code</strong> window, expand the <strong>AdventureWorks.Upload</strong> project.</p>
  </li>
  <li>
    <p>Open the <strong>Program.cs</strong> file.</p>
  </li>
  <li>
    <p>In the <strong>Program.cs</strong> file, review the <strong>using</strong> directives and note that they include <strong>Microsoft.Azure.Cosmos</strong>, <strong>System.IO;</strong>, <strong>System.Text.Json</strong>, <strong>System.Threading.Tasks</strong>, and <strong>System.Collections.Generic</strong>. This enables asynchronous upload of JSON items from a local file on your lab computer to a collection in a Cosmos DB database.</p>
  </li>
  <li>
    <p>In the <strong>Program.cs</strong> file, on line 14, set the value of <strong>EndpointUrl</strong> by replacing the empty string with the <strong>URI</strong> property of the Cosmos DB account that you recorded earlier in this lab. Ensure that the value is enclosed in double quotes.</p>
  </li>
  <li>
    <p>On line 15, set the value of <strong>AuthorizationKey</strong> by replacing the empty string with the <strong>PRIMARY KEY</strong> property of the Cosmos DB account that you recorded earlier in this lab. Ensure that the value is enclosed in double quotes.</p>
  </li>
  <li>
    <p>On line 18, set the value of <strong>PrimaryKey</strong> by replacing the empty string with <strong>“/Category”</strong>.</p>
  </li>
  <li>
    <p>On line 19, set the value of <strong>JsonFilePath</strong> by replacing the empty string with <strong>“F:\\Allfiles\\Labs\\04\\Starter\\AdventureWorks\\AdventureWorks.Upload\\models.json”</strong>.</p>
  </li>
  <li>
    <p>Within the try block, note the invocation of the <strong>CreateDatabaseIfNotExistsAsync</strong> method of the <strong>CosmosClient</strong> class. This will create a database if one doesn’t already exist.</p>
  </li>
  <li>
    <p>Note the invocation of the <strong>DefineContainer</strong> method of the <strong>Database</strong> class. This will create a container that will host the JSON items if one doesn’t already exist.</p>

    <blockquote>
      <p><strong>Note</strong>: The <strong>DefineContainer</strong> method includes a cost-minimizing option whereby you can modify the default indexing policy (which automatically indexes all attributes).</p>
    </blockquote>
  </li>
  <li>
    <p>Note the <strong>using</strong> statement that relies on a <strong>StreamReader</strong> object to read JSON items from a text file and deserializes them into objects of the <strong>Model</strong> class defined further in the <strong>Program.cs</strong> file.</p>
  </li>
  <li>
    <p>Note the foreach loop that iterates over the collection of deserialized objects and asynchronously inserts each of them into the target collection.</p>
  </li>
  <li>
    <p>Review the <strong>Model</strong> and <strong>Product</strong> classes that reflect the format of the objects stored in the JSON-formatted file you reviewed earlier in this lab.</p>
  </li>
  <li>
    <p>Save and close the&nbsp;<strong>Program.cs</strong> file.</p>
  </li>
  <li>
    <p>From the terminal prompt, run the following command to restore any missing NuGet packages and build the project in the folder:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> build
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet build</strong> command will automatically restore any missing NuGet packages prior to building all projects in the folder.</p>
    </blockquote>
  </li>
  <li>
    <p>From the terminal prompt, run the following command to run the .NET Core console application:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> run
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet run</strong> command will automatically build any changes to the project and then start the web application without a debugger attached. The command will output the messages indicating the data load’s progress, including the number of items inserted into the target collection and the duration of the insert operation.</p>
    </blockquote>
  </li>
  <li>
    <p>Observe the results of running the command printed in the terminal. The run should complete successfully, displaying the message about there being 119 items inserted into the target Cosmos DB collection.</p>
  </li>
  <li>
    <p>Select <strong>Kill Terminal</strong> (the <strong>Recycle Bin</strong> icon) to close the terminal pane and any associated processes.</p>
  </li>
</ol>

<h4 id="task-4-validate-json-data-upload">Task 4: Validate JSON data upload</h4>

<ol>
  <li>
    <p>On your lab computer, switch to the <strong>Microsoft Edge</strong> browser window displaying the Azure portal.</p>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the <strong>Azure Cosmos DB</strong> blade and, in the Cosmos DB accounts list, select the <strong>polycosmos</strong><em>[yourname]</em> Azure Cosmos DB account that you created earlier in this lab.</p>
  </li>
  <li>
    <p>On the <strong>Azure Cosmos DB account</strong> blade, find and select the&nbsp;<strong>Data Explorer</strong> link on the blade.</p>
  </li>
  <li>
    <p>In the <strong>Data Explorer</strong> pane, expand the <strong>Retail</strong> database node.</p>
  </li>
  <li>
    <p>Expand the <strong>Online</strong> container node, and then select <strong>New SQL Query</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: The label for this option might be hidden. You can display labels by hovering over the icons in the <strong>Data Explorer</strong> pane.</p>
    </blockquote>
  </li>
  <li>
    <p>On the query tab, enter the following text:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> models
</code></pre>
  </li>
  <li>
    <p>Select <strong>Execute Query</strong>, and then observe the list of JSON items returned by the query.</p>
  </li>
  <li>
    <p>Back in the query editor, replace the existing text with the following text:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> models
</code></pre>
  </li>
  <li>
    <p>Select <strong>Execute Query</strong>, and then observe the result of the <strong>COUNT</strong> aggregate operation.</p>
  </li>
  <li>
    <p>Switch back to the <strong>Visual Studio Code</strong> window.</p>
  </li>
</ol>

<h4 id="review-1">Review</h4>

<p>In this exercise, you used the .NET SDK for Azure Cosmos DB to insert data into Azure Cosmos DB. The web application that you implement next will use this data.</p>

<h3 id="exercise-3-configure-a-net-web-application">Exercise 3: Configure a .NET web application</h3>

<h4 id="task-1-update-references-to-data-stores-and-build-the-web-application">Task 1: Update references to data stores and build the web application</h4>

<ol>
  <li>
    <p>In the&nbsp;<strong>Explorer</strong>&nbsp;pane of the <strong>Visual Studio Code</strong> window, expand the <strong>AdventureWorks.Web</strong> project.</p>
  </li>
  <li>
    <p>Open the <strong>appsettings.json</strong> file.</p>
  </li>
  <li>
    <p>In the JSON object on line 3, find the <strong>ConnectionStrings.AdventureWorksCosmosContext</strong> path. Note that the current value is empty:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="hljs bash"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: {
    <span class="hljs-string"><span class="hljs-string">"AdventureWorksCosmosContext"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>,
},
</code></pre>
  </li>
  <li>
    <p>Update the value of the&nbsp;<strong>AdventureWorksCosmosContext</strong>&nbsp;property by setting its value to the&nbsp;<strong>PRIMARY CONNECTION STRING</strong> of the Azure Cosmos DB account that you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>In the JSON object on line 6, find the <strong>Settings.BlobContainerUrl</strong> path. Note that the current value is empty:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="hljs bash"><span class="hljs-string"><span class="hljs-string">"Settings"</span></span>: {
    <span class="hljs-string"><span class="hljs-string">"BlobContainerUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>,
    ...
}
</code></pre>
  </li>
  <li>
    <p>Update the&nbsp;<strong>BlobContainerUrl</strong>&nbsp;property by setting its value to the&nbsp;<strong>URL</strong> property of the Azure Storage blob container named <strong>images</strong> that you recorded earlier in this lab.</p>
  </li>
  <li>
    <p>Save the&nbsp;<strong>appsettings.json</strong>&nbsp;file and close it.</p>
  </li>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, select <strong>AdventureWorks.Context</strong>, activate the shortcut menu, and then select <strong>Open in Integrated Terminal</strong>.</p>
  </li>
  <li>
    <p>From the terminal prompt, verify that the current directory is set to <strong>AdventureWorks.Context</strong> (or change it to that if it’s not), and then run the following command to import <strong>Microsoft.Azure.Cosmos</strong> from NuGet:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dotnet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Azure</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Cosmos</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--version</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span>
</code></pre>
  </li>
  <li>
    <p>From the terminal prompt, run the following command to build the .NET web application:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> build
</code></pre>
  </li>
  <li>
    <p>Observe the results of the build printed in the terminal. The build should complete successfully with no errors or warning messages.</p>
  </li>
</ol>

<h4 id="task-2-configure-connectivity-to-azure-cosmos-db">Task 2: Configure connectivity to Azure Cosmos DB</h4>

<ol>
  <li>
    <p>In the&nbsp;<strong>Explorer</strong>&nbsp;pane of the <strong>Visual Studio Code</strong> window, expand the <strong>AdventureWorks.Context</strong> project.</p>
  </li>
  <li>
    <p>From the shortcut menu of the <strong>AdventureWorks.Context</strong> folder node, select <strong>New File</strong>.</p>
  </li>
  <li>
    <p>At the new file prompt, enter <strong>AdventureWorksCosmosContext.cs</strong>.</p>
  </li>
  <li>
    <p>From the code editor tab for the&nbsp;<strong>AdventureWorksCosmosContext.cs</strong>&nbsp;file, add the following lines of code to import the <strong>AdventureWorks.Models</strong> namespace from the referenced <strong>AdventureWorks.Models</strong> project:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> AdventureWorks.Models;
</code></pre>
  </li>
  <li>
    <p>Add the following lines of code to import the <strong>Microsoft.Azure.Cosmos</strong> and <strong>Microsoft.Azure.Cosmos.Linq</strong> namespaces from the <strong>Microsoft.Azure.Cosmos</strong> package imported from NuGet:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">using</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Azure</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Cosmos</span></span>;
<span class="hljs-selector-tag"><span class="hljs-selector-tag">using</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Azure</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Cosmos</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Linq</span></span>;
</code></pre>
  </li>
  <li>
    <p>Add the following lines of code to include <strong>using</strong> directives for the built-in namespaces that this file will use:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">using</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span>;
<span class="hljs-selector-tag"><span class="hljs-selector-tag">using</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Generic</span></span>;
<span class="hljs-selector-tag"><span class="hljs-selector-tag">using</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Linq</span></span>;
<span class="hljs-selector-tag"><span class="hljs-selector-tag">using</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Tasks</span></span>;
</code></pre>
  </li>
  <li>
    <p>Enter the following code to add an <strong>AdventureWorks.Context</strong> namespace block:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AdventureWorks.Context</span></span>
{
}
</code></pre>
  </li>
  <li>
    <p>Within the <strong>AdventureWorks.Context</strong> namespace, enter the following code to create a new <strong>AdventureWorksCosmosContext</strong> class:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdventureWorksCosmosContext</span></span></span><span class="hljs-class">
{</span></span>
}
</code></pre>
  </li>
  <li>
    <p>Update the declaration of the <strong>AdventureWorksCosmosContext</strong> class by adding a specification indicating that this class will implement the <strong>IAdventureWorksProductContext</strong> interface:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock15" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock15" class="mt-0"><code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdventureWorksCosmosContext</span></span></span><span class="hljs-class"> :</span></span> IAdventureWorksProductContext
{
}
</code></pre>
  </li>
  <li>
    <p>Within the <strong>AdventureWorksCosmosContext</strong> class, enter the following code to create a new read-only <em>Container</em> variable named <strong>_container</strong>:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock16" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock16" class="mt-0"><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Container _container;
</code></pre>
  </li>
  <li>
    <p>Within the <strong>AdventureWorksCosmosContext</strong> class, add a new constructor with the following signature:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock17" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock17" class="mt-0"><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdventureWorksCosmosContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> database = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Retail"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> container = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Online"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
}
</code></pre>
  </li>
  <li>
    <p>Within the constructor, add the following block of code to create a new instance of the <strong>CosmosClient</strong> class, and then obtain both a <strong>Database</strong> and <strong>Container</strong> instance from the client:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock18" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock18" class="mt-0"><code class="hljs makefile">_container = new CosmosClient(connectionString)
    .GetDatabase(database)
    .GetContainer(container);
</code></pre>
  </li>
  <li>
    <p>Within the <strong>AdventureWorksCosmosContext</strong> class, add a new <strong>FindModelAsync</strong> method with the following signature:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock19" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock19" class="mt-0"><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;Model&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindModelAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)
</span></span>{
}
</code></pre>
  </li>
  <li>
    <p>Within the <strong>FindModelAsync</strong> method, add the following blocks of code to create a LINQ query, transform it into an iterator, iterate over the result set, and then return the single item in the result set:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock20" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock20" class="mt-0"><code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> iterator = _container.GetItemLinqQueryable&lt;Model&gt;()
    .Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">m</span></span></span><span class="hljs-function"> =&gt;</span></span> m.id == id)
    .ToFeedIterator&lt;Model&gt;();

List&lt;Model&gt; matches = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Model&gt;();
<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (iterator.HasMoreResults)
{
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> next = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> iterator.ReadNextAsync();
    matches.AddRange(next);
}

<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> matches.SingleOrDefault();
</code></pre>
  </li>
  <li>
    <p>Within the <strong>AdventureWorksCosmosContext</strong> class, add a new <strong>GetModelsAsync</strong> method with the following signature:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock21" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock21" class="mt-0"><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;List&lt;Model&gt;&gt; GetModelsAsync()
{
}
</code></pre>
  </li>
  <li>
    <p>Within the <strong>GetModelsAsync</strong> method, add the following blocks of code to run an SQL query, get the query result iterator, iterate over the result set, and then return the union of all results:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock22" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock22" class="mt-0"><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query = <span class="hljs-string"><span class="hljs-string">$@"SELECT * FROM items"</span></span>;

<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> iterator = _container.GetItemQueryIterator&lt;Model&gt;(query);

List&lt;Model&gt; matches = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Model&gt;();
<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (iterator.HasMoreResults)
{
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> next = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> iterator.ReadNextAsync();
    matches.AddRange(next);
}

<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> matches;
</code></pre>
  </li>
  <li>
    <p>Within the <strong>AdventureWorksCosmosContext</strong> class, add a new <strong>FindProductAsync</strong> method with the following signature:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock23" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock23" class="mt-0"><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindProductAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)
</span></span>{
}
</code></pre>
  </li>
  <li>
    <p>Within the <strong>FindProductAsync</strong> method, add the following blocks of code to run an SQL query, get the query result iterator, iterate over the result set, and then return the single item in the result set:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock24" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock24" class="mt-0"><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> query = <span class="hljs-string"><span class="hljs-string">$@"SELECT VALUE products
                    FROM models
                    JOIN products in models.Products
                    WHERE products.id = '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{id}</span></span></span><span class="hljs-string">'"</span></span>;

<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> iterator = _container.GetItemQueryIterator&lt;Product&gt;(query);

List&lt;Product&gt; matches = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Product&gt;();
<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (iterator.HasMoreResults)
{
    <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> next = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> iterator.ReadNextAsync();
    matches.AddRange(next);
}

<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> matches.SingleOrDefault();
</code></pre>
  </li>
  <li>
    <p>Save and close the&nbsp;<strong>AdventureWorksCosmosContext.cs</strong>&nbsp;file.</p>
  </li>
  <li>
    <p>From the terminal prompt, with the current directory set to <strong>AdventureWorks.Context</strong>, run the following command to build the .NET web application:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock25" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock25" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> build
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: If there are any build errors, review the <strong>AdventureWorksCosmosContext.cs</strong> file in the <strong>Allfiles (F):\Allfiles\Labs\04\Solution\AdventureWorks\AdventureWorks.Context</strong> folder.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-3-review-the-net-application-startup-logic">Task 3: Review the .NET application startup logic</h4>

<ol>
  <li>
    <p>In the&nbsp;<strong>Explorer</strong>&nbsp;pane of the <strong>Visual Studio Code</strong> window, expand the <strong>AdventureWorks.Web</strong> project.</p>
  </li>
  <li>
    <p>Open the <strong>Startup.cs</strong> file.</p>
  </li>
  <li>
    <p>In the <strong>Startup</strong> class, note the existing <strong>ConfigureProductService</strong> method:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock26" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock26" class="mt-0"><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureProductService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)
</span></span>{
    services.AddScoped&lt;IAdventureWorksProductContext, AdventureWorksSqlContext&gt;(provider =&gt;
        <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AdventureWorksCosmosContext(
            _configuration.GetConnectionString(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(AdventureWorksCosmosContext))
        )
    );
}
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The product service uses Cosmos DB as its database.</p>
    </blockquote>
  </li>
  <li>
    <p>Close the&nbsp;<strong>Startup.cs</strong>&nbsp;file without making any modifications.</p>
  </li>
</ol>

<h4 id="task-4-validate-that-the-net-application-successfully-connects-to-data-stores">Task 4: Validate that the .NET application successfully connects to data stores</h4>

<ol>
  <li>
    <p>In Visual Studio Code, from the terminal prompt, run the following command to switch your terminal context to the <strong>AdventureWorks.Web</strong> folder:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock27" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock27" class="mt-0"><code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ..\AdventureWorks.Web\
</code></pre>
  </li>
  <li>
    <p>From the terminal prompt, run the following command to run the ASP.NET web application:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock28" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock28" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> run
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet run</strong> command will automatically build any changes to the project and then start the web application without a debugger attached. The command will output the URL of the running application and any assigned ports.</p>
    </blockquote>
  </li>
  <li>
    <p>On the taskbar, select the <strong>Microsoft Edge</strong> icon.</p>
  </li>
  <li>
    <p>In the open browser window, browse to the currently running web application (<a href="http://localhost:5000">http://localhost:5000</a>).</p>
  </li>
  <li>
    <p>In the web application, observe the list of models displayed from the front page.</p>
  </li>
  <li>
    <p>Find the <strong>Touring-1000</strong> model, and then select <strong>View Details</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Touring-1000</strong> product detail page, review the listing of options.</p>
  </li>
  <li>
    <p>Close the browser window displaying your web application.</p>
  </li>
  <li>
    <p>Switch to the <strong>Visual Studio Code</strong> window, and then select <strong>Kill Terminal</strong> (the <strong>Recycle Bin</strong> icon) to close the currently open terminal and any associated processes.</p>
  </li>
</ol>

<h4 id="review-2">Review</h4>

<p>In this exercise, you wrote C# code to query an Azure Cosmos DB collection by using the .NET SDK.</p>

<h3 id="exercise-4-clean-up-your-subscription">Exercise 4: Clean up your subscription</h3>

<h4 id="task-1-open-azure-cloud-shell">Task 1: Open Azure Cloud Shell</h4>

<ol>
  <li>
    <p>In the Azure portal, select the <strong>Cloud Shell</strong> icon <a href="media/az204_lab_CloudShell.png" target="_blank"><img src="media/az204_lab_CloudShell.png" alt="Cloud Shell icon"></a> to open a new Bash session. If Cloud Shell defaults to a PowerShell session, select <strong>PowerShell</strong> and, in the drop-down menu, select <strong>Bash</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is the first time you’re starting <strong>Cloud Shell</strong>, when prompted to select either <strong>Bash</strong> or <strong>PowerShell</strong>, select <strong>PowerShell</strong>. When you are presented with the <strong>You have no storage mounted</strong> message, select the subscription you’re using in this lab, and then select <strong>Create storage</strong>.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-delete-resource-groups">Task 2: Delete resource groups</h4>

<ol>
  <li>
    <p>In the <strong>Cloud Shell</strong> pane, run the following command to delete the <strong>PolyglotData</strong> resource group:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock29" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock29" class="mt-0"><code class="hljs coffeescript">az group <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> --name PolyglotData --<span class="hljs-literal"><span class="hljs-literal">no</span></span>-wait --<span class="hljs-literal"><span class="hljs-literal">yes</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The command executes asynchronously (as determined by the <em>–no-wait</em> parameter). Therefore, while you’ll be able to run another Azure CLI command immediately after, within the same Bash session, it’ll take a few minutes before the resource groups are actually removed.</p>
    </blockquote>
  </li>
  <li>
    <p>Close the <strong>Cloud Shell</strong> pane in the portal.</p>
  </li>
</ol>

<h4 id="task-3-close-the-active-applications">Task 3: Close the active applications</h4>

<ol>
  <li>
    <p>Close the currently running Microsoft Edge application.</p>
  </li>
  <li>
    <p>Close the currently running Visual Studio Code application.</p>
  </li>
</ol>

<h4 id="review-3">Review</h4>

<p>In this exercise, you cleaned up your subscription by removing the resource groups used in this lab.</p>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-204-DevelopingSolutionsforMicrosoftAzure" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-204-DevelopingSolutionsforMicrosoftAzure
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D64f540ac7c8eef33997aaf23b6af9bd5b858530e.js"></script>



</body></html>