<!DOCTYPE html><html lang="en"><head>
        <title>
            AZ-204: Developing solutions for Microsoft Azure
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <link rel="stylesheet" href="../../assets/css/style_v%3D64f540ac7c8eef33997aaf23b6af9bd5b858530e.css">
    </head>
    <body data-spy="scroll" data-target="#linksMenu">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
        <div class="container d-flex justify-content-between">
            <a class="my-1 title text-azure text-uppercase" href="../../">
                AZ-204: Developing solutions for Microsoft Azure
            </a>
            <a href="https://github.com/MicrosoftLearning/AZ-204-DevelopingSolutionsforMicrosoftAzure" target="_blank" class="btn btn-sm btn-outline-secondary text-light">
                <i class="fa fa-github" aria-hidden="true"></i>
                <span class="ml-2">GitHub</span>
            </a>
        </div>
    </nav>
    <div class="container">
        <main class="row extra-padding">
            <aside class="col-sm-2">       
                <nav id="linksMenu" class="toc sticky-top">
                    <ul class="nav navbar-nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#before-you-start">Before you start</a></li><li class="nav-item"><a class="nav-link" href="#exercise-1-create-and-configure-azure-resources">Exercise 1: Create and configure Azure resources</a></li><li class="nav-item"><a class="nav-link active" href="#task-3-create-an-azure-web-api-resource">Task 3: Create an Azure Web API resource</a></li><li class="nav-item"><a class="nav-link" href="#exercise-2-monitor-a-local-web-api-by-using-application-insights">Exercise 2: Monitor a local web API by using Application Insights</a></li><li class="nav-item"><a class="nav-link" href="#exercise-3-monitor-a-web-api-using-application-insights">Exercise 3: Monitor a web API using Application Insights</a></li><li class="nav-item"><a class="nav-link" href="#exercise-4-application-insights-logging-with-net-core">Exercise 4: Application Insights logging with .NET Core</a></li><li class="nav-item"><a class="nav-link" href="#exercise-5-clean-up-your-subscription">Exercise 5: Clean up your subscription</a></li></ul>
                </nav>         
            </aside>
            <hr class>
            <article class="col-sm-10 mb-5">
                <h1 id="lab-11-monitor-services-that-are-deployed-to-azure">Lab 11: Monitor services that are deployed to Azure</h1>

<h2 id="microsoft-azure-user-interface">Microsoft Azure user interface</h2>

<p>Given the dynamic nature of Microsoft cloud tools, you might experience Azure UI changes that occur after the development of this training content. As a result, the lab instructions and lab steps might not align correctly.</p>

<p>Microsoft updates this training course when the community alerts us to needed changes. However, cloud updates occur frequently, so you might encounter UI changes before this training content updates. <strong>If this occurs, adapt to the changes, and then work through them in the labs as needed.</strong></p>

<h2 id="instructions">Instructions</h2>

<h3 id="before-you-start">Before you start</h3>

<h4 id="sign-in-to-the-lab-environment">Sign in to the lab environment</h4>

<p>Sign in to your Windows 10 virtual machine (VM) by using the following credentials:</p>

<ul>
  <li>
    <p>Username: <strong>Admin</strong></p>
  </li>
  <li>
    <p>Password: <strong>Pa55w.rd</strong></p>
  </li>
</ul>

<blockquote>
  <p><strong>Note</strong>: Your instructor will provide instructions to connect to the virtual lab environment.</p>
</blockquote>

<h4 id="review-the-installed-applications">Review the installed applications</h4>

<p>Find the taskbar on your Windows 10 desktop. The taskbar contains the icons for the applications that you’ll use in this lab, including:</p>

<ul>
  <li>
    <p>Microsoft Edge</p>
  </li>
  <li>
    <p>File Explorer</p>
  </li>
  <li>
    <p>Visual Studio Code</p>
  </li>
  <li>
    <p>Azure PowerShell</p>
  </li>
</ul>

<h2 id="architecture-diagram">Architecture diagram</h2>

<p><a href="media/Lab11-Diagram.png" target="_blank"><img src="media/Lab11-Diagram.png" alt="Architecture diagram depicting the monitoring of services that are deployed to Azure"></a></p>

<h3 id="exercise-1-create-and-configure-azure-resources">Exercise 1: Create and configure Azure resources</h3>

<h4 id="task-1-open-the-azure-portal">Task 1: Open the Azure portal</h4>

<ol>
  <li>
    <p>On the taskbar, select the <strong>Microsoft Edge</strong> icon.</p>
  </li>
  <li>
    <p>In the browser window, browse to the Azure portal (<a href="https://portal.azure.com">portal.azure.com</a>), and then sign in with the account you’ll be using for this lab.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is your first time signing in to the Azure portal, you’ll be offered a tour of the portal. Select <strong>Get Started</strong> to skip the tour and begin using the portal.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-create-an-application-insights-resource">Task 2: Create an Application Insights resource</h4>

<ol>
  <li>
    <p>In the Azure portal, use the <strong>Search resources, services, and docs</strong> text box at the top of the page to search for <strong>Application Insights</strong> and then, in the list of results, select <strong>Application Insights</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, select <strong>+ Create</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, on the <strong>Basics</strong> tab, perform the following actions, and select <strong>Review + Create</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Subscription</strong> drop-down list</td>
          <td>Retain the default value.</td>
        </tr>
        <tr>
          <td><strong>Resource group</strong> section</td>
          <td>Select <strong>Create new</strong>, enter <strong>MonitoredAssets</strong>, and then select <strong>OK</strong>.</td>
        </tr>
        <tr>
          <td><strong>Name</strong>&nbsp;text box</td>
          <td><strong>instrm</strong><em>[yourname]</em>.</td>
        </tr>
        <tr>
          <td><strong>Region</strong> drop-down list</td>
          <td>Select any Azure region in which you can deploy an Azure Service Bus.</td>
        </tr>
        <tr>
          <td><strong>Resource Mode</strong> section</td>
          <td>Select the <strong>Workspace-based</strong> option.</td>
        </tr>
        <tr>
          <td><strong>WORKSPACE DETAILS</strong> section</td>
          <td>Retain the default values for the <strong>Subscription</strong> and <strong>Log Analytics Workspace</strong> drop-down lists.</td>
        </tr>
      </tbody>
    </table>

    <p>The following screenshot displays the configured settings on the <strong>Application Insights</strong> blade.</p>

    <p><a href="media/l11_create_app_insights_portal.png" target="_blank"><img src="media/l11_create_app_insights_portal.png" alt="Create an Azure Application Insights instance blade"></a></p>
  </li>
  <li>
    <p>On the <strong>Review + Create</strong> tab, review the options that you selected during the previous steps.</p>
  </li>
  <li>
    <p>Select <strong>Create</strong> to create the <strong>Application Insights</strong> instance by using your specified configuration.</p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the creation task to complete before you proceed with this lab.</p>
    </blockquote>
  </li>
  <li>
    <p>On the <strong>Microsoft.AppInsights | Overview</strong> blade, select the <strong>Go to resource</strong> button to navigate to the blade of the newly created <strong>Application Insights</strong> resource.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, in the <strong>Configure</strong> section, select the <strong>Properties</strong> link.</p>
  </li>
  <li>
    <p>On the <strong>Properties</strong> blade, next to the <strong>Instrumentation Key</strong> entry, select the <strong>Copy to clipboard</strong> button, and then record the copied value. You’ll use it later in this lab.</p>

    <blockquote>
      <p><strong>Note</strong>: The key is used by client applications to connect to a specific <strong>Application Insights</strong> resource.</p>
    </blockquote>
  </li>
</ol>

<h3 id="task-3-create-an-azure-web-api-resource">Task 3: Create an Azure Web API resource</h3>

<ol>
  <li>
    <p>In the Azure portal, use the <strong>Search resources, services, and docs</strong> text box at the top of the page to search for <strong>App Services</strong> and then, in the list of results, select <strong>App Services</strong>.</p>
  </li>
  <li>
    <p>On the <strong>App Services</strong> blade, select <strong>+ Create</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Create Web App</strong> blade, on the <strong>Basics</strong> tab, perform the following actions, and then select <strong>Next: Deployment</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Subscription</strong> drop-down list</td>
          <td>Retain the default value.</td>
        </tr>
        <tr>
          <td><strong>Resource group</strong> drop-down list</td>
          <td>Select <strong>MonitoredAssets</strong>.</td>
        </tr>
        <tr>
          <td><strong>Name</strong>&nbsp;text box</td>
          <td>Enter <strong>smpapi</strong><em>[yourname]</em>.</td>
        </tr>
        <tr>
          <td><strong>Publish</strong> section</td>
          <td>Select <strong>Code</strong>.</td>
        </tr>
        <tr>
          <td><strong>Runtime stack</strong> drop-down list</td>
          <td>Select <strong>.NET Core 3.1 (LTS)</strong>.</td>
        </tr>
        <tr>
          <td><strong>Operating System</strong> section</td>
          <td>Select <strong>Windows</strong>.</td>
        </tr>
        <tr>
          <td><strong>Region</strong>&nbsp;drop-down list</td>
          <td>Select the same region you chose as the location of the <strong>Application Instance</strong> resource.</td>
        </tr>
        <tr>
          <td><strong>App Service Plan</strong> section</td>
          <td>Select <strong>Create new</strong>.</td>
        </tr>
        <tr>
          <td><strong>Name</strong> text box</td>
          <td>Enter <strong>MonitoredPlan</strong>, and then select <strong>OK</strong>.</td>
        </tr>
        <tr>
          <td><strong>SKU and size</strong> section</td>
          <td>Retain the default value.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>On the <strong>Deployment</strong> tab, select <strong>Next: Monitoring</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Monitoring</strong> tab, perform the following actions, and then select <strong>Review + Create</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Enable Application Insights</strong> section</td>
          <td>Ensure that <strong>Yes</strong> is selected.</td>
        </tr>
        <tr>
          <td><strong>Application Insights</strong> drop-down list</td>
          <td>Select the <strong>instrm</strong><em>[yourname]</em> Application Insights resource that you created previously in this lab.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>On the <strong>Review + Create</strong> tab, review the options that you selected during the previous steps.</p>
  </li>
  <li>
    <p>Select <strong>Create</strong> to create the web API by using your specified configuration.</p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the creation task to complete before you proceed with this lab.</p>
    </blockquote>
  </li>
  <li>
    <p>On the deployment <strong>Overview</strong> blade, select the <strong>Go to resource</strong> button to navigate to the blade of the newly created Azure web API.</p>
  </li>
  <li>
    <p>On the <strong>App Service</strong> blade, in the <strong>Settings</strong> section, select the <strong>Configuration</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Configuration</strong> section, perform the following actions:</p>

    <p>a.  On the <strong>Application settings</strong> tab, select <strong>Show Values</strong> to display secrets associated with your web API.</p>

    <p>b.  Note the value representing the <strong>APPINSIGHTS_INSTRUMENTATIONKEY</strong> key. This value was set automatically when you built the web API resource.</p>
  </li>
  <li>
    <p>On the <strong>App Service</strong> blade, in the <strong>Settings</strong> section, select the <strong>Properties</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Properties</strong> section, record the value of the <strong>URL</strong> link. You’ll use this value later in the lab to submit requests to the web API.</p>
  </li>
</ol>

<h4 id="task-4-configure-web-api-autoscale-options">Task 4: Configure web API autoscale options</h4>

<ol>
  <li>
    <p>On the <strong>App Service</strong> blade, in the <strong>Settings</strong> section, select the <strong>Scale out (App Service Plan)</strong> link.</p>
  </li>
  <li>
    <p>In the <strong>Scale out</strong> section, perform the following actions, and then select <strong>Save</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Scale out</strong> section</td>
          <td>Select <strong>Custom autoscale</strong>.</td>
        </tr>
        <tr>
          <td><strong>Autoscale setting name</strong> text box</td>
          <td>Enter <strong>ComputeScaler</strong>.</td>
        </tr>
        <tr>
          <td><strong>Resource group</strong> drop-down list</td>
          <td>Select <strong>MonitoredAssets</strong>.</td>
        </tr>
        <tr>
          <td><strong>Scale mode</strong> section</td>
          <td>Select <strong>Scale based on a metric</strong>.</td>
        </tr>
        <tr>
          <td><strong>Minimum</strong> text box in the <strong>Instance limits</strong> section</td>
          <td>Enter <strong>2</strong>.</td>
        </tr>
        <tr>
          <td><strong>Maximum</strong> text box in the <strong>Instance limits</strong> section</td>
          <td>Enter <strong>8</strong>.</td>
        </tr>
        <tr>
          <td><strong>Default</strong> text box in the <strong>Instance limits</strong> section</td>
          <td>Enter <strong>3</strong>.</td>
        </tr>
      </tbody>
    </table>

    <p>The following screenshot displays the configured settings in the <strong>Scale out</strong> section on the <strong>App Service</strong> blade.</p>

    <p><a href="media/l11_scale_web_app_default.png" target="_blank"><img src="media/l11_scale_web_app_default.png" alt="Default scale condition on the Azure web API blade"></a></p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Rules</strong> section</td>
          <td>Select <strong>Add a rule</strong>.</td>
        </tr>
        <tr>
          <td><strong>Scale rule</strong> blade</td>
          <td>Retain default values for all settings, and then select <strong>Add</strong>.</td>
        </tr>
      </tbody>
    </table>

    <p>The following screenshot displays additional settings in the <strong>Scale out</strong> section on the <strong>App Service</strong> blade.</p>

    <p><a href="media/l11_scale_web_app_rule.png" target="_blank"><img src="media/l11_scale_web_app_rule.png" alt="Scale rule blade of the default scale condition on the Azure web API blade"></a></p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the save operation to complete before you continue with this lab.</p>
    </blockquote>
  </li>
</ol>

<h4 id="review">Review</h4>

<p>In this exercise, you created the Azure resources that you’ll use for the remainder of the lab.</p>

<h3 id="exercise-2-monitor-a-local-web-api-by-using-application-insights">Exercise 2: Monitor a local web API by using Application Insights</h3>

<h4 id="task-1-build-a-net-web-api-project">Task 1: Build a .NET Web API project</h4>

<ol>
  <li>
    <p>From the lab computer, start <strong>Visual Studio Code</strong>.</p>
  </li>
  <li>
    <p>In Visual Studio Code, on the <strong>File</strong> menu, select <strong>Open Folder</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Open Folder</strong> window, browse to <strong>Allfiles (F):\Allfiles\Labs\11\Starter\Api</strong>, and then select <strong>Select Folder</strong>.</p>
  </li>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, activate the shortcut menu, and then select <strong>Open in Integrated Terminal</strong>.</p>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to create a new .NET Web API application named <strong>SimpleApi</strong> in the current directory:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock0" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock0" class="mt-0"><code class="hljs coffeescript">dotnet <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> webapi --output . --name SimpleApi
</code></pre>
  </li>
  <li>
    <p>Run the following command to import version 2.18.0 of <strong>Microsoft.ApplicationInsights</strong> from NuGet to the current project:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock1" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock1" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dotnet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ApplicationInsights</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--version</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet add package</strong> command will add the <strong>Microsoft.ApplicationInsights</strong> package from NuGet. For more information, refer to <a href="https://www.nuget.org/packages/Microsoft.ApplicationInsights/">Microsoft.ApplicationInsights</a>.</p>
    </blockquote>
  </li>
  <li>
    <p>Run the following command to import version 2.18.0 of <strong>Microsoft.ApplicationInsights.AspNetCore</strong> from NuGet:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock2" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock2" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dotnet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ApplicationInsights</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AspNetCore</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--version</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet add package</strong> command will add the <strong>Microsoft.ApplicationInsights.AspNetCore</strong> package from NuGet. For more information, refer to <a href="https://www.nuget.org/packages/Microsoft.ApplicationInsights.AspNetCore">Microsoft.ApplicationInsights.AspNetCore</a>.</p>
    </blockquote>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to import version 2.18.0 of <strong>Microsoft.ApplicationInsights.PerfCounterCollector</strong> from NuGet to the current project:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock3" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock3" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dotnet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ApplicationInsights</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PerfCounterCollector</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--version</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet add package</strong> command will add the <strong>Microsoft.ApplicationInsights.PerfCounterCollector</strong> package from NuGet. For more information, refer to <a href="https://www.nuget.org/packages/Microsoft.ApplicationInsights.PerfCounterCollector/">Microsoft.ApplicationInsights.PerfCounterCollector</a>.</p>
    </blockquote>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to build the .NET Web API:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock4" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock4" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> build
</code></pre>
  </li>
</ol>

<h4 id="task-2-update-app-code-to-disable-https-and-use-application-insights">Task 2: Update app code to disable HTTPS and use Application Insights</h4>

<ol>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, on the <strong>Explorer</strong> pane, select the <strong>Startup.cs</strong> file to open the file on the <strong>editor</strong> pane.</p>
  </li>
  <li>
    <p>On the <strong>editor</strong> pane, in the <strong>Startup</strong> class, locate and delete the following code in line 39:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock5" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock5" class="mt-0"><code class="language-csharp hljs">app.UseHttpsRedirection();
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: This line of code forces the web API to use HTTPS. For this lab, this is unnecessary.</p>
    </blockquote>
  </li>
  <li>
    <p>At the beginning of the definition of the <strong>Startup</strong> class, add a new static string constant named <strong>INSTRUMENTATION_KEY</strong> with the value set to the Application Insights resource instrumentation key that you recorded previously in this lab:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock6" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock6" class="mt-0"><code class="language-csharp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> INSTRUMENTATION_KEY = <span class="hljs-string"><span class="hljs-string">"instrumentation_key"</span></span>;
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: For example, if your instrumentation key is <code>d2bb0eed-1342-4394-9b0c-8a56d21aaa43</code>, that line of code would be <code>private const string INSTRUMENTATION_KEY = "d2bb0eed-1342-4394-9b0c-8a56d21aaa43";</code></p>
    </blockquote>
  </li>
  <li>
    <p>Locate the <strong>ConfigureServices</strong> method in the <strong>Startup</strong> class:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock7" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock7" class="mt-0"><code class="language-csharp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)
</span></span>{
    services.AddControllers();
}
</code></pre>
  </li>
  <li>
    <p>Starting from a new line, add the following code at the end of the <strong>ConfigureServices</strong> method to configure Application Insights using the provided instrumentation key:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock8" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock8" class="mt-0"><code class="language-csharp hljs">services.AddApplicationInsightsTelemetry(INSTRUMENTATION_KEY);
</code></pre>
  </li>
  <li>
    <p>Review the <strong>ConfigureServices</strong> method, which should now contain the following code:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock9" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock9" class="mt-0"><code class="language-csharp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)
</span></span>{
    services.AddControllers();
    services.AddApplicationInsightsTelemetry(INSTRUMENTATION_KEY);        
}
</code></pre>
  </li>
  <li>
    <p>Save the <strong>Startup.cs</strong> file.</p>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to build the .NET Web API.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock10" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock10" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> build
</code></pre>
  </li>
</ol>

<h4 id="task-3-test-an-api-application-locally">Task 3: Test an API application locally</h4>

<ol>
  <li>
    <p>At the terminal prompt, run the following command to launch the .NET Web API.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock11" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock11" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> run
</code></pre>
  </li>
  <li>
    <p>From the taskbar, open the context menu for the <strong>Microsoft Edge</strong> icon, and then open a new browser window.</p>
  </li>
  <li>
    <p>In the browser window that opens, navigate to the page in which the URL contains the <strong>/weatherforecast</strong> relative path of your web API, which at this point is hosted at <strong>localhost</strong> on port <strong>5000</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: The full URL is <code>http://localhost:5000/weatherforecast</code>.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: The page should contain an output in the following format:</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock12" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock12" class="mt-0"><code class="hljs json">[{<span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2021-09-04T10:15:04.0969996-07:00"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureC"</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureF"</span></span>:<span class="hljs-number"><span class="hljs-number">129</span></span>,<span class="hljs-attr"><span class="hljs-attr">"summary"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sweltering"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2021-09-05T10:15:04.0972401-07:00"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureC"</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureF"</span></span>:<span class="hljs-number"><span class="hljs-number">111</span></span>,<span class="hljs-attr"><span class="hljs-attr">"summary"</span></span>:<span class="hljs-string"><span class="hljs-string">"Balmy"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2021-09-06T10:15:04.0976549-07:00"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureC"</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureF"</span></span>:<span class="hljs-number"><span class="hljs-number">105</span></span>,<span class="hljs-attr"><span class="hljs-attr">"summary"</span></span>:<span class="hljs-string"><span class="hljs-string">"Scorching"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2021-09-07T10:15:04.0976613-07:00"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureC"</span></span>:<span class="hljs-number"><span class="hljs-number">-4</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureF"</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-attr"><span class="hljs-attr">"summary"</span></span>:<span class="hljs-string"><span class="hljs-string">"Freezing"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2021-09-08T10:15:04.0976618-07:00"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureC"</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureF"</span></span>:<span class="hljs-number"><span class="hljs-number">91</span></span>,<span class="hljs-attr"><span class="hljs-attr">"summary"</span></span>:<span class="hljs-string"><span class="hljs-string">"Balmy"</span></span>}]
</code></pre>
  </li>
  <li>
    <p>Close the browser window that’s displaying the page generated by <code>http://localhost:5000/weatherforecast</code>.</p>
  </li>
  <li>
    <p>In Visual Studio Code, select <strong>Kill Terminal</strong> (the <strong>Recycle Bin</strong> icon) to close the <strong>terminal</strong> pane and any associated processes.</p>
  </li>
</ol>

<h4 id="task-4-review-metrics-in-application-insights">Task 4: Review metrics in Application Insights</h4>

<ol>
  <li>
    <p>On your lab computer, switch to the <strong>Microsoft Edge</strong> browser window displaying the Azure portal.</p>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the blade of the <strong>instrm</strong><em>[yourname]</em> Application Insights resource you created previously in this lab.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, in the tiles in the center of the blade, find the displayed metrics. Specifically, find the number of server requests that have occurred and the average server response time.</p>

    <p>The following screenshot displays the <strong>Application Insights</strong> metrics of the local web app.</p>

    <p><a href="media/l11_web_app_metrics_portal.png" target="_blank"><img src="media/l11_web_app_metrics_portal.png" alt="Application Insights metrics of the local web app in the Azure portal"></a></p>

    <blockquote>
      <p><strong>Note</strong>: It can take up to five minutes to observe requests in the Application Insights metrics charts.</p>
    </blockquote>
  </li>
</ol>

<h4 id="review-1">Review</h4>

<p>In this exercise, you created an API app by using ASP.NET and configured it to stream application metrics to Application Insights. You then used the Application Insights dashboard to review performance details about your API.</p>

<h3 id="exercise-3-monitor-a-web-api-using-application-insights">Exercise 3: Monitor a web API using Application Insights</h3>

<h4 id="task-1-deploy-an-application-to-the-web-api">Task 1: Deploy an application to the web API</h4>

<ol>
  <li>
    <p>On the lab computer, switch to the Visual Studio Code.</p>
  </li>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, in the <strong>Explorer</strong> pane, navigate to the <strong>bin\Debug\netcoreapp3.1</strong> directory.</p>
  </li>
  <li>
    <p>Add a file named <strong>web.config</strong> to the directory.</p>
  </li>
  <li>
    <p>Open the <strong>web.config</strong> file and add the following content:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock13" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock13" class="mt-0"><code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?</span></span></span><span class="php">xml version=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"1.0"</span></span></span><span class="php"> encoding=</span><span class="hljs-string"><span class="php"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-meta"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span>
<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span>
  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">location</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">inheritInChildApplications</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span>
    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span>
      <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span>
        <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"aspNetCore"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">path</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">verb</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">modules</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AspNetCoreModuleV2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">resourceType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Unspecified"</span></span></span><span class="hljs-tag"> /&gt;</span></span>
      <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span>
      <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspNetCore</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">processPath</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dotnet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">arguments</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".\SimpleApi.dll"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stdoutLogEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stdoutLogFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".\logs\stdout"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostingModel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inprocess"</span></span></span><span class="hljs-tag"> /&gt;</span></span>
    <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span>
  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">location</span></span></span><span class="hljs-tag">&gt;</span></span>
<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span>
</code></pre>
  </li>
  <li>
    <p>Save and close the file.</p>
  </li>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, activate the shortcut menu, and then select <strong>Open in Integrated Terminal</strong>.</p>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to ensure that the current directory is set to the <strong>Allfiles (F):\Allfiles\Labs\11\Starter\Api\bin\Debug\netcoreapp3.1</strong>, where the deployment files reside:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock14" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock14" class="mt-0"><code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> F:\Allfiles\Labs\11\Starter\Api\bin\Debug\netcoreapp3.1
</code></pre>
  </li>
  <li>
    <p>Run the following command to create a zip file containing the starter project that you’ll deploy next to the Azure web API:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock15" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock15" class="mt-0"><code class="language-powershell">Compress-Archive -Path * -DestinationPath api.zip
</code></pre>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to sign in to your Azure subscription by using Azure PowerShell:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock16" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock16" class="mt-0"><code class="language-powershell">Connect-AzAccount
</code></pre>
  </li>
  <li>
    <p>Follow the instructions displayed at the terminal prompt by switching to the Microsoft Edge browser displaying the Azure portal, opening another tab in the browser window, navigating to <code>https://microsoft.com/devicelogin</code>, when prompted, entering the provided code, and then signing in with the account you’ll be using for this lab.</p>

    <blockquote>
      <p><strong>Note</strong>: Wait for the sign-in process to complete.</p>
    </blockquote>
  </li>
  <li>
    <p>Close the newly opened browser tab and switch back to the terminal prompt in the Visual Studio Code window.</p>
  </li>
  <li>
    <p>Run the following command to display the listing of all web apps in the <strong>MonitoredAssets</strong> resource group:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock17" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock17" class="mt-0"><code class="language-powershell">Get-AzWebApp -ResourceGroupName MonitoredAssets
</code></pre>
  </li>
  <li>
    <p>Run the following command to display the list of web apps in the <strong>MonitoredAssets</strong> resource group, which names start with <strong>smpapi*</strong>:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock18" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock18" class="mt-0"><code class="language-powershell">Get-AzWebApp -ResourceGroupName MonitoredAssets | Where-Object {$_.Name -like 'smpapi*'}
</code></pre>
  </li>
  <li>
    <p>Run the following commands to display the name of the first of the web apps identified in the previous step and store it in a variable named <strong>$webAppName</strong>:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock19" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock19" class="mt-0"><code class="language-powershell">Get-AzWebApp -ResourceGroupName MonitoredAssets | Where-Object {$_.Name -like 'smpapi*'} | Select-Object -ExpandProperty Name
$webAppName = (Get-AzWebApp -ResourceGroupName MonitoredAssets | Where-Object {$_.Name -like 'smpapi*'})[0] | Select-Object -ExpandProperty Name
</code></pre>
  </li>
  <li>
    <p>Run the following command to deploy the <strong>api.zip</strong> file you created previously in this task to the web API whose name you identified in the previous step:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock20" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock20" class="mt-0"><code class="language-powershell">az webapp deployment source config-zip --resource-group MonitoredAssets --src api.zip --name $webAppName
</code></pre>
    <blockquote>
      <p><strong>Note</strong>: If prompted to authenticate, run <code>az login</code> and follows instructions to complete the sign in process.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: Wait for the deployment to complete before you continue with this lab.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: Review the output of the command and verify that the <code>provisioningState</code> is set to <code>Succeeded</code>. The output of the command should have the following format:</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock21" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock21" class="mt-0"><code class="hljs javascript">Getting scm site credentials <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> zip deployment
Starting zip deployment. This operation can take a <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> to complete ...
Deployment endpoint responded <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> status code <span class="hljs-number"><span class="hljs-number">202</span></span>
{
  <span class="hljs-string"><span class="hljs-string">"active"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>,
  <span class="hljs-string"><span class="hljs-string">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"N/A"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"author_email"</span></span>: <span class="hljs-string"><span class="hljs-string">"N/A"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"complete"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>,
  <span class="hljs-string"><span class="hljs-string">"deployer"</span></span>: <span class="hljs-string"><span class="hljs-string">"ZipDeploy"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"end_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2021-09-03T17:02:18.124062Z"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"f5fb8ef6a11d4f8387f09dc47628007e"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"is_readonly"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>,
  <span class="hljs-string"><span class="hljs-string">"is_temp"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>,
  <span class="hljs-string"><span class="hljs-string">"last_success_end_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2021-09-03T17:02:18.124062Z"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"log_url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://smpapianu.scm.azurewebsites.net/api/deployments/latest/log"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Created via a push deployment"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"progress"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>,
  <span class="hljs-string"><span class="hljs-string">"provisioningState"</span></span>: <span class="hljs-string"><span class="hljs-string">"Succeeded"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"received_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2021-09-03T17:02:11.942626Z"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"site_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"smpapianu"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"start_time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2021-09-03T17:02:12.1613438Z"</span></span>,
  <span class="hljs-string"><span class="hljs-string">"status"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>,
  <span class="hljs-string"><span class="hljs-string">"status_text"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>,
  <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://smpapianu.scm.azurewebsites.net/api/deployments/latest"</span></span>
}
</code></pre>
  </li>
  <li>
    <p>On the lab computer, launch another Microsoft Edge browser window.</p>
  </li>
  <li>
    <p>In the browser window, navigate to the Azure Web API app into which you deployed the API app previously in this task by appending to its URL (that you recorded previously in this lab) the suffix <strong>/weatherforecast</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: For example, if your URL is <code>https://smpapianu.azurewebsites.net</code>, the new URL would be <code>https://smpapianu.azurewebsites.net/weatherforecast</code>.</p>
    </blockquote>
  </li>
  <li>
    <p>Verify that the output resembles the one generated when running the API app locally.</p>

    <blockquote>
      <p><strong>Note</strong>: The output will include different values but it should have the same format.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-configure-in-depth-metric-collection-for-web-apps">Task 2: Configure in-depth metric collection for Web Apps</h4>

<ol>
  <li>
    <p>On your lab computer, switch to the <strong>Microsoft Edge</strong> browser window displaying the Azure portal.</p>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the blade of the <strong>smpapi</strong><em>[yourname]</em> web app resource you created previously in this lab.</p>
  </li>
  <li>
    <p>On the <strong>App Service</strong> blade, select <strong>Application Insights</strong> and then select <strong>Turn on Application Insights</strong>.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, perform the following actions, select <strong>Apply</strong>, and then in the confirmation dialog, select <strong>Yes</strong>:</p>

    <table>
      <thead>
        <tr>
          <th>Setting</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Application Insights</strong> slider</td>
          <td>Ensure it is set to <strong>Enable</strong>.</td>
        </tr>
        <tr>
          <td><strong>Instrument your application</strong> section</td>
          <td>Select the **.NET Core ** tab.</td>
        </tr>
        <tr>
          <td><strong>Collection level</strong> section</td>
          <td>Select <strong>Recommended</strong>.</td>
        </tr>
        <tr>
          <td><strong>Profiler</strong> section</td>
          <td>Select <strong>On</strong>.</td>
        </tr>
        <tr>
          <td><strong>Snapshot debugger</strong> section</td>
          <td>Select <strong>Off</strong>.</td>
        </tr>
        <tr>
          <td><strong>SQL Commands</strong> section</td>
          <td>Select <strong>Off</strong>.</td>
        </tr>
      </tbody>
    </table>

    <p>The following screenshot displays the <strong>Application Insights</strong> settings of the Azure Web API.</p>

    <p><a href="media/l11_web_api_insights.png" target="_blank"><img src="media/l11_web_api_insights.png" alt="Application Insights settings of the Azure Web API"></a></p>
  </li>
  <li>
    <p>Switch to the browser tab you opened in the previous task to display the results of deployment of your API app to the target Azure API app (including the <strong>/weatherforecast</strong> relative path in the target URL) and refresh the browser page several times.</p>
  </li>
  <li>
    <p>Review the JSON-formatted output generated by the API.</p>
  </li>
  <li>
    <p>Record the URL that you used to access the JSON-formatted output.</p>

    <blockquote>
      <p><strong>Note</strong>: The URL should be in the format <code>https://smpapianu.azurewebsites.net/weatherforecast</code>.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-3-get-updated-metrics-in-application-insights">Task 3: Get updated metrics in Application Insights</h4>

<ol>
  <li>
    <p>Return to the browser window displaying the Azure web app in the Azure portal.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade of the web app, select the <strong>View Application Insights data</strong> link.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, review the collected metrics in the tiles in the center of the blade, including the number of server requests that have occurred and the average server response time.</p>

    <p>The following screenshot displays the <strong>Application Insights</strong> metrics of the Azure web app in the Azure portal.</p>

    <p><a href="media/l11_azure_web_app_metrics_portal.png" target="_blank"><img src="media/l11_azure_web_app_metrics_portal.png" alt="Application Insights metrics of the Azure web app in the Azure portal"></a></p>

    <blockquote>
      <p><strong>Note</strong>: It can take up to five minutes for updated metrics to appear in the Application Insights metrics charts.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-4-view-real-time-metrics-in-application-insights">Task 4: View real-time metrics in Application Insights</h4>

<ol>
  <li>
    <p>On the <strong>Application Insights</strong> blade, in the <strong>Investigate</strong> section, select <strong>Live metrics</strong>.</p>
  </li>
  <li>
    <p>Switch back to the browser window displaying the target API app running in the target Azure web app (which targets the <strong>/weatherforecast</strong> relative path in the target URL), and then refresh the browser page several times.</p>
  </li>
  <li>
    <p>Switch to the browser window displaying the <strong>Live metrics</strong> blade and review its content.</p>

    <blockquote>
      <p><strong>Note</strong>: The <strong>Incoming Requests</strong> section should update within seconds, showing the requests that you made to the web API.</p>
    </blockquote>
  </li>
</ol>

<h3 id="exercise-4-application-insights-logging-with-net-core">Exercise 4: Application Insights logging with .NET Core</h3>

<h4 id="task-1-configure-logging-for-a-net-core-api-app">Task 1: Configure logging for a .NET Core API app</h4>

<ol>
  <li>
    <p>Switch to the <strong>Visual Studio Code</strong> window.</p>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to set the current directory to the <strong>Allfiles (F):\Allfiles\Labs\11\Starter\Api</strong>, where the deployment files reside:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock22" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock22" class="mt-0"><code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> F:\Allfiles\Labs\11\Starter\Api
</code></pre>
  </li>
  <li>
    <p>Run the following command to import version 2.18.0 of <strong>Microsoft.Extensions.Logging.ApplicationInsights</strong> from NuGet to the current project:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock23" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock23" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dotnet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Extensions</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Logging</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ApplicationInsights</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--version</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The <strong>dotnet add package</strong> command will add the <strong>Microsoft.ApplicationInsights</strong> package from NuGet. For more information, refer to <a href="https://www.nuget.org/packages/Microsoft.Extensions.Logging.ApplicationInsights">Microsoft.Extensions.Logging.ApplicationInsights</a>.</p>
    </blockquote>
  </li>
  <li>
    <p>In the <strong>Visual Studio Code</strong> window, in the <strong>Explorer</strong> pane, navigate to the <strong>Controllers</strong> directory, and then open the file <strong>WeatherForecastController.cs</strong>.</p>
  </li>
  <li>
    <p>Review the content of the file and note that it includes the <code>using Microsoft.Extensions.Logging</code> directive and a constructor injection for the generic ILogger<weatherforecastcontroller> interface.</weatherforecastcontroller></p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock24" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock24" class="mt-0"><code class="language-csharp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System;
<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic;
<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq;
<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks;
<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Mvc;
<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.Logging;

<span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">SimpleApi.Controllers</span></span>
{
    [<span class="hljs-meta"><span class="hljs-meta">ApiController</span></span>]
    [<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[controller]"</span></span></span><span class="hljs-meta">)</span></span>]
    <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WeatherForecastController</span></span> : <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span>
    {
        <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Summaries = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[]
        {
            <span class="hljs-string"><span class="hljs-string">"Freezing"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bracing"</span></span>, <span class="hljs-string"><span class="hljs-string">"Chilly"</span></span>, <span class="hljs-string"><span class="hljs-string">"Cool"</span></span>, <span class="hljs-string"><span class="hljs-string">"Mild"</span></span>, <span class="hljs-string"><span class="hljs-string">"Warm"</span></span>, <span class="hljs-string"><span class="hljs-string">"Balmy"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hot"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sweltering"</span></span>, <span class="hljs-string"><span class="hljs-string">"Scorching"</span></span>
        };

        <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ILogger&lt;WeatherForecastController&gt; _logger;

        <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WeatherForecastController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ILogger&lt;WeatherForecastController&gt; logger</span></span></span><span class="hljs-function">)
        </span></span>{
            _logger = logger;
        }

        [<span class="hljs-meta"><span class="hljs-meta">HttpGet</span></span>]
        <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;WeatherForecast&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)
        </span></span>{
            <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rng = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random();
            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>).Select(index =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeatherForecast
            {
                Date = DateTime.Now.AddDays(index),
                TemperatureC = rng.Next(<span class="hljs-number"><span class="hljs-number">-20</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>),
                Summary = Summaries[rng.Next(Summaries.Length)]
            })
            .ToArray();
        }
    }
}
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: You’ll leverage this configuration to implement custom logging. Currently, the constructor displays a group of five randomly generated weather forecasts. You’ll modify the controller to display one forecast at a time. For each forecast, you’ll generate an informational, warning, or error log entry indicating the type of weather (mild, severe, and extreme). After these log entries are recorded by Application Insights in the corresponding Log Analytics workspace, each entry will have an automatically assigned severity level of 1, 2, or 3.</p>
    </blockquote>
  </li>
  <li>
    <p>Locate the <code>var rng = new Random();</code> line in the <code>public IEnumerable&lt;WeatherForecast&gt; Get()</code> method in the file <strong>WeatherForecastController.cs</strong>, and then add the following code starting with the next line:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock25" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock25" class="mt-0"><code class="language-csharp hljs">        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> temperatureC = rng.Next(<span class="hljs-number"><span class="hljs-number">-20</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>);
        <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> summaryId = rng.Next(Summaries.Length);

        <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (summaryId)
        {
            <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>:
            _logger.LogError(<span class="hljs-string"><span class="hljs-string">"WeatherForecast: extreme weather"</span></span>);
            <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>:
            _logger.LogWarning(<span class="hljs-string"><span class="hljs-string">"WeatherForecast: severe weather"</span></span>);
            <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>:
            _logger.LogInformation(<span class="hljs-string"><span class="hljs-string">"WeatherForecast: mild weather"</span></span>);
            <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
        }
</code></pre>
  </li>
  <li>
    <p>Modify the <code>return</code> statement so it has the following content:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">c#</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock26" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock26" class="mt-0"><code class="language-csharp hljs">        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Select(index =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeatherForecast
        {
            Date = DateTime.Now.AddDays(index),
            TemperatureC = temperatureC,
            Summary = Summaries[summaryId]
        })
        .ToArray();
</code></pre>
  </li>
  <li>
    <p>Save and close the file.</p>
  </li>
  <li>
    <p>At the terminal prompt, run the following command to build the .NET Web API:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock27" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock27" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> build
</code></pre>
  </li>
</ol>

<h4 id="task-2-test-logging-of-a-net-core-api-app">Task 2: Test logging of a .NET Core API app</h4>

<ol>
  <li>
    <p>Run the following command to launch the .NET Web API.</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock28" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock28" class="mt-0"><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dotnet</span></span> run
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: Keep the web API running and monitor the output of the Visual Studio Code <strong>terminal</strong> pane as you perform the next steps in this task.</p>
    </blockquote>
  </li>
  <li>
    <p>On your lab computer, from the taskbar, open the context menu for the <strong>Microsoft Edge</strong> icon, and then open a new browser window.</p>

    <blockquote>
      <p><strong>Note</strong>: Position the browser window such that it doesn’t block the Visual Studio Code <strong>terminal</strong> pane.</p>
    </blockquote>
  </li>
  <li>
    <p>In the open browser window, navigate to <code>http://localhost:5000/weatherforecast</code>, and then refresh the page several times.</p>

    <blockquote>
      <p><strong>Note</strong>: Each time you refresh the page, it should display a different weather forecast in the following format.</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock29" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock29" class="mt-0"><code class="hljs json">[{<span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-string"><span class="hljs-string">"2021-09-04T14:35:29.0789168-07:00"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureC"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-attr"><span class="hljs-attr">"temperatureF"</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span>,<span class="hljs-attr"><span class="hljs-attr">"summary"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sweltering"</span></span>}]
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: Each refresh of the page should result in an informational, warning, or error message display at the terminal prompt, in the following format:</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock30" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock30" class="mt-0"><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">warn</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">SimpleApi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Controllers</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.WeatherForecastController</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0]</span></span>
  <span class="hljs-selector-tag"><span class="hljs-selector-tag">WeatherForecast</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">severe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">weather</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: Refresh the page several times to ensure that you generated at least one message of each type (<strong>info</strong>, <strong>warn</strong>, and <strong>fail</strong>).</p>
    </blockquote>
  </li>
  <li>
    <p>Leave the API app running.</p>
  </li>
</ol>

<h4 id="task-3-review-the-application-insights-logging">Task 3: Review the Application Insights logging</h4>

<ol>
  <li>
    <p>On your lab computer, switch to the <strong>Microsoft Edge</strong> browser window displaying the Azure portal.</p>
  </li>
  <li>
    <p>In the Azure portal, navigate back to the blade of the <strong>instrm</strong><em>[yourname]</em> Application Insights resource you created previously in this lab.</p>
  </li>
  <li>
    <p>On the <strong>Application Insights</strong> blade, in the <strong>Monitoring</strong> section, select <strong>Logs</strong>.</p>
  </li>
  <li>
    <p>If needed, close the <strong>Welcome to Log Analytics</strong> pane and <strong>Queries</strong> pane.</p>
  </li>
  <li>
    <p>In the <strong>New Query</strong> pane, type the following query and select <strong>Run</strong>:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock31" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock31" class="mt-0"><code class="hljs coffeescript">traces
| order <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> timestamp desc
</code></pre>
  </li>
  <li>
    <p>Review the results of the query.</p>

    <blockquote>
      <p><strong>Note</strong>: The results should include log entries corresponding to the warning and error messages generated by the .NET Core api app, with their respective severity levels (2 and 3).</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: It can take up to five minutes to observe requests in the Application Insights metrics charts.</p>
    </blockquote>

    <p>The following screenshot displays the log query results on the <strong>Application Insights Logs</strong> blade.</p>

    <p><a href="media/l11_web_api_insights_logs.png" target="_blank"><img src="media/l11_web_api_insights_logs.png" alt="Log query results on the Application Insights Logs blade"></a></p>

    <blockquote>
      <p><strong>Note</strong>: You could deploy the updated API app to an Azure web app to collect its logs using Application Insights in an equivalent manner.</p>
    </blockquote>

    <blockquote>
      <p><strong>Note</strong>: You can extend the Application Insights logging level to include informational events by modifying the <strong>appsettings.Development.json</strong> (or <strong>appsettings.json</strong>) file as illustrated in the following code listing. However, you should keep in mind that this will considerably increase the log volume, which has potential network performance and pricing implications:</p>
    </blockquote>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock32" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock32" class="mt-0"><code class="hljs json">{
  <span class="hljs-attr"><span class="hljs-attr">"Logging"</span></span>: {
    <span class="hljs-attr"><span class="hljs-attr">"LogLevel"</span></span>: {
      <span class="hljs-attr"><span class="hljs-attr">"Default"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>,
      <span class="hljs-attr"><span class="hljs-attr">"Microsoft"</span></span>: <span class="hljs-string"><span class="hljs-string">"Warning"</span></span>,
      <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Hosting.Lifetime"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>
    },
    <span class="hljs-attr"><span class="hljs-attr">"ApplicationInsights"</span></span>: {
      <span class="hljs-attr"><span class="hljs-attr">"LogLevel"</span></span>: {
        <span class="hljs-attr"><span class="hljs-attr">"Microsoft"</span></span>: <span class="hljs-string"><span class="hljs-string">"Information"</span></span>
      }
    }
  }
}
</code></pre>
  </li>
  <li>
    <p>Close the browser window displaying the output of your API app.</p>
  </li>
  <li>
    <p>Switch to the <strong>Visual Studio Code</strong> window, and then select <strong>Kill Terminal</strong> (the <strong>Recycle Bin</strong> icon) to close the <strong>terminal</strong> pane and any associated processes.</p>
  </li>
</ol>

<h4 id="review-2">Review</h4>

<p>In this exercise, you configured and tested Application Insights logging of your web API app.</p>

<h3 id="exercise-5-clean-up-your-subscription">Exercise 5: Clean up your subscription</h3>

<h4 id="task-1-open-azure-cloud-shell">Task 1: Open Azure Cloud Shell</h4>

<ol>
  <li>
    <p>In the Azure portal, select the <strong>Cloud Shell</strong> icon <a href="media/az204_lab_CloudShell.png" target="_blank"><img src="media/az204_lab_CloudShell.png" alt="Cloud Shell icon"></a> to open a new PowerShell session. If Cloud Shell defaults to a PowerShell session, select <strong>PowerShell</strong>, and in the drop-down menu, select <strong>Bash</strong>.</p>

    <blockquote>
      <p><strong>Note</strong>: If this is the first time you’re starting <strong>Cloud Shell</strong>, when prompted to select either <strong>Bash</strong> or <strong>PowerShell</strong>, select <strong>Bash</strong>. When you’re presented with the <strong>You have no storage mounted</strong> message, select the subscription you’re using in this lab, and select <strong>Create storage</strong>.</p>
    </blockquote>
  </li>
</ol>

<h4 id="task-2-delete-resource-groups">Task 2: Delete resource groups</h4>

<ol>
  <li>
    <p>On the <strong>Cloud Shell</strong> pane, run the following command to delete the <strong>MonitoredAssets</strong> resource group:</p>

    <div class="code-header mt-3 mb-0 bg-light d-flex justify-content-between border"><span class="mx-2 text-muted text-capitalize font-weight-light">code</span><button class="m-0 btn btn-code btn-sm btn-light codeBtn rounded-0 border-left text-muted font-weight-light" data-clipboard-target="#codeBlock33" type="button"><i class="fa fa-files-o mr-2" aria-hidden="true"></i>Copy</button></div><pre id="codeBlock33" class="mt-0"><code class="hljs coffeescript">az group <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> --name MonitoredAssets --<span class="hljs-literal"><span class="hljs-literal">no</span></span>-wait --<span class="hljs-literal"><span class="hljs-literal">yes</span></span>
</code></pre>

    <blockquote>
      <p><strong>Note</strong>: The command executes asynchronously (as determined by the <em>–no-wait</em> parameter), so while you’ll be able to run another Azure CLI command immediately afterwards within the same Bash session, it’ll take a few minutes before the resource groups are actually removed.</p>
    </blockquote>
  </li>
  <li>
    <p>Close the <strong>Cloud Shell</strong> pane in the portal.</p>
  </li>
</ol>

<h4 id="task-3-close-the-active-applications">Task 3: Close the active applications</h4>

<ol>
  <li>
    <p>Close the currently running Microsoft Edge application.</p>
  </li>
  <li>
    <p>Close the currently running Visual Studio Code application.</p>
  </li>
</ol>

<h4 id="review-3">Review</h4>

<p>In this exercise, you cleaned up your subscription by removing the resource groups used in this lab.</p>

            </article>
        </main>
    </div>
    <footer class="fixed-bottom d-print-none">
        <nav class="navbar navbar-light bg-light d-flex justify-content-around">
            <span class="navbar-text">
                <i class="fa fa-github" aria-hidden="true"></i>
                <a href="https://github.com/MicrosoftLearning/AZ-204-DevelopingSolutionsforMicrosoftAzure" target="_blank" class="ml-2">
                    MicrosoftLearning/AZ-204-DevelopingSolutionsforMicrosoftAzure
                </a>
            </span>
        </nav>
    </footer>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="../../assets/js/script_v%3D64f540ac7c8eef33997aaf23b6af9bd5b858530e.js"></script>



</body></html>